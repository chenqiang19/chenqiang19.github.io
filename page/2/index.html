<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.0.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    hostname: new URL('http://yoursite.com').hostname,
    root: '/',
    scheme: 'Mist',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="è®°å½•æ˜¯å¿˜è®°çš„ç¬¬ä¸€åŠ©æ‰‹.">
<meta property="og:type" content="website">
<meta property="og:title" content="ç¼–è¾‘å°¼æ’‘">
<meta property="og:url" content="http:&#x2F;&#x2F;yoursite.com&#x2F;page&#x2F;2&#x2F;index.html">
<meta property="og:site_name" content="ç¼–è¾‘å°¼æ’‘">
<meta property="og:description" content="è®°å½•æ˜¯å¿˜è®°çš„ç¬¬ä¸€åŠ©æ‰‹.">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://yoursite.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>ç¼–è¾‘å°¼æ’‘</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="ç¼–è¾‘å°¼æ’‘" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">ç¼–è¾‘å°¼æ’‘</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">å­¦æ— æ­¢å¢ƒ</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ ">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>é¦–é¡µ</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>æ ‡ç­¾</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>åˆ†ç±»</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>å½’æ¡£</a>

  </li>
        <li class="menu-item menu-item-schedule">

    <a href="/schedule/" rel="section"><i class="fa fa-fw fa-calendar"></i>æ—¥ç¨‹è¡¨</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>æœç´¢
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocorrect="off" autocapitalize="none"
           placeholder="æœç´¢..." spellcheck="false"
           type="text" id="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result"></div>

</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/07/25/Image-Process-Three-Fourier-Transform/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qiang Chen">
      <meta itemprop="description" content="è®°å½•æ˜¯å¿˜è®°çš„ç¬¬ä¸€åŠ©æ‰‹.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ç¼–è¾‘å°¼æ’‘">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/25/Image-Process-Three-Fourier-Transform/" class="post-title-link" itemprop="url">Image-Process-Three-Fourier-Transform</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-07-25 20:32:11 / ä¿®æ”¹æ—¶é—´ï¼š20:35:01" itemprop="dateCreated datePublished" datetime="2021-07-25T20:32:11+08:00">2021-07-25</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Image-Processing/" itemprop="url" rel="index">
                    <span itemprop="name">Image Processing</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="å›¾åƒå¤„ç†å­¦ä¹ "><a href="#å›¾åƒå¤„ç†å­¦ä¹ " class="headerlink" title="å›¾åƒå¤„ç†å­¦ä¹ "></a>å›¾åƒå¤„ç†å­¦ä¹ </h2><h4 id="ç¬¬ä¸€éƒ¨åˆ†-ç¦»æ•£å‚…é‡Œå¶å˜æ¢"><a href="#ç¬¬ä¸€éƒ¨åˆ†-ç¦»æ•£å‚…é‡Œå¶å˜æ¢" class="headerlink" title="ç¬¬ä¸€éƒ¨åˆ† ç¦»æ•£å‚…é‡Œå¶å˜æ¢"></a>ç¬¬ä¸€éƒ¨åˆ† ç¦»æ•£å‚…é‡Œå¶å˜æ¢</h4><p>è¿™é‡Œå…ˆå¼•å…¥å•å˜é‡çš„ç¦»æ•£å‚…é‡Œå¶å˜æ¢(DFT)ã€‚</p>
<script type="math/tex; mode=display">
\begin{align}
&å‡è®¾åŸå§‹å‡½æ•°ä¸ºf(x),ç»è¿‡é‡‡æ ·åçš„å‡½æ•°ä¸º\tilde{f}(x),é‡‡æ ·å‡½æ•°ç›¸åº”çš„å‚…é‡Œå¶å˜æ¢ä¸º\tilde{F}(\mu),åˆ™åˆ©ç”¨å‚…é‡Œå¶å˜æ¢å¯å¾—ï¼š \\
&\tilde{F}(\mu)=\int_{-\infty}^{\infty}\tilde{f}(x)e^{-j2\pi\mu t}dt \\
&æ ¹æ®æ•°å­—å›¾åƒå¤„ç†p131çš„å¼(4.3-1)ï¼Œ\tilde{f}(t)=f(t)s_{\Delta T}(t)=\sum_{n=-\infty}^{\infty}f(t)\delta(t-n\Delta T),ä»£å…¥å¾—ï¼š \\
\tilde{F}(\mu)=&\int_{-\infty}^{\infty}\tilde{f}(t)e^{-j2\pi\mu t}dt=\int_{-\infty}^{\infty}\sum_{n=-\infty}^{\infty}f(t)\delta(t-n\Delta T)e^{-j2\pi\mu t}dt \\
=&\sum_{n=-\infty}^{\infty}\int_{-\infty}^{\infty}f(t)\delta(t-n\Delta T)e^{-j2\pi\mu t}dt=\sum_{\infty}^{\infty}f_ne^{-j2\pi\mu n\Delta T}
\end{align}</script><p>ä¸Šå¼å¾—æœ€åä¸€æ­¥æ¨å¯¼æœ‰ç‚¹ä¸ç†è§£ï¼Œä¸‹é¢ç»™å‡ºä¸ªäººçš„ä¸€ä¸ªç†è§£ï¼š</p>
<script type="math/tex; mode=display">
ç”±äºå•ä½å†²æ¿€å‡½æ•°\delta(t)çš„å®šä¹‰ä¸ºï¼š\\
\delta(t)=\begin{cases}
\infty & t=0 \\
0 & t\neq0 
\end{cases},é‚£ä¹ˆ
\delta(t-t_0)=\begin{cases}
\infty & t-t_0=0 \\
0 & t-t_0\neq0 
\end{cases} \\
åˆæ ¹æ®å–æ ·ç‰¹æ€§ï¼š\int_{-\infty}^{\infty}f(t)\delta(t-t_0)dt=f(t_0)ï¼Œè¿™é‡Œå¯ä»¥ç›´æ¥æŠŠ\int_{-\infty}^{\infty}f(t)\delta(t-t_0)dt=f(t_0)çœ‹æˆ\int_{-\infty}^{\infty}f(t_0)\delta(t-t_0)dt=f(t_0)\\
å› ä¸º\int_{-\infty}^{\infty}\delta(t-t_0)d(t-t_0)=1ï¼Œ \int_{-\infty}^{\infty}f(t_0)\delta(t-t_0)dt=f(t_0)=f(t_0)\int_{-\infty}^{\infty}\delta(t-t_0)dt=f(t_0)\\
æ‰€ä»¥ï¼Œ\sum_{n=-\infty}^{\infty}\int_{-\infty}^{\infty}f(t)\delta(t-n\Delta T)e^{-j2\pi\mu t}dt=\sum_{n=-\infty}^{\infty}\int_{-\infty}^{\infty}f(n\Delta T)\delta(t-n\Delta T)e^{-j2\pi\mu t}dt=\sum_{n=-\infty}^{\infty}f(n\Delta T)\int_{-\infty}^{\infty}\delta(t-n\Delta T)e^{-j2\pi\mu t}dt\\
ç”±äºæ•°å­—å›¾åƒå¤„ç†p129ä¸­ä¾‹4.2,F(\mu)=\int_{-\infty}^{\infty}\delta(t-t_0)e^{-j2\pi\mu t}dt=e^{-j2\pi\mu t_0},æ‰€ä»¥ä¸Šå¼ç­‰äº \\
\sum_{n=-\infty}^{\infty}\int_{-\infty}^{\infty}f(n\Delta T)\delta(t-n\Delta T)e^{-j2\pi\mu t}dt=\sum_{n=-\infty}^{\infty}f(n\Delta T)e^{-j2\pi\mu n\Delta T} \\
å› ä¸ºæ•°å­—å›¾åƒå¤„ç†p132ä¸­å¼(4.3-2),f_k=\int_{-\infty}^{\infty}f(t)\delta(t-k\Delta T)dt=f(k\Delta T) \\
æ‰€ä»¥ï¼Œ\sum_{n=-\infty}^{\infty}\int_{-\infty}^{\infty}f(n\Delta T)\delta(t-n\Delta T)e^{-j2\pi\mu t}dt=\sum_{n=-\infty}^{\infty}f_ne^{-j2\pi\mu n\Delta T}</script><p>å‡è®¾æƒ³è¦åœ¨å‘¨æœŸ&mu;=0åˆ°&amp;mu=1/&Delta;Tä¹‹é—´å¾—åˆ°Mä¸ªç­‰é—´è·çš„æ ·æœ¬ï¼Œå¯ä»¥é€šè¿‡åœ¨å¦‚ä¸‹é¢‘ç‡å¤„å–æ ·ï¼š</p>
<script type="math/tex; mode=display">
\mu=\frac{m}{M\Delta T},m=0,1,2,\cdots,M-1,ä»£å…¥\tilde{F}(\mu)å¾—ï¼ŒF_m=\sum_{n=0}^{M-1}f_ne^{-j2\pi mn/M},M=0,1,2,\cdots,M-1</script><p>æ ¹æ®ä¸Šé¢ä¸€ç»´ç¦»æ•£å‚…é‡Œå¶å˜æ¢å¾—æ¨å¯¼ï¼Œå¯ä»¥æ‰©å±•åˆ°ä¸‹é¢å¾—äºŒç»´ç¦»æ•£å‚…é‡Œå¶å˜æ¢å¾—æƒ…å†µã€‚</p>
<p>äºŒç»´ç¦»æ•£å‚…ç«‹å¶å˜æ¢æ˜¯å‚…ç«‹å¶å˜æ¢åœ¨å›¾åƒå¤„ç†ä¸Šçš„åº”ç”¨æ–¹æ³•ã€‚é€šå¸¸å‚…ç«‹å¶å˜æ¢ç”¨äºåˆ†ç¦»æ¨¡æ‹Ÿä¿¡å·æˆ–éŸ³é¢‘ç­‰è¿ç»­ä¸€ç»´ä¿¡å·çš„é¢‘ç‡ã€‚ä½†æ˜¯ï¼Œæ•°å­—å›¾åƒä½¿ç”¨[0, 255]èŒƒå›´å†…çš„ç¦»æ•£å€¼è¡¨ç¤ºï¼ŒèŒƒå›´å†…çš„ç¦»æ•£å€¼è¡¨ç¤ºï¼Œå¹¶ä¸”å›¾åƒä½¿ç”¨HxWçš„äºŒç»´çŸ©é˜µè¡¨ç¤ºï¼Œæ‰€ä»¥åœ¨è¿™é‡Œä½¿ç”¨äºŒç»´ç¦»æ•£å‚…ç«‹å¶å˜æ¢ã€‚äºŒç»´ç¦»æ•£å‚…ç«‹å¶å˜æ¢ä½¿ç”¨ä¸‹å¼è®¡ç®—ï¼Œå…¶ä¸­ è¡¨ç¤ºè¾“å…¥å›¾åƒï¼š</p>
<script type="math/tex; mode=display">
G(u,v)=\sum^{M-1}_{x=0}\sum^{N-1}_{y=0}I(x,y)e^{-2\cdot \pi\cdot j\cdot (\frac{ux}{M}+\frac{vy}{N})}</script><p>äºŒç»´å‚…é‡Œå¶é€†å˜æ¢ä»é¢‘ç‡åˆ†é‡GæŒ‰ç…§ä¸‹å¼å¤åŸå›¾åƒï¼š</p>
<script type="math/tex; mode=display">
I(x,y)=\frac{1}{M\cdot N}\sum^{M-1}_{x=0}\sum^{N-1}_{y=0}G(u,v)e^{2\cdot \pi\cdot j\cdot (\frac{ux}{M}+\frac{vy}{N})}</script><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># DFT hyper-parameters</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">K, L = <span class="number">128</span>, <span class="number">128</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">channel = <span class="number">3</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># DFT</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dft</span><span class="params">(img)</span>:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">	H, W, _ = img.shape</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># Prepare DFT coefficient</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">	G = np.zeros((L, K, channel), dtype=np.complex)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># prepare processed index corresponding to original image positions</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">	x = np.tile(np.arange(W), (H, <span class="number">1</span>))</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">	y = np.arange(H).repeat(W).reshape(H, <span class="number">-1</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># dft</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">for</span> c <span class="keyword">in</span> range(channel):</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">		<span class="keyword">for</span> l <span class="keyword">in</span> range(L):</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">			<span class="keyword">for</span> k <span class="keyword">in</span> range(K):</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">				G[l, k, c] = np.sum(img[..., c] * np.exp(<span class="number">-2j</span> * np.pi * (x * k / K + y * l / L))) / np.sqrt(K * L)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">				<span class="comment">#for n in range(N):</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">				<span class="comment">#    for m in range(M):</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">				<span class="comment">#        v += gray[n, m] * np.exp(-2j * np.pi * (m * k / M + n * l / N))</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">				<span class="comment">#G[l, k] = v / np.sqrt(M * N)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">return</span> G</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># IDFT</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">idft</span><span class="params">(G)</span>:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># prepare out image</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">	H, W, _ = G.shape</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">	out = np.zeros((H, W, channel), dtype=np.float32)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># prepare processed index corresponding to original image positions</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">	x = np.tile(np.arange(W), (H, <span class="number">1</span>))</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">	y = np.arange(H).repeat(W).reshape(H, <span class="number">-1</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># idft</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">for</span> c <span class="keyword">in</span> range(channel):</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">		<span class="keyword">for</span> l <span class="keyword">in</span> range(H):</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">			<span class="keyword">for</span> k <span class="keyword">in</span> range(W):</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">				out[l, k, c] = np.abs(np.sum(G[..., c] * np.exp(<span class="number">2j</span> * np.pi * (x * k / W + y * l / H)))) / np.sqrt(W * H)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># clipping</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">	out = np.clip(out, <span class="number">0</span>, <span class="number">255</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">	out = out.astype(np.uint8)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">return</span> out</span></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> <span class="built_in">height</span> = <span class="number">128</span>, <span class="built_in">width</span> = <span class="number">128</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fourier_str</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">std</span>::<span class="built_in">complex</span>&lt;<span class="keyword">double</span>&gt; coef[<span class="built_in">height</span>][<span class="built_in">width</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// RGB to Gray scale</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="function">cv::Mat <span class="title">BGR2GRAY</span><span class="params">(cv::Mat img)</span></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// prepare output</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">  cv::Mat out = cv::Mat::zeros(<span class="built_in">height</span>, <span class="built_in">width</span>, CV_8UC1);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// BGR -&gt; Gray</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; <span class="built_in">height</span>; y++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; <span class="built_in">width</span>; x++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">      out.at&lt;uchar&gt;(y, x) = (<span class="keyword">int</span>)((<span class="keyword">float</span>)img.at&lt;cv::Vec3b&gt;(y, x)[<span class="number">0</span>] * <span class="number">0.0722</span> + \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">				  (<span class="keyword">float</span>)img.at&lt;cv::Vec3b&gt;(y, x)[<span class="number">1</span>] * <span class="number">0.7152</span> + \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">				  (<span class="keyword">float</span>)img.at&lt;cv::Vec3b&gt;(y, x)[<span class="number">2</span>] * <span class="number">0.2126</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> out;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// Discrete Fourier transformation</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line"><span class="function">fourier_str <span class="title">dft</span><span class="params">(cv::Mat img, fourier_str fourier_s)</span></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> I;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> theta;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">std</span>::<span class="built_in">complex</span>&lt;<span class="keyword">double</span>&gt; val;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> l = <span class="number">0</span>; l &lt; <span class="built_in">height</span>; l ++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> k = <span class="number">0</span>; k &lt; <span class="built_in">width</span>; k ++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">      val.real(<span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">      val.imag(<span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; <span class="built_in">height</span>; y++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; <span class="built_in">width</span>; x++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">          I = (<span class="keyword">double</span>)img.at&lt;uchar&gt;(y, x);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">          theta = <span class="number">-2</span> * M_PI * ((<span class="keyword">double</span>)k * (<span class="keyword">double</span>)x / (<span class="keyword">double</span>)<span class="built_in">width</span> + (<span class="keyword">double</span>)l * (<span class="keyword">double</span>)y / (<span class="keyword">double</span>)<span class="built_in">height</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">          val += <span class="built_in">std</span>::<span class="built_in">complex</span>&lt;<span class="keyword">double</span>&gt;(<span class="built_in">cos</span>(theta), <span class="built_in">sin</span>(theta)) * I;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">      val /= <span class="built_in">sqrt</span>(<span class="built_in">height</span> * <span class="built_in">width</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">      fourier_s.coef[l][k] = val;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> fourier_s;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// Inverse Discrete Fourier transformation</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line"><span class="function">cv::Mat <span class="title">idft</span><span class="params">(cv::Mat out, fourier_str fourier_s)</span></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> theta;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> g;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">std</span>::<span class="built_in">complex</span>&lt;<span class="keyword">double</span>&gt; G;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">54</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">std</span>::<span class="built_in">complex</span>&lt;<span class="keyword">double</span>&gt; val;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">55</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">56</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span> ( <span class="keyword">int</span> y = <span class="number">0</span>; y &lt; <span class="built_in">height</span>; y ++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">57</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> ( <span class="keyword">int</span> x = <span class="number">0</span>; x &lt; <span class="built_in">width</span>; x ++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">58</span></pre></td><td class="code"><pre><span class="line">      val.real(<span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">59</span></pre></td><td class="code"><pre><span class="line">      val.imag(<span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">60</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">for</span> ( <span class="keyword">int</span> l = <span class="number">0</span>; l &lt; <span class="built_in">height</span>; l ++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">61</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">for</span> ( <span class="keyword">int</span> k = <span class="number">0</span>; k &lt; <span class="built_in">width</span>; k ++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">62</span></pre></td><td class="code"><pre><span class="line">          G = fourier_s.coef[l][k];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">63</span></pre></td><td class="code"><pre><span class="line">          theta = <span class="number">2</span> * M_PI * ((<span class="keyword">double</span>)k * (<span class="keyword">double</span>)x / (<span class="keyword">double</span>)<span class="built_in">width</span> + (<span class="keyword">double</span>)l * (<span class="keyword">double</span>)y / (<span class="keyword">double</span>)<span class="built_in">height</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">64</span></pre></td><td class="code"><pre><span class="line">          val += <span class="built_in">std</span>::<span class="built_in">complex</span>&lt;<span class="keyword">double</span>&gt;(<span class="built_in">cos</span>(theta), <span class="built_in">sin</span>(theta)) * G;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">65</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">66</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">67</span></pre></td><td class="code"><pre><span class="line">      g = <span class="built_in">std</span>::<span class="built_in">abs</span>(val) / <span class="built_in">sqrt</span>(<span class="built_in">height</span> * <span class="built_in">width</span>);      </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">68</span></pre></td><td class="code"><pre><span class="line">      out.at&lt;uchar&gt;(y, x) = (uchar)g;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">69</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">70</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">71</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">72</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> out;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">73</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<h4 id="ç¬¬äºŒéƒ¨åˆ†-äºŒç»´å‚…é‡Œå¶å˜æ¢çš„ä¸€äº›æ€§è´¨"><a href="#ç¬¬äºŒéƒ¨åˆ†-äºŒç»´å‚…é‡Œå¶å˜æ¢çš„ä¸€äº›æ€§è´¨" class="headerlink" title="ç¬¬äºŒéƒ¨åˆ† äºŒç»´å‚…é‡Œå¶å˜æ¢çš„ä¸€äº›æ€§è´¨"></a>ç¬¬äºŒéƒ¨åˆ† äºŒç»´å‚…é‡Œå¶å˜æ¢çš„ä¸€äº›æ€§è´¨</h4><h5 id="1ã€å¹³ç§»"><a href="#1ã€å¹³ç§»" class="headerlink" title="1ã€å¹³ç§»"></a>1ã€å¹³ç§»</h5><script type="math/tex; mode=display">
f(x,y)e^{j2\pi(u_0x/M+v_0y/N)}\Leftrightarrow F(u-u_0,v-v_0),f(x-x_0,y-y_0)\Leftrightarrow F(u,v)e^{-j2\pi(x_0u/M+y_0v/N)}</script><p>ä¸Šå¼æŒ‡å‡ºï¼Œç”¨æŒ‡æ•°é¡¹ä¹˜ä»¥f(x,y)å°†ä½¿DFTçš„åŸç‚¹ç§»åˆ°ç‚¹(u<sub>0</sub>,v<sub>0</sub>)ï¼›åä¹‹ï¼Œç”¨è´ŸæŒ‡æ•°ä¹˜ä»¥F(u,v)å°†ä½¿f(x,y)çš„åŸç‚¹ç§»åˆ°ç‚¹(x<sub>0</sub>,y<sub>0</sub>)ã€‚è¦è¯æ˜ä¸Šå¼æˆç«‹ï¼Œé¦–å…ˆéœ€è¦çœ‹æ¸…æ¥šæŒ‡æ•°é¡¹æ‰€ä¹˜çš„å¯¹è±¡ï¼Œä¸å¯¹åº”çš„è½¬æ¢ã€‚</p>
<script type="math/tex; mode=display">
\because F(u,v)=\sum^{M-1}_{x=0}\sum^{N-1}_{y=0}f(x,y)e^{-j2\pi(ux/M+vy/N)}</script><script type="math/tex; mode=display">
\therefore \sum^{M-1}_{x=0}\sum^{N-1}_{y=0}f(x,y)e^{-j2\pi(\frac{ux}{M}+\frac{vy}{N})}\times e^{j2\pi(\frac{u_0x}{M}+\frac{v_0y}{N})}=\sum^{M-1}_{x=0}\sum^{N-1}_{y=0}f(x,y)e^{-j2\pi[\frac{(u-u_0)x}{M}+\frac{(v-v_0)y}{N}]}=F(u-u_0,v-v_0)</script><script type="math/tex; mode=display">
åŒç†ï¼Œ\because f(x,y)=\frac{1}{M}\sum^{M-1}_{u=0}\sum^{N-1}_{v=0}F(u,v)e^{j2\pi(ux/M+vy/N}</script><script type="math/tex; mode=display">
\therefore \frac{1}{M}\sum^{M-1}_{u=0}\sum^{N-1}_{v=0}F(u,v)e^{j2\pi(ux/M+vy/N}\times e^{-j2\pi(x_0u/M+y_0v/N)}=\frac{1}{M}\sum^{M-1}_{u=0}\sum^{N-1}_{v=0}F(u,v)e^{j2\pi[(x-x_0)u/M+(v-v_0)y/N)]}=f(x-x_0,y-y_0)</script><p> é™¤äº†ä¸Šé¢çš„æ¨å¯¼å¤–ï¼Œä»ç½‘ä¸Šçœ‹åˆ°äº†å¦ä¸€ç§æ¨å¯¼æ–¹å¼ï¼Œå¾ˆæ¼‚äº®ğŸ‘ã€‚<a href="http://www.kevinnan.org.cn/index.php/archives/637/" target="_blank" rel="noopener">é“¾æ¥</a></p>
<p>ç®€å•åšä¸€ä¸‹è®°å½•ï¼Œä¾¿äºä»¥åå›é¡¾ï¼š</p>
<script type="math/tex; mode=display">
f(x-x_0,y-y_0)\Leftrightarrow F(u',v') \\
F(u',v')=\int^{\infty}_{-\infty}\int^{\infty}_{-\infty}f(x-x_0,y-y_0)e^{-j2\pi(ux+vy)}dxdy \\
ä»¤x-x_0=x',y-y_0=y',åˆ™x=x'+x_0,y=y'+y_0;dx=dx',dy=dy' \\
æ‰€ä»¥ï¼ŒF(u',v')=\int^{\infty}_{-\infty}\int^{\infty}_{-\infty}f(x',y')e^{-j2\pi [u(x'+x_0)+v(y'+y_0)]}dx'dy'=e^{-j2\pi (ux_0+vy_0)}\cdot\int^{\infty}_{-\infty}\int^{\infty}_{-\infty}f(x',y')e^{-j2\pi (ux'+vy')}dx'dy' \\
å› æ­¤ï¼ŒF(u',v')=F(u,v)\cdot e^{-j2\pi(ux_0+vy_0)}ï¼ŒåŒç†ä¹Ÿå¯ä»¥å°†F(u-u_0,v-v_0)ä»£å…¥æ±‚F(u-u_0,v-v_0)\Leftrightarrow f(x',y')*2ã€æ—‹è½¬</script><h5 id="2ã€æ—‹è½¬"><a href="#2ã€æ—‹è½¬" class="headerlink" title="2ã€æ—‹è½¬"></a>2ã€æ—‹è½¬</h5><p>è‹¥f(x,y)æ—‹è½¬&theta;è§’ï¼Œåˆ™F(u,v)ä¹Ÿå¾€ç›¸åŒçš„æ–¹å‘æ—‹è½¬ç›¸åŒçš„è§’åº¦ã€‚</p>
<p>å‡è®¾ç›´è§’åæ ‡ç³»ä¸­ç‚¹P(x,y)ï¼Œç»•å¹³é¢ä¸­å¿ƒæ—‹è½¬&theta;å¾—Q(xâ€™,yâ€™)ï¼Œç”¨æ—‹è½¬çŸ©é˜µè¡¨ç¤ºä¸¤è€…å¾—å…³ç³»ï¼šï¼ˆåˆ©ç”¨æåæ ‡çš„è¡¨ç¤ºæ–¹æ³•æ¨å¯¼ä¸‹å¼ï¼‰</p>
<script type="math/tex; mode=display">
x=r\cos\phi\quad y=r\sin\phi;x'=rcos(\theta+\phi),y=rsin(\theta+\phi)\\
åˆ©ç”¨ä¸‰è§’å‡½æ•°å±•å¼€ï¼Œx'=r\cos\theta\cos\phi-r\sin\theta\sin\phi,y'=r\sin\theta\cos\phi+r\cos\theta\sin\phi\\
å°†x,yä»£å…¥ï¼Œå³å¯å¾—ï¼Œx'=x\cos\theta-y\sin\theta,y'=x\sin\theta+y\cos\theta</script><script type="math/tex; mode=display">
\left[
\begin{matrix}
x\\
y \\
\end{matrix}
\right]
=
\left[
\begin{matrix}
cos\theta & -sin\theta\\
sin\theta & cos\theta \\
\end{matrix}
\right]
\left[
\begin{matrix}
x'\\
y'\\
\end{matrix}
\right]
åå‘æ±‚x',y';
\left[
\begin{matrix}
x'\\
y'\\
\end{matrix}
\right]
=
\left[
\begin{matrix}
cos\theta & sin\theta\\
-sin\theta & cos\theta \\
\end{matrix}
\right]
\left[
\begin{matrix}
x\\
y\\
\end{matrix}
\right]</script><p>ä¸Šå¼æ˜¯åˆ©ç”¨äº†æ—‹è½¬çŸ©é˜µçš„é€†ç­‰äºæ—‹è½¬çŸ©é˜µçš„è½¬ç½®è¿™ä¸ªæ€§è´¨ï¼Œå³ï¼š</p>
<script type="math/tex; mode=display">
å‡è®¾æ—‹è½¬çŸ©é˜µä¸ºï¼šR=[x^T\quad y^T\quad z^T],å…¶è½¬ç½®çŸ©é˜µä¸ºR^T=\left[
\begin{matrix}
x^T\\
y^T\\
z^T
\end{matrix}
\right]\\
åˆ™ï¼ŒR^TR=\left[
\begin{matrix}
xx^T & xy^T & xz^T\\
yx^T & yy^T & yz^T\\
zx^T & zy^T & zz^T
\end{matrix}
\right],ç”±äºä¸‰è§’å‡½æ•°çš„æ­£äº¤ç‰¹æ€§ï¼Œåªæœ‰xx^T=yy^T=zz^T=1,å…¶ä½™ä¸º0\\
æ•…R^TR=I=R^{-1}R,å³R^R=R^{-1}</script><p>æ—‹è½¬åç‚¹f(xâ€™,yâ€™)çš„å‚…é‡Œå¶å˜æ¢ä¸ºï¼š</p>
<script type="math/tex; mode=display">
F(u',v')=\int^{\infty}_{-\infty}\int^{\infty}_{-\infty}f(x',y')e^{-j2\pi(ux+vy)}dxdy \\
F(u',v')=\int^{\infty}_{-\infty}\int^{\infty}_{-\infty}e^{-j2\pi[u(cos\theta x'-sin\theta y')+v(sin\theta x'+cos\theta y')]}dx'dy'\\
F(u',v')=\int^{\infty}_{-\infty}\int^{\infty}_{-\infty}e^{-j2\pi[x'(ucos\theta+vsin\theta )+y'(vcos\theta-usin\theta)]}dx'dy'\\
F(u',v')=F(ucos\theta+vsin\theta,-usin\theta+vsin\theta)ï¼Œç”±æ­¤å¯å¾—ï¼š\\
\left[
\begin{matrix}
u'\\
v'\\
\end{matrix}
\right]
=
\left[
\begin{matrix}
cos\theta & sin\theta\\
-sin\theta & cos\theta \\
\end{matrix}
\right]
\left[
\begin{matrix}
u\\
v\\
\end{matrix}
\right]</script><p>æ‰€ä»¥ï¼Œuï¼Œvæ—‹è½¬çš„è§’åº¦å’Œxï¼Œyæ—‹è½¬çš„è§’åº¦ç›¸åŒã€‚ä¸Šé¢çš„dxï¼Œdyä¸dxâ€™ï¼Œdyâ€™çš„è½¬æ¢ä½¿ç”¨çš„æ˜¯äºŒé‡ç§¯åˆ†çš„å˜æ¢å…³ç³»å¼ã€‚<a href="https://zhuanlan.zhihu.com/p/50355468" target="_blank" rel="noopener">å‚è€ƒ</a></p>
<h5 id="3ã€å‘¨æœŸæ€§"><a href="#3ã€å‘¨æœŸæ€§" class="headerlink" title="3ã€å‘¨æœŸæ€§"></a>3ã€å‘¨æœŸæ€§</h5><p>å¦‚ä¸€ç»´æƒ…å†µä¸€æ ·ï¼ŒäºŒç»´å‚…é‡Œå¶å˜æ¢åŠå…¶åå˜æ¢åœ¨uæ–¹å‘å’Œvæ–¹å‘æ˜¯æ— çº¿å‘¨æœŸçš„ï¼Œå³</p>
<script type="math/tex; mode=display">
F(u,v)=F(u+k_1M,v)=F(u,v+k_2N)=F(u+k1M,v+k_2N)\\
f(x,y)=f(x+k_1M,y)=f(x,y+k_2N)=f(x+k_1M,y+k_2N)</script><p>ä¸Šå¼ä¸­k<sub>1</sub>,k<sub>2</sub>ä¸ºæ•´æ•°ã€‚</p>
<p>ç”±äºåœ¨å•ç»´ç¦»æ•£å‚…é‡Œå¶å˜æ¢è¡¨ç¤ºä¸ºï¼š</p>
<script type="math/tex; mode=display">
F_m=\sum^{M-1}_{n=0}f_ne^{-j2\pi mn/M},m=0,1,2,\cdots,M-1\\
å½“m=\frac{M}{2}æ—¶ï¼ŒF_m=\sum^{M-1}_{n=0}f_ne^{-j\pi n}=\sum^{M-1}_{n=0}f_n[\cos(\pi n)-\sin(\pi n)]=\sum^{M-1}_{n=0}f_n\cos(\pi n)</script><p>ä¸Šå¼è¯´æ˜ï¼Œåœ¨M/2å¤„ï¼Œåªæœ‰åŠä¸ªå‘¨æœŸã€‚è€Œé‡‡æ ·åŒºé—´æ˜¯åœ¨[0, M-1]ã€‚å¯è§ï¼Œè¯¥åŒºé—´å†…æ˜¯ä¸¤ä¸ªå‘¨æœŸçš„å„ä¸€åŠï¼Œå³èƒŒé èƒŒçš„åŠä¸ªå‘¨æœŸç»„æˆã€‚ä¸ºäº†æ˜¾ç¤ºå’Œæ»¤æ³¢ï¼Œ<strong>åœ¨è¯¥åŒºé—´ä¸­æœ‰ä¸€ä¸ªå˜æ¢çš„å®Œæ•´å‘¨æœŸä¼šæ›´åŠ æ–¹ä¾¿</strong>ã€‚æ‰€ä»¥éœ€è¦å¹³ç§»M/2ä¸ªåŠå‘¨æœŸã€‚æ ¹æ®å¹³ç§»çš„æ€§è´¨ï¼š</p>
<script type="math/tex; mode=display">
f(x)e^{j2\pi(u_0x/M)}\Leftrightarrow F(u-u_0),ä»¤u_0=M/2,åˆ™æŒ‡æ•°å˜ä¸ºe^{j\pi x}ï¼Œç”±äºxä¸ºæ•´æ•°\\
e^{j\pi x}=\cos(\pi x)=(-1)^x,æ‰€ä»¥ï¼Œä¸Šå¼ï¼Œf(x)(-1)^x=F(u-u_0)</script><p>ä¸Šå¼ç”¨(-1)<sup>x</sup>ä¹˜ä»¥f(x)å°†ä½äºåŸç‚¹çš„æ•°æ®F(0)ç§»åŠ¨åˆ°åŒºé—´[0, M-1]çš„ä¸­å¿ƒä½ç½®ã€‚è¿™é‡Œåšçš„æ˜¯<strong>é¢‘è°±çš„ä¸­å¿ƒåŒ–</strong>ï¼Œå¯ä»¥æ‰©å±•åˆ°äºŒç»´ç¦»æ•£ç©ºé—´ã€‚</p>
<script type="math/tex; mode=display">
f(x,y)(-1)^x\Leftrightarrow F(u-M/2,v-N/2)</script><h4 id="è¡¥å……éƒ¨åˆ†"><a href="#è¡¥å……éƒ¨åˆ†" class="headerlink" title="è¡¥å……éƒ¨åˆ†"></a>è¡¥å……éƒ¨åˆ†</h4><p>å‘¨æœŸå†²å‡»ä¸²çš„å‚…é‡Œå¶å˜æ¢</p>
<p>é¦–å…ˆï¼Œä»‹ç»ä¸€ä¸‹å†²å‡»ä¸²s<sub>&Delta;T</sub>(t)ï¼šæ— é™å¤šä¸ªåˆ†ç¦»çš„å‘¨æœŸå†²æ¿€å•å…ƒ&Delta;Tä¹‹å’Œ</p>
<script type="math/tex; mode=display">
s_{\Delta T}(t)=\sum^{\infty}_{n=-\infty}\delta(t-n\Delta T)</script><p>å› ä¸ºå†²å‡»ä¸²æ˜¯ä¸€ä¸ªå‘¨æœŸå‡½æ•°ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨å‚…é‡Œå¶çº§æ•°è¡¨ç¤ºï¼š</p>
<script type="math/tex; mode=display">
s_{\Delta T}(t)=\sum^{\infty}_{n=-\infty}c_ne^{j\frac{2\pi n}{\Delta T}t}</script><p> å…¶ä¸­ï¼Œ</p>
<script type="math/tex; mode=display">
c_n=\frac{1}{\Delta T}\int^{\Delta T/2}_{-\Delta T/2}s_{\Delta T}e^{-j\frac{2\pi n}{\Delta T}t}dt</script><p>ç”±äºåœ¨åŒºé—´[-&Delta;T/2ï¼Œ&Delta;T/2]çš„ç§¯åˆ†ä»…åŒ…å«ä½äºåŸç‚¹çš„å†²æ¿€ï¼Œæ‰€ä»¥ï¼Œ</p>
<script type="math/tex; mode=display">
c_n=\frac{1}{\Delta T}\int^{\Delta T/2}_{-\Delta T/2}\delta (t)e^{-j\frac{2\pi n}{\Delta T}t}dt=\frac{1}{\Delta T}</script><p>åˆ™ï¼Œ</p>
<script type="math/tex; mode=display">
s_{\Delta T}(t)=\frac{1}{\Delta T}\sum^{\infty}_{n=-\infty}e^{j\frac{2\pi n}{\Delta T}t}</script><p>åˆ™å‘¨æœŸå†²æ¿€ä¸²çš„å‚…é‡Œå¶å˜æ¢S(&mu;)ä¸ºï¼š</p>
<script type="math/tex; mode=display">
S(\mu)=\mathscr{F}\{s_{\Delta T(t)}\}=\mathscr{F}\{\frac{1}{\Delta T}\sum^{\infty}_{n=-\infty}e^{j\frac{2\pi n}{\Delta T}t}\}=\frac{1}{\Delta T}\mathscr{F}\{\sum^{\infty}_{n=-\infty}e^{j\frac{2\pi n}{\Delta T}t}\}</script><p> ä»ä¸Šå¼çš„æœ€åä¸€é¡¹çœ‹æ˜¯å¯¹æŒ‡æ•°å‡½æ•°æ±‚å’Œçš„å‚…é‡Œå¶å˜æ¢ï¼Œç”±äºæ±‚å’Œæ˜¯çº¿æ€§å˜æ¢ï¼Œä¸å‚…é‡Œå¶å˜æ¢ä¹‹åæ±‚å’Œçš„ç»“æœä¸€è‡´ï¼Œæ‰€ä»¥éœ€è¦æ±‚æŒ‡æ•°å‡½æ•°çš„å‚…é‡Œå¶å˜æ¢ï¼Œå³ï¼š</p>
<script type="math/tex; mode=display">
è¦æ±‚ï¼Œ\mathscr{F}\{e^{j\frac{2\pi n}{\Delta T}t}\}ï¼Œæ ¹æ®å®šä¹‰\mathscr{F}\{f(t)\}=\int^{\infty}_{-\infty}f(t)e^{-j2\pi\mu t}dt \\
åˆ™ï¼Œ\mathscr{F}\{e^{j\frac{2\pi n}{\Delta T}t}\}=\int^{\infty}_{-\infty}e^{j\frac{2\pi n}{\Delta T}t}\cdot e^{-j2\pi\mu t}dt=\int^{\infty}_{-\infty}1\cdot e^{-j2\pi(\mu-\frac{n}{\Delta T})t}dt \\
æ‰€ä»¥ï¼Œ\mathscr{F}\{e^{j\frac{2\pi n}{\Delta T}t}\}=F(\mu-\frac{n}{\Delta T})=\delta(\mu-\frac{n}{\Delta T}),è¿™é‡Œç›¸å½“äºæ¨¡æ‹Ÿ\muçš„ä¸€ä¸ªå‡½æ•°</script><h4 id="ä¸‰ã€ä½é€šæ»¤æ³¢å™¨"><a href="#ä¸‰ã€ä½é€šæ»¤æ³¢å™¨" class="headerlink" title="ä¸‰ã€ä½é€šæ»¤æ³¢å™¨"></a>ä¸‰ã€ä½é€šæ»¤æ³¢å™¨</h4><p>ä½é€šæ»¤æ³¢å™¨åœ¨é¢‘ç‡ä¸­å°†é«˜é¢‘ä¿¡å·æ»¤é™¤ï¼Œä¿ç•™æ›´å¤šçš„ä½é¢‘ä¿¡å·ã€‚å…¶ä¸­ï¼Œåœ¨å‚…é‡Œå¶å˜æ¢ä¸”ä¸­å¿ƒåŒ–é¢‘ç‡åï¼Œä¸­å¿ƒæ˜¯å¹³å‡ç°åº¦å€¼ï¼Œè¶Šé è¿‘ä¸­å¿ƒï¼Œä½é¢‘ä¿¡å·è¶Šå¤šï¼›è¶Šè¿œç¦»ï¼Œåˆ™ä¸ºé«˜é¢‘ä¿¡å·ï¼Œä¾‹å¦‚ï¼šè¾¹ç•Œæˆ–å™ªå£°ã€‚</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cv2</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># DFT hyper-parameters</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">K, L = <span class="number">128</span>, <span class="number">128</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">channel = <span class="number">3</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># bgr -&gt; gray</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bgr2gray</span><span class="params">(img)</span>:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">	gray = <span class="number">0.2126</span> * img[..., <span class="number">2</span>] + <span class="number">0.7152</span> * img[..., <span class="number">1</span>] + <span class="number">0.0722</span> * img[..., <span class="number">0</span>]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">return</span> gray</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># DFT</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dft</span><span class="params">(img)</span>:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># Prepare DFT coefficient, complex() å‡½æ•°ç”¨äºåˆ›å»ºä¸€ä¸ªå€¼ä¸º real + imag * j çš„å¤æ•° </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">	G = np.zeros((L, K, channel), dtype=np.complex)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># prepare processed index corresponding to original image positions</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">	x = np.tile(np.arange(W), (H, <span class="number">1</span>))</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">	y = np.arange(H).repeat(W).reshape(H, <span class="number">-1</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># dft</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">for</span> c <span class="keyword">in</span> range(channel):</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">		<span class="keyword">for</span> l <span class="keyword">in</span> range(L):</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">			<span class="keyword">for</span> k <span class="keyword">in</span> range(K):</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">				G[l, k, c] = np.sum(img[..., c] * np.exp(<span class="number">-2j</span> * np.pi * (x * k / K + y * l / L))) / np.sqrt(K * L)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">				<span class="comment">#for n in range(N):</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">				<span class="comment">#    for m in range(M):</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">				<span class="comment">#        v += gray[n, m] * np.exp(-2j * np.pi * (m * k / M + n * l / N))</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">				<span class="comment">#G[l, k] = v / np.sqrt(M * N)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">return</span> G</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># IDFT</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">idft</span><span class="params">(G)</span>:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># prepare out image</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">	H, W, _ = G.shape</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">	out = np.zeros((H, W, channel), dtype=np.float32)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># prepare processed index corresponding to original image positions</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">	x = np.tile(np.arange(W), (H, <span class="number">1</span>))</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">	y = np.arange(H).repeat(W).reshape(H, <span class="number">-1</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># idft</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">for</span> c <span class="keyword">in</span> range(channel):</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line">		<span class="keyword">for</span> l <span class="keyword">in</span> range(H):</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">			<span class="keyword">for</span> k <span class="keyword">in</span> range(W):</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line">				out[l, k, c] = np.abs(np.sum(G[..., c] * np.exp(<span class="number">2j</span> * np.pi * (x * k / W + y * l / H)))) / np.sqrt(W * H)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># clipping</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">54</span></pre></td><td class="code"><pre><span class="line">	out = np.clip(out, <span class="number">0</span>, <span class="number">255</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">55</span></pre></td><td class="code"><pre><span class="line">	out = out.astype(np.uint8)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">56</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">57</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">return</span> out</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">58</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">59</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">60</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># LPF</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">61</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">lpf</span><span class="params">(G, ratio=<span class="number">0.5</span>)</span>:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">62</span></pre></td><td class="code"><pre><span class="line">	H, W, _ = G.shape	</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">63</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">64</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># transfer positions</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">65</span></pre></td><td class="code"><pre><span class="line">	_G = np.zeros_like(G)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">66</span></pre></td><td class="code"><pre><span class="line">	_G[:H//<span class="number">2</span>, :W//<span class="number">2</span>] = G[H//<span class="number">2</span>:, W//<span class="number">2</span>:]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">67</span></pre></td><td class="code"><pre><span class="line">	_G[:H//<span class="number">2</span>, W//<span class="number">2</span>:] = G[H//<span class="number">2</span>:, :W//<span class="number">2</span>]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">68</span></pre></td><td class="code"><pre><span class="line">	_G[H//<span class="number">2</span>:, :W//<span class="number">2</span>] = G[:H//<span class="number">2</span>, W//<span class="number">2</span>:]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">69</span></pre></td><td class="code"><pre><span class="line">	_G[H//<span class="number">2</span>:, W//<span class="number">2</span>:] = G[:H//<span class="number">2</span>, :W//<span class="number">2</span>]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">70</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">71</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># get distance from center (H / 2, W / 2)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">72</span></pre></td><td class="code"><pre><span class="line">	x = np.tile(np.arange(W), (H, <span class="number">1</span>))</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">73</span></pre></td><td class="code"><pre><span class="line">	y = np.arange(H).repeat(W).reshape(H, <span class="number">-1</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">74</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">75</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># make filter</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">76</span></pre></td><td class="code"><pre><span class="line">	_x = x - W // <span class="number">2</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">77</span></pre></td><td class="code"><pre><span class="line">	_y = y - H // <span class="number">2</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">78</span></pre></td><td class="code"><pre><span class="line">	r = np.sqrt(_x ** <span class="number">2</span> + _y ** <span class="number">2</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">79</span></pre></td><td class="code"><pre><span class="line">	mask = np.ones((H, W), dtype=np.float32)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">80</span></pre></td><td class="code"><pre><span class="line">	mask[r &gt; (W // <span class="number">2</span> * ratio)] = <span class="number">0</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">81</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">82</span></pre></td><td class="code"><pre><span class="line">	mask = np.repeat(mask, channel).reshape(H, W, channel)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">83</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">84</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># filtering</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">85</span></pre></td><td class="code"><pre><span class="line">	_G *= mask</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">86</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">87</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># reverse original positions</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">88</span></pre></td><td class="code"><pre><span class="line">	G[:H//<span class="number">2</span>, :W//<span class="number">2</span>] = _G[H//<span class="number">2</span>:, W//<span class="number">2</span>:]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">89</span></pre></td><td class="code"><pre><span class="line">	G[:H//<span class="number">2</span>, W//<span class="number">2</span>:] = _G[H//<span class="number">2</span>:, :W//<span class="number">2</span>]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">90</span></pre></td><td class="code"><pre><span class="line">	G[H//<span class="number">2</span>:, :W//<span class="number">2</span>] = _G[:H//<span class="number">2</span>, W//<span class="number">2</span>:]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">91</span></pre></td><td class="code"><pre><span class="line">	G[H//<span class="number">2</span>:, W//<span class="number">2</span>:] = _G[:H//<span class="number">2</span>, :W//<span class="number">2</span>]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">92</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">93</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">return</span> G</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">94</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">95</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">96</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># Read image</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">97</span></pre></td><td class="code"><pre><span class="line">img = cv2.imread(<span class="string">"imori.jpg"</span>).astype(np.float32)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">98</span></pre></td><td class="code"><pre><span class="line">H, W, C = img.shape</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">99</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">100</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># Gray scale</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">101</span></pre></td><td class="code"><pre><span class="line">gray = bgr2gray(img)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">102</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">103</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># DFT</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">104</span></pre></td><td class="code"><pre><span class="line">G = dft(img)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">105</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">106</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># LPF</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">107</span></pre></td><td class="code"><pre><span class="line">G = lpf(G)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">108</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">109</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># IDFT</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">110</span></pre></td><td class="code"><pre><span class="line">out = idft(G)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">111</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">112</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># Save result</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">113</span></pre></td><td class="code"><pre><span class="line">cv2.imshow(<span class="string">"result"</span>, out)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">114</span></pre></td><td class="code"><pre><span class="line">cv2.waitKey(<span class="number">0</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">115</span></pre></td><td class="code"><pre><span class="line">cv2.imwrite(<span class="string">"out.jpg"</span>, out)</span></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> <span class="built_in">height</span> = <span class="number">128</span>, <span class="built_in">width</span> = <span class="number">128</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fourier_str</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">std</span>::<span class="built_in">complex</span>&lt;<span class="keyword">double</span>&gt; coef[<span class="built_in">height</span>][<span class="built_in">width</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// RGB to Gray scale</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="function">cv::Mat <span class="title">BGR2GRAY</span><span class="params">(cv::Mat img)</span></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// prepare output</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">  cv::Mat out = cv::Mat::zeros(<span class="built_in">height</span>, <span class="built_in">width</span>, CV_8UC1);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// BGR -&gt; Gray</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; <span class="built_in">height</span>; y++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; <span class="built_in">width</span>; x++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">      out.at&lt;uchar&gt;(y, x) = (<span class="keyword">int</span>)((<span class="keyword">float</span>)img.at&lt;cv::Vec3b&gt;(y, x)[<span class="number">0</span>] * <span class="number">0.0722</span> + \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">				  (<span class="keyword">float</span>)img.at&lt;cv::Vec3b&gt;(y, x)[<span class="number">1</span>] * <span class="number">0.7152</span> + \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">				  (<span class="keyword">float</span>)img.at&lt;cv::Vec3b&gt;(y, x)[<span class="number">2</span>] * <span class="number">0.2126</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> out;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// Discrete Fourier transformation</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line"><span class="function">fourier_str <span class="title">dft</span><span class="params">(cv::Mat img, fourier_str fourier_s)</span></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> I;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> theta;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">std</span>::<span class="built_in">complex</span>&lt;<span class="keyword">double</span>&gt; val;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span> ( <span class="keyword">int</span> l = <span class="number">0</span>; l &lt; <span class="built_in">height</span>; l ++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> ( <span class="keyword">int</span> k = <span class="number">0</span>; k &lt; <span class="built_in">width</span>; k ++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">      val.real(<span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">      val.imag(<span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">for</span> ( <span class="keyword">int</span> y = <span class="number">0</span>; y &lt; <span class="built_in">height</span>; y ++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">for</span> ( <span class="keyword">int</span> x = <span class="number">0</span>; x &lt; <span class="built_in">width</span>; x ++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">          I = (<span class="keyword">double</span>)img.at&lt;uchar&gt;(y, x);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">          <span class="comment">//æ±‚æ¬§æ‹‰å…¬å¼ä¸­çš„thetaè§’jxtheta=cos(theta)+jsin(theta)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">          theta = <span class="number">-2</span> * M_PI * ((<span class="keyword">double</span>)k * (<span class="keyword">double</span>)x / (<span class="keyword">double</span>)<span class="built_in">width</span> + (<span class="keyword">double</span>)l * (<span class="keyword">double</span>)y / (<span class="keyword">double</span>)<span class="built_in">height</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">          val += <span class="built_in">std</span>::<span class="built_in">complex</span>&lt;<span class="keyword">double</span>&gt;(<span class="built_in">cos</span>(theta), <span class="built_in">sin</span>(theta)) * I;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">      val /= <span class="built_in">sqrt</span>(<span class="built_in">height</span> * <span class="built_in">width</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">      fourier_s.coef[l][k] = val;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> fourier_s;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// Inverse Discrete Fourier transformation</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line"><span class="function">cv::Mat <span class="title">idft</span><span class="params">(cv::Mat out, fourier_str fourier_s)</span></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> theta;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">54</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> g;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">55</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">std</span>::<span class="built_in">complex</span>&lt;<span class="keyword">double</span>&gt; G;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">56</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">std</span>::<span class="built_in">complex</span>&lt;<span class="keyword">double</span>&gt; val;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">57</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">58</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span> ( <span class="keyword">int</span> y = <span class="number">0</span>; y &lt; <span class="built_in">height</span>; y ++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">59</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> ( <span class="keyword">int</span> x = <span class="number">0</span>; x &lt; <span class="built_in">width</span>; x ++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">60</span></pre></td><td class="code"><pre><span class="line">      val.real(<span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">61</span></pre></td><td class="code"><pre><span class="line">      val.imag(<span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">62</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">for</span> ( <span class="keyword">int</span> l = <span class="number">0</span>; l &lt; <span class="built_in">height</span>; l ++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">63</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">for</span> ( <span class="keyword">int</span> k = <span class="number">0</span>; k &lt; <span class="built_in">width</span>; k ++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">64</span></pre></td><td class="code"><pre><span class="line">          G = fourier_s.coef[l][k];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">65</span></pre></td><td class="code"><pre><span class="line">          theta = <span class="number">2</span> * M_PI * ((<span class="keyword">double</span>)k * (<span class="keyword">double</span>)x / (<span class="keyword">double</span>)<span class="built_in">width</span> + (<span class="keyword">double</span>)l * (<span class="keyword">double</span>)y / (<span class="keyword">double</span>)<span class="built_in">height</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">66</span></pre></td><td class="code"><pre><span class="line">          val += <span class="built_in">std</span>::<span class="built_in">complex</span>&lt;<span class="keyword">double</span>&gt;(<span class="built_in">cos</span>(theta), <span class="built_in">sin</span>(theta)) * G;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">67</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">68</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">69</span></pre></td><td class="code"><pre><span class="line">      g = <span class="built_in">std</span>::<span class="built_in">abs</span>(val) / <span class="built_in">sqrt</span>(<span class="built_in">height</span> * <span class="built_in">width</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">70</span></pre></td><td class="code"><pre><span class="line">      g = fmin(fmax(g, <span class="number">0</span>), <span class="number">255</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">71</span></pre></td><td class="code"><pre><span class="line">      out.at&lt;uchar&gt;(y, x) = (uchar)g;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">72</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">73</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">74</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">75</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> out;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">76</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">77</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">78</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">79</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// Low pass Filter</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">80</span></pre></td><td class="code"><pre><span class="line"><span class="function">fourier_str <span class="title">lpf</span><span class="params">(fourier_str fourier_s, <span class="keyword">double</span> pass_r)</span></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">81</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// filtering</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">82</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> r = <span class="built_in">height</span> / <span class="number">2</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">83</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> filter_d = (<span class="keyword">int</span>)((<span class="keyword">double</span>)r * pass_r);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">84</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span> ( <span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="built_in">height</span> / <span class="number">2</span>; j++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">85</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> ( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">width</span> / <span class="number">2</span>; i++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">86</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> (<span class="built_in">sqrt</span>(i * i + j * j) &gt;= filter_d)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">87</span></pre></td><td class="code"><pre><span class="line">        fourier_s.coef[j][i] = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">88</span></pre></td><td class="code"><pre><span class="line">        fourier_s.coef[j][<span class="built_in">width</span> - i] = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">89</span></pre></td><td class="code"><pre><span class="line">        fourier_s.coef[<span class="built_in">height</span> - i][i] = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">90</span></pre></td><td class="code"><pre><span class="line">        fourier_s.coef[<span class="built_in">height</span> - i][<span class="built_in">width</span> - i] = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">91</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">92</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">93</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">94</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">95</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> fourier_s;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">96</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<h4 id="å››ã€é«˜é€šæ»¤æ³¢å™¨"><a href="#å››ã€é«˜é€šæ»¤æ³¢å™¨" class="headerlink" title="å››ã€é«˜é€šæ»¤æ³¢å™¨"></a>å››ã€é«˜é€šæ»¤æ³¢å™¨</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># DFT hyper-parameters</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">K, L = <span class="number">128</span>, <span class="number">128</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">channel = <span class="number">3</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># bgr -&gt; gray</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bgr2gray</span><span class="params">(img)</span>:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">	gray = <span class="number">0.2126</span> * img[..., <span class="number">2</span>] + <span class="number">0.7152</span> * img[..., <span class="number">1</span>] + <span class="number">0.0722</span> * img[..., <span class="number">0</span>]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">return</span> gray</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># DFT</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dft</span><span class="params">(img)</span>:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># Prepare DFT coefficient</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">	G = np.zeros((L, K, channel), dtype=np.complex)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># prepare processed index corresponding to original image positions</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">	x = np.tile(np.arange(W), (H, <span class="number">1</span>))</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">	y = np.arange(H).repeat(W).reshape(H, <span class="number">-1</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># dft</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">for</span> c <span class="keyword">in</span> range(channel):</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">		<span class="keyword">for</span> l <span class="keyword">in</span> range(L):</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">			<span class="keyword">for</span> k <span class="keyword">in</span> range(K):</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">				G[l, k, c] = np.sum(img[..., c] * np.exp(<span class="number">-2j</span> * np.pi * (x * k / K + y * l / L))) / np.sqrt(K * L)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">return</span> G</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># IDFT</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">idft</span><span class="params">(G)</span>:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># prepare out image</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">	H, W, _ = G.shape</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">	out = np.zeros((H, W, channel), dtype=np.float32)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># prepare processed index corresponding to original image positions</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">	x = np.tile(np.arange(W), (H, <span class="number">1</span>))</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">	y = np.arange(H).repeat(W).reshape(H, <span class="number">-1</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># idft</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">for</span> c <span class="keyword">in</span> range(channel):</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">		<span class="keyword">for</span> l <span class="keyword">in</span> range(H):</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">			<span class="keyword">for</span> k <span class="keyword">in</span> range(W):</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">				out[l, k, c] = np.abs(np.sum(G[..., c] * np.exp(<span class="number">2j</span> * np.pi * (x * k / W + y * l / H)))) / np.sqrt(W * H)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># clipping</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">	out = np.clip(out, <span class="number">0</span>, <span class="number">255</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">	out = out.astype(np.uint8)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">return</span> out</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># HPF</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">hpf</span><span class="params">(G, ratio=<span class="number">0.1</span>)</span>:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line">	H, W, _ = G.shape	</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">54</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># transfer positions</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">55</span></pre></td><td class="code"><pre><span class="line">	_G = np.zeros_like(G)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">56</span></pre></td><td class="code"><pre><span class="line">	_G[:H//<span class="number">2</span>, :W//<span class="number">2</span>] = G[H//<span class="number">2</span>:, W//<span class="number">2</span>:]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">57</span></pre></td><td class="code"><pre><span class="line">	_G[:H//<span class="number">2</span>, W//<span class="number">2</span>:] = G[H//<span class="number">2</span>:, :W//<span class="number">2</span>]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">58</span></pre></td><td class="code"><pre><span class="line">	_G[H//<span class="number">2</span>:, :W//<span class="number">2</span>] = G[:H//<span class="number">2</span>, W//<span class="number">2</span>:]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">59</span></pre></td><td class="code"><pre><span class="line">	_G[H//<span class="number">2</span>:, W//<span class="number">2</span>:] = G[:H//<span class="number">2</span>, :W//<span class="number">2</span>]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">60</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">61</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># get distance from center (H / 2, W / 2)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">62</span></pre></td><td class="code"><pre><span class="line">	x = np.tile(np.arange(W), (H, <span class="number">1</span>))</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">63</span></pre></td><td class="code"><pre><span class="line">	y = np.arange(H).repeat(W).reshape(H, <span class="number">-1</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">64</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">65</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># make filter</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">66</span></pre></td><td class="code"><pre><span class="line">	_x = x - W // <span class="number">2</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">67</span></pre></td><td class="code"><pre><span class="line">	_y = y - H // <span class="number">2</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">68</span></pre></td><td class="code"><pre><span class="line">	r = np.sqrt(_x ** <span class="number">2</span> + _y ** <span class="number">2</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">69</span></pre></td><td class="code"><pre><span class="line">	mask = np.ones((H, W), dtype=np.float32)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">70</span></pre></td><td class="code"><pre><span class="line">	mask[r &lt; (W // <span class="number">2</span> * ratio)] = <span class="number">0</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">71</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">72</span></pre></td><td class="code"><pre><span class="line">	mask = np.repeat(mask, channel).reshape(H, W, channel)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">73</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">74</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># filtering</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">75</span></pre></td><td class="code"><pre><span class="line">	_G *= mask</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">76</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">77</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># reverse original positions</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">78</span></pre></td><td class="code"><pre><span class="line">	G[:H//<span class="number">2</span>, :W//<span class="number">2</span>] = _G[H//<span class="number">2</span>:, W//<span class="number">2</span>:]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">79</span></pre></td><td class="code"><pre><span class="line">	G[:H//<span class="number">2</span>, W//<span class="number">2</span>:] = _G[H//<span class="number">2</span>:, :W//<span class="number">2</span>]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">80</span></pre></td><td class="code"><pre><span class="line">	G[H//<span class="number">2</span>:, :W//<span class="number">2</span>] = _G[:H//<span class="number">2</span>, W//<span class="number">2</span>:]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">81</span></pre></td><td class="code"><pre><span class="line">	G[H//<span class="number">2</span>:, W//<span class="number">2</span>:] = _G[:H//<span class="number">2</span>, :W//<span class="number">2</span>]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">82</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">83</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">return</span> G</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">84</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">85</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">86</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># Read image</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">87</span></pre></td><td class="code"><pre><span class="line">img = cv2.imread(<span class="string">"imori.jpg"</span>).astype(np.float32)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">88</span></pre></td><td class="code"><pre><span class="line">H, W, C = img.shape</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">89</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">90</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># Gray scale</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">91</span></pre></td><td class="code"><pre><span class="line">gray = bgr2gray(img)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">92</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">93</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># DFT</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">94</span></pre></td><td class="code"><pre><span class="line">G = dft(img)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">95</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">96</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># HPF</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">97</span></pre></td><td class="code"><pre><span class="line">G = hpf(G)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">98</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">99</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># IDFT</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">100</span></pre></td><td class="code"><pre><span class="line">out = idft(G)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">101</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">102</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># Save result</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">103</span></pre></td><td class="code"><pre><span class="line">cv2.imshow(<span class="string">"result"</span>, out)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">104</span></pre></td><td class="code"><pre><span class="line">cv2.waitKey(<span class="number">0</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">105</span></pre></td><td class="code"><pre><span class="line">cv2.imwrite(<span class="string">"out.jpg"</span>, out)</span></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="keyword">int</span> <span class="built_in">height</span> = <span class="number">128</span>, <span class="built_in">width</span> = <span class="number">128</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fourier_str</span> &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">std</span>::<span class="built_in">complex</span>&lt;<span class="keyword">double</span>&gt; coef[<span class="built_in">height</span>][<span class="built_in">width</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#125;;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// RGB to Gray scale</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="function">cv::Mat <span class="title">BGR2GRAY</span><span class="params">(cv::Mat img)</span></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// prepare output</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">  cv::Mat out = cv::Mat::zeros(<span class="built_in">height</span>, <span class="built_in">width</span>, CV_8UC1);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// BGR -&gt; Gray</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; <span class="built_in">height</span>; y++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; <span class="built_in">width</span>; x++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">      out.at&lt;uchar&gt;(y, x) = (<span class="keyword">int</span>)((<span class="keyword">float</span>)img.at&lt;cv::Vec3b&gt;(y, x)[<span class="number">0</span>] * <span class="number">0.0722</span> + \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">				  (<span class="keyword">float</span>)img.at&lt;cv::Vec3b&gt;(y, x)[<span class="number">1</span>] * <span class="number">0.7152</span> + \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">				  (<span class="keyword">float</span>)img.at&lt;cv::Vec3b&gt;(y, x)[<span class="number">2</span>] * <span class="number">0.2126</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> out;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// Discrete Fourier transformation</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line"><span class="function">fourier_str <span class="title">dft</span><span class="params">(cv::Mat img, fourier_str fourier_s)</span></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> I;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> theta;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">std</span>::<span class="built_in">complex</span>&lt;<span class="keyword">double</span>&gt; val;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span> ( <span class="keyword">int</span> l = <span class="number">0</span>; l &lt; <span class="built_in">height</span>; l ++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> ( <span class="keyword">int</span> k = <span class="number">0</span>; k &lt; <span class="built_in">width</span>; k ++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">      val.real(<span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">      val.imag(<span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">for</span> ( <span class="keyword">int</span> y = <span class="number">0</span>; y &lt; <span class="built_in">height</span>; y ++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">for</span> ( <span class="keyword">int</span> x = <span class="number">0</span>; x &lt; <span class="built_in">width</span>; x ++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">          I = (<span class="keyword">double</span>)img.at&lt;uchar&gt;(y, x);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">          theta = <span class="number">-2</span> * M_PI * ((<span class="keyword">double</span>)k * (<span class="keyword">double</span>)x / (<span class="keyword">double</span>)<span class="built_in">width</span> + (<span class="keyword">double</span>)l * (<span class="keyword">double</span>)y / (<span class="keyword">double</span>)<span class="built_in">height</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">          val += <span class="built_in">std</span>::<span class="built_in">complex</span>&lt;<span class="keyword">double</span>&gt;(<span class="built_in">cos</span>(theta), <span class="built_in">sin</span>(theta)) * I;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">      val /= <span class="built_in">sqrt</span>(<span class="built_in">height</span> * <span class="built_in">width</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">      fourier_s.coef[l][k] = val;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> fourier_s;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// Inverse Discrete Fourier transformation</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line"><span class="function">cv::Mat <span class="title">idft</span><span class="params">(cv::Mat out, fourier_str fourier_s)</span></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> theta;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> g;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">54</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">std</span>::<span class="built_in">complex</span>&lt;<span class="keyword">double</span>&gt; G;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">55</span></pre></td><td class="code"><pre><span class="line">  <span class="built_in">std</span>::<span class="built_in">complex</span>&lt;<span class="keyword">double</span>&gt; val;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">56</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">57</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span> ( <span class="keyword">int</span> y = <span class="number">0</span>; y &lt; <span class="built_in">height</span>; y ++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">58</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> ( <span class="keyword">int</span> x = <span class="number">0</span>; x &lt; <span class="built_in">width</span>; x ++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">59</span></pre></td><td class="code"><pre><span class="line">      val.real(<span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">60</span></pre></td><td class="code"><pre><span class="line">      val.imag(<span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">61</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">for</span> ( <span class="keyword">int</span> l = <span class="number">0</span>; l &lt; <span class="built_in">height</span>; l ++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">62</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">for</span> ( <span class="keyword">int</span> k = <span class="number">0</span>; k &lt; <span class="built_in">width</span>; k ++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">63</span></pre></td><td class="code"><pre><span class="line">          G = fourier_s.coef[l][k];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">64</span></pre></td><td class="code"><pre><span class="line">          theta = <span class="number">2</span> * M_PI * ((<span class="keyword">double</span>)k * (<span class="keyword">double</span>)x / (<span class="keyword">double</span>)<span class="built_in">width</span> + (<span class="keyword">double</span>)l * (<span class="keyword">double</span>)y / (<span class="keyword">double</span>)<span class="built_in">height</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">65</span></pre></td><td class="code"><pre><span class="line">          val += <span class="built_in">std</span>::<span class="built_in">complex</span>&lt;<span class="keyword">double</span>&gt;(<span class="built_in">cos</span>(theta), <span class="built_in">sin</span>(theta)) * G;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">66</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">67</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">68</span></pre></td><td class="code"><pre><span class="line">      g = <span class="built_in">std</span>::<span class="built_in">abs</span>(val) / <span class="built_in">sqrt</span>(<span class="built_in">height</span> * <span class="built_in">width</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">69</span></pre></td><td class="code"><pre><span class="line">      g = fmin(fmax(g, <span class="number">0</span>), <span class="number">255</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">70</span></pre></td><td class="code"><pre><span class="line">      out.at&lt;uchar&gt;(y, x) = (uchar)g;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">71</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">72</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">73</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">74</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> out;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">75</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">76</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">77</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">78</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// Band pass Filter</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">79</span></pre></td><td class="code"><pre><span class="line"><span class="function">fourier_str <span class="title">bpf</span><span class="params">(fourier_str fourier_s, <span class="keyword">double</span> pass_lower, <span class="keyword">double</span> pass_upper)</span></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">80</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">81</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// filtering</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">82</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> r = <span class="built_in">height</span> / <span class="number">2</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">83</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> filter_lower = (<span class="keyword">int</span>)((<span class="keyword">double</span>)r * pass_lower);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">84</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> filter_upper = (<span class="keyword">int</span>)((<span class="keyword">double</span>)r * pass_upper);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">85</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span> ( <span class="keyword">int</span> j = <span class="number">0</span>; j &lt; <span class="built_in">height</span> / <span class="number">2</span>; j++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">86</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> ( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="built_in">width</span> / <span class="number">2</span>; i++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">87</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> ((<span class="built_in">sqrt</span>(i * i + j * j) &lt; filter_lower) || </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">88</span></pre></td><td class="code"><pre><span class="line">          (<span class="built_in">sqrt</span>(i * i + j * j) &gt; filter_upper))&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">89</span></pre></td><td class="code"><pre><span class="line">        fourier_s.coef[j][i] = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">90</span></pre></td><td class="code"><pre><span class="line">        fourier_s.coef[j][<span class="built_in">width</span> - i] = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">91</span></pre></td><td class="code"><pre><span class="line">        fourier_s.coef[<span class="built_in">height</span> - i][i] = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">92</span></pre></td><td class="code"><pre><span class="line">        fourier_s.coef[<span class="built_in">height</span> - i][<span class="built_in">width</span> - i] = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">93</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">94</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">95</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">96</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">97</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> fourier_s;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">98</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/07/03/CUDA-Programmer-Learn-two/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qiang Chen">
      <meta itemprop="description" content="è®°å½•æ˜¯å¿˜è®°çš„ç¬¬ä¸€åŠ©æ‰‹.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ç¼–è¾‘å°¼æ’‘">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/03/CUDA-Programmer-Learn-two/" class="post-title-link" itemprop="url">CUDA-Programmer-Learn-Two</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-07-03 23:25:06 / ä¿®æ”¹æ—¶é—´ï¼š23:33:30" itemprop="dateCreated datePublished" datetime="2021-07-03T23:25:06+08:00">2021-07-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CUDA-Programmer/" itemprop="url" rel="index">
                    <span itemprop="name">CUDA Programmer</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="CUDAç¼–ç¨‹å­¦ä¹ ç¬”è®°"><a href="#CUDAç¼–ç¨‹å­¦ä¹ ç¬”è®°" class="headerlink" title="CUDAç¼–ç¨‹å­¦ä¹ ç¬”è®°"></a>CUDAç¼–ç¨‹å­¦ä¹ ç¬”è®°</h2><p>æœ¬ç¬”è®°ä¸»è¦<a href="https://face2ai.com/program-blog/#GPU%E7%BC%96%E7%A8%8B%EF%BC%88CUDA%EF%BC%89" target="_blank" rel="noopener">å‚è€ƒ: è°­å‡</a>å¤§ç¥çš„åšå®¢è¿›è¡Œäº†éƒ¨åˆ†å…³é”®çŸ¥è¯†çš„æ‘˜å½•ï¼Œå¯èƒ½æœ‰äº›åœ°æ–¹å›å»å•ç‹¬æŸ¥æ‰¾ä¸€äº›èµ„æ–™è¿›è¡Œè§£é‡Šã€‚</p>
<p>GPUä¸­ä½¿ç”¨CUDAç¼–ç¨‹çš„æ ¸å¿ƒéƒ¨åˆ†åˆ†ä¸ºï¼šæ ¸å‡½æ•°ã€å†…å­˜ç®¡ç†ã€çº¿ç¨‹ç®¡ç†å’Œæµã€‚</p>
<p>åœ¨CUADç¼–ç¨‹ä¸­ç‰¹æœ‰çš„åŠŸèƒ½ä¸ºï¼šé€šè¿‡ç»„ç»‡å±‚æ¬¡ç»“æ„åœ¨GPUä¸Šç»„ç»‡çº¿ç¨‹çš„æ–¹æ³•ï¼›é€šè¿‡ç»„ç»‡å±‚æ¬¡ç»“æ„åœ¨GPUä¸Šç»„ç»‡å†…å­˜çš„æ–¹æ³•ã€‚</p>
<p>åœ¨å®é™…çš„CUDAåº”ç”¨å¼€å‘è¿‡ç¨‹ä¸­ï¼šéœ€è¦ä»ä¸‰ä¸ªè§’åº¦æ¥æ€è€ƒå¦‚ä½•è§£å†³é—®é¢˜ï¼Ÿ</p>
<ol>
<li>é¢†åŸŸå±‚ï¼Œæ ¹æ®æ‰€è¦è§£å†³çš„é—®é¢˜çš„æ¡ä»¶ï¼Œåœ¨é¢†åŸŸå±‚åˆ†ææ•°æ®å’Œå‡½æ•°</li>
<li>é€»è¾‘å±‚ï¼Œéœ€è¦è€ƒè™‘çº¿ç¨‹çš„å±‚æ¬¡ç»“æ„ï¼Œå¯ä»¥è·å¾—è‰¯å¥½çš„å¯æ‰©å±•æ€§ã€‚</li>
<li>ç¡¬ä»¶å±‚ï¼Œé€šè¿‡ç†è§£çº¿ç¨‹å¦‚ä½•æ˜ å°„åˆ°æœºå™¨ä¸Šï¼Œèƒ½å……åˆ†å¸®åŠ©æˆ‘ä»¬æé«˜æ€§èƒ½ã€‚</li>
</ol>
<h4 id="ä¸€ã€å†…å­˜ç®¡ç†"><a href="#ä¸€ã€å†…å­˜ç®¡ç†" class="headerlink" title="ä¸€ã€å†…å­˜ç®¡ç†"></a>ä¸€ã€å†…å­˜ç®¡ç†</h4><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:center">æ ‡å‡†Cå‡½æ•°</th>
<th style="text-align:center">CUDA Cå‡½æ•°</th>
<th style="text-align:center">è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">malloc</td>
<td style="text-align:center">cudaMalloc</td>
<td style="text-align:center">å†…å­˜åˆ†é…</td>
</tr>
<tr>
<td style="text-align:center">memcpy</td>
<td style="text-align:center">cudaMemcpy</td>
<td style="text-align:center">å†…å­˜å¤åˆ¶</td>
</tr>
<tr>
<td style="text-align:center">memset</td>
<td style="text-align:center">cudaMemset</td>
<td style="text-align:center">å†…å­˜è®¾ç½®</td>
</tr>
<tr>
<td style="text-align:center">free</td>
<td style="text-align:center">cudaFree</td>
<td style="text-align:center">é‡Šæ”¾å†…å­˜</td>
</tr>
</tbody>
</table>
</div>
<h4 id="äºŒã€çº¿ç¨‹ç®¡ç†"><a href="#äºŒã€çº¿ç¨‹ç®¡ç†" class="headerlink" title="äºŒã€çº¿ç¨‹ç®¡ç†"></a>äºŒã€çº¿ç¨‹ç®¡ç†</h4><p>ä¸€ä¸ªæ ¸å‡½æ•°åªèƒ½æœ‰ä¸€ä¸ªgridï¼Œä¸€ä¸ªgridå¯ä»¥æœ‰å¾ˆå¤šä¸ªå—ï¼Œæ¯ä¸ªå—å¯ä»¥æœ‰å¾ˆå¤šçš„çº¿ç¨‹ï¼Œè¿™ç§åˆ†å±‚çš„ç»„ç»‡ç»“æ„ä½¿å¾—æˆ‘ä»¬çš„å¹¶è¡Œè¿‡ç¨‹æ›´åŠ è‡ªå¦‚çµæ´»ã€‚ä¸€ä¸ªçº¿ç¨‹å—blockä¸­çš„çº¿ç¨‹å¯ä»¥å®ŒæˆåŒæ­¥å’Œå†…å­˜å…±äº«ã€‚<strong>ä¸åŒå—å†…çº¿ç¨‹ä¸èƒ½ç›¸äº’å½±å“ï¼Œä»–ä»¬æ˜¯ç‰©ç†éš”ç¦»çš„ã€‚</strong></p>
<p>æ¯ä¸ªçº¿ç¨‹éƒ½æ‰§è¡ŒåŒæ ·çš„ä¸€æ®µä¸²è¡Œä»£ç ï¼Œé‚£ä¹ˆæ€ä¹ˆè®©è¿™æ®µç›¸åŒçš„ä»£ç å¯¹åº”ä¸åŒçš„æ•°æ®å‘¢ï¼Ÿ</p>
<p>ä¾é ä¸‹é¢ä¸¤ä¸ªå†…ç½®ç»“æ„ä½“ç¡®å®šçº¿ç¨‹æ ‡å·ï¼šblockIdxï¼ˆçº¿ç¨‹å—åœ¨çº¿ç¨‹ç½‘æ ¼å†…çš„ä½ç½®ç´¢å¼•ï¼‰ï¼ŒthreadIdxï¼ˆçº¿ç¨‹åœ¨çº¿ç¨‹å—å†…çš„ä½ç½®ç´¢å¼•ï¼‰ã€‚è¿™ä¸¤ä¸ªå†…ç½®ç»“æ„ä½“åŸºäº uint3 å®šä¹‰ï¼ŒåŒ…å«ä¸‰ä¸ªæ— ç¬¦å·æ•´æ•°çš„ç»“æ„ï¼Œé€šè¿‡ä¸‰ä¸ªå­—æ®µæ¥æŒ‡å®šï¼šblockIdx.xï¼ŒblockIdx.yï¼ŒblockIdx.zï¼ŒthreadIdx.xï¼ŒthreadIdx.yï¼ŒthreadIdx.zã€‚</p>
<p>blockIdxå¯¹åº”çš„èŒƒå›´ä¸ºgridDimï¼ŒthreadIdxå¯¹åº”çš„èŒƒå›´ä¸ºblockDimã€‚ä»–ä»¬æ˜¯dim3ç±»å‹(åŸºäºuint3å®šä¹‰çš„æ•°æ®ç»“æ„)çš„å˜é‡ï¼Œä¹ŸåŒ…å«ä¸‰ä¸ªå­—æ®µx,y,zã€‚blockDim.xï¼ŒblockDim.yï¼ŒblockDim.zã€‚</p>
<p>é€šè¿‡æŒ‡å®šgridå’Œblockçš„ç»´åº¦ï¼Œæˆ‘ä»¬å¯ä»¥é…ç½®ï¼š1ã€å†…æ ¸ä¸­çº¿ç¨‹çš„æ•°ç›®ï¼›2ã€å†…æ ¸ä¸­ä½¿ç”¨çš„çº¿ç¨‹å¸ƒå±€ã€‚å¯ä»¥ä½¿ç”¨<strong>dim3ç±»å‹</strong>çš„gridç»´åº¦å’Œblockç»´åº¦é…ç½®å†…æ ¸ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨intç±»å‹çš„å˜é‡ï¼Œæˆ–è€…å¸¸é‡ç›´æ¥åˆå§‹åŒ–ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">kernel_name&lt;&lt;&lt;<span class="number">4</span>,<span class="number">8</span>&gt;&gt;&gt;(argument <span class="built_in">list</span>);</span></pre></td></tr></table></figure>
<p>ä¸Šé¢è¿™æ¡æŒ‡ä»¤çš„çº¿ç¨‹å¸ƒå±€æ˜¯ï¼š</p>
<p><img src="/2021/07/03/CUDA-Programmer-Learn-two/1.png" alt="CUDA-Program-Lean-Plus"></p>
<p>æ ¸å‡½æ•°æ˜¯åŒæ—¶å¤åˆ¶åˆ°å¤šä¸ªçº¿ç¨‹æ‰§è¡Œçš„ï¼Œä¸Šæ–‡æˆ‘ä»¬è¯´è¿‡ä¸€ä¸ªå¯¹åº”é—®é¢˜ï¼Œå¤šä¸ªè®¡ç®—æ‰§è¡Œåœ¨ä¸€ä¸ªæ•°æ®ï¼Œè‚¯å®šæ˜¯æµªè´¹æ—¶é—´ï¼Œæ‰€ä»¥ä¸ºäº†è®©å¤šçº¿ç¨‹æŒ‰ç…§æˆ‘ä»¬çš„æ„æ„¿å¯¹åº”åˆ°ä¸åŒçš„æ•°æ®ï¼Œå°±è¦ç»™çº¿ç¨‹ä¸€ä¸ªå”¯ä¸€çš„æ ‡è¯†ï¼Œç”±äºè®¾å¤‡å†…å­˜æ˜¯çº¿æ€§çš„ï¼ˆåŸºæœ¬å¸‚é¢ä¸Šçš„å†…å­˜ç¡¬ä»¶éƒ½æ˜¯çº¿æ€§å½¢å¼å­˜å‚¨æ•°æ®çš„ï¼‰æˆ‘ä»¬è§‚å¯Ÿä¸Šå›¾ï¼Œå¯ä»¥ç”¨threadIdx.x å’ŒblockIdx.x æ¥ç»„åˆè·å¾—å¯¹åº”çš„çº¿ç¨‹çš„å”¯ä¸€æ ‡è¯†ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¸»æœºç«¯æ˜¾ç¤ºç­‰å¾…è®¾å¤‡ç«¯æ‰§è¡Œ</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function">cudaError_t <span class="title">cudaDeviceSynchronize</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¸»æœºç«¯éšå¼ç­‰å¾…è®¾å¤‡ç«¯æ‰§è¡Œ </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//å½“æ ¸å‡½æ•°å¯åŠ¨åçš„ä¸‹ä¸€æ¡æŒ‡ä»¤å°±æ˜¯ä»è®¾å¤‡å¤åˆ¶æ•°æ®å›ä¸»æœºç«¯ï¼Œé‚£ä¹ˆä¸»æœºç«¯å¿…é¡»è¦ç­‰å¾…è®¾å¤‡ç«¯è®¡ç®—å®Œæˆã€‚</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="function">cudaError_t <span class="title">cudaMemcpy</span><span class="params">(<span class="keyword">void</span>* dst,<span class="keyword">const</span> <span class="keyword">void</span> * src,</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="params">  <span class="keyword">size_t</span> count,cudaMemcpyKind kind)</span></span>;</span></pre></td></tr></table></figure>
<p>æ‰€æœ‰CUDAæ ¸å‡½æ•°çš„å¯åŠ¨éƒ½æ˜¯å¼‚æ­¥çš„ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç¼–å†™æ ¸å‡½æ•°</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function">__global__ <span class="keyword">void</span> <span class="title">kernel_name</span><span class="params">(argument <span class="built_in">list</span>)</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//CUDAå°æŠ€å·§ï¼Œå½“æˆ‘ä»¬è¿›è¡Œè°ƒè¯•çš„æ—¶å€™å¯ä»¥æŠŠæ ¸å‡½æ•°é…ç½®æˆå•çº¿ç¨‹çš„</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">kernel_name&lt;&lt;&lt;<span class="number">1</span>,<span class="number">1</span>&gt;&gt;&gt;(argument <span class="built_in">list</span>)</span></pre></td></tr></table></figure>
<p><strong>é”™è¯¯å¤„ç†</strong>ï¼Œè·å¾—æ¯ä¸ªå‡½æ•°æ‰§è¡Œåçš„è¿”å›ç»“æœï¼Œç„¶åå¯¹ä¸æˆåŠŸçš„ä¿¡æ¯åŠ ä»¥å¤„ç†ï¼ŒCUDA C çš„APIæ¯ä¸ªè°ƒç”¨éƒ½ä¼šè¿”å›ä¸€ä¸ªé”™è¯¯ä»£ç ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CHECK(call) \</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">&#123;\</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">const</span> cudaError_t error=call;\</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">if</span>(error!=cudaSuccess)\</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">	&#123;\</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">		<span class="built_in">printf</span>(<span class="string">"ERROR: %s:%d,"</span>,__FILE__,__LINE__);\</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">		<span class="built_in">printf</span>(<span class="string">"code:%d,reason:%s\n"</span>,error,cudaGetErrorString(error));\</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">		<span class="built_in">exit</span>(<span class="number">1</span>);\</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">	&#125;\</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p><strong>ç”¨CPUè®¡æ—¶</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">cpuSecond</span><span class="params">()</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tp</span>;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">  gettimeofday(&amp;tp,<span class="literal">NULL</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span>((<span class="keyword">double</span>)tp.tv_sec+(<span class="keyword">double</span>)tp.tv_usec*<span class="number">1e-6</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p><strong>ç†è®ºæé™æœ€å¤§åŒ–</strong></p>
<p>å¾—åˆ°äº†å®é™…æ“ä½œå€¼ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“çš„æ˜¯æˆ‘ä»¬èƒ½ä¼˜åŒ–çš„æé™å€¼æ˜¯å¤šå°‘ï¼Œä¹Ÿå°±æ˜¯æœºå™¨çš„ç†è®ºè®¡ç®—æé™ï¼Œè¿™ä¸ªæé™æˆ‘ä»¬æ°¸è¿œä¹Ÿè¾¾ä¸åˆ°ï¼Œä½†æ˜¯æˆ‘ä»¬å¿…é¡»æ˜ç¡®çš„çŸ¥é“ï¼Œæ¯”å¦‚ç†è®ºæé™æ˜¯2ç§’ï¼Œæˆ‘ä»¬å·²ç»ä»10ç§’ä¼˜åŒ–åˆ°2.01ç§’äº†ï¼ŒåŸºæœ¬å°±æ²¡æœ‰å¿…è¦å†ç»§ç»­èŠ±å¤§é‡æ—¶é—´ä¼˜åŒ–é€Ÿåº¦äº†ï¼Œè€Œåº”è¯¥è€ƒè™‘ä¹°æ›´å¤šçš„æœºå™¨æˆ–è€…æ›´æ–°çš„è®¾å¤‡ã€‚å„ä¸ªè®¾å¤‡çš„ç†è®ºæé™å¯ä»¥é€šè¿‡å…¶èŠ¯ç‰‡è¯´æ˜è®¡ç®—å¾—åˆ°ã€‚å…·ä½“çš„è®¡ç®—æŒ‡æ ‡ä¸ºï¼š</p>
<ul>
<li>å•ç²¾åº¦å³°å€¼æµ®ç‚¹æ•°è®¡ç®—æ¬¡æ•°</li>
<li>å†…å­˜å¸¦å®½å³°å€¼</li>
<li>æŒ‡ä»¤æ¯”</li>
</ul>
<h4 id="ä¸‰ã€ç»„ç»‡å¹¶è¡Œçº¿ç¨‹"><a href="#ä¸‰ã€ç»„ç»‡å¹¶è¡Œçº¿ç¨‹" class="headerlink" title="ä¸‰ã€ç»„ç»‡å¹¶è¡Œçº¿ç¨‹"></a>ä¸‰ã€ç»„ç»‡å¹¶è¡Œçº¿ç¨‹</h4><p>ä»‹ç»æ¯ä¸€ä¸ªçº¿ç¨‹æ˜¯æ€ä¹ˆç¡®å®šå”¯ä¸€çš„ç´¢å¼•ï¼Œç„¶åå»ºç«‹å¹¶è¡Œè®¡ç®—ï¼Œå¹¶ä¸”ä¸åŒçš„çº¿ç¨‹ç»„ç»‡å½¢å¼æ˜¯æ€æ ·å½±å“æ€§èƒ½çš„ï¼Ÿ</p>
<p><strong>ä½¿ç”¨å¿«å’Œçº¿ç¨‹å»ºç«‹çŸ©é˜µç´¢å¼•</strong></p>
<p>å¤šçº¿ç¨‹çš„ä¼˜ç‚¹å°±æ˜¯æ¯ä¸ªçº¿ç¨‹å¤„ç†ä¸åŒçš„æ•°æ®è®¡ç®—ï¼Œé‚£ä¹ˆæ€ä¹ˆåˆ†é…å¥½æ¯ä¸ªçº¿ç¨‹å¤„ç†ä¸åŒçš„æ•°æ®ï¼Œè€Œä¸è‡³äºå¤šä¸ªä¸åŒçš„çº¿ç¨‹å¤„ç†åŒä¸€ä¸ªæ•°æ®ï¼Œæˆ–è€…é¿å…ä¸åŒçš„çº¿ç¨‹æ²¡æœ‰ç»„ç»‡çš„ä¹±è®¿é—®å†…å­˜ã€‚</p>
<p><img src="/2021/07/03/CUDA-Programmer-Learn-two/2.png" alt="CUDA-Program-Learn-Plus"></p>
<p>è¿™é‡Œ(ix,iy)å°±æ˜¯æ•´ä¸ªçº¿ç¨‹æ¨¡å‹ä¸­ä»»æ„ä¸€ä¸ªçº¿ç¨‹çš„ç´¢å¼•ï¼Œæˆ–è€…å«åšå…¨å±€åœ°å€ï¼Œå±€éƒ¨åœ°å€å½“ç„¶å°±æ˜¯(threadIdx.x,threadIdx.y)äº†ï¼Œå½“ç„¶è¿™ä¸ªå±€éƒ¨åœ°å€ç›®å‰è¿˜æ²¡æœ‰ä»€ä¹ˆç”¨å¤„ï¼Œä»–åªèƒ½ç´¢å¼•çº¿ç¨‹å—å†…çš„çº¿ç¨‹ï¼Œä¸åŒçº¿ç¨‹å—ä¸­æœ‰ç›¸åŒçš„å±€éƒ¨ç´¢å¼•å€¼ã€‚</p>
<p>å‰é¢è®²è¿‡CUDAæ¯ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œç›¸åŒçš„ä»£ç ï¼Œä¹Ÿå°±æ˜¯å¼‚æ„è®¡ç®—ä¸­è¯´çš„å¤šçº¿ç¨‹å•æŒ‡ä»¤ï¼Œå¦‚æœæ¯ä¸ªä¸åŒçš„çº¿ç¨‹æ‰§è¡ŒåŒæ ·çš„ä»£ç ï¼Œåˆå¤„ç†åŒä¸€ç»„æ•°æ®ï¼Œå°†ä¼šå¾—åˆ°å¤šä¸ªç›¸åŒçš„ç»“æœï¼Œæ˜¾ç„¶è¿™æ˜¯æ²¡æ„ä¹‰çš„ï¼Œä¸ºäº†è®©ä¸åŒçº¿ç¨‹å¤„ç†ä¸åŒçš„æ•°æ®ï¼ŒCUDAå¸¸ç”¨çš„åšæ³•æ˜¯è®©ä¸åŒçš„çº¿ç¨‹å¯¹åº”ä¸åŒçš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ç”¨çº¿ç¨‹çš„å…¨å±€æ ‡å·å¯¹åº”ä¸åŒç»„çš„æ•°æ®ã€‚</p>
<p>è®¾å¤‡å†…å­˜æˆ–è€…ä¸»æœºå†…å­˜éƒ½æ˜¯çº¿æ€§å­˜åœ¨çš„ï¼Œæ¯”å¦‚ä¸€ä¸ªäºŒç»´çŸ©é˜µ (8Ã—6)ï¼Œå­˜å‚¨åœ¨å†…å­˜ä¸­æ˜¯è¿™æ ·çš„ï¼š</p>
<p><img src="/2021/07/03/CUDA-Programmer-Learn-two/3.png" alt="CUDA-Program-Learn-Plus"></p>
<p>å›¾åƒå—ä¸­æ•°æ®å¯»å€çš„è®¡ç®—æ­¥éª¤ï¼š</p>
<ul>
<li>çº¿ç¨‹å’Œå—ç´¢å¼•ï¼ˆæ¥è®¡ç®—çº¿ç¨‹çš„å…¨å±€ç´¢å¼•ï¼‰ï¼ŒçŸ©é˜µä¸­ç»™å®šç‚¹çš„åæ ‡ï¼ˆix,iyï¼‰</li>
<li>(ix,iy)å¯¹åº”çš„çº¿æ€§å†…å­˜çš„ä½ç½®</li>
</ul>
<p>çº¿æ€§ä½ç½®çš„è®¡ç®—æ–¹æ³•æ˜¯ï¼š</p>
<script type="math/tex; mode=display">
idx=ix+iyâˆ—nx</script><h4 id="å››ã€æ‰§è¡Œæ¨¡å‹"><a href="#å››ã€æ‰§è¡Œæ¨¡å‹" class="headerlink" title="å››ã€æ‰§è¡Œæ¨¡å‹"></a>å››ã€æ‰§è¡Œæ¨¡å‹</h4><p>ç”¨CUDAçš„ç›®çš„å…¶å®è¯´ç™½äº†å°±æ˜¯ä¸ºè®¡ç®—é€Ÿåº¦å¿«ï¼Œæ‰€ä»¥å‹æ¦¨æ€§èƒ½ï¼Œæé«˜æ•ˆç‡å…¶å®å°±æ˜¯CUDAå­¦ä¹ çš„æœ€ç»ˆç›®çš„ã€‚ä»€ä¹ˆæ—¶å€™æˆ‘ä»¬æ²¿ç€ç¡¬ä»¶è®¾è®¡çš„æ€è·¯è®¾è®¡ç¨‹åºï¼Œæˆ‘ä»¬å°±ä¼šå¾—åˆ°ç™¾æˆ˜ç™¾èƒœã€‚CUDAæ‰§è¡Œæ¨¡å‹æ­ç¤ºäº†GPUå¹¶è¡Œæ¶æ„çš„æŠ½è±¡è§†å›¾ï¼Œäº†è§£CUDAçš„æ‰§è¡Œæ¨¡å‹ï¼Œå¯ä»¥å¸®åŠ©æˆ‘ä»¬ä¼˜åŒ–æŒ‡ä»¤ååé‡ï¼Œå’Œå†…å­˜ä½¿ç”¨æ¥è·å¾—æé™é€Ÿåº¦ã€‚</p>
<p><strong>GPUæ¶æ„æ¦‚è¿°ï¼š</strong>GPUæ¶æ„æ˜¯å›´ç»•ä¸€ä¸ªæµå¼å¤šå¤„ç†å™¨ï¼ˆSMï¼‰çš„æ‰©å±•é˜µåˆ—æ­å»ºçš„ã€‚é€šè¿‡å¤åˆ¶è¿™ç§ç»“æ„æ¥å®ç°GPUçš„ç¡¬ä»¶å¹¶è¡Œã€‚</p>
<p>ä¸‹é¢å›¾ä¸­å±•ç¤ºäº†æµå¼å¤šå¤„ç†å™¨ä¸­çš„ä¸€äº›æ ¸å¿ƒç»„ä»¶ï¼šCUDAæ ¸å¿ƒã€å…±äº«å†…å­˜/ä¸€çº§ç¼“å­˜ã€å¯„å­˜å™¨æ–‡ä»¶ã€åŠ è½½/å­˜å‚¨å•å…ƒã€ç‰¹æ®ŠåŠŸèƒ½å•å…ƒã€çº¿ç¨‹æŸè°ƒåº¦å™¨ã€‚</p>
<p><img src="/2021/07/03/CUDA-Programmer-Learn-two/4.png" alt="CUDA-Program-Learn-Plus"></p>
<p>GPUä¸­æ¯ä¸ªSMéƒ½èƒ½æ”¯æŒæ•°ç™¾ä¸ªçº¿ç¨‹å¹¶å‘æ‰§è¡Œï¼Œæ¯ä¸ªGPUé€šå¸¸æœ‰å¤šä¸ªSMï¼Œå½“ä¸€ä¸ªæ ¸å‡½æ•°çš„ç½‘æ ¼è¢«å¯åŠ¨çš„æ—¶å€™ï¼Œå¤šä¸ªblockä¼šè¢«åŒæ—¶åˆ†é…ç»™å¯ç”¨çš„SMä¸Šæ‰§è¡Œã€‚</p>
<p><strong>æ³¨æ„:</strong> å½“ä¸€ä¸ªblcokè¢«åˆ†é…ç»™ä¸€ä¸ªSMåï¼Œä»–å°±åªèƒ½åœ¨è¿™ä¸ªSMä¸Šæ‰§è¡Œäº†ï¼Œä¸å¯èƒ½é‡æ–°åˆ†é…åˆ°å…¶ä»–SMä¸Šäº†ï¼Œå¤šä¸ªçº¿ç¨‹å—å¯ä»¥è¢«åˆ†é…åˆ°åŒä¸€ä¸ªSMä¸Šã€‚åœ¨SMä¸ŠåŒä¸€ä¸ªå—å†…çš„å¤šä¸ªçº¿ç¨‹è¿›è¡Œçº¿ç¨‹çº§åˆ«å¹¶è¡Œï¼Œ<strong>è€ŒåŒä¸€çº¿ç¨‹å†…ï¼ŒæŒ‡ä»¤åˆ©ç”¨æŒ‡ä»¤çº§å¹¶è¡Œå°†å•ä¸ªçº¿ç¨‹å¤„ç†æˆæµæ°´çº¿ã€‚</strong></p>
<p><strong>çº¿ç¨‹æŸï¼š</strong>CUDA  é‡‡ç”¨å•æŒ‡ä»¤å¤šçº¿ç¨‹SIMTæ¶æ„ç®¡ç†æ‰§è¡Œçº¿ç¨‹ï¼Œä¸åŒè®¾å¤‡æœ‰ä¸åŒçš„çº¿ç¨‹æŸå¤§å°ï¼Œä½†æ˜¯åˆ°ç›®å‰ä¸ºæ­¢åŸºæœ¬æ‰€æœ‰è®¾å¤‡éƒ½æ˜¯ç»´æŒåœ¨32ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯ä¸ªSMä¸Šæœ‰å¤šä¸ªblockï¼Œä¸€ä¸ªblockæœ‰å¤šä¸ªçº¿ç¨‹ï¼ˆå¯ä»¥æ˜¯å‡ ç™¾ä¸ªï¼Œä½†ä¸ä¼šè¶…è¿‡æŸä¸ªæœ€å¤§å€¼ï¼‰ï¼Œä½†æ˜¯ä»æœºå™¨çš„è§’åº¦ï¼Œåœ¨æŸæ—¶åˆ»Tï¼ŒSMä¸Šåªæ‰§è¡Œä¸€ä¸ªçº¿ç¨‹æŸï¼Œä¹Ÿå°±æ˜¯32ä¸ªçº¿ç¨‹åœ¨åŒæ—¶åŒæ­¥æ‰§è¡Œï¼Œçº¿ç¨‹æŸä¸­çš„æ¯ä¸ªçº¿ç¨‹æ‰§è¡ŒåŒä¸€æ¡æŒ‡ä»¤ã€‚</p>
<p><strong>SIMD vs SIMTï¼š</strong>å•æŒ‡ä»¤å¤šæ•°æ®çš„æ‰§è¡Œå±äºå‘é‡æœºï¼Œæ¯”å¦‚æˆ‘ä»¬æœ‰å››ä¸ªæ•°å­—è¦åŠ ä¸Šå››ä¸ªæ•°å­—ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç”¨è¿™ç§å•æŒ‡ä»¤å¤šæ•°æ®çš„æŒ‡ä»¤æ¥ä¸€æ¬¡å®Œæˆæœ¬æ¥è¦åšå››æ¬¡çš„è¿ç®—ã€‚è¿™ç§æœºåˆ¶çš„é—®é¢˜å°±æ˜¯è¿‡äºæ­»æ¿ï¼Œä¸å…è®¸æ¯ä¸ªåˆ†æ”¯æœ‰ä¸åŒçš„æ“ä½œï¼Œæ‰€æœ‰åˆ†æ”¯å¿…é¡»åŒæ—¶æ‰§è¡Œç›¸åŒçš„æŒ‡ä»¤ï¼Œå¿…é¡»æ‰§è¡Œæ²¡æœ‰ä¾‹å¤–ã€‚ç›¸æ¯”ä¹‹ä¸‹å•æŒ‡ä»¤å¤šçº¿ç¨‹SIMTå°±æ›´åŠ çµæ´»äº†ï¼Œè™½ç„¶ä¸¤è€…éƒ½æ˜¯å°†ç›¸åŒæŒ‡ä»¤å¹¿æ’­ç»™å¤šä¸ªæ‰§è¡Œå•å…ƒï¼Œä½†æ˜¯SIMTçš„æŸäº›çº¿ç¨‹å¯ä»¥é€‰æ‹©ä¸æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è¯´åŒä¸€æ—¶åˆ»æ‰€æœ‰çº¿ç¨‹è¢«åˆ†é…ç»™ç›¸åŒçš„æŒ‡ä»¤ï¼ŒSIMDè§„å®šæ‰€æœ‰äººå¿…é¡»æ‰§è¡Œï¼Œè€ŒSIMTåˆ™è§„å®šæœ‰äº›äººå¯ä»¥æ ¹æ®éœ€è¦ä¸æ‰§è¡Œï¼Œè¿™æ ·SIMTå°±ä¿è¯äº†çº¿ç¨‹çº§åˆ«çš„å¹¶è¡Œï¼Œè€ŒSIMDæ›´åƒæ˜¯æŒ‡ä»¤çº§åˆ«çš„å¹¶è¡Œã€‚</p>
<p>SIMTåŒ…æ‹¬ä»¥ä¸‹SIMDä¸å…·æœ‰çš„å…³é”®ç‰¹æ€§ï¼š</p>
<ol>
<li>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„æŒ‡ä»¤åœ°å€è®¡æ•°å™¨</li>
<li>æ¯ä¸ªçº¿ç¨‹éƒ½æœ‰è‡ªå·±çš„å¯„å­˜å™¨çŠ¶æ€</li>
<li>æ¯ä¸ªçº¿ç¨‹å¯ä»¥æœ‰ä¸€ä¸ªç‹¬ç«‹çš„æ‰§è¡Œè·¯å¾„</li>
</ol>
<p>è€Œä¸Šé¢è¿™ä¸‰ä¸ªç‰¹æ€§åœ¨ç¼–ç¨‹æ¨¡å‹å¯ç”¨çš„æ–¹å¼å°±æ˜¯ç»™æ¯ä¸ªçº¿ç¨‹ä¸€ä¸ªå”¯ä¸€çš„æ ‡å·ï¼ˆblckIdx,threadIdxï¼‰ï¼Œå¹¶ä¸”è¿™ä¸‰ä¸ªç‰¹æ€§ä¿è¯äº†å„çº¿ç¨‹ä¹‹é—´çš„ç‹¬ç«‹ã€‚</p>
<p><strong>é—®é¢˜ï¼šå¦‚ä½•å°†çº¿ç¨‹çš„æ ‡å·å”¯ä¸€çš„å¯¹åº”åˆ°SMæµå¼å¤šå¤„ç†å™¨ä¸­çš„blockï¼Œå¯¹åº”åˆ°blockåCUDAæ ¸å’ŒæŒ‡ä»¤å¯„å­˜å™¨ä¹‹é—´çš„å…³ç³»å¦‚ä½•ç¡®å®š?</strong></p>
<h4 id="äº”ã€CUDAç¼–ç¨‹çš„ç»„ä»¶ä¸é€»è¾‘"><a href="#äº”ã€CUDAç¼–ç¨‹çš„ç»„ä»¶ä¸é€»è¾‘" class="headerlink" title="äº”ã€CUDAç¼–ç¨‹çš„ç»„ä»¶ä¸é€»è¾‘"></a>äº”ã€CUDAç¼–ç¨‹çš„ç»„ä»¶ä¸é€»è¾‘</h4><p>ä¸‹å›¾ä»é€»è¾‘è§’åº¦å’Œç¡¬ä»¶è§’åº¦æè¿°äº†CUDAç¼–ç¨‹æ¨¡å‹å¯¹åº”çš„ç»„ä»¶ã€‚</p>
<p><img src="/2021/07/03/CUDA-Programmer-Learn-two/5.png" alt="CUDA-Program-Learn-Plus"></p>
<p>SMä¸­å…±äº«å†…å­˜ï¼Œå’Œå¯„å­˜å™¨æ˜¯å…³é”®çš„èµ„æºï¼Œçº¿ç¨‹å—ä¸­çº¿ç¨‹é€šè¿‡å…±äº«å†…å­˜å’Œå¯„å­˜å™¨ç›¸äº’é€šä¿¡åè°ƒã€‚å¯„å­˜å™¨å’Œå…±äº«å†…å­˜çš„åˆ†é…å¯ä»¥ä¸¥é‡å½±å“æ€§èƒ½ï¼</p>
<p>æ¯ä¸ªSMæœ‰<strong>ä¸¤ä¸ªçº¿ç¨‹æŸè°ƒåº¦å™¨ï¼Œå’Œä¸¤ä¸ªæŒ‡ä»¤è°ƒåº¦å•å…ƒ</strong>ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹å—è¢«æŒ‡å®šç»™ä¸€ä¸ªSMæ—¶ï¼Œçº¿ç¨‹å—å†…çš„æ‰€æœ‰çº¿ç¨‹è¢«åˆ†æˆçº¿ç¨‹æŸï¼Œçº¿ç¨‹æŸé€‰æ‹©å…¶ä¸­ä¸¤ä¸ªçº¿ç¨‹æŸï¼Œåœ¨ç”¨æŒ‡ä»¤è°ƒåº¦å™¨å­˜å‚¨ä¸¤ä¸ªçº¿ç¨‹æŸè¦æ‰§è¡Œçš„æŒ‡ä»¤ï¼ˆå°±åƒä¸Šé¢ä¾‹å­ä¸­åˆ†æ°´æœçš„æ°´æœä¸€æ ·ï¼Œæˆ‘ä»¬è¿™é‡Œæœ‰ä¸¤ä¸ªç­ï¼Œä¸¤ä¸ªç­çš„è€å¸ˆå„è‡ªæ§åˆ¶çš„è‡ªå·±çš„æ°´æœï¼Œè€å¸ˆå°±æ˜¯æŒ‡ä»¤è°ƒåº¦å™¨ï¼‰åƒç¬¬ä¸€å¼ å›¾ä¸Šçš„æ˜¾ç¤ºä¸€æ ·ï¼Œæ¯16ä¸ªCUDAæ ¸å¿ƒä¸ºä¸€ä¸ªç»„ï¼Œè¿˜æœ‰16ä¸ªåŠ è½½/å­˜å‚¨å•å…ƒæˆ–4ä¸ªç‰¹æ®ŠåŠŸèƒ½å•å…ƒã€‚å½“æŸä¸ªçº¿ç¨‹å—è¢«åˆ†é…åˆ°ä¸€ä¸ªSMä¸Šçš„æ—¶å€™ï¼Œä¼šè¢«åˆ†æˆå¤šä¸ªçº¿ç¨‹æŸï¼Œçº¿ç¨‹æŸåœ¨SMä¸Šäº¤æ›¿æ‰§è¡Œã€‚</p>
<p><strong>å¼€å‘é«˜æ€§èƒ½è®¡ç®—ç¨‹åºå…³é”®çš„ä¸¤ä¸ªæ­¥éª¤ï¼š1ã€ä¿è¯ç»“æœæ­£ç¡®ï¼Œå’Œç¨‹åºå¥å£®æ€§ï¼›2ã€ä¼˜åŒ–é€Ÿåº¦ã€‚</strong></p>
<p><strong>æ€§èƒ½åˆ†æçš„ä¸»è¦å…³æ³¨ç‚¹ï¼š</strong></p>
<ol>
<li>åº”ç”¨ç¨‹åºä»£ç çš„ç©ºé—´æˆ–æ—¶é—´å¤æ‚åº¦</li>
<li>ç‰¹æ®ŠæŒ‡ä»¤çš„ä½¿ç”¨</li>
<li>å‡½æ•°è°ƒç”¨çš„é¢‘ç‡å’ŒæŒç»­æ—¶é—´</li>
</ol>
<p><strong>æ€§èƒ½åˆ†æå·¥å…·ï¼š</strong></p>
<ul>
<li>nvvp</li>
<li>nvprop</li>
</ul>
<h4 id="å…­ã€çº¿ç¨‹æŸå’Œçº¿ç¨‹å—"><a href="#å…­ã€çº¿ç¨‹æŸå’Œçº¿ç¨‹å—" class="headerlink" title="å…­ã€çº¿ç¨‹æŸå’Œçº¿ç¨‹å—"></a>å…­ã€çº¿ç¨‹æŸå’Œçº¿ç¨‹å—</h4><p>çº¿ç¨‹æŸæ˜¯SMä¸­åŸºæœ¬çš„æ‰§è¡Œå•å…ƒï¼Œå½“ä¸€ä¸ªç½‘æ ¼è¢«å¯åŠ¨ï¼ˆç½‘æ ¼è¢«å¯åŠ¨ï¼Œç­‰ä»·äºä¸€ä¸ªå†…æ ¸è¢«å¯åŠ¨ï¼Œæ¯ä¸ªå†…æ ¸å¯¹åº”äºè‡ªå·±çš„ç½‘æ ¼ï¼‰ï¼Œç½‘æ ¼ä¸­åŒ…å«çº¿ç¨‹å—ï¼Œçº¿ç¨‹å—è¢«åˆ†é…åˆ°æŸä¸€ä¸ªSMä¸Šä»¥åï¼Œå°†åˆ†ä¸ºå¤šä¸ªçº¿ç¨‹æŸï¼Œæ¯ä¸ªçº¿ç¨‹æŸä¸€èˆ¬æ˜¯32ä¸ªçº¿ç¨‹ï¼ˆç›®å‰çš„GPUéƒ½æ˜¯32ä¸ªçº¿ç¨‹ï¼Œä½†ä¸ä¿è¯æœªæ¥è¿˜æ˜¯32ä¸ªï¼‰åœ¨ä¸€ä¸ªçº¿ç¨‹æŸä¸­ï¼Œæ‰€æœ‰çº¿ç¨‹æŒ‰ç…§å•æŒ‡ä»¤å¤šçº¿ç¨‹SIMTçš„æ–¹å¼æ‰§è¡Œï¼Œæ¯ä¸€æ­¥æ‰§è¡Œç›¸åŒçš„æŒ‡ä»¤ï¼Œä½†æ˜¯å¤„ç†çš„æ•°æ®ä¸ºç§æœ‰çš„æ•°æ®ï¼Œä¸‹å›¾ååº”çš„å°±æ˜¯é€»è¾‘ï¼Œå®é™…ï¼Œå’Œç¡¬ä»¶çš„å›¾å½¢åŒ–ã€‚</p>
<p><img src="/2021/07/03/CUDA-Programmer-Learn-two/6.png" alt="CUDA-Program-Learn-Plus"></p>
<p><strong>çº¿ç¨‹æŸçš„åˆ†åŒ–ï¼š</strong>é‚£ä¹ˆå½“ä¸€ä¸ªçº¿ç¨‹æŸçš„32ä¸ªçº¿ç¨‹æ‰§è¡Œè¿™æ®µä»£ç çš„æ—¶å€™ï¼Œå¦‚æœå…¶ä¸­16ä¸ªæ‰§è¡Œifä¸­çš„ä»£ç æ®µï¼Œè€Œå¦å¤–16ä¸ªæ‰§è¡Œelseä¸­çš„ä»£ç å—ï¼ŒåŒä¸€ä¸ªçº¿ç¨‹æŸä¸­çš„çº¿ç¨‹ï¼Œæ‰§è¡Œä¸åŒçš„æŒ‡ä»¤ã€‚<strong>çº¿ç¨‹æŸåˆ†åŒ–ä¼šäº§ç”Ÿä¸¥é‡çš„æ€§èƒ½ä¸‹é™ã€‚æ¡ä»¶åˆ†æ”¯è¶Šå¤šï¼Œå¹¶è¡Œæ€§å‰Šå¼±è¶Šä¸¥é‡ã€‚</strong>ï¼ˆå› ä¸ºåˆ†é…å‘½ä»¤çš„è°ƒåº¦å™¨å°±ä¸€ä¸ªï¼Œæ‰€ä»¥æ»¡è¶³ifæ¡ä»¶çš„çº¿ç¨‹å¾—åˆ°ifä¸­çš„æŒ‡ä»¤æ‰§è¡Œï¼Œä¸æ»¡è¶³çš„éƒ¨åˆ†ç­‰å¾…ã€‚å½“æ»¡è¶³ifæ¡ä»¶çš„çº¿ç¨‹æ‰§è¡Œå®Œåï¼Œä¸æ»¡è¶³çš„çº¿ç¨‹æ‰§è¡Œelseä¸­çš„æŒ‡ä»¤ï¼Œå…¶ä½™çº¿ç¨‹ç­‰å¾…ï¼‰</p>
<p><strong>å¦‚ä½•è§£å†³çº¿ç¨‹æŸçš„åˆ†åŒ–ï¼Ÿ</strong></p>
<p>æ ¹æœ¬æ€è·¯æ˜¯é¿å…åŒä¸€ä¸ªçº¿ç¨‹æŸå†…çš„çº¿ç¨‹åˆ†åŒ–ï¼Œè€Œè®©æˆ‘ä»¬èƒ½æ§åˆ¶çº¿ç¨‹æŸå†…çº¿ç¨‹è¡Œä¸ºçš„åŸå› æ˜¯çº¿ç¨‹å—ä¸­çº¿ç¨‹åˆ†é…åˆ°çº¿ç¨‹æŸæ˜¯æœ‰è§„å¾‹çš„è€Œä¸æ˜¯éšæœºçš„ã€‚è¿™å°±ä½¿å¾—æˆ‘ä»¬æ ¹æ®çº¿ç¨‹ç¼–å·æ¥è®¾è®¡åˆ†æ”¯æ˜¯å¯ä»¥çš„ï¼Œè¡¥å……è¯´æ˜ä¸‹ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹æŸä¸­æ‰€æœ‰çš„çº¿ç¨‹éƒ½æ‰§è¡Œifæˆ–è€…ï¼Œéƒ½æ‰§è¡Œelseæ—¶ï¼Œä¸å­˜åœ¨æ€§èƒ½ä¸‹é™ï¼›åªæœ‰å½“çº¿ç¨‹æŸå†…æœ‰åˆ†æ­§äº§ç”Ÿåˆ†æ”¯çš„æ—¶å€™ï¼Œæ€§èƒ½æ‰ä¼šæ€¥å‰§ä¸‹é™ã€‚çº¿ç¨‹æŸå†…è¢«åˆ†é…çš„çº¿ç¨‹æ˜¯å¯ä»¥è¢«æˆ‘ä»¬æ§åˆ¶çš„ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±æŠŠéƒ½æ‰§è¡Œifçš„çº¿ç¨‹å¡åˆ°ä¸€ä¸ªçº¿ç¨‹æŸä¸­ï¼Œæˆ–è€…è®©ä¸€ä¸ªçº¿ç¨‹æŸä¸­çš„çº¿ç¨‹éƒ½æ‰§è¡Œifï¼Œå¦å¤–çº¿ç¨‹éƒ½æ‰§è¡Œelseçš„è¿™ç§æ–¹å¼å¯ä»¥å°†æ•ˆç‡æé«˜å¾ˆå¤šã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä½æ•ˆçš„if else</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function">__global__ <span class="keyword">void</span> <span class="title">mathKernel1</span><span class="params">(<span class="keyword">float</span> *c)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">int</span> tid = blockIdx.x* blockDim.x + threadIdx.x;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">float</span> a = <span class="number">0.0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">float</span> b = <span class="number">0.0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">if</span> (tid % <span class="number">2</span> == <span class="number">0</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">	&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">		a = <span class="number">100.0f</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">	&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">else</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">	&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">		b = <span class="number">200.0f</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">	&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">	c[tid] = a + b;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//é«˜æ•ˆçš„if else</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"><span class="function">__global__ <span class="keyword">void</span> <span class="title">mathKernel2</span><span class="params">(<span class="keyword">float</span> *c)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">int</span> tid = blockIdx.x* blockDim.x + threadIdx.x;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">float</span> a = <span class="number">0.0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">float</span> b = <span class="number">0.0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">if</span> ((tid/warpSize) % <span class="number">2</span> == <span class="number">0</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">	&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">		a = <span class="number">100.0f</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">	&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">else</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">	&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">		b = <span class="number">200.0f</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">	&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">	c[tid] = a + b;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¸Šé¢warpSizeè¡¨ç¤ºçº¿ç¨‹æŸä¸­çº¿ç¨‹çš„å¤§å°,æ¯”å¦‚æ€»64ä¸ªçº¿ç¨‹ï¼Œåˆ†åˆ°äº†ä¸¤ä¸ªçº¿ç¨‹æŸï¼Œä¸€ä¸ªçº¿ç¨‹æŸ32ä¸ªçº¿ç¨‹ã€‚</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//é‚£ä¹ˆ0-31çš„çº¿ç¨‹æŸéƒ½æ˜¯ifå†…çš„æŒ‡ä»¤ï¼Œ32-63çš„çº¿ç¨‹æŸéƒ½æ˜¯elseæŒ‡ä»¤ã€‚</span></span></pre></td></tr></table></figure>
<h4 id="ä¸ƒã€èµ„æºåˆ†é…"><a href="#ä¸ƒã€èµ„æºåˆ†é…" class="headerlink" title="ä¸ƒã€èµ„æºåˆ†é…"></a>ä¸ƒã€èµ„æºåˆ†é…</h4><p>æ¯ä¸ªSMä¸Šæ‰§è¡Œçš„åŸºæœ¬å•ä½æ˜¯çº¿ç¨‹æŸï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå•æŒ‡ä»¤é€šè¿‡æŒ‡ä»¤è°ƒåº¦å™¨å¹¿æ’­ç»™æŸçº¿ç¨‹æŸçš„å…¨éƒ¨çº¿ç¨‹ï¼Œè¿™äº›çº¿ç¨‹åŒä¸€æ—¶åˆ»æ‰§è¡ŒåŒä¸€å‘½ä»¤ã€‚å¯¹äºçº¿ç¨‹æŸæ¥è¯´æœ‰æ¿€æ´»å’Œæœªæ¿€æ´»ä¸¤ä¸ªçŠ¶æ€ï¼Œçº¿ç¨‹æŸä¸€æ—¦è¢«æ¿€æ´»æ¥åˆ°ç‰‡ä¸Šï¼Œé‚£ä¹ˆä»–å°±ä¸ä¼šå†ç¦»å¼€SMç›´åˆ°æ‰§è¡Œç»“æŸã€‚è€Œæ¯ä¸ªSMä¸Šæœ‰å¤šå°‘ä¸ªçº¿ç¨‹æŸå¤„äºæ¿€æ´»çŠ¶æ€ï¼Œå–å†³äºä»¥ä¸‹èµ„æºï¼š</p>
<ol>
<li>ç¨‹åºè®¡æ•°å™¨</li>
<li>å¯„å­˜å™¨</li>
<li>å…±äº«å†…å­˜</li>
</ol>
<p>ä¸€ä¸ªSMä¸Šè¢«åˆ†é…å¤šå°‘ä¸ªçº¿ç¨‹å—å’Œçº¿ç¨‹æŸå–å†³äºSMä¸­å¯ç”¨çš„å¯„å­˜å™¨å’Œå…±äº«å†…å­˜ï¼Œä»¥åŠå†…æ ¸éœ€è¦çš„å¯„å­˜å™¨å’Œå…±äº«å†…å­˜å¤§å°ã€‚</p>
<p>å½“å¯„å­˜å™¨å’Œå…±äº«å†…å­˜åˆ†é…ç»™äº†çº¿ç¨‹å—ï¼Œè¿™ä¸ªçº¿ç¨‹å—å¤„äºæ´»è·ƒçŠ¶æ€ï¼Œæ‰€åŒ…å«çš„çº¿ç¨‹æŸç§°ä¸ºæ´»è·ƒçº¿ç¨‹æŸã€‚æ´»è·ƒçš„çº¿ç¨‹æŸåˆåˆ†ä¸ºä¸‰ç±»ï¼š</p>
<ul>
<li>é€‰å®šçš„çº¿ç¨‹æŸ</li>
<li>é˜»å¡çš„çº¿ç¨‹æŸ</li>
<li>ç¬¦åˆæ¡ä»¶çš„çº¿ç¨‹æŸ //32ä¸ªCUDAæ ¸å¿ƒå¯ä»¥ç”¨äºæ‰§è¡Œï¼›æ‰§è¡Œæ‰€éœ€è¦çš„èµ„æºå…¨éƒ¨å°±ä½</li>
</ul>
<p>å½“SMè¦æ‰§è¡ŒæŸä¸ªçº¿ç¨‹æŸçš„æ—¶å€™ï¼Œæ‰§è¡Œçš„è¿™ä¸ªçº¿ç¨‹æŸå«åšé€‰å®šçš„çº¿ç¨‹æŸï¼Œå‡†å¤‡è¦æ‰§è¡Œçš„å«ç¬¦åˆæ¡ä»¶çš„çº¿ç¨‹æŸï¼Œå¦‚æœçº¿ç¨‹æŸä¸ç¬¦åˆæ¡ä»¶è¿˜æ²¡å‡†å¤‡å¥½å°±æ˜¯é˜»å¡çš„çº¿ç¨‹æŸã€‚</p>
<h4 id="å…«ã€å»¶è¿Ÿéšè—"><a href="#å…«ã€å»¶è¿Ÿéšè—" class="headerlink" title="å…«ã€å»¶è¿Ÿéšè—"></a>å…«ã€å»¶è¿Ÿéšè—</h4><p>æœ€å¤§åŒ–æ˜¯è¦æœ€å¤§åŒ–ç¡¬ä»¶ï¼Œå°¤å…¶æ˜¯è®¡ç®—éƒ¨åˆ†çš„ç¡¬ä»¶æ»¡è·‘ï¼Œéƒ½ä¸é—²ç€çš„æƒ…å†µä¸‹åˆ©ç”¨ç‡æ˜¯æœ€é«˜çš„ï¼Œæ€»æœ‰äººé—²ç€ï¼Œåˆ©ç”¨ç‡å°±ä¼šä½å¾ˆå¤šï¼Œå³æœ€å¤§åŒ–åŠŸèƒ½å•å…ƒçš„åˆ©ç”¨ç‡ã€‚<strong>åˆ©ç”¨ç‡ä¸å¸¸é©»çº¿ç¨‹æŸç›´æ¥ç›¸å…³ã€‚</strong>ç¡¬ä»¶ä¸­çº¿ç¨‹æŸè°ƒåº¦å™¨è´Ÿè´£è°ƒåº¦çº¿ç¨‹æŸè°ƒåº¦ï¼Œå½“æ¯æ—¶æ¯åˆ»éƒ½æœ‰å¯ç”¨çš„çº¿ç¨‹æŸä¾›å…¶è°ƒåº¦ï¼Œè¿™æ—¶å€™å¯ä»¥è¾¾åˆ°è®¡ç®—èµ„æºçš„å®Œå…¨åˆ©ç”¨ï¼Œä»¥æ­¤æ¥ä¿è¯é€šè¿‡å…¶ä»–å¸¸é©»çº¿ç¨‹æŸä¸­å‘å¸ƒå…¶ä»–æŒ‡ä»¤çš„ï¼Œå¯ä»¥éšè—æ¯ä¸ªæŒ‡ä»¤çš„å»¶è¿Ÿã€‚</p>
<p>å¯¹äºæŒ‡ä»¤çš„å»¶è¿Ÿï¼Œé€šå¸¸åˆ†ä¸ºä¸¤ç§ï¼šç®—æœ¯æŒ‡ä»¤ã€å†…å­˜æŒ‡ä»¤ã€‚</p>
<p>ç®—æ•°æŒ‡ä»¤å»¶è¿Ÿæ˜¯ä¸€ä¸ªç®—æœ¯æ“ä½œä»å¼€å§‹ï¼Œåˆ°äº§ç”Ÿç»“æœä¹‹é—´çš„æ—¶é—´ï¼Œè¿™ä¸ªæ—¶é—´æ®µå†…åªæœ‰æŸäº›è®¡ç®—å•å…ƒå¤„äºå·¥ä½œçŠ¶æ€ï¼Œè€Œå…¶ä»–é€»è¾‘è®¡ç®—å•å…ƒå¤„äºç©ºé—²ã€‚ç®—æœ¯å»¶è¿Ÿ 10~20   ä¸ªæ—¶é’Ÿå‘¨æœŸ</p>
<p>å†…å­˜æŒ‡ä»¤å»¶è¿Ÿå¾ˆå¥½ç†è§£ï¼Œå½“äº§ç”Ÿå†…å­˜è®¿é—®çš„æ—¶å€™ï¼Œè®¡ç®—å•å…ƒè¦ç­‰æ•°æ®ä»å†…å­˜æ‹¿åˆ°å¯„å­˜å™¨ï¼Œè¿™ä¸ªå‘¨æœŸæ˜¯éå¸¸é•¿çš„ã€‚å†…å­˜å»¶è¿Ÿ 400~800 ä¸ªæ—¶é’Ÿå‘¨æœŸ</p>
<p>æ‰€éœ€çº¿ç¨‹æŸ=å»¶è¿ŸÃ—ååé‡</p>
<p>åŒæ ·ï¼Œä¸æŒ‡ä»¤å‘¨æœŸéšè—å»¶è¿Ÿç±»ä¼¼ï¼Œå†…å­˜éšè—å»¶è¿Ÿæ˜¯é å†…å­˜è¯»å–çš„å¹¶å‘æ“ä½œæ¥å®Œæˆçš„ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒæŒ‡ä»¤éšè—çš„å…³é”®ç›®çš„æ˜¯ä½¿ç”¨å…¨éƒ¨çš„è®¡ç®—èµ„æºï¼Œè€Œå†…å­˜è¯»å–çš„å»¶è¿Ÿéšè—æ˜¯ä¸ºäº†ä½¿ç”¨å…¨éƒ¨çš„å†…å­˜å¸¦å®½ï¼Œå†…å­˜å»¶è¿Ÿçš„æ—¶å€™ï¼Œè®¡ç®—èµ„æºæ­£åœ¨è¢«åˆ«çš„çº¿ç¨‹æŸä½¿ç”¨ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸è€ƒè™‘å†…å­˜è¯»å–å»¶è¿Ÿçš„æ—¶å€™è®¡ç®—èµ„æºåœ¨åšäº†ä»€ä¹ˆã€‚</p>
<p>æ‰€ä»¥ï¼Œå»¶è¿Ÿçš„éšè—å–å†³äºæ´»åŠ¨çš„çº¿ç¨‹æŸçš„æ•°é‡ï¼Œæ•°é‡è¶Šå¤šï¼Œéšè—çš„è¶Šå¥½ï¼Œä½†æ˜¯çº¿ç¨‹æŸçš„æ•°é‡åˆå—åˆ°ä¸Šé¢çš„è¯´çš„èµ„æºå½±å“ã€‚æ‰€ä»¥è¿™é‡Œå°±éœ€è¦å¯»æ‰¾æœ€ä¼˜çš„æ‰§è¡Œé…ç½®æ¥è¾¾åˆ°æœ€ä¼˜çš„å»¶è¿Ÿéšè—ã€‚</p>
<h4 id="ä¹ã€åŒæ­¥"><a href="#ä¹ã€åŒæ­¥" class="headerlink" title="ä¹ã€åŒæ­¥"></a>ä¹ã€åŒæ­¥</h4><p>å—çº§åˆ«çš„å°±æ˜¯åŒä¸€ä¸ªå—å†…çš„çº¿ç¨‹ä¼šåŒæ—¶åœæ­¢åœ¨æŸä¸ªè®¾å®šçš„ä½ç½®</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">__syncthread();</span></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/07/03/CUDA-Programmer-Learn-Two/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qiang Chen">
      <meta itemprop="description" content="è®°å½•æ˜¯å¿˜è®°çš„ç¬¬ä¸€åŠ©æ‰‹.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ç¼–è¾‘å°¼æ’‘">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/03/CUDA-Programmer-Learn-Two/" class="post-title-link" itemprop="url">CUDA-Programmer-Learn-Two</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-07-03 23:25:06" itemprop="dateCreated datePublished" datetime="2021-07-03T23:25:06+08:00">2021-07-03</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/07/03/CUDA-Programmer-Learn-One/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qiang Chen">
      <meta itemprop="description" content="è®°å½•æ˜¯å¿˜è®°çš„ç¬¬ä¸€åŠ©æ‰‹.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ç¼–è¾‘å°¼æ’‘">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/03/CUDA-Programmer-Learn-One/" class="post-title-link" itemprop="url">CUDA-Programmer-Learn-One</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-07-03 23:21:18" itemprop="dateCreated datePublished" datetime="2021-07-03T23:21:18+08:00">2021-07-03</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">æ›´æ–°äº</span>
                <time title="ä¿®æ”¹æ—¶é—´ï¼š2021-07-04 00:04:58" itemprop="dateModified" datetime="2021-07-04T00:04:58+08:00">2021-07-04</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CUDA-Programmer/" itemprop="url" rel="index">
                    <span itemprop="name">CUDA Programmer</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="CUDAç¼–ç¨‹å­¦ä¹ ç¬”è®°"><a href="#CUDAç¼–ç¨‹å­¦ä¹ ç¬”è®°" class="headerlink" title="CUDAç¼–ç¨‹å­¦ä¹ ç¬”è®°"></a>CUDAç¼–ç¨‹å­¦ä¹ ç¬”è®°</h2><p>æœ¬ç¬”è®°ä¸»è¦<a href="https://face2ai.com/program-blog/#GPU%E7%BC%96%E7%A8%8B%EF%BC%88CUDA%EF%BC%89" target="_blank" rel="noopener">å‚è€ƒ: è°­å‡</a>å¤§ç¥çš„åšå®¢è¿›è¡Œäº†éƒ¨åˆ†å…³é”®çŸ¥è¯†çš„æ‘˜å½•ï¼Œå¯èƒ½æœ‰äº›åœ°æ–¹å›å»å•ç‹¬æŸ¥æ‰¾ä¸€äº›èµ„æ–™è¿›è¡Œè§£é‡Šã€‚</p>
<h4 id="ä¸€ã€ç¼–ç¨‹æ¨¡å‹"><a href="#ä¸€ã€ç¼–ç¨‹æ¨¡å‹" class="headerlink" title="ä¸€ã€ç¼–ç¨‹æ¨¡å‹"></a>ä¸€ã€ç¼–ç¨‹æ¨¡å‹</h4><p>1ã€ <strong>ç®€å•ä»‹ç»çº¿ç¨‹å±‚çº§ï¼š</strong>CUDAç¼–ç¨‹æ˜¯ä¸€ä¸ªå¤šçº¿ç¨‹ç¼–ç¨‹ï¼Œæ•°ä¸ªçº¿ç¨‹(Thread)ç»„æˆä¸€ä¸ªçº¿ç¨‹å—(Block)ï¼Œæ‰€æœ‰çº¿ç¨‹å—ç»„æˆä¸€ä¸ªçº¿ç¨‹ç½‘æ ¼(Grid)ã€‚ç›®å‰çš„GPUé™åˆ¶ä¸€ä¸ª<strong>çº¿ç¨‹å—</strong>ä¸­ï¼Œæœ€å¤šå¯ä»¥å®‰æ’1024ä¸ªçº¿ç¨‹ã€‚ç”±äº<strong>32ä¸ªç›¸é‚»çš„çº¿ç¨‹ä¼šç»„æˆä¸€ä¸ªçº¿ç¨‹æŸ</strong>(Thread Warp)ï¼Œè€Œä¸€ä¸ªçº¿ç¨‹æŸä¸­çš„çº¿ç¨‹ä¼šè¿è¡ŒåŒæ ·çš„æŒ‡ä»¤ã€‚å› æ­¤ä¸€èˆ¬çº¿ç¨‹å—ä¸­çº¿ç¨‹çš„æ•°é‡è¢«å®‰æ’ä¸º32çš„å€æ•°ï¼Œé€‰ç”¨256æ˜¯æ¯”è¾ƒåˆé€‚çš„ã€‚</p>
<p>2ã€<strong>å†…æ ¸å‡½æ•°ï¼š</strong>CUDAæ¯ä¸ªçº¿ç¨‹æ‰§è¡Œçš„å‡½æ•°ã€‚å…³é”®å­—ä¸ºglobalï¼Œè¿”å›å€¼çš„å…³é”®å­—ä¸ºvoidã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//kernal definition</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function">__global__ <span class="keyword">void</span> <span class="title">vecAdd</span><span class="params">(<span class="keyword">float</span>* A, <span class="keyword">float</span>* B, <span class="keyword">float</span>* C)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> i=threadId.x;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    C[i]=A[i]+B[i];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    vecAdd&lt;&lt;&lt;<span class="number">1</span>, N&gt;&gt;&gt;(A, B, C);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="function">__global__ <span class="keyword">void</span> <span class="title">matAdd</span><span class="params">(<span class="keyword">float</span> A[N][N], <span class="keyword">float</span> B[N][N], <span class="keyword">float</span> C[N][N])</span></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//blockDimä»£è¡¨å½“å‰çº¿ç¨‹å—çš„å°ºå¯¸</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> i = blockIdx.x * blockDim.x + threadIdx.x;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> j = blockIdx.y * blockDim.y + threadIdx.y;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(i &lt; N &amp;&amp; j &lt; N)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">        C[j][i] = A[j][i] + B[j][i]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> main()&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    dim3 threadsPerBlock(<span class="number">16</span>,<span class="number">16</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    <span class="function">dim3 <span class="title">numBlocks</span><span class="params">(N / threadsPerBlock.x, N / threadsPerBlock.y)</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    matAdd&lt;&lt;&lt;numBlocks, threadsPerBlock&gt;&gt;&gt;(A, B, C);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p><strong>SIMTï¼Œç›¸åŒæŒ‡ä»¤ï¼Œä¸åŒçº¿ç¨‹</strong></p>
<p>3ã€<strong>å†…å­˜å±‚çº§ï¼š</strong>ä¸€èˆ¬ä¸»æœºç«¯å†…å­˜é€šè¿‡PCI-Eæ€»çº¿ä¸è®¾å¤‡ç«¯å†…å­˜äº¤æ¢æ•°æ®ã€‚æ•°æ®äº¤æ¢çš„é€Ÿåº¦ç­‰äºPCI-Eæ€»çº¿çš„é€Ÿåº¦ã€‚</p>
<ol>
<li>å¯„å­˜å™¨å’Œæœ¬åœ°å†…å­˜ç»‘å®šåˆ°äº†æ¯ä¸ªçº¿ç¨‹ï¼Œå…¶ä»–çº¿ç¨‹æ— æ³•è®¿é—®ã€‚</li>
<li>åŒä¸€ä¸ªçº¿ç¨‹å—å†…çš„çº¿ç¨‹ï¼Œå¯ä»¥è®¿é—®åŒä¸€å—å…±äº«å†…å­˜ã€‚æ³¨æ„ï¼Œå³ä½¿ä¸¤ä¸ªçº¿ç¨‹å—è¢«è°ƒåº¦åˆ°äº†åŒä¸€ä¸ªSMä¸Šï¼Œä»–ä»¬çš„å…±äº«å†…å­˜ä¹Ÿæ˜¯éš”ç¦»å¼€çš„ï¼Œä¸èƒ½äº’ç›¸è®¿é—®ã€‚</li>
<li>ç½‘æ ¼ä¸­çš„æ‰€æœ‰çº¿ç¨‹éƒ½å¯ä»¥è‡ªç”±è¯»å†™å…¨å±€å†…å­˜ã€‚</li>
<li>å¸¸é‡å†…å­˜å’Œçº¹ç†å†…å­˜åªèƒ½è¢«CPUç«¯ä¿®æ”¹ï¼ŒGPUå†…çš„çº¿ç¨‹åªèƒ½è¯»å–æ•°æ®ã€‚</li>
</ol>
<p>4ã€<strong>CPU/GPUæ··åˆç¼–ç¨‹ï¼š</strong></p>
<p>CPUå’ŒGPUçš„å†…å­˜æ˜¯ç‹¬ç«‹çš„ï¼Œå¦‚ä½•åœ¨ä¸¤è€…ä¹‹é—´å…±äº«æ•°æ®ã€‚</p>
<ul>
<li>ä¸»æœºç«¯(Hostï¼Œå³CPU)æ‰§è¡Œä¸²è¡Œä»£ç ï¼Œç„¶åè°ƒç”¨å†…æ ¸å‡½æ•°ï¼Œè®©è®¾å¤‡ç«¯(Deviceï¼Œå³GPU)æ‰§è¡Œå¹¶è¡Œä»£ç ã€‚å¦‚æ­¤äº¤é”™æ‰§è¡Œã€‚<ul>
<li>ä¸€ã€å› æ­¤åœ¨è¿è¡Œå†…æ ¸å‡½æ•°å‰ï¼Œä¸»æœºç«¯éœ€è¦è°ƒç”¨å†…å­˜æ‹·è´å‡½æ•°ï¼Œå°†æ•°æ®é€šè¿‡PCI-Eæ€»çº¿æ‹·è´åˆ°è®¾å¤‡ç«¯ã€‚å†…æ ¸è¿è¡Œç»“æŸåï¼Œéœ€è¦CPUå†æ¬¡è°ƒç”¨å†…å­˜æ‹·è´å‡½æ•°ï¼Œå°†æ•°æ®æ‹·å›ä¸»æœºç«¯å†…å­˜ã€‚</li>
<li>äºŒã€ä½¿ç”¨ç»Ÿä¸€ç¼–å€ï¼Œå°†è®¾å¤‡ç«¯çš„å†…å­˜å’Œä¸»æœºç«¯å†…å­˜ç¼–åˆ°ä¸€èµ·ã€‚è¿™æ ·ä¸»æœºå°±ä¸éœ€è¦æ˜¾å¼çš„è°ƒç”¨å‡½æ•°å°†æ•°æ®æ‹·è´åˆ°è®¾å¤‡ç«¯å†…å­˜äº†ã€‚</li>
</ul>
</li>
<li>é™¤äº†CPU/GPUäº¤é”™æ‰§è¡Œä»£ç çš„æ–¹å¼å¤–ï¼Œè¿˜å¯ä»¥é€šè¿‡ä½¿ç”¨äº‹ä»¶(event)å’Œæµ(stream)ç­‰æ–¹å¼ï¼Œè®©CPU/GPUå¹¶è¡Œå·¥ä½œï¼Œæå‡æ•´ä½“çš„æ•ˆç‡ã€‚</li>
</ul>
<p>5ã€<strong>è®¡ç®—èƒ½åŠ›ï¼š</strong>æŒ‡ä¸åŒçš„GPUç‰ˆæœ¬ï¼Œæ¯ä¸ªç‰ˆæœ¬å…·æœ‰ä¸åŒçš„ç‰¹æ€§ï¼Œç¼–ç¨‹ä¹Ÿä¼šæœ‰æ‰€å·®å¼‚ã€‚CUDAçš„ç‰ˆæœ¬ä¸è®¡ç®—èƒ½åŠ›æ²¡æœ‰å…³ç³»ï¼Œåªæ˜¯è¡¨ç¤ºå¯¹ä¸åŒæ¶æ„çš„æ”¯æŒã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//CPUã€OpenCVã€CUDAåˆ†åˆ«æ‰§è¡Œå›¾åƒç°åº¦è½¬æ¢</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;iostream&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span><span class="meta-string">&lt;time.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"opencv2/highgui.hpp"</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"opencv2/opencv.hpp"</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> cv;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> <span class="built_in">std</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//CPUè½¬æ¢</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="function">Mat <span class="title">cpuConvertGray</span><span class="params">(Mat src, <span class="keyword">int</span> <span class="built_in">height</span>, <span class="keyword">int</span> <span class="built_in">width</span>)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    Mat outImg = zeros(imgHeight, imgWidth, CV_8UC1, Scalar(<span class="number">0</span>));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> y=<span class="number">0</span>; y&lt;<span class="built_in">height</span>; ++y)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> x=<span class="number">0</span>; x&lt;<span class="built_in">width</span>; ++x)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">            outImg.at&lt;uchar&gt;(y,x) = <span class="number">0.2126</span> * (<span class="keyword">float</span>)src.at&lt;Vec3b&gt;(y,x)[<span class="number">2</span>] + \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">                <span class="number">0.7152</span> * (<span class="keyword">float</span>)src.at&lt;Vec3b&gt;(y,x)[<span class="number">1</span>] + \</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">                <span class="number">0.0722</span> * (<span class="keyword">float</span>)src.at&lt;Vec3b&gt;(y,x)[<span class="number">0</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> outImg;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//OpenCVè½¬æ¢</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"><span class="function">Mat <span class="title">openCvtGray</span><span class="params">(Mat src)</span></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    Mat out;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    cvtColor(src, out, COLOR_BGR2GRAY);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> out;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//CUDAè½¬æ¢</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line"><span class="function">__global__ <span class="keyword">void</span> <span class="title">gpuConvertGray</span><span class="params">(uchar3* <span class="keyword">const</span> input, <span class="keyword">unsigned</span> <span class="keyword">char</span>* output, <span class="keyword">int</span> <span class="built_in">height</span>, <span class="keyword">int</span> <span class="built_in">width</span>)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> idx = blockIdx.x * blockDim.x + threadIdx.x;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">int</span> idy = blockIdx.y * blockDim.y + threadIdy.y;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(idx &lt; <span class="built_in">width</span> &amp;&amp; idy &lt; <span class="built_in">height</span>)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">        uchar3 rgbImg = input[idy*<span class="built_in">width</span>+idx];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">        output[idy*<span class="built_in">width</span>+idx]=<span class="number">0.299f</span> * rgb.x + <span class="number">0.587f</span> * rgb.y + <span class="number">0.114f</span> * rgb.z;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span> </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">clock_t</span> start, <span class="built_in">end</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">    Mat srcImg = imread(imagePath);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> imgHeight = srcImg.rows;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">const</span> <span class="keyword">int</span> imgWidth = srcImg.cols;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">    Mat grayImg = zeros(imgHeight, imgWidth, CV_8UC1, Scalar(<span class="number">0</span>));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line">    start = clock();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//åœ¨CPUä¸Šè¿›è¡Œå›¾åƒç°åº¦è½¬åŒ–</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line">    grayImg = cpuConvertGray(srcImg, imgHeight, imgWidth);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">end</span> = clock();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">printf</span>(<span class="string">"Cpu exec time is %.8f\n"</span>, (<span class="keyword">double</span>)(<span class="built_in">end</span>-start)/CLOCKS_PER_SEC);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">54</span></pre></td><td class="code"><pre><span class="line">   </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">55</span></pre></td><td class="code"><pre><span class="line">    Mat outImg = zeros(imgHeight, imgWidth, CV_8UC1, Scalar(<span class="number">0</span>));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">56</span></pre></td><td class="code"><pre><span class="line">    uchar3* input;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">57</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>* output;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">58</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">59</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//ä½¿ç”¨opencvè½¬åŒ–</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">60</span></pre></td><td class="code"><pre><span class="line">    start = clock();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">61</span></pre></td><td class="code"><pre><span class="line">    grayImg = openCvtGray(srcImg);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">62</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">end</span> = clock();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">63</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">printf</span>(<span class="string">"OpenCV exec time is %.8f\n"</span>, (<span class="keyword">double</span>)(<span class="built_in">end</span>-start)/CLOCKS_PER_SEC);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">64</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">65</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//åœ¨GPUä¸Šåˆ†é…å†…å­˜</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">66</span></pre></td><td class="code"><pre><span class="line">    cudaMalloc((<span class="keyword">void</span>**)&amp;input, <span class="built_in">height</span>*<span class="built_in">width</span>*<span class="keyword">sizeof</span>(uchar3));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">67</span></pre></td><td class="code"><pre><span class="line">    cudaMalloc((<span class="keyword">void</span>**)&amp;output, <span class="built_in">height</span>*<span class="built_in">width</span>*<span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> <span class="keyword">char</span>));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">68</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//å°†å›¾åƒæ•°æ®ä»hostæ‹·è´åˆ°gpuä¸Š</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">69</span></pre></td><td class="code"><pre><span class="line">    cudaMemcpy(input, src.data, <span class="built_in">height</span>*<span class="built_in">width</span>*<span class="keyword">sizeof</span>(uchar3), cudaMemcpyHostToDevice);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">70</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">71</span></pre></td><td class="code"><pre><span class="line">    <span class="function">dim3 <span class="title">threadsPerBlock</span><span class="params">(<span class="number">32</span>, <span class="number">32</span>)</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">72</span></pre></td><td class="code"><pre><span class="line">    <span class="function">dim3 <span class="title">blocksPerGrid</span><span class="params">((imgWidth+threadsPerBlock.x<span class="number">-1</span>) / threadsPerBlock.x, \</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">73</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="params">                       (imgHeight+threadsPerBlock.y<span class="number">-1</span>) / threadsPerBlock.y)</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">74</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">75</span></pre></td><td class="code"><pre><span class="line">    start = clock();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">76</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">77</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//å¯åŠ¨å†…æ ¸</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">78</span></pre></td><td class="code"><pre><span class="line">    gpuConvertGray&lt;&lt;&lt;blocksPerGrid, threadsPerBlock&gt;&gt;&gt;(input, output, imgHeight, imgWidth);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">79</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//æ‰§è¡Œä¸€ä¸ªå†…æ ¸æ˜¯ä¸€ä¸ªå¼‚æ­¥æ“ä½œï¼Œå› æ­¤éœ€è¦åŒæ­¥ç»Ÿè®¡æ—¶é—´</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">80</span></pre></td><td class="code"><pre><span class="line">    cudaDeviceSynchronize();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">81</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">end</span> = clock();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">82</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">83</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">printf</span>(<span class="string">"Cuda exec time is %.8f\n"</span>, (<span class="keyword">double</span>)(<span class="built_in">end</span>-start)/CLOCKS_PER_SEC);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">84</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">85</span></pre></td><td class="code"><pre><span class="line">    cudaMemcpy(grayImg.data, output, imgHeight*imgWidth*<span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> <span class="keyword">char</span>), cudaMemcpyDeviceToHost);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">86</span></pre></td><td class="code"><pre><span class="line">    cudaFree(input);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">87</span></pre></td><td class="code"><pre><span class="line">	cudaFree(output);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">88</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">89</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">90</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p>6ã€<strong>NVCCç¼–è¯‘å™¨ç¼–è¯‘CUDAç¨‹åº</strong></p>
<p>NVCCæä¾›äº†ç®€å•æ–¹ä¾¿çš„æ¥å£ï¼Œèƒ½å¤Ÿå¾ˆå¥½çš„åŒæ—¶å¤„ç†ä¸»æœºç«¯å’Œè®¾å¤‡ç«¯ä»£ç ã€‚</p>
<ul>
<li><p>ç¦»çº¿ç¼–è¯‘</p>
<p><em>åˆ†ç¦»CUDAç¨‹åºä¸­çš„ä¸»æœºç«¯ä»£ç (host code)å’Œè®¾å¤‡ç«¯ä»£ç (device code)</em>  å°†è®¾å¤‡ç«¯ä»£ç ç¼–è¯‘æˆä¸€ç§è™šæ‹Ÿæ±‡ç¼–æ–‡ä»¶(åä¸ºPTX)ï¼Œå†æ¥ç€ç¼–è¯‘æˆäºŒè¿›åˆ¶ä»£ç (åä¸ºcubin) ï¼Œå°†ä¸»æœºç«¯ä»£ç ä¸­å«æœ‰â€&lt;&lt;&lt;&gt;&gt;&gt;â€çš„ä»£ç (å³å†…æ ¸è°ƒç”¨)æ›¿æ¢ä¸ºCUDAè¿è¡Œåº“ä¸­çš„å‡½æ•°è°ƒç”¨ä»£ç ã€‚ä¹‹åNVCCä¼šå€ŸåŠ©å…¶ä»–ç¼–è¯‘å™¨(å¦‚gcc)å°†ä¸»æœºç«¯ä»£ç ç¼–è¯‘å‡ºæ¥ï¼Œä¸»æœºç«¯ä»£ç å’Œè®¾å¤‡ç«¯ä»£ç è¢«ç¼–è¯‘å¥½åï¼Œnvccä¼šå°†ä¸¤æ®µä»£ç é“¾æ¥èµ·æ¥ã€‚</p>
</li>
<li><p>åœ¨çº¿ç¼–è¯‘</p>
<p>PTXæ˜¯ä¸€ä¸ªè™šæ‹Ÿæ±‡ç¼–æ–‡ä»¶ã€‚å…¶å½¢å¼è™½ç„¶å¾ˆåƒæ±‡ç¼–ï¼Œä½†é‡Œé¢çš„æ¯ä¸€æ¡æŒ‡ä»¤å®é™…ä¸Šæ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„æŒ‡ä»¤ï¼Œä¸æœºå™¨ç æ— æ³•å¯¹åº”ã€‚éœ€è¦ç¼–è¯‘å™¨æˆ–è®¾å¤‡é©±åŠ¨ç¨‹åºå°†å…¶ç¿»è¯‘æˆå¯¹åº”å¹³å°çš„æ±‡ç¼–/æœºå™¨ç æ‰èƒ½è¿è¡Œã€‚</p>
<p>å¦‚æœåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­ï¼ŒNVCCä¸å°†è®¾å¤‡ç«¯ä»£ç ç¼–è¯‘ä¸ºcubinæ–‡ä»¶ï¼Œå³äºŒè¿›åˆ¶ä»£ç ï¼Œè€Œæ˜¯åœåœ¨PTXä»£ç ä¸Šã€‚è®¾å¤‡é©±åŠ¨(device  driver)ä¼šè´Ÿè´£åœ¨è¿è¡Œæ—¶ï¼Œä½¿ç”¨PTXä»£ç ç”ŸæˆäºŒè¿›åˆ¶ä»£ç ã€‚è¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä½œåœ¨çº¿ç¼–è¯‘(JIT Compilation, Just-In-Time  Compilation)ã€‚</p>
<p>åœ¨çº¿ç¼–è¯‘å¿…ç„¶ä¼šä½¿å¾—ç¨‹åºå¯åŠ¨çš„æ—¶é—´å»¶é•¿ï¼Œä¸è¿‡è®¾å¤‡é©±åŠ¨ç¨‹åºä¼šè‡ªåŠ¨ç¼“å­˜ç¼–è¯‘å‡ºæ¥çš„äºŒè¿›åˆ¶ä»£ç (ä¹Ÿè¢«ç§°ä½œcompute cache)ã€‚</p>
</li>
</ul>
<p>7ã€<strong>CUDA Cè¿è¡Œåº“</strong></p>
<p>7.1 åˆå§‹åŒ–ï¼šCUDAè¿è¡Œåº“æ²¡æœ‰æ˜¾å¼çš„åˆå§‹åŒ–å‡½æ•°ï¼Œåœ¨è°ƒç”¨ç¬¬ä¸€ä¸ªå‡½æ•°æ—¶ä¼šè‡ªåŠ¨åˆå§‹åŒ–(è®¾å¤‡å’Œç‰ˆæœ¬ç®¡ç†å‡½æ•°ä¸è¡Œ)ã€‚åˆå§‹åŒ–æ—¶ï¼Œä¼šäº§ç”Ÿä¸€ä¸ªå…¨å±€å¯è§çš„è®¾å¤‡ä¸Šä¸‹æ–‡(device context)ã€‚ä¸»æœºç«¯ä»£ç è°ƒç”¨äº†<code>cudaDeviceReset()</code>å‡½æ•°ï¼Œåˆ™ä¼šé”€æ¯æ‰è¿™ä¸ªä¸Šä¸‹æ–‡ã€‚æ³¨æ„ï¼Œé”€æ¯çš„ä¸Šä¸‹æ–‡æ˜¯ä¸»æœºç«¯æ­£åœ¨æ“çºµçš„è®¾å¤‡ã€‚å¦‚è¦æ›´æ¢ï¼Œéœ€è¦ä½¿ç”¨<code>cudaSetDevice()</code>æ¥è¿›è¡Œåˆ‡æ¢ã€‚</p>
<p>7.2 è®¾å¤‡å†…å­˜ï¼š</p>
<p>CUDAè¿è¡Œåº“æä¾›äº†å‡½æ•°ä»¥åˆ†é…/é‡Šæ”¾è®¾å¤‡ç«¯çš„å†…å­˜(å…¨å±€å†…å­˜+å¸¸é‡å†…å­˜+çº¹ç†å†…å­˜)ï¼Œä»¥åŠä¸ä¸»æœºç«¯å†…å­˜ä¼ è¾“æ•°æ®ã€‚</p>
<ul>
<li><p>çº¿æ€§å­˜å‚¨(linear memory)ï¼šåœ¨GPUä¸Šç”¨40ä½çš„åœ°å€çº¿å¯»å€</p>
<p>çº¿æ€§å†…å­˜å¯ä»¥ç”¨<code>cudaMalloc()</code>åˆ†é…ï¼Œç”¨<code>cudaFree()</code>é‡Šæ”¾ï¼Œç”¨<code>cudaMemcpy()</code>å¤åˆ¶æ•°æ®ï¼Œç”¨<code>cudaMemset()</code>èµ‹å€¼ã€‚</p>
<p>å¯¹äº2Dæˆ–3Dæ•°ç»„ï¼Œå¯ä»¥ä½¿ç”¨<code>cudaMallocPitch()</code>å’Œ<code>cudaMalloc3D()</code>æ¥åˆ†é…å†…å­˜ã€‚è¿™ä¸¤ä¸ªå‡½æ•°ä¼šè‡ªåŠ¨paddingï¼Œä»¥æ»¡è¶³å†…å­˜å¯¹é½çš„è¦æ±‚ï¼Œæé«˜å†…å­˜è¯»å†™æ•ˆç‡ã€‚</p>
</li>
<li><p>CUDA arraysâ€”ä¸çº¹ç†å†…å­˜æœ‰å…³</p>
</li>
</ul>
<p>åœ¨è®¾å¤‡å†…å­˜ä¸­å®šä¹‰å…¨å±€å˜é‡ï¼Œåˆ™éœ€è¦ä½¿ç”¨ä½¿ç”¨<code>__constant__</code>æˆ–<code>__device__</code>æ¥ä¿®é¥°ï¼Œå¹¶ä½¿ç”¨<code>cudaMemcpyToSymbol()</code>å’Œ<code>cudaMemcpyFromSymbol()</code>æ¥è¯»å†™ã€‚</p>
<p>å®é™…ä¸Šï¼Œå½“ä½¿ç”¨<code>__constant__</code>å…³é”®å­—æ—¶ï¼Œæ˜¯ç”³è¯·äº†ä¸€å—å¸¸é‡å†…å­˜ï¼›è€Œä½¿ç”¨<code>__device__</code>æ—¶ï¼Œæ˜¯æ™®é€šçš„å…¨å±€å†…å­˜ã€‚å› æ­¤<code>__device__</code>ç”³è¯·çš„å†…å­˜éœ€è¦ç”³è¯·ï¼Œè€Œ<code>__constant__</code>ä¸ç”¨ã€‚ä¸ç®¡æ˜¯å…¨å±€å†…å­˜ï¼Œè¿˜æ˜¯å¸¸é‡å†…å­˜ï¼Œéœ€è¦ç”¨å¸¦æœ‰<code>Symbol</code>çš„å‡½æ•°æ‹·è´ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">__constant__ <span class="keyword">float</span> constData[<span class="number">256</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">float</span> data[<span class="number">256</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">cudaMemcpyToSymbol(&amp;constData, data, <span class="keyword">sizeof</span>(data));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">cudaMemcpyFromSymbol(&amp;data, constData, <span class="keyword">sizeof</span>(data));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">__device__ <span class="keyword">float</span> devData;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">float</span> value = <span class="number">3.14f</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">cudaMemcpyToSymbol(devData, &amp;value, <span class="keyword">sizeof</span>(<span class="keyword">float</span>));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">__device__ <span class="keyword">float</span>* devPtr;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">float</span>* ptr;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">cudaMalloc(&amp;ptr, <span class="number">256</span>*<span class="keyword">sizeof</span>(<span class="keyword">float</span>));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">cudaMemcpyToSymbol(devPtr, &amp;ptr, <span class="keyword">sizeof</span>(ptr));</span></pre></td></tr></table></figure>
<p>8ã€<strong>å…±äº«å†…å­˜</strong></p>
<p>ä¸ç®¡æ˜¯å…¨å±€å˜é‡è¿˜æ˜¯å±€éƒ¨å˜é‡ï¼Œéƒ½éœ€è¦ä½¿ç”¨<code>__shared__</code>æ¥ä¿®é¥°ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå³ä½¿å®šä¹‰ä¸ºå…¨å±€å˜é‡ï¼Œå…±äº«å†…å­˜ä¾æ—§åªèƒ½è¢«åŒä¸€çº¿ç¨‹å—å†…çš„çº¿ç¨‹å¯è§ã€‚ä½†æ˜¯æ³¨æ„ï¼Œå¹¶ä¸æ˜¯ä»€ä¹ˆæ—¶å€™éƒ½å¯ä»¥ä½¿ç”¨å…±äº«å†…å­˜æ¥è·å–åŠ é€Ÿçš„ã€‚ä¾‹å¦‚å†…æ ¸å‡½æ•°è®¡ç®—å‡ºæ¥ç»“æœåï¼Œå¦‚æœè¿™ä¸ªç»“æœåªéœ€è¦ä¼ è¾“å›ä¸»æœºç«¯ï¼Œè€Œä¸éœ€è¦å†æ¬¡è¢«ç”¨åˆ°æ—¶ï¼Œç›´æ¥å†™å›å…¨å±€å†…å­˜ä¼šæ¯”è¾ƒå¿«ã€‚å¦‚æœå…ˆå†™å›å…±äº«å†…å­˜ï¼Œå†å†™å›å…¨å±€å†…å­˜ï¼Œåè€Œä¼šæ¯”è¾ƒç¼“æ…¢ã€‚ä¸€èˆ¬æ¥è®²ï¼Œå½“éœ€è¦é¢‘ç¹è¯»å†™ï¼Œæˆ–æ˜¯æœ‰åŸå­æ“ä½œæ—¶ï¼Œä½¿ç”¨å…±äº«å†…å­˜æ›¿ä»£å…¨å±€å†…å­˜ï¼Œä¼šå–å¾—æ¯”è¾ƒå¤§çš„å¢ç›Šã€‚</p>
<p><strong>å…±äº«å†…å­˜åªèƒ½ä¸ºçº¿ç¨‹å—å†…çš„çº¿ç¨‹å…±äº«ã€‚å¦‚æœéœ€è¦æ•´ä¸ªçº¿ç¨‹ç½‘æ ¼ä¸­çº¿ç¨‹éƒ½èƒ½è®¿é—®ï¼Œåˆ™éœ€è¦å…¨å±€å†…å­˜æˆ–å¸¸é‡å†…å­˜ã€‚</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç›´æ–¹å›¾ç»Ÿè®¡</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">__shared__ <span class="keyword">unsigned</span> <span class="keyword">char</span> hist_shared[<span class="number">256</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="function">__global__ <span class="keyword">void</span> <span class="title">getGrayHistByCudaUsingSharedMem</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span> * <span class="keyword">const</span> grayData,</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="params">                                               <span class="keyword">unsigned</span> <span class="keyword">int</span> * <span class="keyword">const</span> hist,</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="params">                                               uint imgheight,</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="params">                                               uint imgwidth)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p>9ã€<strong>é”é¡µå†…å­˜</strong></p>
<p>é”é¡µå†…å­˜æŒ‡çš„æ˜¯ä¸»æœºç«¯ä¸Šä¸ä¼šè¢«æ¢å‡ºåˆ°è™šæ‹Ÿå†…å­˜(ä½äºç¡¬ç›˜)ä¸Šçš„å†…å­˜ã€‚</p>
<p>é”é¡µå†…å­˜çš„åˆ†é…ä¸é‡Šæ”¾ï¼šåœ¨CUDAç¨‹åºä¸­ï¼Œä½¿ç”¨<code>cudaHostAlloc()</code>ï¼Œå¯ä»¥åˆ†é…é”é¡µå†…å­˜ï¼Œä½¿ç”¨<code>cudaFreeHost()</code>æ¥é‡Šæ”¾é”é¡µå†…å­˜ï¼Œæˆ–è€…ä½¿ç”¨<code>cudaHostRegister()</code>æ¥å°†<code>malloc()</code>åˆ†é…çš„å†…å­˜æŒ‡å®šä¸ºé”é¡µå†…å­˜ã€‚</p>
<p>10ã€<strong>åˆå¹¶å†™å†…å­˜(Write-Combining Memory)</strong></p>
<p>11ã€<strong>å¼‚æ­¥å¹¶è¡Œæ‰§è¡Œ</strong></p>
<ul>
<li><p>ä¸»æœºç«¯/è®¾å¤‡ç«¯å¹¶è¡Œï¼š</p>
<ul>
<li>å†…æ ¸å¯åŠ¨ä¸æ‰§è¡Œ</li>
<li>è®¾å¤‡ç«¯å†…éƒ¨ä¼ è¾“æ•°æ®</li>
<li>ä½¿ç”¨æµæˆ–å†…å­˜æ˜ å°„ä¼ è¾“æ•°æ®</li>
<li>è®¾å¤‡ç«¯memsetå‡½æ•°cudaMemset())</li>
</ul>
</li>
<li><p>å†…æ ¸å¹¶è¡Œæ‰§è¡Œ</p>
<ul>
<li>è®¡ç®—èƒ½åŠ›2.xåŠä»¥ä¸Šçš„è®¾å¤‡ï¼Œæ”¯æŒå¤šä¸ªå†…æ ¸å‡½æ•°åŒæ—¶æ‰§è¡Œã€‚</li>
<li>æ‰§è¡Œå¤šä¸ªå†…æ ¸å‡½æ•°ï¼Œéœ€è¦ä¸»æœºç«¯ä¸åŒçš„çº¿ç¨‹å¯åŠ¨ã€‚å¦‚æœä¸€ä¸ªçº¿ç¨‹ä¾æ¬¡å¯åŠ¨å¤šä¸ªå†…æ ¸ï¼Œåˆ™è¿™äº›å†…æ ¸ä¼šä¸²è¡Œæ‰§è¡Œã€‚åŒä¸€çº¿ç¨‹çš„å†…æ ¸å‡½æ•°è¿”å›æ—¶ä¼šè§¦å‘éšå¼çš„åŒæ­¥ã€‚</li>
<li>å¤šä¸ªå†…æ ¸å‡½æ•°å¿…é¡»ä½äºåŒä¸€ä¸ªCUDAä¸Šä¸‹æ–‡(CUDA context)ä¸Šã€‚ä¸åŒCUDAä¸Šä¸‹æ–‡ä¸Šçš„å†…æ ¸ä¸èƒ½å¹¶è¡Œã€‚</li>
</ul>
</li>
<li><p>æ•°æ®ä¼ è¾“å’Œå†…æ ¸æ‰§è¡Œå¹¶è¡Œ(éœ€è¦ä½¿ç”¨é”é¡µå†…å­˜)</p>
<ul>
<li>ä¸€äº›è®¾å¤‡æ”¯æŒæ•°æ®ä¼ è¾“(ä¸»æœºç«¯/è®¾å¤‡ç«¯ã€è®¾å¤‡ç«¯/è®¾å¤‡ç«¯)å’Œå†…æ ¸æ‰§è¡Œå¹¶è¡Œï¼Œå¯é€šè¿‡æ£€æŸ¥<code>asyncEngineCount</code>æ¥ç¡®è®¤ã€‚</li>
</ul>
</li>
<li><p>æ•°æ®ä¼ å…¥æ ¸ä¼ å‡ºå¹¶è¡Œ</p>
</li>
<li><p>æµ(stream)</p>
<p>å¯ä»¥é€šè¿‡<code>cudaStreamCreateWithPriority()</code>æ¥åœ¨åˆ›å»ºæµæ—¶æŒ‡å®šæµçš„ä¼˜å…ˆçº§ã€‚å¯ä»¥æŒ‡å®šçš„ä¼˜å…ˆçº§å¯ç”±<code>cudaDeviceGetStreamPriorityRange()</code>æ¥è·å¾—ã€‚</p>
<p>è¿è¡Œæ—¶ï¼Œé«˜ä¼˜å…ˆçº§streamä¸­çš„çº¿ç¨‹å—ä¸èƒ½æ‰“æ–­æ­£åœ¨æ‰§è¡Œçš„ä½ä¼˜å…ˆçº§streamçš„çº¿ç¨‹å—(å³ä¸æ˜¯æŠ¢å å¼çš„)ã€‚ä½†æ˜¯å½“ä½ä¼˜å…ˆçº§streamçš„çº¿ç¨‹å—é€€å‡ºSMæ—¶ï¼Œé«˜ä¼˜å…ˆçº§streamä¸­çš„çº¿ç¨‹å—ä¼šè¢«ä¼˜å…ˆè°ƒåº¦è¿›SMã€‚</p>
<ul>
<li>åœ¨CUDAä¸­ï¼Œæµ(streams)æŒ‡çš„æ˜¯åœ¨GPUä¸Šä¸€è¿ä¸²æ‰§è¡Œçš„å‘½ä»¤ã€‚</li>
<li>ä¸åŒçš„çº¿ç¨‹ï¼Œå¯ä»¥å‘åŒä¸€ä¸ªæµå¡«å…¥ä»»åŠ¡ã€‚</li>
<li>åŒä¸€ä¸ªæµå†…çš„ä»»åŠ¡ä¼šæŒ‰é¡ºåºæ‰§è¡Œã€‚</li>
<li>åŒä¸€è®¾å¤‡ä¸Šä¸åŒçš„æµæœ‰å¯èƒ½å¹¶è¡Œï¼Œå…¶æ‰§è¡Œé¡ºåºä¸ä¼šæœ‰ä¿è¯ã€‚</li>
</ul>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//æµçš„åˆ›å»ºå’Œé”€æ¯</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">cudaStream_t stream[<span class="number">2</span>];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">2</span>; i++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    cudaStreamCreate(&amp;stream[i]);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">2</span>; i++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    cudaStreamDestroy(stream[i]);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//å½“è®¾å¤‡è¿˜åœ¨æ‰§è¡Œæµä¸­çš„ä»»åŠ¡ï¼Œè€Œç”¨æˆ·è°ƒç”¨cudaStreamDestroy()å‡½æ•°æ—¶ï¼Œå‡½æ•°ä¼šç«‹åˆ»æ‰§è¡Œ(ä¸ä¼šé˜»å¡)ã€‚ä¹‹åï¼Œå½“æµä¸­çš„ä»»åŠ¡å®Œæˆåï¼Œä¸æµç›¸å…³çš„èµ„æºä¼šè‡ªåŠ¨é‡Šæ”¾ã€‚</span></span></pre></td></tr></table></figure>
<p>12ã€<strong>æ˜¾ç¤ºåŒæ­¥(Explicit Synchronization)</strong></p>
<p><strong>cudaDeviceSynchronize():</strong>  ç›´åˆ°<strong>æ‰€æœ‰çº¿ç¨‹</strong>å‘è®¾å¤‡ç«¯çš„<strong>æ‰€æœ‰æµ</strong>çš„<strong>æ‰€æœ‰å·²é€å…¥æŒ‡ä»¤</strong>å®Œæˆï¼Œæ‰ä¼šé€€å‡ºé˜»å¡ã€‚</p>
<p><strong>cudaStreamSynchronize():</strong> ç›´åˆ°<strong>æŒ‡å®šæµ</strong>çš„<strong>ä¹‹å‰æ‰€æœ‰å·²é€å…¥æŒ‡ä»¤</strong>å®Œæˆï¼Œæ‰ä¼šé€€å‡ºé˜»å¡ã€‚</p>
<p><strong>cudaStreamWaitEvent():</strong> éœ€è¦streamå’Œeventä½œä¸ºè¾“å…¥å‚æ•°ã€‚éœ€è¦ç­‰å¾…è¯¥å‡½æ•°ç­‰å¾…çš„äº‹ä»¶(Event)å‘ç”Ÿåï¼Œæ‰èƒ½æ‰§è¡Œã€‚</p>
<p>13ã€<strong>éšå¼åŒæ­¥(Implicit Synchronization)</strong></p>
<p>ä¸€èˆ¬æ¥è®²ï¼Œä¸åŒæµå†…çš„å‘½ä»¤å¯ä»¥å¹¶è¡Œã€‚ä½†æ˜¯å½“ä»»ä½•ä¸€ä¸ªæµæ‰§è¡Œå¦‚ä¸‹çš„å‘½ä»¤æ—¶ï¼Œæƒ…å†µä¾‹å¤–ï¼Œä¸èƒ½å¹¶è¡Œï¼š</p>
<ul>
<li>é”é¡µå†…å­˜çš„åˆ†é…</li>
<li>è®¾å¤‡ç«¯å†…å­˜åˆ†é…  </li>
<li>è®¾å¤‡ç«¯å†…å­˜è®¾ç½®(memset) </li>
<li>è®¾å¤‡å†…éƒ¨æ‹·è´ </li>
<li>NULL streamå†…çš„å‘½ä»¤</li>
<li>L1 cache/å…±äº«å†…å­˜ç©ºé—´çš„é‡æ–°åˆ†é…</li>
</ul>
<p>14ã€<strong>å›è°ƒå‡½æ•°</strong></p>
<p>å¯ä»¥ä½¿ç”¨<code>cudaStreamAddCallback()</code>å‡½æ•°ï¼Œå‘æµä¸­æ·»åŠ callbackã€‚è¯¥callbackä¼šåœ¨æµä¸­ä¹‹å‰æ‰€æœ‰çš„ä»»åŠ¡å®Œæˆåè¢«è°ƒç”¨ã€‚å¦‚æœstreamå‚æ•°è®¾ä¸º0ï¼Œåˆ™ä»£è¡¨ä¹‹å‰çš„æ‰€æœ‰streamçš„ä»»åŠ¡æ‰§è¡Œå®Œåå°±è°ƒç”¨è¯¥callbackã€‚</p>
<p>å›è°ƒå‡½æ•°å’Œ<code>cudaStreamWaitEvent()</code>ä¸€æ ·ï¼Œå¯¹äºåœ¨åŠ åœ¨callbackä¹‹åçš„æŒ‡ä»¤ï¼Œå¿…é¡»ç­‰å¾…callback<em>æ‰§è¡Œå®Œæˆ</em>åï¼Œæ‰ä¼šç»§ç»­æ‰§è¡Œã€‚</p>
<p>å›è°ƒå‡½æ•°ä¸­ä¸èƒ½ç›´æ¥æˆ–é—´æ¥çš„æ‰§è¡ŒCUDAå‡½æ•°ï¼Œå¦åˆ™ä¼šå› ä¸ºç­‰å¾…è‡ªå·±å®Œæˆè€Œé€ æˆæ­»é”ã€‚</p>
<p>15ã€<strong>äº‹ä»¶(Event)</strong></p>
<p>äº‹ä»¶(Event)å¯ä»¥è¢«å‹å…¥æµä¸­ä»¥ç›‘è§†æµçš„è¿è¡Œæƒ…å†µï¼Œæˆ–è€…ç”¨äºç²¾ç¡®è®¡æ—¶ã€‚å¦‚æœå‘stream 0å‹å…¥äº‹ä»¶ï¼Œåˆ™å½“å‹å…¥äº‹ä»¶å‰å‘æ‰€æœ‰æµå‹å…¥çš„ä»»åŠ¡å®Œæˆåï¼Œäº‹ä»¶æ‰è¢«è§¦å‘ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">cudaEvent_t start, <span class="built_in">stop</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">cudaEventCreate(&amp;start);   <span class="comment">//åˆ›å»º</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">cudaEventCreate(&amp;<span class="built_in">stop</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">...</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">cudaEventDestroy(start);    <span class="comment">//é”€æ¯</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">cudaEventDestroy(<span class="built_in">stop</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//è®¡ç®—æ—¶é—´</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">cudaEventRecord(start, <span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">2</span>; i++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    cudaMemcpyAsync(inputDev + i * <span class="built_in">size</span>, inputHost + i * <span class="built_in">size</span>, <span class="built_in">size</span>, cudaMemcpyHostToDevice, stream[i]);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    MyKernel&lt;&lt;&lt;<span class="number">100</span>, <span class="number">512</span>, <span class="number">0</span>, stream[i]&gt;&gt;&gt;(outputDev + i * <span class="built_in">size</span>, inputDev + i * <span class="built_in">size</span>, <span class="built_in">size</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    cudaMemcpyAsync(outputHost + i * <span class="built_in">size</span>, outputDev + i * <span class="built_in">size</span>, <span class="built_in">size</span>, cudaMemcpyDeviceToHost, stream[i]);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">cudaEventRecord(<span class="built_in">stop</span>, <span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">cudaEventSynchronize(<span class="built_in">stop</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">float</span> elapsedTime;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">cudaEventElapsedTime(&amp;elapsedTime, start, <span class="built_in">stop</span>);</span></pre></td></tr></table></figure>
<p>16ã€<strong>å¤šè®¾å¤‡ç³»ç»Ÿ</strong></p>
<ul>
<li>è®¾å¤‡æšä¸¾</li>
<li>è®¾å¤‡é€‰æ‹©</li>
<li>æµå’Œäº‹ä»¶çš„æ‰§è¡Œæƒ…å†µ<ul>
<li><strong>å†…æ ¸å¯åŠ¨</strong>ï¼šå¦‚æœå°†å†…æ ¸å‹å…¥ä¸å±äºå½“å‰è®¾å¤‡çš„æµä¸­ï¼Œåˆ™å†…æ ¸ä¼šå¯åŠ¨å¤±è´¥ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœè¦å‘ä¸€ä¸ªæµä¸­å‹å…¥å†…æ ¸ï¼Œå¿…é¡»å…ˆåˆ‡æ¢åˆ°æµæ‰€åœ¨çš„è®¾å¤‡ã€‚</li>
<li><strong>å†…å­˜æ‹·è´</strong>ï¼šå¦‚æœå¯¹ä¸€ä¸ªä¸å±äºå½“å‰è®¾å¤‡çš„æµè¿›è¡Œå†…å­˜æ‹·è´å·¥ä½œï¼Œå†…å­˜æ‹·è´ä¼šæˆåŠŸã€‚</li>
<li><strong>cudaEventRecord()</strong>ï¼šå¿…é¡»ç°å°†è®¾å¤‡ä¸Šä¸‹æ–‡åˆ‡æ¢è¿‡å»ï¼Œå†å‘æµå‹å…¥äº‹ä»¶ã€‚</li>
<li><strong>cudaEventElapsedTime()</strong>ï¼šè®¡ç®—æ—¶é—´å·®å‰ï¼Œå¿…é¡»å…ˆåˆ‡æ¢è®¾å¤‡ã€‚</li>
<li><strong>cudaEventSynchronize() and cudaEventQuery()</strong>ï¼šå³ä½¿å¤„äºä¸åŒçš„è®¾å¤‡ï¼Œäº‹ä»¶åŒæ­¥å’Œäº‹ä»¶æŸ¥è¯¢ä¾ç„¶æœ‰æ•ˆã€‚</li>
<li><strong>cudaStreamWaitEvent()</strong>ï¼šæ¯”è¾ƒç‰¹æ®Šï¼Œå³ä½¿å‡½æ•°è¾“å…¥çš„æµå’Œäº‹ä»¶ä¸åœ¨åŒä¸€ä¸ªè®¾å¤‡ä¸Šï¼Œä¹Ÿèƒ½æˆåŠŸæ‰§è¡Œã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯ä»¥è®©æµç­‰å¾…å¦ä¸€ä¸ªè®¾å¤‡ä¸Š(å½“ç„¶å½“å‰è®¾å¤‡ä¹Ÿå¯ä»¥)çš„äº‹ä»¶ã€‚è¿™ä¸ªå‡½æ•°å¯ä»¥ç”¨ä½œå¤šä¸ªè®¾å¤‡é—´çš„åŒæ­¥ã€‚</li>
</ul>
</li>
<li>å†…å­˜çš„è®¿é—®</li>
<li>(è®¾å¤‡é—´)å¯¹ç­‰å†…å­˜è®¿é—®ï¼šè®¡ç®—èƒ½åŠ›2.0åŠä»¥ä¸Šçš„è®¾å¤‡æ”¯æŒè®¾å¤‡é—´å¯¹ç­‰å†…å­˜è®¿é—®ï¼Œè¿™æ„å‘³ç€ä¸¤ä¸ªGPUä¹‹é—´çš„ä¼ è¾“å’Œè®¿é—®å¯ä»¥ä¸ç»è¿‡ä¸»æœºç«¯ä¸­è½¬ï¼Œé€Ÿåº¦ä¼šæœ‰æå‡ã€‚</li>
<li>(è®¾å¤‡é—´)å¯¹ç­‰å†…å­˜è®¿é—®ï¼šå¯¹ç­‰è®¾å¤‡çš„åœ°å€æ˜¯ç»Ÿä¸€ç¼–å€çš„ï¼Œå¯ä»¥ä½¿ç”¨<code>cudaMemcpyPeer()ã€cudaMemcpyPeerAsync()ã€cudaMemcpy3DPeerã€cudaMemcpy3DPeerAsync()</code>æ¥è¿›è¡Œç›´æ¥æ‹·è´ã€‚æ— éœ€å…ˆæ‹·è´ä¼šä¸»æœºç«¯å†…å­˜ï¼Œå†è½¬åˆ°å¦ä¸€å—å¡ä¸Šã€‚</li>
</ul>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//è®¾å¤‡æšä¸¾</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> deviceCount;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">cudaGetDeviceCount(&amp;deviceCount);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> device;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(device=<span class="number">0</span>; device&lt;deviceCount; device++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    cudaDeviceProp deviceProp;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    cudaGetDeviceProperties(&amp;deviceProp, device);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">printf</span>(<span class="string">"Device %d has compute capability %d.%d.\n"</span>, device, deviceProp.major, deviceProp.minor);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//è®¾å¤‡é€‰æ‹©</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä½¿ç”¨cudaSetDevice()é€‰æ‹©è®¾å¤‡ï¼Œå½“ä¸é€‰æ‹©æ—¶ï¼Œé»˜è®¤ä½¿ç”¨è®¾å¤‡0ã€‚</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ³¨æ„ï¼Œæ‰€æœ‰çš„å†…å­˜åˆ†é…ã€å†…æ ¸å‡½æ•°å¯åŠ¨ã€æµå’Œäº‹ä»¶çš„åˆ›å»ºç­‰ï¼Œéƒ½æ˜¯é’ˆå¯¹å½“å‰é€‰æ‹©çš„è®¾å¤‡çš„ã€‚</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> <span class="built_in">size</span> = <span class="number">1024</span> * <span class="keyword">sizeof</span>(<span class="keyword">float</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">cudaSetDevice(<span class="number">0</span>);   <span class="comment">// Set device 0 as current</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">float</span>* p0;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">cudaMalloc(&amp;p0, <span class="built_in">size</span>);  <span class="comment">// Allocate memory on device 0</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">MyKernel&lt;&lt;&lt;<span class="number">1000</span>, <span class="number">128</span>&gt;&gt;&gt;(p0);    <span class="comment">// Launch kernel on device 0</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">cudaSetDevice(<span class="number">1</span>);   <span class="comment">// Set device 1 as current</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">float</span>* p1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">cudaMalloc(&amp;p1, <span class="built_in">size</span>);  <span class="comment">// Allocate memory on device 1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">MyKernel&lt;&lt;&lt;<span class="number">1000</span>, <span class="number">128</span>&gt;&gt;&gt;(p1); <span class="comment">// Launch kernel on device 1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//è®¾å¤‡é—´ï¼Œå¯¹ç­‰å†…å­˜æ‹·è´</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">cudaSetDevice(<span class="number">0</span>);   <span class="comment">// Set device 0 as current</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">float</span>* p0;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> <span class="built_in">size</span> = <span class="number">1024</span> * <span class="keyword">sizeof</span>(<span class="keyword">float</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">cudaMalloc(&amp;p0, <span class="built_in">size</span>);  <span class="comment">// Allocate memory on device 0</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">cudaSetDevice(<span class="number">1</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">float</span>* p1;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">cudaMalloc(&amp;p1, <span class="built_in">size</span>);  <span class="comment">// Allocate memory on device 1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">cudaSetDevice(<span class="number">0</span>);       <span class="comment">// Set Device 0 as Current</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">MyKernel&lt;&lt;&lt;<span class="number">1000</span>, <span class="number">128</span>&gt;&gt;&gt;(p0);    <span class="comment">// Launch Kernel on Device 0</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">cudaSetDevice(<span class="number">1</span>);               <span class="comment">// Set Device 1 as Current</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">cudaMemcpyPeer(p1, <span class="number">1</span>, p0, <span class="number">0</span>, <span class="built_in">size</span>); <span class="comment">// Copy p0 to p1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">MyKernel&lt;&lt;&lt;<span class="number">1000</span>, <span class="number">128</span>&gt;&gt;&gt;(p1);        <span class="comment">// Launch Kernel on Device 1</span></span></pre></td></tr></table></figure>
<p>å¦‚æœä½¿ç”¨çš„æ˜¯NULL streamï¼Œå¦‚æœæ‹·è´çš„åŒæ–¹ä¸­çš„ä»»ä½•ä¸€æ–¹ï¼Œåœ¨è®¾å¤‡æ‹·è´å‰æœ‰ä»»åŠ¡æœªå®Œæˆï¼Œåˆ™æ‹·è´ä¼šè¢«é˜»å¡ï¼Œç›´è‡³ä»»åŠ¡å®Œæˆã€‚*  åªæœ‰æ‹·è´ç»“æŸåï¼Œä¸¤è€…çš„åç»­ä»»åŠ¡æ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚</p>
<h4 id="äºŒã€æ€§èƒ½ä¼˜åŒ–"><a href="#äºŒã€æ€§èƒ½ä¼˜åŒ–" class="headerlink" title="äºŒã€æ€§èƒ½ä¼˜åŒ–"></a>äºŒã€æ€§èƒ½ä¼˜åŒ–</h4><p>æ€§èƒ½ä¼˜åŒ–çš„åŸåˆ™ï¼š</p>
<ol>
<li>æœ€å¤§åŒ–å¹¶è¡Œï¼Œä»¥æå‡èµ„æºåˆ©ç”¨ç‡</li>
<li>ä¼˜åŒ–å†…å­˜æ’å¸ƒï¼Œä»¥æœ€å¤§åŒ–å†…å­˜åå</li>
<li>æœ€å¤§åŒ–æŒ‡ä»¤åå</li>
</ol>
<p>æ€§èƒ½åˆ†æå·¥å…·ï¼šCUDA profiler</p>
<p><strong>åº”ç”¨çº§åˆ«å¹¶è¡Œ</strong>ï¼š å°½å¯èƒ½è®©ä¸»æœºç«¯ã€è®¾å¤‡ç«¯ã€PCI-Eæ€»çº¿å¹¶è¡Œå·¥ä½œã€‚å¯¹æ­¤å¯ä»¥ä½¿ç”¨å¼‚æ­¥CUDAå‡½æ•°ï¼Œä»¥åŠæµ(Stream)æ¥å®ç°ã€‚</p>
<p>åŒæ­¥æ“ä½œï¼Œä»¥åŠå†…å­˜çš„å…±äº«ä¼šå½±å“ç¨‹åºçš„å¹¶è¡Œæ€§ã€‚å› æ­¤éœ€è¦ä»”ç»†è®¾è®¡ç®—æ³•æµç¨‹ï¼Œå°½é‡å‡å°‘åŒæ­¥å’Œå†…å­˜å…±äº«ã€‚</p>
<p><strong>è®¾å¤‡çº§åˆ«åŒæ­¥ï¼š</strong>å¯ä»¥é€šè¿‡æµçš„æ–¹å¼ï¼Œå°½å¯èƒ½çš„è®©å¤šä¸ªå†…æ ¸å¹¶è¡Œï¼Œæå‡åˆ©ç”¨ç‡ã€‚</p>
<p><strong>å¤„ç†å™¨çº§åˆ«å¹¶è¡Œï¼š</strong>å»¶è¿Ÿ(latency)æŒ‡çš„æ˜¯çº¿ç¨‹æŸ(ä»ä¸Šä¸€ä¸ªåŠ¨ä½œå¼€å§‹)åˆ°å®ƒå¤„äºreadyçŠ¶æ€çš„æ—¶é’Ÿæ•°ã€‚ ä¾‹å¦‚çº¿ç¨‹æŸå…ˆæäº¤äº†ä¸€ä¸ªå†…å­˜è®¿é—®è¯·æ±‚ï¼Œç„¶åç­‰äº†400ä¸ªæ—¶é’Ÿå‘¨æœŸï¼Œå†…å­˜ç®¡ç†ç³»ç»Ÿæ‰è¿”å›æ•°æ®ï¼Œçº¿ç¨‹æŸå¯ä»¥ç»§ç»­æ‰§è¡Œã€‚è¿™400ä¸ªæ—¶é’Ÿå‘¨æœŸç§°ä¸ºå»¶è¿Ÿã€‚</p>
<p>å½“ä¸€ä¸ªçº¿ç¨‹æŸå‘ç”Ÿå»¶è¿Ÿæ—¶ï¼Œçº¿ç¨‹æŸè°ƒåº¦å™¨(warp  scheduler)ä¼šå°†å…¶ä»–å¤„äºreadyçŠ¶æ€çš„çº¿ç¨‹æŸè°ƒåº¦åˆ°SPä¸Šã€‚ç­‰åˆ°å»¶è¿Ÿç»“æŸåï¼Œå†å°†è¯¥çº¿ç¨‹è°ƒåº¦å›SPç»§ç»­æ‰§è¡Œã€‚è¿™æ ·ä¸€æ¥ï¼Œå‰ä¸€ä¸ªçº¿ç¨‹æŸçš„å»¶è¿Ÿï¼Œå°±è¢«å¦ä¸€ä¸ªçº¿ç¨‹æŸçš„æ‰§è¡Œæ‰€éšè—äº†ã€‚ è¿™ä¸€è¿‡ç¨‹è¢«ç§°ä½œå»¶è¿Ÿçš„éšè—(hidden latency)ã€‚  </p>
<p>éšè—å»¶è¿Ÿæ˜¯GPUç¼–ç¨‹çš„æ ¸å¿ƒæ¦‚å¿µã€‚ç”±äºGPUå…·æœ‰å·¨å¤§çš„å¯„å­˜å™¨ç©ºé—´ï¼Œçº¿ç¨‹çš„åˆ‡æ¢ä¸å­˜åœ¨æŸè€—ã€‚å› æ­¤ï¼Œé€šè¿‡å‘GPUä¸Šåˆ†é…è¶³å¤Ÿå¤šçš„çº¿ç¨‹ï¼Œå¯ä»¥è®©è¿™äº›çº¿ç¨‹å»¶è¿Ÿäº’ç›¸äº¤é”™ï¼Œä»¥èµ·åˆ°éšè—å»¶è¿Ÿçš„ä½œç”¨ï¼Œæé«˜ç¡¬ä»¶åˆ©ç”¨ç‡ã€‚</p>
<p><strong>æœ€å¤§åŒ–å†…å­˜ååï¼š</strong>ä¸»è¦æ‰‹æ®µå°±æ˜¯å°‘ç”¨ä½å¸¦å®½çš„å†…å­˜ã€‚é¦–å…ˆè¦å°½å¯èƒ½å‡å°‘ä¸»æœºç«¯å’Œè®¾å¤‡ç«¯é—´çš„è®¾å¤‡ä¼ è¾“(PCI-Eï¼Œç‰¹åˆ«æ…¢)ï¼Œå…¶æ¬¡è¦å°½å¯èƒ½å‡å°‘å…¨å±€å†…å­˜çš„è¯»å†™(å¿«äºPCI-Eï¼Œä½†æ˜¯ç›¸å¯¹äºç‰‡å†…å†…å­˜æ¥è¯´ï¼Œè¿˜æ˜¯æŒºæ…¢çš„)ï¼›å°½å¯èƒ½çš„ä½¿ç”¨ç‰‡å†…çš„å†…å­˜(å¯„å­˜å™¨ã€cacheã€å…±äº«å†…å­˜)ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/07/03/CUDA-Programmer-Learn-Zero/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qiang Chen">
      <meta itemprop="description" content="è®°å½•æ˜¯å¿˜è®°çš„ç¬¬ä¸€åŠ©æ‰‹.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ç¼–è¾‘å°¼æ’‘">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/03/CUDA-Programmer-Learn-Zero/" class="post-title-link" itemprop="url">CUDA-Programmer-Learn-Zero</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-07-03 23:14:11 / ä¿®æ”¹æ—¶é—´ï¼š23:16:39" itemprop="dateCreated datePublished" datetime="2021-07-03T23:14:11+08:00">2021-07-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/CUDA-Programmer/" itemprop="url" rel="index">
                    <span itemprop="name">CUDA Programmer</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="CUDAç¼–ç¨‹å­¦ä¹ ç¬”è®°"><a href="#CUDAç¼–ç¨‹å­¦ä¹ ç¬”è®°" class="headerlink" title="CUDAç¼–ç¨‹å­¦ä¹ ç¬”è®°"></a>CUDAç¼–ç¨‹å­¦ä¹ ç¬”è®°</h2><h4 id="ä¸€ã€CUDAç¼–ç¨‹æ¨¡å¼çš„åŸºæœ¬æ¦‚å¿µ"><a href="#ä¸€ã€CUDAç¼–ç¨‹æ¨¡å¼çš„åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="ä¸€ã€CUDAç¼–ç¨‹æ¨¡å¼çš„åŸºæœ¬æ¦‚å¿µ"></a>ä¸€ã€CUDAç¼–ç¨‹æ¨¡å¼çš„åŸºæœ¬æ¦‚å¿µ</h4><p>CUDAæ˜¯ä¸€ç§é€šç”¨çš„å¼‚æ„å¹¶è¡Œè®¡ç®—å¹³å°å’Œç¼–ç¨‹æ¨¡å‹ï¼Œä½ å¯ä»¥åˆ©ç”¨CUDAå¹³å°åƒåœ¨CPUä¸Šé‚£æ ·ä½¿ç”¨GPUæ¥è¿›è¡Œè®¡ç®—ã€‚</p>
<p>ä¸€èˆ¬çš„CUDA(.cu)ç¨‹åºçš„æ‰§è¡Œæ­¥éª¤ä¸ºï¼š</p>
<ol>
<li>åˆ†é…GPUæ˜¾å­˜</li>
<li>å°†å¾…å¤„ç†çš„æ•°æ®ä»HOSTå†…å­˜æ‹·è´åˆ°GPUçš„æ˜¾å­˜</li>
<li>è°ƒç”¨æ ¸å‡½æ•°å¯¹å­˜å‚¨åœ¨GPUæ˜¾å­˜ä¸­çš„æ•°æ®è¿›è¡Œå¤„ç†</li>
<li>å°†ç»“æœä»GPUæ˜¾å­˜æ‹·è´åˆ°HOSTå†…å­˜</li>
<li>é‡Šæ”¾GPUæ˜¾å­˜</li>
</ol>
<h4 id="äºŒã€CUDAç¼–ç¨‹æ¨¡å¼çš„ä¸¤å¤§é‡ç‚¹"><a href="#äºŒã€CUDAç¼–ç¨‹æ¨¡å¼çš„ä¸¤å¤§é‡ç‚¹" class="headerlink" title="äºŒã€CUDAç¼–ç¨‹æ¨¡å¼çš„ä¸¤å¤§é‡ç‚¹"></a>äºŒã€CUDAç¼–ç¨‹æ¨¡å¼çš„ä¸¤å¤§é‡ç‚¹</h4><ol>
<li><p>é€šè¿‡å±‚æ¬¡ç»“æ„æ¥ç»„ç»‡çº¿ç¨‹</p>
<p>1.1 çº¿ç¨‹çš„ç®¡ç†ï¼š<strong>çº¿ç¨‹ç½‘æ ¼(Grid)ã€çº¿ç¨‹å—(Block)ã€çº¿ç¨‹æŸ(Warp)å’Œçº¿ç¨‹(Thread)</strong></p>
<p>1.2 ä¸€ä¸ªå†…æ ¸å¯åŠ¨æ‰€ç”Ÿæˆçš„æ‰€æœ‰çº¿ç¨‹ç§°ä¸ºä¸€ä¸ªç½‘æ ¼ï¼ŒåŒä¸€ç½‘æ ¼å†…çš„æ‰€æœ‰çº¿ç¨‹å…±äº«åŒä¸€å—å…¨å±€å†…å­˜ç©ºé—´ã€‚ä¸€ä¸ªç½‘æ ¼æœ‰å¤šä¸ªçº¿ç¨‹å—æ„æˆã€‚ä¸€ä¸ªçº¿ç¨‹å—ç”±ä¸€ç»„çº¿ç¨‹æ„æˆ</p>
<p>1.3 ä¼˜åŠ¿ï¼šåˆç†çš„åˆ©ç”¨èµ„æºï¼Œä¼˜åŒ–æ€§èƒ½</p>
</li>
<li><p>é€šè¿‡å±‚æ¬¡ç»“æ„æ¥ç»„ç»‡å†…å­˜</p>
<p>2.1 GPUçš„å„çº§ç¼“å­˜å’Œæ˜¾å­˜æ˜¯å¯ä»¥é€šè¿‡ç¨‹åºè¿›è¡Œæ§åˆ¶çš„ã€‚å…·ä½“æœ‰å¯„å­˜å™¨ã€å…±äº«å†…å­˜ã€å¸¸é‡å†…å­˜å’Œå…¨å±€å†…å­˜ç­‰</p>
<p>2.2 <strong>å¯„å­˜å™¨</strong>æ˜¯GPUä¸Šè¿è¡Œé€Ÿåº¦æœ€å¿«çš„å†…å­˜ç©ºé—´ï¼Œå¸¦å®½é€šå¸¸ä¸º8TB/s,å»¶æ—¶ä¸ºä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚<strong>å…±äº«å†…å­˜</strong>æ˜¯GPUä¸Šå¯å—ç”¨æˆ·æ§åˆ¶çš„ä¸€çº§ç¼“å­˜ï¼Œå¸¦å®½é€šå¸¸ä¸º1.5TB/s,å»¶è¿Ÿä¸º1~32ä¸ªæ—¶é’Ÿå‘¨æœŸã€‚<strong>å…¨å±€å†…å­˜</strong>æ˜¯GPUä¸­æœ€å¤§çš„ï¼Œå»¶è¿Ÿæœ€é«˜ä¸”æœ€å¸¸è¢«ä½¿ç”¨çš„å†…å­˜ã€‚</p>
<p><img src="/2021/07/03/CUDA-Programmer-Learn-Zero/1.jpg" alt="Cuda-memory-struct"></p>
</li>
</ol>
<h5 id="ä¸‰ã€çŸ©é˜µè¿ç®—"><a href="#ä¸‰ã€çŸ©é˜µè¿ç®—" class="headerlink" title="ä¸‰ã€çŸ©é˜µè¿ç®—"></a>ä¸‰ã€çŸ©é˜µè¿ç®—</h5><p>1ã€çŸ©é˜µç´¢å¼•ï¼šåœ¨ä¸€ä¸ªäºŒç»´çŸ©é˜µåŠ æ³•çš„æ ¸å‡½æ•°ä¸­ï¼Œä¸€ä¸ªçº¿ç¨‹é€šå¸¸è¢«åˆ†é…ä¸€ä¸ªæ•°æ®å…ƒç´ æ¥å¤„ç†ã€‚é¦–å…ˆè¦å®Œæˆçš„ä»»åŠ¡æ˜¯å¦‚ä½•ä½¿ç”¨å—å’Œçº¿ç¨‹ç´¢å¼•ä»å…¨å±€å†…å­˜ä¸­è®¿é—®æŒ‡å®šçš„æ•°æ®ã€‚</p>
<p><strong>å¦‚ä½•æ˜ å°„çº¿ç¨‹çš„Idåˆ°å›¾åƒçŸ©é˜µçš„åæ ‡ä¸Šï¼Ÿ</strong></p>
<p>å¯ä»¥ä½¿ç”¨å¦‚ä¸‹çš„å…¬å¼å°†çº¿ç¨‹ç½‘æ ¼å’Œçº¿ç¨‹å—çš„ç´¢å¼•æ˜ å°„åˆ°çŸ©é˜µåæ ‡ä¸Š,ç§°ä¸ºåæ ‡ç´¢å¼•ã€‚</p>
<script type="math/tex; mode=display">
ix = blockIdx.x * blockDim.x + threadIdx.x \\
iy = blockIdx.y * blockDim.y + threadIdx.y</script><p>å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å…¬å¼å°†çŸ©é˜µåæ ‡æ˜ å°„åˆ°å…¨å±€å†…å­˜çš„ç´¢å¼•/å­˜å‚¨å•å…ƒä¸Šï¼Œç§°ä¸ºå…¨å±€ç´¢å¼•(å› ä¸ºæ•°æ®åœ¨å†…å­˜çš„å­˜å‚¨å¾€å¾€æ˜¯ä¸€ç»´çš„ï¼Œéœ€è¦åœ°å€æ˜ å°„)ã€‚</p>
<script type="math/tex; mode=display">
idx = iy*nx + ix,\quad nxè¡¨ç¤ºxç»´åº¦ä¸Šå…ƒç´ çš„ä¸ªæ•°</script><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function">__global__ <span class="keyword">void</span> <span class="title">sumMatUsingGPU</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">char</span>* A, <span class="keyword">unsigned</span> <span class="keyword">char</span>* B, <span class="keyword">unsigned</span> <span class="keyword">char</span>* C, uint <span class="built_in">height</span>, uint <span class="built_in">width</span>)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> ix = blockIdx.x * blockDim.x + threadIdx.x;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> iy = blockIdy.y * blockDim.y + threadIdy.y;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> idx = iy * <span class="built_in">width</span> + ix;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span>(ix &lt; <span class="built_in">width</span> &amp;&amp; iy &lt; <span class="built_in">height</span>)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        C[idx] = A[idx] + B[idx];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    uint <span class="built_in">height</span> = <span class="number">5</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    uint <span class="built_in">width</span> = <span class="number">20</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> byteSize = <span class="built_in">height</span> * <span class="built_in">width</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">size_t</span> nBytes = byteSize * <span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> <span class="keyword">char</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">float</span> *h_A, *h_B, *h_C;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    h_A = (<span class="keyword">float</span> *)<span class="built_in">malloc</span>(nBytes);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    h_B = (<span class="keyword">float</span> *)<span class="built_in">malloc</span>(nBytes);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    h_C = (<span class="keyword">float</span> *)<span class="built_in">malloc</span>(nBytes);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span>* A, *B, *C;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    cudaMalloc(&amp;A, byteSize*<span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> <span class="keyword">char</span>));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    cudaMalloc(&amp;B, byteSize*<span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> <span class="keyword">char</span>));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    cudaMalloc(&amp;C, byteSize*<span class="keyword">sizeof</span>(<span class="keyword">unsigned</span> <span class="keyword">char</span>));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    cudaMemcpy(A, h_A, nBytes, cudaMemcpyHostToDeviec);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">    cudaMemcpy(B, h_B, nBytes, cudaMemcpyHostToDeviec);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">    cudaMemcpy(C, h_C, nBytes, cudaMemcpyHostToDeviec);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">    <span class="function">dim3 <span class="title">thread</span><span class="params">(<span class="built_in">height</span>/<span class="number">5</span>,<span class="built_in">width</span>/<span class="number">5</span>)</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">    <span class="function">dim3 <span class="title">block</span><span class="params">(<span class="built_in">height</span>, <span class="built_in">width</span>)</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">    sumMatUsingGPU&lt;&lt;&lt;block, thread&gt;&gt;&gt;(A, B, C, <span class="built_in">height</span>, <span class="built_in">width</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">    cudaMemcpy(h_c, d_c, nBytes, cudaMemcpyDeviceToHost);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">    cudaFree(A);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">    cudaFree(B);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">    cudaFree(C);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç¼–è¯‘</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">nvcc -arch=sm_20 sumOnGPU.cu -o sumOnGPU</span></pre></td></tr></table></figure>
<div class="table-container">
<table>
<thead>
<tr>
<th>é™å®šç¬¦</th>
<th>æ‰§è¡Œ</th>
<th>è°ƒç”¨</th>
<th>å¤‡æ³¨</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>__global__</code></td>
<td>åœ¨è®¾å¤‡ç«¯æ‰§è¡Œ</td>
<td>å¯ä»ä¸»æœºã€è®¾å¤‡ç«¯è°ƒç”¨</td>
<td>å¿…é¡»æœ‰ä¸€ä¸ªvoidè¿”å›ç±»å‹</td>
</tr>
<tr>
<td><code>__device__</code></td>
<td>åœ¨è®¾å¤‡ç«¯æ‰§è¡Œ</td>
<td>ä»…èƒ½ä»è®¾å¤‡ç«¯è°ƒç”¨</td>
<td></td>
</tr>
<tr>
<td><code>__host__</code></td>
<td>åœ¨ä¸»æœºç«¯æ‰§è¡Œ</td>
<td>ä»…èƒ½ä»ä¸»æœºç«¯ä¸Šè°ƒç”¨</td>
<td>å¯ä»¥çœç•¥ä¸å†™</td>
</tr>
</tbody>
</table>
</div>
<h4 id="å››ã€å¦‚ä½•æå‡å¹¶è¡Œèƒ½åŠ›"><a href="#å››ã€å¦‚ä½•æå‡å¹¶è¡Œèƒ½åŠ›" class="headerlink" title="å››ã€å¦‚ä½•æå‡å¹¶è¡Œèƒ½åŠ›"></a>å››ã€å¦‚ä½•æå‡å¹¶è¡Œèƒ½åŠ›</h4><ul>
<li>é™ä½å»¶è¿Ÿï¼Œå»¶è¿Ÿæ˜¯æŒ‡æ“ä½œä»å¼€å§‹åˆ°ç»“æŸæ‰€éœ€è¦çš„æ—¶é—´ï¼Œä¸€èˆ¬ç”¨å¾®ç§’è®¡ç®—ï¼Œå»¶è¿Ÿè¶Šä½è¶Šå¥½ã€‚</li>
<li>æé«˜å¸¦å®½ï¼Œå¸¦å®½æ˜¯å•ä½æ—¶é—´å†…å¤„ç†çš„æ•°æ®é‡ï¼Œä¸€èˆ¬ç”¨MB/sæˆ–è€…GB/sè¡¨ç¤ºã€‚</li>
<li>æé«˜ååé‡ï¼Œååé‡æ˜¯å•ä½æ—¶é—´å†…æˆåŠŸå¤„ç†çš„è¿ç®—æ•°é‡ï¼Œä¸€èˆ¬ç”¨gflopsæ¥è¡¨ç¤ºï¼ˆåäº¿æ¬¡æµ®ç‚¹è®¡ç®—ï¼‰ï¼Œååé‡å’Œå»¶è¿Ÿæœ‰ä¸€å®šå…³ç³»ï¼Œéƒ½æ˜¯ååº”è®¡ç®—é€Ÿåº¦çš„ï¼Œ<strong>ä¸€ä¸ªæ˜¯æ—¶é—´é™¤ä»¥è¿ç®—æ¬¡æ•°ï¼Œå¾—åˆ°çš„æ˜¯å•ä½æ¬¡æ•°ç”¨çš„æ—¶é—´â€“å»¶è¿Ÿï¼Œä¸€ä¸ªæ˜¯è¿ç®—æ¬¡æ•°é™¤ä»¥æ—¶é—´ï¼Œå¾—åˆ°çš„æ˜¯å•ä½æ—¶é—´æ‰§è¡Œæ¬¡æ•°â€“ååé‡ã€‚</strong></li>
</ul>
<h4 id="äº”ã€è®¡ç®—æœºæ¶æ„"><a href="#äº”ã€è®¡ç®—æœºæ¶æ„" class="headerlink" title="äº”ã€è®¡ç®—æœºæ¶æ„"></a>äº”ã€è®¡ç®—æœºæ¶æ„</h4><p>åˆ’åˆ†ä¸åŒè®¡ç®—æœºç»“æ„çš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œå¹¿æ³›ä½¿ç”¨çš„ä¸€ç§è¢«ç§°ä¸ºä½›æ—åˆ†ç±»æ³•Flynnâ€™s Taxonomyï¼Œ<strong>æ ¹æ®æŒ‡ä»¤å’Œæ•°æ®è¿›å…¥CPUçš„æ–¹å¼åˆ†ç±»</strong>ï¼Œåˆ†ä¸ºä»¥ä¸‹å››ç±»ï¼š</p>
<ol>
<li>å•æŒ‡ä»¤å•æ•°æ®SISDï¼ˆä¼ ç»Ÿä¸²è¡Œè®¡ç®—æœºï¼Œ386ï¼‰</li>
<li>å•æŒ‡ä»¤å¤šæ•°æ®SIMDï¼ˆå¹¶è¡Œæ¶æ„ï¼Œæ¯”å¦‚å‘é‡æœºï¼Œæ‰€æœ‰æ ¸å¿ƒæŒ‡ä»¤å”¯ä¸€ï¼Œä½†æ˜¯æ•°æ®ä¸åŒï¼Œç°åœ¨CPUåŸºæœ¬éƒ½æœ‰è¿™ç±»çš„å‘é‡æŒ‡ä»¤ï¼‰</li>
<li>å¤šæŒ‡ä»¤å•æ•°æ®MISDï¼ˆå°‘è§ï¼Œå¤šä¸ªæŒ‡ä»¤å›´æ®´ä¸€ä¸ªæ•°æ®ï¼‰</li>
<li>å¤šæŒ‡ä»¤å¤šæ•°æ®MIMDï¼ˆå¹¶è¡Œæ¶æ„ï¼Œå¤šæ ¸å¿ƒï¼Œå¤šæŒ‡ä»¤ï¼Œå¼‚æ­¥å¤„ç†å¤šä¸ªæ•°æ®æµï¼Œä»è€Œå®ç°ç©ºé—´ä¸Šçš„å¹¶è¡Œï¼ŒMIMDå¤šæ•°æƒ…å†µä¸‹åŒ…å«SIMDï¼Œå°±æ˜¯MIMDæœ‰å¾ˆå¤šè®¡ç®—æ ¸ï¼Œè®¡ç®—æ ¸æ”¯æŒSIMDï¼‰</li>
</ol>
<p><strong>æ ¹æ®å†…å­˜åˆ’åˆ†</strong>ï¼Œåˆ†ä¸ºä»¥ä¸‹ä¸¤ç±»ï¼š</p>
<ol>
<li><p>åˆ†å¸ƒå¼å†…å­˜çš„å¤šèŠ‚ç‚¹ç³»ç»Ÿ</p>
<p>é€šå¸¸å«åšé›†ç¾¤ï¼Œå°±æ˜¯ä¸€ä¸ªæœºæˆ¿å¥½å¤šæœºç®±ï¼Œæ¯ä¸ªæœºç®±éƒ½æœ‰å†…å­˜å¤„ç†å™¨ç”µæºç­‰ä¸€äº›åˆ—ç¡¬ä»¶ï¼Œé€šè¿‡ç½‘ç»œäº’åŠ¨ï¼Œè¿™æ ·ç»„æˆçš„å°±æ˜¯åˆ†å¸ƒå¼ã€‚</p>
</li>
<li><p>å…±äº«å†…å­˜çš„å¤šå¤„ç†å™¨ç³»ç»Ÿ</p>
<p>å•ä¸ªä¸»æ¿æœ‰å¤šä¸ªå¤„ç†å™¨ï¼Œä»–ä»¬å…±äº«ç›¸åŒçš„ä¸»æ¿ä¸Šçš„å†…å­˜ï¼Œå†…å­˜å¯»å€ç©ºé—´ç›¸åŒï¼Œé€šè¿‡PCIeå’Œå†…å­˜äº’åŠ¨ã€‚</p>
<p><strong>å¤šä¸ªå¤„ç†å™¨å¯ä»¥åˆ†å¤šç‰‡å¤„ç†å™¨ï¼Œå’Œå•ç‰‡å¤šæ ¸ï¼ˆä¼—æ ¸many-coreï¼‰</strong>ï¼Œä¹Ÿå°±æ˜¯æœ‰äº›ä¸»æ¿ä¸ŠæŒ‚äº†å¥½å¤šç‰‡å¤„ç†å™¨ï¼Œä¹Ÿæœ‰çš„æ˜¯ä¸€ä¸ªä¸»æ¿ä¸Šå°±ä¸€ä¸ªå¤„ç†å™¨ï¼Œä½†æ˜¯è¿™ä¸ªå¤„ç†å™¨é‡Œé¢æœ‰å‡ ç™¾ä¸ªæ ¸ã€‚<strong>GPUå°±å±äºä¼—æ ¸ç³»ç»Ÿ</strong></p>
</li>
</ol>
<ul>
<li>CPUé€‚åˆæ‰§è¡Œå¤æ‚çš„é€»è¾‘ï¼Œæ¯”å¦‚å¤šåˆ†æ”¯ï¼Œå…¶æ ¸å¿ƒæ¯”è¾ƒé‡ï¼ˆå¤æ‚ï¼‰</li>
<li>GPUé€‚åˆæ‰§è¡Œç®€å•çš„é€»è¾‘ï¼Œå¤§é‡çš„æ•°æ®è®¡ç®—ï¼Œå…¶ååé‡æ›´é«˜ï¼Œä½†æ˜¯æ ¸å¿ƒæ¯”è¾ƒè½»ï¼ˆç»“æ„ç®€å•ï¼‰</li>
</ul>
<h4 id="å…­ã€å¼‚æ„æ¶æ„"><a href="#å…­ã€å¼‚æ„æ¶æ„" class="headerlink" title="å…­ã€å¼‚æ„æ¶æ„"></a>å…­ã€å¼‚æ„æ¶æ„</h4><p>æ‹¥æœ‰ä¸åŒè®¡ç®—æœºæ¶æ„ä½“ç³»çš„ç¡¬ä»¶ç›¸äº’é…åˆå®Œæˆé«˜ååé‡å·¥ä½œçš„ç³»ç»Ÿã€‚ä¾‹å¦‚ï¼šCPUæˆ‘ä»¬å¯ä»¥æŠŠå®ƒçœ‹åšä¸€ä¸ªæŒ‡æŒ¥è€…ï¼Œä¸»æœºç«¯ï¼Œhostï¼Œè€Œå®Œæˆå¤§é‡è®¡ç®—çš„GPUæ˜¯æˆ‘ä»¬çš„è®¡ç®—è®¾å¤‡ï¼Œdeviceã€‚ä¸‹å›¾æ¥ä¹‹è°­å‡çš„çŸ¥ä¹</p>
<p><img src="/2021/07/03/CUDA-Programmer-Learn-Zero/2.png" alt="Cuda-memory-struct"></p>
<ul>
<li>å·¦å›¾ï¼šä¸€ä¸ªå››æ ¸CPUä¸€èˆ¬æœ‰å››ä¸ªALUï¼ŒALUæ˜¯å®Œæˆé€»è¾‘è®¡ç®—çš„æ ¸å¿ƒï¼Œä¹Ÿæ˜¯æˆ‘ä»¬å¹³æ—¶è¯´å››æ ¸å…«æ ¸çš„æ ¸ï¼Œæ§åˆ¶å•å…ƒï¼Œç¼“å­˜ä¹Ÿåœ¨ç‰‡ä¸Šï¼ŒDRAMæ˜¯å†…å­˜ï¼Œä¸€èˆ¬ä¸åœ¨ç‰‡ä¸Šï¼ŒCPUé€šè¿‡æ€»çº¿è®¿é—®å†…å­˜ã€‚</li>
<li>å³å›¾ï¼šGPUï¼Œç»¿è‰²å°æ–¹å—æ˜¯ALUï¼Œæˆ‘ä»¬æ³¨æ„çº¢è‰²æ¡†å†…çš„éƒ¨åˆ†SMï¼Œè¿™ä¸€ç»„ALUå…¬ç”¨ä¸€ä¸ªControlå•å…ƒå’ŒCacheï¼Œ<strong>è¿™ä¸ªéƒ¨åˆ†ç›¸å½“äºä¸€ä¸ªå®Œæ•´çš„å¤šæ ¸CPU</strong>ï¼Œä½†æ˜¯<strong>ä¸åŒçš„æ˜¯ALUå¤šäº†ï¼Œcontroléƒ¨åˆ†å˜å°ï¼Œå¯è§è®¡ç®—èƒ½åŠ›æå‡äº†ï¼Œæ§åˆ¶èƒ½åŠ›å‡å¼±äº†ï¼Œ</strong>æ‰€ä»¥å¯¹äºæ§åˆ¶ï¼ˆé€»è¾‘ï¼‰å¤æ‚çš„ç¨‹åºï¼Œä¸€ä¸ªGPUçš„SMæ˜¯æ²¡åŠæ³•å’ŒCPUæ¯”è¾ƒçš„ï¼Œä½†æ˜¯å¯¹äº†é€»è¾‘ç®€å•ï¼Œæ•°æ®é‡å¤§çš„ä»»åŠ¡ï¼ŒGPUæ›´é«˜æ•ˆã€‚æ³¨æ„ï¼Œä¸€ä¸ªGPUæœ‰å¥½å¤šä¸ªSMï¼Œè€Œä¸”è¶Šæ¥è¶Šå¤šã€‚</li>
</ul>
<p>CPUå’ŒGPUä¹‹é—´é€šè¿‡PCIeæ€»çº¿è¿æ¥ï¼Œç”¨äºä¼ é€’æŒ‡ä»¤å’Œæ•°æ®ï¼Œè¿™éƒ¨åˆ†ä¹Ÿæ˜¯åé¢è¦è®¨è®ºçš„æ€§èƒ½ç“¶é¢ˆä¹‹ä¸€ã€‚</p>
<p>ä¸€ä¸ªå¼‚æ„åº”ç”¨åŒ…å«ä¸¤ç§ä»¥ä¸Šæ¶æ„ï¼Œæ‰€ä»¥åˆ†ä¸ºä¸»æœºç«¯ä»£ç å’Œè®¾å¤‡ç«¯ä»£ç ã€‚ä¸»æœºä»£ç åœ¨ä¸»æœºç«¯è¿è¡Œï¼Œè¢«<strong>ç¼–è¯‘æˆä¸»æœºæ¶æ„çš„æœºå™¨ç </strong>ï¼Œè®¾å¤‡ç«¯çš„åœ¨è®¾å¤‡ä¸Šæ‰§è¡Œï¼Œ<strong>è¢«ç¼–è¯‘æˆè®¾å¤‡æ¶æ„çš„æœºå™¨ç </strong>ï¼Œæ‰€ä»¥ä¸»æœºç«¯çš„æœºå™¨ç å’Œè®¾å¤‡ç«¯çš„æœºå™¨ç æ˜¯éš”ç¦»çš„ï¼Œè‡ªå·±æ‰§è¡Œè‡ªå·±çš„ï¼Œæ²¡åŠæ³•äº¤æ¢æ‰§è¡Œã€‚</p>
<p>ä¸»æœºç«¯ä»£ç ä¸»è¦æ˜¯<strong>æ§åˆ¶è®¾å¤‡ï¼Œå®Œæˆæ•°æ®ä¼ è¾“ç­‰æ§åˆ¶ç±»å·¥ä½œ</strong>ï¼Œè®¾å¤‡ç«¯ä¸»è¦çš„ä»»åŠ¡å°±æ˜¯<strong>è®¡ç®—</strong>ã€‚</p>
<p>NVIDIAç›®å‰æœ‰å¤šç§è®¡ç®—å¹³å°ï¼Œæ¯ä¸ªå¹³å¤ªé’ˆå¯¹ä¸åŒçš„åº”ç”¨åœºæ™¯ï¼Œæ¯”å¦‚Tegraç”¨äºåµŒå…¥å¼ï¼ŒGeforceæ˜¯æˆ‘ä»¬å¹³æ—¶æ‰“æ¸¸æˆç”¨åˆ°ï¼ŒTeslaä¸»è¦ç”¨äºè®¡ç®—ã€‚</p>
<p>è¡¡é‡GPUè®¡ç®—èƒ½åŠ›çš„ä¸»è¦é ä¸‹é¢ä¸¤ç§<strong>å®¹é‡ç‰¹å¾</strong>ï¼š<strong>CUDAæ ¸å¿ƒæ•°å’Œå†…å­˜å¤§å°</strong>ã€‚<strong>è®¡ç®—èƒ½åŠ›çš„æ€§èƒ½æŒ‡æ ‡</strong>ï¼š<strong>å³°å€¼è®¡ç®—èƒ½åŠ›å’Œå†…å­˜å¸¦å®½</strong>ã€‚ä¸‹å›¾æ¥ä¹‹è°­å‡çš„çŸ¥ä¹</p>
<p><img src="/2021/07/03/CUDA-Programmer-Learn-Zero/3.png" alt="Cuda-memory-struct"></p>
<p>CPUå’ŒGPUçº¿ç¨‹çš„åŒºåˆ«ï¼š</p>
<ol>
<li>CPUçº¿ç¨‹æ˜¯é‡é‡çº§å®ä½“ï¼Œæ“ä½œç³»ç»Ÿäº¤æ›¿æ‰§è¡Œçº¿ç¨‹ï¼Œçº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢èŠ±é”€å¾ˆå¤§ã€‚</li>
<li>GPUçº¿ç¨‹æ˜¯è½»é‡çº§çš„ï¼ŒGPUåº”ç”¨ä¸€èˆ¬åŒ…å«æˆåƒä¸Šä¸‡çš„çº¿ç¨‹ï¼Œå¤šæ•°åœ¨æ’é˜ŸçŠ¶æ€ï¼Œçº¿ç¨‹ä¹‹é—´åˆ‡æ¢åŸºæœ¬æ²¡æœ‰å¼€é”€ã€‚</li>
<li>CPUçš„æ ¸è¢«è®¾è®¡ç”¨æ¥å°½å¯èƒ½å‡å°‘ä¸€ä¸ªæˆ–ä¸¤ä¸ªçº¿ç¨‹è¿è¡Œæ—¶é—´çš„å»¶è¿Ÿï¼Œè€ŒGPUæ ¸åˆ™æ˜¯å¤§é‡çº¿ç¨‹ï¼Œæœ€å¤§å¹…åº¦æé«˜ååé‡ã€‚</li>
</ol>
<p>CUDA nvccç¼–è¯‘å™¨ä¼šè‡ªåŠ¨åˆ†ç¦»ä½ ä»£ç é‡Œé¢çš„ä¸åŒéƒ¨åˆ†ï¼Œå¦‚å›¾ä¸­ä¸»æœºä»£ç ç”¨Cå†™æˆï¼Œä½¿ç”¨æœ¬åœ°çš„Cè¯­è¨€ç¼–è¯‘å™¨ç¼–è¯‘ï¼Œè®¾å¤‡ç«¯ä»£ç ï¼Œä¹Ÿå°±æ˜¯æ ¸å‡½æ•°ï¼Œç”¨CUDA Cç¼–å†™ï¼Œé€šè¿‡nvccç¼–è¯‘ï¼Œé“¾æ¥é˜¶æ®µï¼Œåœ¨å†…æ ¸ç¨‹åºè°ƒç”¨æˆ–è€…æ˜æ˜¾çš„GPUè®¾å¤‡æ“ä½œæ—¶ï¼Œæ·»åŠ è¿è¡Œæ—¶åº“ã€‚</p>
<p>å¯ä»¥ç”¨åˆ°çš„å·¥å…·ï¼š</p>
<ul>
<li>Nvidia Nsighté›†æˆå¼€å‘ç¯å¢ƒ</li>
<li>CUDA-GDB å‘½ä»¤è¡Œè°ƒè¯•å™¨</li>
<li>æ€§èƒ½åˆ†æå¯è§†åŒ–å·¥å…·</li>
<li>CUDA-MEMCHECKå·¥å…·</li>
<li>GPUè®¾å¤‡ç®¡ç†å·¥å…·</li>
</ul>
<p><a href="https://face2ai.com/program-blog/#GPU%E7%BC%96%E7%A8%8B%EF%BC%88CUDA%EF%BC%89" target="_blank" rel="noopener">å­¦ä¹ å‚è€ƒèµ„æ–™</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/346910129" target="_blank" rel="noopener">æ€»ç»“æ€§èµ„æ–™</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/07/03/Principles-Of-Computer-Composition-Zero/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qiang Chen">
      <meta itemprop="description" content="è®°å½•æ˜¯å¿˜è®°çš„ç¬¬ä¸€åŠ©æ‰‹.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ç¼–è¾‘å°¼æ’‘">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/07/03/Principles-Of-Computer-Composition-Zero/" class="post-title-link" itemprop="url">Principles-Of-Computer-Composition-Zero</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-07-03 23:06:30 / ä¿®æ”¹æ—¶é—´ï¼š23:13:35" itemprop="dateCreated datePublished" datetime="2021-07-03T23:06:30+08:00">2021-07-03</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Principles-Of-Computer-Composition/" itemprop="url" rel="index">
                    <span itemprop="name">Principles-Of-Computer-Composition</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="è®¡ç®—æœºç»„æˆåŸç†éƒ¨åˆ†çŸ¥è¯†å­¦ä¹ ç¬”è®°"><a href="#è®¡ç®—æœºç»„æˆåŸç†éƒ¨åˆ†çŸ¥è¯†å­¦ä¹ ç¬”è®°" class="headerlink" title="è®¡ç®—æœºç»„æˆåŸç†éƒ¨åˆ†çŸ¥è¯†å­¦ä¹ ç¬”è®°"></a>è®¡ç®—æœºç»„æˆåŸç†éƒ¨åˆ†çŸ¥è¯†å­¦ä¹ ç¬”è®°</h2><h4 id="ä¸€ã€çº¿ç¨‹ç»‘å®šCPUæ ¸å¿ƒçš„æ„ä¹‰"><a href="#ä¸€ã€çº¿ç¨‹ç»‘å®šCPUæ ¸å¿ƒçš„æ„ä¹‰" class="headerlink" title="ä¸€ã€çº¿ç¨‹ç»‘å®šCPUæ ¸å¿ƒçš„æ„ä¹‰"></a>ä¸€ã€çº¿ç¨‹ç»‘å®šCPUæ ¸å¿ƒçš„æ„ä¹‰</h4><p>åœ¨å¤šæ ¸CPUä¸­åˆç†çš„è°ƒåº¦çº¿ç¨‹åœ¨å„ä¸ªæ ¸ä¸Šè¿è¡Œå¯ä»¥è·å¾—æ›´é«˜çš„æ€§èƒ½ã€‚åœ¨å¤šçº¿ç¨‹ç¼–ç¨‹ä¸­ï¼Œ<strong>æ¯ä¸ªçº¿ç¨‹å¤„ç†çš„ä»»åŠ¡ä¼˜å…ˆçº§æ˜¯ä¸ä¸€æ ·</strong>çš„ï¼Œå¯¹äº<strong>è¦æ±‚å®æ—¶æ€§æ¯”è¾ƒé«˜</strong>çš„çº¿ç¨‹æˆ–è€…æ˜¯<strong>ä¸»çº¿ç¨‹</strong>ï¼Œå¯¹äºè¿™ç§çº¿ç¨‹å¯ä»¥<strong>åœ¨åˆ›å»ºçº¿ç¨‹æ—¶æŒ‡å®šå…¶ç»‘å®šåˆ°æŸä¸ªCPUæ ¸</strong>ä¸Šï¼Œä»¥åè¿™ä¸ªæ ¸å°±ä¸“é—¨å¤„ç†è¯¥çº¿ç¨‹ã€‚è¿™æ ·å¯ä»¥ä½¿å¾—è¯¥çº¿ç¨‹çš„ä»»åŠ¡å¯ä»¥å¾—åˆ°è¾ƒå¿«çš„å¤„ç†(<strong>å› ä¸ºå‡å°‘äº†çº¿ç¨‹ä¸Šä¸‹æ–‡åœ¨å¤šæ ¸é—´åˆ‡æ¢æ—¶å€™çš„å¼€é”€)</strong>ï¼Œç‰¹åˆ«æ˜¯å’Œç”¨æˆ·ç›´æ¥äº¤äº’çš„ä»»åŠ¡ï¼Œè¾ƒçŸ­çš„å“åº”æ—¶é—´å¯ä»¥æå‡ç”¨æˆ·çš„ä½“éªŒæ„Ÿã€‚<br>åŸæ–‡é“¾æ¥ï¼š<a href="https://blog.csdn.net/weixin_42031299/article/details/114376419" target="_blank" rel="noopener">https://blog.csdn.net/weixin_42031299/article/details/114376419</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE             <span class="comment">/* See feature_test_macros(7) */</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_setaffinity_np</span><span class="params">(<span class="keyword">pthread_t</span> thread, <span class="keyword">size_t</span> cpusetsize, <span class="keyword">const</span> <span class="keyword">cpu_set_t</span> *cpuset)</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">pthread_getaffinity_np</span><span class="params">(<span class="keyword">pthread_t</span> thread, <span class="keyword">size_t</span> cpusetssoize, <span class="keyword">cpu_set_t</span> *cpuset)</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç¼–è¯‘å’Œé“¾æ¥çš„æ—¶å€™éœ€è¦åœ¨Makefileä¸­æ·»åŠ  -pthreadåŠ¨æ€soåº“</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">åŸæ–‡é“¾æ¥ï¼šhttps:<span class="comment">//blog.csdn.net/bandaoyu/article/details/113700713</span></span></pre></td></tr></table></figure>
<h4 id="äºŒã€è¿›ç¨‹ç»‘å®šCPUæ ¸å¿ƒ"><a href="#äºŒã€è¿›ç¨‹ç»‘å®šCPUæ ¸å¿ƒ" class="headerlink" title="äºŒã€è¿›ç¨‹ç»‘å®šCPUæ ¸å¿ƒ"></a>äºŒã€è¿›ç¨‹ç»‘å®šCPUæ ¸å¿ƒ</h4><p>åœ¨Linuxç³»ç»Ÿä¸­ï¼Œè¿›ç¨‹çš„è°ƒåº¦åˆ‡æ¢æ˜¯ç”±å†…æ ¸è‡ªåŠ¨å®Œæˆçš„ï¼Œåœ¨å¤šæ ¸CPUä¸Šï¼Œè¿›ç¨‹æœ‰å¯èƒ½åœ¨ä¸åŒçš„CPUæ ¸ä¸Šæ¥å›åˆ‡æ¢æ‰§è¡Œï¼Œè¿™å¯¹CPUçš„ç¼“å­˜ä¸æ˜¯å¾ˆæœ‰åˆ©ã€‚</p>
<p><img src="/2021/07/03/Principles-Of-Computer-Composition-Zero/1.png" alt="CPU"></p>
<p>åœ¨å¤šæ ¸CPUç»“æ„ä¸­ï¼Œæ¯ä¸ªæ ¸å¿ƒæœ‰å„è‡ªçš„L1ã€L2ç¼“å­˜ï¼Œè€ŒL3ç¼“å­˜æ˜¯å…±ç”¨çš„ã€‚å¦‚æœä¸€ä¸ªè¿›ç¨‹åœ¨æ ¸å¿ƒé—´æ¥å›åˆ‡æ¢ï¼Œå„ä¸ª<strong>æ ¸å¿ƒçš„ç¼“å­˜å‘½ä¸­ç‡</strong>å°±ä¼šå—åˆ°å½±å“ã€‚ç›¸åå¦‚æœè¿›ç¨‹ä¸ç®¡å¦‚ä½•è°ƒåº¦ï¼Œéƒ½å§‹ç»ˆå¯ä»¥åœ¨ä¸€ä¸ªæ ¸å¿ƒä¸Šæ‰§è¡Œï¼Œé‚£ä¹ˆå…¶æ•°æ®çš„L1ã€L2 ç¼“å­˜çš„å‘½ä¸­ç‡å¯ä»¥æ˜¾è‘—æé«˜ã€‚å¦‚ä¸‹ä¸ºç»‘å®šCPUçš„å…·ä½“å®ç°ï¼š</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//1ã€ä½¿ç”¨ **CPU_**ç³»åˆ—å‡½æ•°ï¼Œå¿…é¡»å®šä¹‰ _GNU_SOURCE å®ï¼Œå‘Šè¯‰ç¼–è¯‘å™¨å¯ç”¨è¿™äº›å‡½æ•°ã€‚</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//2ã€é¦–å…ˆå£°æ˜ä¸€ä¸ª cpu_set_tï¼Œç„¶åç”¨ CPU_ZERO()åˆå§‹åŒ–bitæ•°æ®ï¼š</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//The cpu_set_t data type is implemented as a bitset. </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">cpu_set_t</span> mask;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//å°†cpu_set_tç»“æ„ä½“æ¸…é›¶ï¼ŒClears set, so that it contains no CPUs. </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">CPU_ZERO(&amp;mask);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ¥ä¸‹æ¥æŠŠè¿›ç¨‹ç»‘å®šåˆ°æŸå‡ ä¸ªCPUæ ¸å¿ƒï¼Œè¿™è¦ç”¨CPU_SET()æ¥è®¾ç½®cpu_set_tä¸­ç›¸åº”çš„bitä½ï¼Œæ¯”å¦‚æƒ³è®©è¿›ç¨‹åªåœ¨æ ¸å¿ƒ1æˆ–æ ¸å¿ƒ5ä¸Šæ‰§è¡Œï¼š</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">CPU_SET(<span class="number">1</span>, &amp;mask); <span class="comment">//Add CPU cpu to set. </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//æœ€åç”¨sched_setaffinityå®Œæˆå®é™…çš„ç»‘å®šï¼š</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//sched_setaffinity(pid_t pid, unsigned int cpusetsize, cpu_set_t *mask) </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¯¥å‡½æ•°è®¾ç½®è¿›ç¨‹ä¸ºpidçš„è¿™ä¸ªè¿›ç¨‹,è®©å®ƒè¿è¡Œåœ¨maskæ‰€è®¾å®šçš„CPUä¸Š.å¦‚æœpidçš„å€¼ä¸º0,åˆ™è¡¨ç¤ºæŒ‡å®šçš„æ˜¯å½“å‰è¿›ç¨‹,ä½¿å½“å‰è¿›ç¨‹è¿è¡Œåœ¨maskæ‰€è®¾å®šçš„é‚£äº›CPUä¸Š.ç¬¬äºŒä¸ªå‚æ•°cpusetsizeæ˜¯maskæ‰€æŒ‡å®šçš„æ•°çš„é•¿åº¦.é€šå¸¸è®¾å®šä¸ºsizeof(cpu_set_t).å¦‚æœå½“å‰pidæ‰€æŒ‡å®šçš„è¿›ç¨‹æ­¤æ—¶æ²¡æœ‰è¿è¡Œåœ¨maskæ‰€æŒ‡å®šçš„ä»»æ„ä¸€ä¸ªCPUä¸Š,åˆ™è¯¥æŒ‡å®šçš„è¿›ç¨‹ä¼šä»å…¶å®ƒCPUä¸Šè¿ç§»åˆ°maskçš„æŒ‡å®šçš„ä¸€ä¸ªCPUä¸Šè¿è¡Œ. </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">sched_setaffinity(<span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">cpu_set_t</span>), &amp;mask);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//sched_getaffinityè·å–ç»‘å®šå…³ç³»</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//Remove CPU cpu from set. </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">CPU_CLR()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//Test to see if CPU cpu is a member of set.  </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">CPU_ISSET()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//Return the number of CPUs in set.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">CPU_COUNT()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//The constant CPU_SETSIZE (currently 1024) specifies a value one greater than the maximum CPU number that can be stored in cpu_set_t. </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">num = sysconf(_SC_NPROCESSORS_CONF);  <span class="comment">//è·å–æ ¸æ•°</span></span></pre></td></tr></table></figure>
<p>ä¸¾ä¾‹ï¼šå‡å®šæœ‰ä¸€å°åŒæ ¸æœºå™¨ï¼Œè¿™æ®µç¨‹åºæˆ‘ä»¬èµ·äº†20ä¸ªè¿›ç¨‹ï¼Œä»0å¼€å§‹æ¯ä¸ªè¿›ç¨‹åˆ†é…ä¸€ä¸ªè¿›ç¨‹å·ï¼ˆæ³¨æ„æ˜¯è¿™é‡Œå€¼æˆ‘ä»¬è‡ªå·±èµ·çš„è¿›ç¨‹å·ï¼Œä¸æ˜¯è¿›ç¨‹pidï¼‰ï¼Œå¥‡æ•°è¿›ç¨‹å·ç»‘å®šç»‘å®šåœ¨ Core 0ä¸Šæ‰§è¡Œï¼Œå¶æ•°å·çš„è¿›ç¨‹ç»‘å®šåœ¨ Core 1ä¸Šæ‰§è¡Œã€‚<br>é“¾æ¥ï¼š<a href="https://www.jianshu.com/p/f59d7df06432" target="_blank" rel="noopener">https://www.jianshu.com/p/f59d7df06432</a></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _GNU_SOURCE</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/time.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> N 100000</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">(<span class="keyword">int</span> pid, <span class="keyword">int</span> core)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">cpu_set_t</span> mask;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">	CPU_ZERO(&amp;mask);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">	CPU_SET(core, &amp;mask);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    è®¾ç½®äº²å’Œæ€§</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">	sched_setaffinity(<span class="number">0</span>, <span class="keyword">sizeof</span>(<span class="keyword">cpu_set_t</span>), &amp;mask);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">	</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">timeval</span> <span class="title">tv</span>;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">	gettimeofday(&amp;tv, <span class="literal">NULL</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">long</span> <span class="built_in">begin</span>=tv.tv_sec * <span class="number">1000</span> * <span class="number">1000</span> + tv.tv_usec;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">	</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">int</span> i;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">int</span> arr[N];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i != N; i++) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">        arr[i] = i;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">long</span> sum = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i != N; i++) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">        sum += arr[i];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">    gettimeofday(&amp;tv, <span class="literal">NULL</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">long</span> <span class="built_in">end</span> = tv.tv_sec * <span class="number">1000</span> * <span class="number">1000</span>+ tv.tv_usec;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">    <span class="built_in">printf</span>(<span class="string">"%ld\n"</span>, <span class="built_in">end</span> - <span class="built_in">begin</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">//for(int i=0; i&lt;2; i++)&#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">//	printf("%d, %d\n",pid,sched_getcpu());</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">//&#125;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">int</span> i;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">for</span>(i=<span class="number">0</span>; i&lt;<span class="number">20</span>; ++i)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">		<span class="keyword">pid_t</span> pid = fork(); <span class="comment">//forkå‡½æ•°</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">		<span class="keyword">if</span>(pid==<span class="number">0</span>)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">			<span class="built_in">run</span>(i, i%<span class="number">2</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">			<span class="built_in">exit</span>(<span class="number">0</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">		&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line">	&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//Makefileç¼–è¯‘å’Œé“¾æ¥</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line">g++ thread_bind_cpu.cpp -o thread_bind_cpu</span></pre></td></tr></table></figure>
<p>æµ‹è¯•çš„éƒ¨åˆ†ç»“æœï¼Œå¾—å‡ºç»‘å®šå¯¹åº”çš„CPUå¯¹è®¡ç®—æ€§èƒ½æœ‰ä¸€å®šçš„æå‡ã€‚</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>æ¬¡æ•°</th>
<th>1</th>
<th>2</th>
<th>3</th>
<th>4</th>
<th>5</th>
<th>6</th>
<th>7</th>
<th>8</th>
<th>9</th>
<th>10</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç»‘CPUæ ¸</td>
<td>849/us</td>
<td>838/us</td>
<td>835/us</td>
<td>818/us</td>
<td>834/us</td>
<td>819/us</td>
<td>838/us</td>
<td>819/us</td>
<td>841/us</td>
<td>823/us</td>
</tr>
<tr>
<td>ä¸ç»‘å®šæ ¸</td>
<td>868/us</td>
<td>903/us</td>
<td>943/us</td>
<td>918/us</td>
<td>954/us</td>
<td>981/us</td>
<td>985/us</td>
<td>987/us</td>
<td>1025/us</td>
<td>960/us</td>
</tr>
</tbody>
</table>
</div>
<p><a href="https://linux.die.net/man/3/cpu_set" target="_blank" rel="noopener">cpu_set_tçš„å‚è€ƒé“¾æ¥</a>  | <a href="https://linux.die.net/man/2/sched_setaffinity" target="_blank" rel="noopener">sched_setaffinityçš„å‚è€ƒé“¾æ¥</a>  </p>
<p><strong>Linuxä¸­çš„fork()å‡½æ•°</strong></p>
<p><strong>ä¸€ä¸ªè¿›ç¨‹</strong>ï¼Œ<strong>åŒ…æ‹¬ä»£ç ã€æ•°æ®å’Œåˆ†é…ç»™è¿›ç¨‹çš„èµ„æº</strong>ã€‚forkï¼ˆï¼‰å‡½æ•°é€šè¿‡ç³»ç»Ÿè°ƒç”¨åˆ›å»ºä¸€ä¸ªä¸åŸæ¥è¿›ç¨‹å‡ ä¹å®Œå…¨ç›¸åŒçš„è¿›ç¨‹ï¼Œä¹Ÿå°±æ˜¯ä¸¤ä¸ªè¿›ç¨‹å¯ä»¥åšå®Œå…¨ç›¸åŒçš„äº‹ã€‚ä¸€ä¸ªè¿›ç¨‹è°ƒç”¨forkï¼ˆï¼‰å‡½æ•°åï¼Œç³»ç»Ÿå…ˆç»™æ–°çš„è¿›ç¨‹åˆ†é…èµ„æºï¼Œä¾‹å¦‚å­˜å‚¨æ•°æ®å’Œä»£ç çš„ç©ºé—´ã€‚ç„¶åæŠŠåŸæ¥çš„è¿›ç¨‹çš„æ‰€æœ‰å€¼éƒ½å¤åˆ¶åˆ°æ–°çš„æ–°è¿›ç¨‹ä¸­ï¼Œåªæœ‰å°‘æ•°å€¼ä¸åŸæ¥çš„è¿›ç¨‹çš„å€¼ä¸åŒã€‚ç›¸å½“äºå…‹éš†äº†ä¸€ä¸ªè‡ªå·±ã€‚åœ¨<strong>forkå‡½æ•°æ‰§è¡Œå®Œæ¯•å</strong>ï¼Œ<strong>å¦‚æœåˆ›å»ºæ–°è¿›ç¨‹æˆåŠŸ</strong>ï¼Œ<strong>åˆ™å‡ºç°ä¸¤ä¸ªè¿›ç¨‹ï¼Œä¸€ä¸ªæ˜¯å­è¿›ç¨‹ï¼Œä¸€ä¸ªæ˜¯çˆ¶è¿›ç¨‹</strong>ã€‚<strong>åœ¨å­è¿›ç¨‹ä¸­ï¼Œforkå‡½æ•°è¿”å›0ï¼Œåœ¨çˆ¶è¿›ç¨‹ä¸­ï¼Œforkè¿”å›æ–°åˆ›å»ºå­è¿›ç¨‹çš„è¿›ç¨‹ID</strong>ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡forkè¿”å›çš„å€¼æ¥åˆ¤æ–­å½“å‰è¿›ç¨‹æ˜¯å­è¿›ç¨‹è¿˜æ˜¯çˆ¶è¿›ç¨‹ã€‚ç”¨å¤§ç¥çš„è¯è¯´â€œå…¶å®å°±ç›¸å½“äºé“¾è¡¨ï¼Œè¿›ç¨‹å½¢æˆäº†é“¾è¡¨ï¼Œçˆ¶è¿›ç¨‹çš„fpid(p æ„å‘³point)æŒ‡å‘å­è¿›ç¨‹çš„è¿›ç¨‹id, å› ä¸ºå­è¿›ç¨‹æ²¡æœ‰å­è¿›ç¨‹ï¼Œæ‰€ä»¥å…¶fpidä¸º0ã€‚</p>
<p>forkå‡ºé”™å¯èƒ½æœ‰ä¸¤ç§åŸå› ï¼š1ã€å½“å‰çš„è¿›ç¨‹æ•°å·²ç»è¾¾åˆ°äº†ç³»ç»Ÿè§„å®šçš„ä¸Šé™ï¼Œè¿™æ—¶errnoçš„å€¼è¢«è®¾ç½®ä¸ºEAGAINã€‚2ã€ç³»ç»Ÿå†…å­˜ä¸è¶³ï¼Œè¿™æ—¶errnoçš„å€¼è¢«è®¾ç½®ä¸ºENOMEMã€‚</p>
<p>åˆ›å»ºæ–°è¿›ç¨‹æˆåŠŸåï¼Œç³»ç»Ÿä¸­å‡ºç°ä¸¤ä¸ªåŸºæœ¬å®Œå…¨ç›¸åŒçš„è¿›ç¨‹ï¼Œè¿™ä¸¤ä¸ªè¿›ç¨‹<strong>æ‰§è¡Œæ²¡æœ‰å›ºå®šçš„å…ˆåé¡ºåº</strong>ï¼Œå“ªä¸ªè¿›ç¨‹å…ˆæ‰§è¡Œè¦çœ‹ç³»ç»Ÿçš„è¿›ç¨‹è°ƒåº¦ç­–ç•¥ã€‚ <strong>æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰ä¸€ä¸ªç‹¬ç‰¹ï¼ˆäº’ä¸ç›¸åŒï¼‰çš„è¿›ç¨‹æ ‡è¯†ç¬¦ï¼ˆprocess IDï¼‰ï¼Œå¯ä»¥é€šè¿‡getpidï¼ˆï¼‰å‡½æ•°è·å¾—</strong>ï¼Œè¿˜æœ‰ä¸€ä¸ªè®°å½•çˆ¶è¿›ç¨‹pidçš„å˜é‡ï¼Œå¯ä»¥é€šè¿‡getppidï¼ˆï¼‰å‡½æ•°è·å¾—å˜é‡çš„å€¼ã€‚</p>
<p><strong>æ³¨æ„ï¼š</strong> <strong>fork()ä¸æ˜¯ä»#includeå¤„å¼€å§‹å¤åˆ¶ä»£ç çš„</strong>ï¼Œè¿™æ˜¯å› ä¸ºforkæ˜¯æŠŠè¿›ç¨‹å½“å‰çš„æƒ…å†µæ‹·è´ä¸€ä»½ï¼Œæ‰§è¡Œforkæ—¶ï¼Œè¿›ç¨‹å·²ç»æ‰§è¡Œå®Œäº†int count=0;forkåªæ‹·è´ä¸‹ä¸€ä¸ªè¦æ‰§è¡Œçš„ä»£ç åˆ°æ–°çš„è¿›ç¨‹ã€‚</p>
<p><a href="https://www.cnblogs.com/dongguolei/p/8086346.html" target="_blank" rel="noopener">åŸæ–‡é“¾æ¥</a></p>
<h4 id="ä¸‰ã€å¯¹ä¸Šé¢ä¸€ã€äºŒçš„è¡¥å……"><a href="#ä¸‰ã€å¯¹ä¸Šé¢ä¸€ã€äºŒçš„è¡¥å……" class="headerlink" title="ä¸‰ã€å¯¹ä¸Šé¢ä¸€ã€äºŒçš„è¡¥å……"></a>ä¸‰ã€å¯¹ä¸Šé¢ä¸€ã€äºŒçš„è¡¥å……</h4><p>1ã€æŸ¥çœ‹ç»‘å®šæƒ…å†µ</p>
<p>æŸ¥çœ‹è¿›ç¨‹çš„ç»‘å®šæ ¸æƒ…å†µï¼š</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">taskset -p pid</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash">&gt;&gt; pid xxx<span class="string">'s current affinity mask: 6 //6çš„äºŒè¿›åˆ¶è¡¨ç¤ºä¸º110,åˆ™è¡¨ç¤ºè¯¥pidåœ¨cpu1å’Œcpu2ä¸Šè¿è¡Œï¼Œä»0å¼€å§‹è®¡æ•°</span></span></span></pre></td></tr></table></figure>
<p>2ã€ç¨‹åºå¯åŠ¨æ—¶ç»‘å®š</p>
<p>3ã€ç¨‹åºå¯åŠ¨åç»‘å®š</p>
<p>4ã€æŸ¥çœ‹cpuçš„æ ¸æ•°</p>
<p>ä½¿ç”¨<code>cat /proc/cpuinfo</code>æŸ¥çœ‹cpuä¿¡æ¯: processoræŒ‡æ˜ç¬¬å‡ ä¸ªcpuå¤„ç†å™¨ï¼Œcpu coresæŒ‡æ˜æ¯ä¸ªå¤„ç†å™¨çš„æ ¸æ•°ã€‚</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sysconf</span><span class="params">(_SC_NPROCESSORS_CONF)</span></span>;<span class="comment">/* è¿”å›ç³»ç»Ÿå¯ä»¥ä½¿ç”¨çš„æ ¸æ•°ï¼Œä½†æ˜¯å…¶å€¼ä¼šåŒ…æ‹¬ç³»ç»Ÿä¸­ç¦ç”¨çš„æ ¸çš„æ•°ç›®ï¼Œå›  æ­¤è¯¥å€¼å¹¶ä¸ä»£è¡¨å½“å‰ç³»ç»Ÿä¸­å¯ç”¨çš„æ ¸æ•° */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">sysconf</span><span class="params">(_SC_NPROCESSORS_ONLN)</span></span>;<span class="comment">/* è¿”å›å€¼çœŸæ­£çš„ä»£è¡¨äº†ç³»ç»Ÿå½“å‰å¯ç”¨çš„æ ¸æ•° */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ä»¥ä¸‹ä¸¤ä¸ªå‡½æ•°ä¸ä¸Šè¿°ç±»ä¼¼ */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sysinfo.h&gt;</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_nprocs_conf</span> <span class="params">(<span class="keyword">void</span>)</span></span>;<span class="comment">/* å¯ç”¨æ ¸æ•° */</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">get_nprocs</span> <span class="params">(<span class="keyword">void</span>)</span></span>;<span class="comment">/* çœŸæ­£çš„åæ˜ äº†å½“å‰å¯ç”¨æ ¸æ•° */</span></span></pre></td></tr></table></figure>
<p>åŸæ–‡é“¾æ¥ï¼š<a href="https://blog.csdn.net/bandaoyu/article/details/113700713" target="_blank" rel="noopener">https://blog.csdn.net/bandaoyu/article/details/113700713</a></p>
<h4 id="å››ã€ç®€è¿°Opaque-ä¸é€æ˜ç±»å‹"><a href="#å››ã€ç®€è¿°Opaque-ä¸é€æ˜ç±»å‹" class="headerlink" title="å››ã€ç®€è¿°Opaque(ä¸é€æ˜ç±»å‹)"></a>å››ã€ç®€è¿°Opaque(ä¸é€æ˜ç±»å‹)</h4><p>åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œ<strong>ä¸é€æ˜æ•°æ®ç±»å‹</strong>(opaque is a data type)æ˜¯å…¶å…·ä½“<strong>æ•°æ®ç»“æ„æœªåœ¨æ¥å£ä¸­å®šä¹‰</strong>çš„æ•°æ®ç±»å‹ã€‚ è¿™ä¼š<strong>å¼ºåˆ¶éšè—ä¿¡æ¯</strong>ï¼Œå› ä¸º<strong>å®ƒçš„å€¼</strong>åªèƒ½<strong>é€šè¿‡è°ƒç”¨æœ‰æƒè®¿é—®</strong>ç¼ºå¤±ä¿¡æ¯<strong>çš„å­ä¾‹ç¨‹</strong>æ¥æ“ä½œã€‚ ç±»å‹çš„<strong>å…·ä½“è¡¨ç¤ºå¯¹å…¶ç”¨æˆ·æ˜¯éšè—çš„</strong>ï¼Œ<strong>å¯è§çš„å®ç°æ˜¯ä¸å®Œæ•´çš„</strong>ã€‚ <strong>å¦‚æœ</strong>è¡¨ç¤ºå¯è§çš„æ•°æ®ç±»å‹ç§°ä¸ºé€æ˜ï¼Œ<strong>å¦åˆ™</strong>ç§°ä¸ºä¸é€æ˜ç±»å‹ã€‚ ä¸é€æ˜æ•°æ®ç±»å‹ç»å¸¸ç”¨äºå®ç°æŠ½è±¡æ•°æ®ç±»å‹ã€‚ </p>
<p>ä¸é€æ˜æ•°æ®ç±»å‹çš„<strong>å…¸å‹ç¤ºä¾‹</strong>åŒ…æ‹¬æ“ä½œç³»ç»Ÿå‘åº”ç”¨è½¯ä»¶æä¾›çš„èµ„æºå¥æŸ„ã€‚ ä¾‹å¦‚ï¼Œçº¿ç¨‹çš„ POSIX æ ‡å‡†å®šä¹‰äº†ä¸€ä¸ªåŸºäºè®¸å¤šä¸é€æ˜ç±»å‹çš„åº”ç”¨ç¨‹åºç¼–ç¨‹æ¥å£ï¼Œè¿™äº›ç±»å‹ä»£è¡¨çº¿ç¨‹æˆ–åŒæ­¥åŸè¯­ï¼Œå¦‚<strong>äº’æ–¥é”æˆ–æ¡ä»¶å˜é‡</strong>ã€‚</p>
<p><a href="https://en.wikipedia.org/wiki/Opaque_data_type" target="_blank" rel="noopener">å‚è€ƒWiki</a></p>
<h4 id="äº”ã€ç¼“å­˜ç›¸å…³å­¦ä¹ ç¬”è®°"><a href="#äº”ã€ç¼“å­˜ç›¸å…³å­¦ä¹ ç¬”è®°" class="headerlink" title="äº”ã€ç¼“å­˜ç›¸å…³å­¦ä¹ ç¬”è®°"></a>äº”ã€ç¼“å­˜ç›¸å…³å­¦ä¹ ç¬”è®°</h4><p>ä¸»è¦å‚è€ƒæ¥è‡ªäº<a href="https://www.cnblogs.com/ricks/p/12400900.html" target="_blank" rel="noopener">æ­¤</a></p>
<h5 id="1ã€åŸºç¡€çŸ¥è¯†ï¼š"><a href="#1ã€åŸºç¡€çŸ¥è¯†ï¼š" class="headerlink" title="1ã€åŸºç¡€çŸ¥è¯†ï¼š"></a>1ã€åŸºç¡€çŸ¥è¯†ï¼š</h5><p>ç°åœ¨çš„CPUå¤šæ ¸æŠ€æœ¯ï¼Œéƒ½ä¼šæœ‰å‡ çº§ç¼“å­˜ï¼Œè€çš„CPUä¼šæœ‰ä¸¤çº§å†…å­˜ï¼ˆL1å’ŒL2ï¼‰ï¼Œæ–°çš„CPUä¼šæœ‰ä¸‰çº§å†…å­˜ï¼ˆL1ï¼ŒL2ï¼ŒL3 ï¼‰ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<p><img src="/2021/07/03/Principles-Of-Computer-Composition-Zero/2.png" alt="cache-architecture"></p>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li>L1ç¼“åˆ†æˆä¸¤ç§ï¼Œä¸€ç§æ˜¯æŒ‡ä»¤ç¼“å­˜ï¼Œä¸€ç§æ˜¯æ•°æ®ç¼“å­˜ã€‚L2ç¼“å­˜å’ŒL3ç¼“å­˜ä¸åˆ†æŒ‡ä»¤å’Œæ•°æ®ã€‚</li>
<li>L1å’ŒL2ç¼“å­˜åœ¨æ¯ä¸€ä¸ªCPUæ ¸ä¸­ï¼ŒL3åˆ™æ˜¯æ‰€æœ‰CPUæ ¸å¿ƒå…±äº«çš„å†…å­˜ã€‚</li>
<li>L1ã€L2ã€L3çš„è¶Šç¦»CPUè¿‘å°±è¶Šå°ï¼Œé€Ÿåº¦ä¹Ÿè¶Šå¿«ï¼Œè¶Šç¦»CPUè¿œï¼Œé€Ÿåº¦ä¹Ÿè¶Šæ…¢ã€‚</li>
</ul>
<p>å†å¾€åé¢å°±æ˜¯å†…å­˜ï¼Œå†…å­˜çš„åé¢å°±æ˜¯ç¡¬ç›˜ï¼Œå¦‚ä¸‹ä¸ºå„çº§çš„å­˜å–é€Ÿåº¦ï¼š</p>
<ul>
<li>L1 çš„å­˜å–é€Ÿåº¦ï¼š<strong>4 ä¸ªCPUæ—¶é’Ÿå‘¨æœŸ</strong></li>
<li>L2 çš„å­˜å–é€Ÿåº¦ï¼š <strong>11 ä¸ªCPUæ—¶é’Ÿå‘¨æœŸ</strong></li>
<li>L3 çš„å­˜å–é€Ÿåº¦ï¼š<strong>39 ä¸ªCPUæ—¶é’Ÿå‘¨æœŸ</strong></li>
<li>RAMå†…å­˜çš„å­˜å–é€Ÿåº¦<strong>ï¼š107 ä¸ªCPUæ—¶é’Ÿå‘¨æœŸ</strong></li>
</ul>
<p>æ•°æ®å°±ä»å†…å­˜å‘ä¸Šï¼Œå…ˆåˆ°L3ï¼Œå†åˆ°L2ï¼Œå†åˆ°L1ï¼Œæœ€ååˆ°å¯„å­˜å™¨è¿›è¡ŒCPUè®¡ç®—ã€‚ä¸ºä»€ä¹ˆä¼šè®¾è®¡æˆä¸‰å±‚ï¼Ÿè¿™é‡Œæœ‰ä¸‹é¢å‡ ä¸ªæ–¹é¢çš„è€ƒè™‘ï¼š</p>
<ul>
<li>ä¸€ä¸ªæ–¹é¢æ˜¯ç‰©ç†é€Ÿåº¦ï¼Œå¦‚æœè¦æ›´å¤§çš„å®¹é‡å°±éœ€è¦æ›´å¤šçš„æ™¶ä½“ç®¡ï¼Œé™¤äº†èŠ¯ç‰‡çš„ä½“ç§¯ä¼šå˜å¤§ï¼Œæ›´é‡è¦çš„æ˜¯å¤§é‡çš„æ™¶ä½“ç®¡ä¼šå¯¼è‡´é€Ÿåº¦ä¸‹é™ï¼Œå› ä¸ºè®¿é—®é€Ÿåº¦å’Œè¦è®¿é—®çš„æ™¶ä½“ç®¡æ‰€åœ¨çš„ä½ç½®æˆåæ¯”ï¼Œä¹Ÿå°±æ˜¯å½“ä¿¡å·è·¯å¾„å˜é•¿æ—¶ï¼Œé€šä¿¡é€Ÿåº¦ä¼šå˜æ…¢ã€‚è¿™éƒ¨åˆ†æ˜¯ç‰©ç†é—®é¢˜ã€‚</li>
<li>å¦å¤–ä¸€ä¸ªé—®é¢˜æ˜¯ï¼Œå¤šæ ¸æŠ€æœ¯ä¸­ï¼Œæ•°æ®çš„çŠ¶æ€éœ€è¦åœ¨å¤šä¸ªCPUä¸­è¿›è¡ŒåŒæ­¥ï¼Œå¹¶ä¸”ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼Œcacheå’ŒRAMçš„é€Ÿåº¦å·®è·å¤ªå¤§ï¼Œæ‰€ä»¥ï¼Œå¤šçº§ä¸åŒå°ºå¯¸çš„ç¼“å­˜æœ‰åˆ©äºæé«˜æ•´ä½“çš„æ€§èƒ½ã€‚</li>
</ul>
<p>åŒæ—¶ä¼šäº§ç”Ÿä¸¤ä¸ªæ¯”è¾ƒé‡è¦çš„é—®é¢˜ï¼š</p>
<ul>
<li>ä¸€ä¸ªæ˜¯æ¯”è¾ƒç®€å•çš„ç¼“å­˜çš„å‘½ä¸­ç‡çš„é—®é¢˜ã€‚</li>
<li>å¦ä¸€ä¸ªæ˜¯æ¯”è¾ƒå¤æ‚çš„ç¼“å­˜æ›´æ–°çš„ä¸€è‡´æ€§é—®é¢˜ã€‚</li>
</ul>
<h5 id="2ã€ç¼“å­˜å‘½ä¸­-è®¡ç®—æœºç»„æˆåŸç†"><a href="#2ã€ç¼“å­˜å‘½ä¸­-è®¡ç®—æœºç»„æˆåŸç†" class="headerlink" title="2ã€ç¼“å­˜å‘½ä¸­(è®¡ç®—æœºç»„æˆåŸç†)"></a>2ã€ç¼“å­˜å‘½ä¸­(è®¡ç®—æœºç»„æˆåŸç†)</h5><p>ç¼“å­˜åŸºæœ¬ä¸Šæ¥è¯´å°±æ˜¯æŠŠåé¢çš„æ•°æ®åŠ è½½åˆ°ç¦»è‡ªå·±è¿‘çš„åœ°æ–¹ï¼Œå¯¹äºCPUæ¥è¯´ï¼Œå®ƒæ˜¯ä¸ä¼šä¸€ä¸ªå­—èŠ‚ä¸€ä¸ªå­—èŠ‚çš„åŠ è½½çš„ï¼Œå› ä¸ºè¿™éå¸¸æ²¡æœ‰æ•ˆç‡ï¼Œ<strong>ä¸€èˆ¬æ¥è¯´éƒ½æ˜¯è¦ä¸€å—ä¸€å—çš„åŠ è½½çš„</strong>ï¼Œå¯¹äºè¿™æ ·çš„ä¸€å—ä¸€å—çš„æ•°æ®å•ä½ï¼Œæœ¯è¯­å«<strong>â€œCache Lineâ€</strong>ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªä¸»æµçš„CPUçš„Cache Line æ˜¯ 64  Bytesï¼ˆä¹Ÿæœ‰çš„CPUç”¨32Byteså’Œ128Bytesï¼‰ï¼Œ64Bytesä¹Ÿå°±æ˜¯16ä¸ª32ä½çš„æ•´å‹ï¼Œè¿™å°±æ˜¯CPUä»å†…å­˜ä¸­ææ•°æ®ä¸Šæ¥çš„æœ€å°æ•°æ®å•ä½ã€‚</p>
<p><strong>æ¯”å¦‚ï¼š</strong>Cache Lineæ˜¯æœ€å°å•ä½ï¼ˆ64Bytesï¼‰ï¼Œæ‰€ä»¥å…ˆæŠŠCacheåˆ†æˆå¤šä¸ªCache Lineï¼Œæ¯”å¦‚ï¼šL1æœ‰32KBï¼Œé‚£ä¹ˆï¼Œ32KB/64B = 512 ä¸ª Cache Lineã€‚</p>
<p>ä¸€æ–¹é¢ï¼Œç¼“å­˜éœ€è¦æŠŠå†…å­˜é‡Œçš„æ•°æ®æ”¾åˆ°æ”¾è¿›æ¥ï¼Œè‹±æ–‡å« <strong>CPU  Associativity</strong>ã€‚Cacheçš„æ•°æ®<strong>æ”¾ç½®çš„ç­–ç•¥</strong>å†³å®šäº†å†…å­˜ä¸­çš„æ•°æ®å—ä¼šæ‹·è´åˆ°CPU  Cacheä¸­çš„å“ªä¸ªä½ç½®ä¸Šï¼Œå› ä¸ºCacheçš„å¤§å°è¿œè¿œå°äºå†…å­˜ï¼Œæ‰€ä»¥ï¼Œéœ€è¦æœ‰ä¸€ç§<strong>åœ°å€å…³è”</strong>çš„ç®—æ³•ï¼Œèƒ½å¤Ÿè®©å†…å­˜ä¸­çš„æ•°æ®å¯ä»¥è¢«æ˜ å°„åˆ°Cacheä¸­æ¥ã€‚</p>
<p>åŸºæœ¬ä¸Šæ¥è¯´ï¼Œä¼šæœ‰å¦‚ä¸‹çš„ä¸€äº›æ–¹æ³•ï¼š</p>
<ul>
<li>ä¸€ç§æ–¹æ³•æ˜¯ï¼Œä»»ä½•ä¸€ä¸ªå†…å­˜åœ°å€çš„æ•°æ®å¯ä»¥è¢«ç¼“å­˜åœ¨ä»»ä½•ä¸€ä¸ªCache Lineé‡Œï¼Œè¿™ç§æ–¹æ³•æ˜¯æœ€çµæ´»çš„ï¼Œ<strong>ä½†æ˜¯</strong>ï¼Œå¦‚æœæˆ‘ä»¬è¦çŸ¥é“ä¸€ä¸ªå†…å­˜æ˜¯å¦å­˜åœ¨äºCacheä¸­ï¼Œæˆ‘ä»¬å°±éœ€è¦è¿›è¡ŒO(n)å¤æ‚åº¦çš„Cacheéå†ï¼Œè¿™æ˜¯å¾ˆæ²¡æœ‰æ•ˆç‡çš„ã€‚<strong>ï¼ˆå…¨ç›¸è”æ–¹å¼ï¼‰</strong></li>
<li>å¦ä¸€ç§æ–¹æ³•ï¼Œä¸ºäº†é™ä½ç¼“å­˜æœç´¢ç®—æ³•ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨åƒHash Tableè¿™æ ·çš„æ•°æ®ç»“æ„ï¼Œæœ€ç®€å•çš„hash tableå°±æ˜¯åšâ€œæ±‚æ¨¡è¿ç®—â€ï¼Œæ¯”å¦‚ï¼šæˆ‘ä»¬çš„L1 Cacheæœ‰512ä¸ªCache Lineï¼Œé‚£ä¹ˆï¼Œå…¬å¼ï¼š<code>ï¼ˆå†…å­˜åœ°å€ mod 512ï¼‰* 64</code> å°±å¯ä»¥ç›´æ¥æ‰¾åˆ°æ‰€åœ¨çš„Cacheåœ°å€çš„åç§»äº†ã€‚<strong>ä½†æ˜¯</strong>ï¼Œè¿™æ ·çš„æ–¹å¼éœ€è¦æˆ‘ä»¬çš„ç¨‹åºå¯¹å†…å­˜åœ°å€çš„è®¿é—®è¦éå¸¸åœ°å¹³å‡ï¼Œä¸ç„¶<strong>å†²çªå°±ä¼šéå¸¸ä¸¥é‡</strong>ã€‚<strong>ï¼ˆç›´æ¥ç›¸è”æ–¹å¼ï¼‰</strong></li>
<li>ä¸ºäº†é¿å…ä¸Šè¿°çš„ä¸¤ç§æ–¹æ¡ˆçš„é—®é¢˜ï¼Œäºæ˜¯å°±è¦å®¹å¿ä¸€å®šçš„hashå†²çªï¼Œä¹Ÿå°±å‡ºç°äº† <strong>N-Way å…³è”</strong>ã€‚ä¹Ÿå°±æ˜¯æŠŠè¿ç»­çš„Nä¸ªCache Lineç»‘æˆä¸€ç»„ï¼Œç„¶åï¼Œå…ˆæŠŠæ‰¾åˆ°ç›¸å…³çš„ç»„ï¼Œç„¶åå†åœ¨è¿™ä¸ªç»„å†…æ‰¾åˆ°ç›¸å…³çš„Cache Lineã€‚è¿™å« <strong>Set Associativity</strong>ã€‚<strong>ä½†æ˜¯</strong>ï¼Œä½†æ˜¯å®ç°éš¾åº¦å’Œé€ ä»·è¦æ¯”ç›´æ¥æ˜ åƒæ–¹å¼é«˜ã€‚<strong>ï¼ˆç»„ç›¸è”æ˜ åƒæ–¹å¼ï¼‰</strong></li>
</ul>
<p><img src="/2021/07/03/Principles-Of-Computer-Composition-Zero/3.png" alt="cache-associative-fill-both"></p>
<p>N-ways  Set-Associativeï¼Œè¿™ä¸ªn=1ï¼Œå°±æ˜¯ç›´æ¥æ˜ å°„ï¼›n=cacheå¤§å°ï¼Œå°±æ˜¯å…¨ç›¸å…³æ˜ å°„ã€‚æˆ‘ä»¬ä»ä¸Šé¢çŸ¥é“ä¸¤è€…éƒ½ä¸å¥½ï¼Œè€Œnæœ€å¥½å–ä¸­é—´æŸä¸ªå€¼ã€‚é‚£ä¹ˆnåˆ°åº•è¯¥é€‰å‡ å‘¢ï¼Ÿè¿™æ¯”è¾ƒå¤æ‚ï¼Œå’ŒCacheçš„é€Ÿåº¦å’Œå¤§å°ã€å†…å­˜çš„é€Ÿåº¦ã€ä¸»é¢‘ç­‰ç­‰å¾ˆå¤šéƒ½ç›¸å…³ï¼Œåœ¨å¾ˆå¤šæƒ…å†µä¸‹éƒ½æ˜¯ä¸ªç»éªŒå€¼ï¼Œä¹Ÿæ˜¯å¤§é‡pre-siliconå®éªŒçš„ç»“æœã€‚</p>
<p>TLBå¯ä»¥çœ‹ä½œé¡µè¡¨çš„Cacheï¼Œ<strong>CPUæ¯æ¬¡è½¬æ¢åœ°å€éƒ½ä¼šæŸ¥çœ‹TLB</strong>ï¼Œ<strong>å¦‚æœæœ‰äº†å°±ä¸ç”¨å»å–å†…å­˜é¡µè¡¨äº†</strong>ã€‚<strong>é‚£ä¹ˆTLBå’ŒCacheæœ‰ä»€ä¹ˆå…³ç³»å‘¢ï¼Ÿ</strong>å¯ä»¥è¯´TLBå‘½ä¸­æ˜¯Cacheå‘½ä¸­çš„åŸºæœ¬æ¡ä»¶ã€‚TLBä¸å‘½ä¸­ï¼Œä¼šæ›´æ–°TLBé¡¹ï¼Œè¿™ä¸ªä»£ä»·éå¸¸å¤§ï¼ŒCacheå‘½ä¸­çš„å¥½å¤„åŸºæœ¬éƒ½æ²¡æœ‰äº†ã€‚<strong>åœ¨TLBå‘½ä¸­çš„æƒ…å†µä¸‹ï¼Œç‰©ç†åœ°å€æ‰èƒ½å¤Ÿè¢«é€‰å‡ºï¼ŒCacheçš„å‘½ä¸­ä¸å¦æ‰èƒ½å¤Ÿè¾¾æˆã€‚</strong>å¯ä»¥çœ‹å‡ºï¼Œåªæœ‰åœ¨TLBå‘½ä¸­çš„å‰æä¸‹ï¼Œæ‰æœ‰å¯èƒ½è·å¾—è™šæ‹Ÿåœ°å€å¯¹åº”çš„ç‰©ç†åœ°å€ï¼ŒçŸ¥é“äº†ç‰©ç†åœ°å€æ‰èƒ½å¾—çŸ¥Cacheæ˜¯å¦å‘½ä¸­ã€‚<a href="https://zhuanlan.zhihu.com/p/31859105" target="_blank" rel="noopener">æ®µè½å‚è€ƒ</a></p>
<p>åœ¨çŸ¥é“ç‰©ç†åœ°å€çš„æƒ…å†µä¸‹ï¼Œå¦‚ä½•åˆ†æCacheæ˜¯å¦å‘½ä¸­ï¼Ÿ</p>
<p>å¦‚ä¸‹å›¾ï¼šæ ¹æ®ç‰©ç†é¡µåœ°å€çš„24ä½æ‰¾åˆ°å¯¹åº”Cacheä¸­çš„ç»„ï¼Œä¹Ÿå³Directoryã€‚ç„¶åæ ¹æ®6bits(2<sup>6</sup>=64)çš„Set IndexæŸ¥æ‰¾ä¸€è·¯ä¸­çš„Cache Lineç´¢å¼•(å› ä¸ºä¸€è·¯ä¸­åŒ…å«å¤šä¸ªCache Line)ï¼Œ6bits(2<sup>6</sup>=64)çš„Offset Into cache lineè¡¨ç¤ºåœ¨Cache Line é‡Œçš„åç§»é‡ã€‚</p>
<p><img src="/2021/07/03/Principles-Of-Computer-Composition-Zero/4.png" alt="cache-associative-fill-both"></p>
<p>ï¼ˆå›¾ç‰‡æ¥è‡ªã€Š<a href="https://manybutfinite.com/post/intel-cpu-caches/" target="_blank" rel="noopener">Cache: a place for concealment and safekeeping</a>ã€‹ï¼‰</p>
<p>ä¸Šé¢çš„å›¾è¯´æ˜L1Cacheå¯ä»¥æ˜ å°„åˆ°36bitsçš„å†…å­˜åœ°å€ï¼Œä¸€å…±2<sup>36</sup>=64GBçš„å†…å­˜ã€‚å½“CPUè¦è®¿é—®ä¸€ä¸ªå†…å­˜çš„æ—¶å€™ï¼Œé€šè¿‡è¿™ä¸ªå†…å­˜çš„å‰24bits å’Œä¸­é—´çš„6bitså¯ä»¥ç›´æ¥å®šä½ç›¸åº”çš„Cache Lineã€‚è¿™é‡Œçš„64GBæ˜¯å¤„ç†å™¨å¯ä»¥å¯»å€ 64GB çš„ç‰©ç† RAMã€‚åŒæ—¶ç”±äºé¡µé¢ä¸€èˆ¬ä¸º4KBã€‚æ‰€ä»¥éœ€è¦å¯»å€çš„ä½ä¸º 64GB / 4KB =2<sup>24</sup>ï¼Œå› æ­¤æˆ‘ä»¬çš„æ ‡ç­¾éœ€è¦ 24 ä½ ã€‚</p>
<p>æ­¤å¤–ï¼Œå½“æœ‰æ•°æ®æ²¡æœ‰å‘½ä¸­ç¼“å­˜çš„æ—¶å€™ï¼ŒCPUå°±ä¼šä»¥æœ€å°ä¸ºCache  Lineçš„å•å…ƒå‘å†…å­˜æ›´æ–°æ•°æ®ã€‚å½“ç„¶ï¼ŒCPUå¹¶ä¸ä¸€å®šåªæ˜¯æ›´æ–°64Bytesï¼Œå› ä¸ºè®¿é—®ä¸»å­˜å®åœ¨æ˜¯å¤ªæ…¢äº†ï¼Œæ‰€ä»¥ï¼Œä¸€èˆ¬éƒ½ä¼šå¤šæ›´æ–°ä¸€äº›ã€‚å¥½çš„CPUä¼šæœ‰ä¸€äº›é¢„æµ‹çš„æŠ€æœ¯ï¼Œå¦‚æœæ‰¾åˆ°ä¸€ç§patternçš„è¯ï¼Œå°±ä¼šé¢„å…ˆåŠ è½½æ›´å¤šçš„å†…å­˜ï¼ŒåŒ…æ‹¬æŒ‡ä»¤ä¹Ÿå¯ä»¥é¢„åŠ è½½ã€‚è¿™å« Prefetching æŠ€æœ¯ ï¼ˆå‚çœ‹ï¼ŒWikipedia çš„ <a href="https://en.wikipedia.org/wiki/Cache_prefetching" target="_blank" rel="noopener">Cache Prefetching</a> å’Œ <a href="http://compas.cs.stonybrook.edu/~nhonarmand/courses/sp16/cse502/slides/13-prefetch.pdf" target="_blank" rel="noopener">çº½çº¦å·ç«‹å¤§å­¦çš„ Memory Prefetching</a>ï¼‰ã€‚æ¯”å¦‚ï¼Œä½ åœ¨for-loopè®¿é—®ä¸€ä¸ªè¿ç»­çš„æ•°ç»„ï¼Œä½ çš„æ­¥é•¿æ˜¯ä¸€ä¸ªå›ºå®šçš„æ•°ï¼Œå†…å­˜å°±å¯ä»¥åšåˆ°prefetchingã€‚<a href="https://www.cnblogs.com/ricks/p/12400900.html" target="_blank" rel="noopener">æ®µè½å‚è€ƒ</a></p>
<h4 id="å…­ã€ç¼“å­˜çš„ä¸€è‡´æ€§"><a href="#å…­ã€ç¼“å­˜çš„ä¸€è‡´æ€§" class="headerlink" title="å…­ã€ç¼“å­˜çš„ä¸€è‡´æ€§"></a>å…­ã€ç¼“å­˜çš„ä¸€è‡´æ€§</h4><p>å¯¹äºä¸»æµçš„CPUæ¥è¯´ï¼Œç¼“å­˜çš„å†™æ“ä½œåŸºæœ¬ä¸Šæ˜¯ä¸¤ç§ç­–ç•¥ï¼š</p>
<ul>
<li>ä¸€ç§æ˜¯Write Backï¼Œå†™æ“ä½œåªè¦åœ¨cacheä¸Šï¼Œç„¶åå†flushåˆ°å†…å­˜ä¸Šã€‚</li>
<li>ä¸€ç§æ˜¯Write Throughï¼Œå†™æ“ä½œåŒæ—¶å†™åˆ°cacheå’Œå†…å­˜ä¸Šã€‚</li>
</ul>
<p>ä¸ºäº†æé«˜å†™çš„æ€§èƒ½ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä¸»æµçš„CPUï¼ˆå¦‚ï¼šIntel Core i7/i9ï¼‰é‡‡ç”¨çš„æ˜¯Write Backçš„ç­–ç•¥ï¼Œå› ä¸ºç›´æ¥å†™å†…å­˜å®åœ¨æ˜¯å¤ªæ…¢äº†ã€‚<strong>ç°åœ¨é—®é¢˜æ¥äº†</strong>ï¼Œå¦‚æœæœ‰ä¸€ä¸ª<strong>æ•°æ® x åœ¨ CPU ç¬¬0æ ¸çš„ç¼“å­˜ä¸Šè¢«æ›´æ–°äº†</strong>ï¼Œé‚£ä¹ˆ<strong>å…¶å®ƒCPUæ ¸ä¸Šå¯¹äºè¿™ä¸ªæ•°æ® x çš„å€¼ä¹Ÿè¦è¢«æ›´æ–°</strong>ï¼Œè¿™å°±æ˜¯ç¼“å­˜ä¸€è‡´æ€§çš„é—®é¢˜ã€‚ï¼ˆå½“ç„¶ï¼Œå¯¹äºæˆ‘ä»¬ä¸Šå±‚çš„ç¨‹åºæˆ‘ä»¬ä¸ç”¨å…³å¿ƒCPUå¤šä¸ªæ ¸çš„ç¼“å­˜æ˜¯æ€ä¹ˆåŒæ­¥çš„ï¼Œè¿™å¯¹ä¸Šå±‚çš„ä»£ç æ¥è¯´éƒ½æ˜¯é€æ˜çš„ï¼‰ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ï¼Œåœ¨CPUç¡¬ä»¶ä¸Šçš„è§£å†³æ–¹æ³•æœ‰ä¸¤ç§æ–¹æ³•ï¼š</p>
<ul>
<li><strong>Directory åè®®ï¼š</strong>è¿™ç§æ–¹æ³•çš„å…¸å‹å®ç°æ˜¯è¦è®¾è®¡ä¸€ä¸ªé›†ä¸­å¼æ§åˆ¶å™¨ï¼Œå®ƒæ˜¯ä¸»å­˜å‚¨å™¨æ§åˆ¶å™¨çš„ä¸€éƒ¨åˆ†ã€‚å…¶ä¸­æœ‰ä¸€ä¸ªç›®å½•å­˜å‚¨åœ¨ä¸»å­˜å‚¨å™¨ä¸­ï¼Œå…¶ä¸­åŒ…å«æœ‰å…³å„ç§æœ¬åœ°ç¼“å­˜å†…å®¹çš„å…¨å±€çŠ¶æ€ä¿¡æ¯ã€‚å½“å•ä¸ªCPU Cache å‘å‡ºè¯»å†™è¯·æ±‚æ—¶ï¼Œè¿™ä¸ªé›†ä¸­å¼æ§åˆ¶å™¨ä¼šæ£€æŸ¥å¹¶å‘å‡ºå¿…è¦çš„å‘½ä»¤ï¼Œä»¥åœ¨ä¸»å­˜å’ŒCPU Cacheä¹‹é—´æˆ–åœ¨CPU  Cacheè‡ªèº«ä¹‹é—´è¿›è¡Œæ•°æ®åŒæ­¥å’Œä¼ è¾“ã€‚</li>
<li><strong>Snoopy åè®®ï¼š</strong>è¿™ç§åè®®æ›´åƒæ˜¯ä¸€ç§æ•°æ®é€šçŸ¥çš„æ€»çº¿å‹çš„æŠ€æœ¯ã€‚CPU Cacheé€šè¿‡è¿™ä¸ªåè®®å¯ä»¥è¯†åˆ«å…¶å®ƒCacheä¸Šçš„æ•°æ®çŠ¶æ€ã€‚å¦‚æœæœ‰æ•°æ®å…±äº«çš„è¯ï¼Œå¯ä»¥é€šè¿‡å¹¿æ’­æœºåˆ¶å°†å…±äº«æ•°æ®çš„çŠ¶æ€é€šçŸ¥ç»™å…¶å®ƒCPU Cacheã€‚è¿™ä¸ªåè®®è¦æ±‚æ¯ä¸ªCPU Cache éƒ½å¯ä»¥<strong>çª¥æ¢</strong>æ•°æ®äº‹ä»¶çš„é€šçŸ¥å¹¶åšå‡ºç›¸åº”çš„ååº”ã€‚<a href="https://www.cnblogs.com/ricks/p/12400900.html" target="_blank" rel="noopener">æ®µè½å‚è€ƒ</a></li>
</ul>
<h4 id="ä¸ƒã€ç¨‹åºè™šæ‹Ÿåœ°å€å’Œå®é™…ç‰©ç†åœ°å€çš„æ˜ å°„"><a href="#ä¸ƒã€ç¨‹åºè™šæ‹Ÿåœ°å€å’Œå®é™…ç‰©ç†åœ°å€çš„æ˜ å°„" class="headerlink" title="ä¸ƒã€ç¨‹åºè™šæ‹Ÿåœ°å€å’Œå®é™…ç‰©ç†åœ°å€çš„æ˜ å°„"></a>ä¸ƒã€ç¨‹åºè™šæ‹Ÿåœ°å€å’Œå®é™…ç‰©ç†åœ°å€çš„æ˜ å°„</h4><p>æŒ‡ä»¤é‡Œé¢çš„åœ°å€æ˜¯ç¨‹åºç©ºé—´ï¼ˆè™šæ‹Ÿç©ºé—´ï¼‰çš„è™šæ‹Ÿåœ°å€ï¼ˆç¨‹åºåœ°å€ï¼‰ã€‚æ‰€ä»¥å½“ ç¨‹åºçœŸæ­£è¿è¡Œèµ·æ¥çš„æ—¶å€™ï¼Œæ¯ä¸ªè™šæ‹Ÿåœ°å€å¿…ç„¶è¦å¯¹åº”ç€ä¸€ä¸ªç‰©ç†åœ°å€ï¼ˆå®é™…å­˜åœ¨ï¼‰ã€‚</p>
<p>åˆ†é¡µå†…å­˜ç®¡ç†æœºåˆ¶å°†è™šæ‹Ÿå†…å­˜å’Œç‰©ç†å†…å­˜éƒ½åˆ†æˆå¤§å°ä¸€æ ·å¤§çš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬ç§°ä¸ºé¡µï¼Œç„¶åæŒ‰é¡µè¿›è¡Œå†…å­˜åˆ†é…ã€‚ä¸€èˆ¬é¡µçš„å¤§å°æœ‰4KBã€8KBã€16KBã€‚åœ¨è¯¥ç®¡ç†æœºåˆ¶ä¸‹å†…å­˜åˆ†é…å•ä½åŒ–è€Œä¸”ä¸éœ€è¦ç©ºé—²è¿ç»­åœ¨ä¸€èµ·å³å¯ä½¿ç”¨ã€‚<strong>è™šæ‹Ÿåœ°å€çš„é¡µå·è¡¨ç¤ºå’Œç‰©ç†åœ°å€é¡µå·è¡¨ç¤ºæ˜¯ä»0å¼€å§‹çš„</strong>ã€‚</p>
<p><strong>å†…å­˜çš„ä¸¤ç§è§†è§’</strong></p>
<ul>
<li>è™šæ‹Ÿåœ°å€(çº¿æ€§åœ°å€)ï¼Œè¿›ç¨‹çœ‹åˆ°çš„å†…å­˜åœ°å€ç§°ä¸ºè™šæ‹Ÿåœ°å€ï¼Œä»–ä»¬ä¸å¯¹åº”ä»»ä½•ç‰©ç†å®ä½“ï¼Œæ¯ä¸ªè¿›ç¨‹æœ‰è‡ªå·±çš„åœ°å€ç©ºé—´ã€‚</li>
<li>ç‰©ç†åœ°å€ï¼Œå†…å­˜ç³»ç»Ÿçœ‹åˆ°çš„åœ°å€ç§°ä¸ºç‰©ç†åœ°å€ï¼Œä»–ä»¬ç”¨å®é™…çš„åœ°å€å»æŸ¥æ‰¾å’Œå­˜å‚¨å†…å®¹ã€‚</li>
</ul>
<p><strong>ä¸ºä»€ä¹ˆï¼Ÿ</strong>å¦‚æœè¿è¡Œå¤šä¸ªè¿›ç¨‹ï¼Œç›´æ¥å°†å†…å®¹æ˜ å°„åˆ°ç‰©ç†åœ°å€çš„è¯å¯èƒ½ä¼šå­˜åœ¨è®¿é—®å†²çªã€‚æ‰€ä»¥éœ€è¦ç›¸å¯¹åœ°å€ï¼Œè¿›è€Œä¿æŠ¤è¿›è¡Œã€‚å› æ­¤ï¼Œåœ¨æ—©æœŸçš„æ—¶å€™è®¾ç½®äº†åœ°å€ç©ºé—´ï¼Œåˆ©ç”¨<strong>åŠ¨æ€é‡å®šä½æŠ€æœ¯</strong>ç”¨ä¸¤ä¸ªå¯„å­˜å™¨åˆ†åˆ«ä¸º<strong>åŸºå€å¯„å­˜å™¨</strong>å’Œ<strong>ç•Œé™å¯„å­˜å™¨</strong>ï¼Œå°†è¿›ç¨‹çš„èµ·å§‹åœ°å€æ”¾åˆ°åŸºå€å¯„å­˜å™¨ä¸­ï¼Œè¿›ç¨‹å æ®å†…å­˜çš„é•¿åº¦å­˜åˆ°ç•Œé™å¯„å­˜å™¨ä¸­ï¼Œè¿™æ ·å°±ç›¸å½“äºä¸ºè¿›ç¨‹åˆ’æ¸…äº†ç•Œé™ã€‚<strong>(è¦æ±‚ä¸ºå†…å­˜ç©ºé—´è¿ç»­)ã€‚</strong>ä½†æ˜¯ä¼šé‡åˆ°ä»€ä¹ˆé—®é¢˜ï¼Ÿå½“è¿›ç¨‹å¾ˆå¤šçš„æ—¶å€™ï¼Œå†…å­˜ä¸­æ”¾ä¸ä¸‹ï¼Œé‚£ä¹ˆåªèƒ½åˆ©ç”¨<strong>å†…å­˜çš„äº¤æ¢æŠ€æœ¯(swapping)</strong>å°†ä¸€éƒ¨åˆ†<strong>è¿›ç¨‹</strong>æš‚æ—¶æ”¾åˆ°ç£ç›˜ä¸­ï¼Œä½†æ˜¯åœ¨äº¤æ¢çš„è¿‡ç¨‹ä¸­ä¼šå‡ºç°å¤§é‡çš„<strong>å†…å­˜ç©ºæ´</strong>ï¼Œæ‰€ä»¥éœ€è¦å°†å†…å­˜ä¸­çš„<strong>è¿›ç¨‹å‘ä½åœ°å€ç§»åŠ¨</strong>ï¼Œä»¥ä¾¿ç•™å‡ºæ›´å¤§çš„ç©ºé—´ï¼Œç§°ä¸º<strong>å†…å­˜ç´§ç¼©</strong>ã€‚ä½†æ˜¯ä¼šè€—è´¹å¤§é‡çš„CPUæ—¶é—´ã€‚<strong>ä¸€ä¸ªæ›´å¥½çš„æ–¹æ³•</strong>ï¼Œå°†è¿›ç¨‹æ‰€éœ€çš„å†…å­˜åˆ‡æˆä¸€ä¸ªä¸ªå°å—ï¼Œæ¯”å¦‚4KBå¤§å°ï¼Œç§°ä¸ºä¸€é¡µï¼Œå…¶ä¸­åªæœ‰ä¸€éƒ¨åˆ†çš„é¡µåœ¨å†…å­˜ä¸­ï¼Œå½“cpuéœ€è¦æ–¹ä½çš„åœ°å€ä¸åœ¨å†…å­˜ä¸­æ—¶ï¼Œå¯ä»¥ä»ç£ç›˜åŠ è½½å¯¹åº”çš„éƒ¨åˆ†ï¼ŒåŒæ—¶å†…å­˜ä¸å¤Ÿæ—¶ä¹Ÿå¯ä»¥æŠŠé•¿æœŸä¸è®¿é—®çš„é¡µé¢ä¿å­˜åˆ°ç£ç›˜ä¸­ï¼Œç„¶ååˆ é™¤å†…å­˜ä¸­çš„éƒ¨åˆ†ã€‚è¿™ç§åšæ³•ç§°ä¸ºè™šæ‹Ÿå†…å­˜ã€‚</p>
<p>å†…å­˜å¦‚ä½•ç®¡ç†ï¼ŸæŸ¥çœ‹æ˜¯å¦æœ‰è¶³å¤Ÿå¤§çš„å†…å­˜èƒ½å¤Ÿæ»¡è¶³è¿›ç¨‹çš„è¦æ±‚</p>
<ol>
<li>ä½å›¾ï¼šå°†å†…å­˜åˆ’åˆ†ä¸ºå•ä½å°åŒºåŸŸï¼Œæ¯ä¸ªåŒºåŸŸç”±0/1è¡¨ç¤ºçŠ¶æ€ï¼ˆç©ºé—²/å ç”¨ï¼‰ã€‚å½“ä¸€ä¸ªè¿›ç¨‹éœ€è¦åŠ è½½å†…å­˜æ˜¯ï¼Œéœ€è¦æ‰«æè¿ç»­ä¸º0çš„ç©ºé—²åŒºåŸŸï¼Œä½œä¸ºè¿›ç¨‹çš„å†…å­˜åŒºåŸŸã€‚ç¼ºç‚¹æŸ¥æ‰¾æ¯”è¾ƒè€—æ—¶ã€‚</li>
<li>é“¾è¡¨ï¼šä¸ºäº†è§„é¿ä½å›¾è€—æ—¶çš„é—®é¢˜ï¼Œæ¯ä¸€å—è¿ç»­çš„åŒºåŸŸåˆ†åˆ«ç”±ä¸€ä¸ªèŠ‚ç‚¹è¡¨ç¤ºï¼ŒèŠ‚ç‚¹æœ‰4ä¸ªå€¼ï¼Œç¬¬ä¸€ä¸ªè‹¥ä¸ºPï¼Œåˆ™è¡¨ç¤ºè¿™å—åŒºåŸŸæ˜¯æœ‰è¿›ç¨‹çš„ï¼ŒHåˆ™ä»£è¡¨ç©ºé—²åŒºã€‚ç¬¬äºŒä¸ªå€¼æŒ‡å‘å¯¹åº”åŒºåŸŸçš„èµ·å§‹ä½ç½®ï¼Œç¬¬ä¸‰ä¸ªå€¼å¯¹åº”çš„æ˜¯åŒºåŸŸçš„é•¿åº¦ï¼Œç¬¬å››ä¸ªå€¼æ˜¯ä¸ªæŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚è¿›ç¨‹åŠ è½½å†…å­˜æ˜¯æ‰«æç¬¬ä¸€ä¸ªå€¼ï¼Œç§°ä¸ºé¦–æ¬¡é€‚é…ç®—æ³•ã€‚æ­¤å¤–ï¼Œè¿˜æ˜¯æœ‰æœ€ä½³é€‚é…ç®—æ³•ç­‰ã€‚</li>
</ol>
<p>ä»‹ç»ä¸€ä¸‹æ•´ä¸ªåœ°å€æ˜ å°„çš„å…³ç³»ï¼š</p>
<p>é¦–å…ˆç¨‹åºå¯¹åº”çš„æ˜¯é€»è¾‘åœ°å€ï¼Œå…¶ä¸­åŒ…æ‹¬ä»£ç ã€æ•°æ®ã€å †(ä»ä½åœ°å€å¾€é«˜åœ°å€å¯»å€)ã€æ ˆ(ä»é«˜åœ°å€å¾€ä½åœ°å€å¯»å€)ã€‚ä¾‹å¦‚ï¼šæ ˆåœ°å€éœ€è¦æ ¹æ®é€»è¾‘åœ°å€(è™šæ‹Ÿåœ°å€)selector:offsetï¼Œæ ¹æ®selectorä»GDT(Global Descriptor Table)ä¸­è·å–æ®µæè¿°ç¬¦å…¶ä¸­åŒ…å«Base Addressï¼Œç»“åˆé€»è¾‘åœ°å€ä¸­çš„offsetèƒ½å¤Ÿè®¡ç®—å‡ºçº¿æ€§åœ°å€ã€‚æœ€åï¼Œæ ¹æ®çº¿æ€§åœ°å€(22-31ä½)ï¼Œä»CR3å¯„å­˜å™¨ä¸­è·å–åˆ°é¡µç›®å½•çš„åœ°å€(Base Address)ï¼Œçº¿æ€§åœ°å€ä¸­è®°è½½äº†é¡µç›®å½•çš„offsetï¼ŒåŠ ä¸Šoffsetå¾—åˆ°é¡µè¡¨çš„Base Addressï¼ŒåŠ ä¸Šçº¿æ€§åœ°å€ä¸­(12-22ä½)çš„offsetï¼Œå¾—åˆ°ç‰©ç†åœ°å€ä¸­çš„åŸºåœ°å€ï¼ŒåŠ ä¸Šåç§»é‡(çº¿æ€§åœ°å€)ä¸­çš„(0-12ä½)å¾—åˆ°ç‰©ç†åœ°å€ä¸­çš„ç¬¬å‡ é¡µã€‚</p>
<p>ç¨‹åºè™šæ‹Ÿç©ºé—´ä¸­çš„è™šæ‹Ÿåœ°å€<strong>é€šè¿‡åˆ†æ®µæœºåˆ¶</strong>å¾—åˆ°è™šæ‹Ÿåœ°å€/çº¿æ€§åœ°å€ï¼Œçº¿æ€§åœ°å€<strong>é€šè¿‡åˆ†é¡µæœºåˆ¶</strong>ï¼ˆéœ€è¦ç”¨åˆ°é¡µè¡¨(page table)ï¼Œæ¯æ¬¡åœ°å€è½¬æ¢éƒ½è¦æŸ¥çœ‹å†…å­˜é¡µè¡¨å¤ªæµªè´¹æ—¶é—´äº†ã€‚ç°ä»£è®¡ç®—æœºä¸ºäº†åŠ é€Ÿè¿™ä¸€è¿‡ç¨‹ï¼Œè½¬è¯‘åå¤‡ç¼“å†²åŒºTLBï¼‰å¾—åˆ°çœŸå®çš„ç‰©ç†åœ°å€ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/06/27/Image-Process-There-Plus/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qiang Chen">
      <meta itemprop="description" content="è®°å½•æ˜¯å¿˜è®°çš„ç¬¬ä¸€åŠ©æ‰‹.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ç¼–è¾‘å°¼æ’‘">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/27/Image-Process-There-Plus/" class="post-title-link" itemprop="url">Image-Process-There-Plus</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-06-27 10:06:52 / ä¿®æ”¹æ—¶é—´ï¼š10:29:29" itemprop="dateCreated datePublished" datetime="2021-06-27T10:06:52+08:00">2021-06-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Image-Processing/" itemprop="url" rel="index">
                    <span itemprop="name">Image Processing</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="å›¾åƒå¤„ç†å­¦ä¹ "><a href="#å›¾åƒå¤„ç†å­¦ä¹ " class="headerlink" title="å›¾åƒå¤„ç†å­¦ä¹ "></a>å›¾åƒå¤„ç†å­¦ä¹ </h2><h3 id="é¢‘ç‡åŸŸæ»¤æ³¢"><a href="#é¢‘ç‡åŸŸæ»¤æ³¢" class="headerlink" title="é¢‘ç‡åŸŸæ»¤æ³¢"></a>é¢‘ç‡åŸŸæ»¤æ³¢</h3><h4 id="ä¸€ã€åŸºæœ¬æ¦‚å¿µ"><a href="#ä¸€ã€åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="ä¸€ã€åŸºæœ¬æ¦‚å¿µ"></a>ä¸€ã€åŸºæœ¬æ¦‚å¿µ</h4><h5 id="1ã€å¤æ•°"><a href="#1ã€å¤æ•°" class="headerlink" title="1ã€å¤æ•°"></a>1ã€å¤æ•°</h5><p>å¤æ•°Cçš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<script type="math/tex; mode=display">
C=R=jI, \quad å…¶ä¸­ï¼ŒRå’ŒIæ˜¯å®æ•°ï¼Œjæ˜¯ä¸€ä¸ªç­‰äº-1çš„å¹³æ–¹æ ¹çš„è™šæ•°ã€‚å³j=\sqrt{-1}</script><p>Rè¡¨ç¤ºå¤æ•°çš„å®éƒ¨ï¼ŒIæ˜¯å¤æ•°çš„è™šéƒ¨ã€‚å®æ•°æ˜¯I=0çš„å¤æ•°çš„å­é›†ã€‚ä¸€ä¸ªå¤æ•°Cçš„å…±è½­è¡¨ç¤ºä¸ºC<sup>*</sup>, å…¶å®šä¹‰æ˜¯ï¼š</p>
<script type="math/tex; mode=display">
C^*=R-jI</script><p>å¤æ•°ä»å‡ ä½•çš„è§’åº¦å¯ä»¥è¢«çœ‹åšæ˜¯å¹³é¢(ç§°ä¸ºå¤å¹³é¢)ä¸Šçš„ä¸€ä¸ªç‚¹ï¼Œå…¶æ¨ªåæ ‡æ˜¯å®è½´(Rçš„å€¼)ï¼Œå…¶çºµåæ ‡æ˜¯è™šè½´(Içš„å€¼)ã€‚å¤æ•°R+jIå¯ä»¥çœ‹æˆæ˜¯å¤å¹³é¢ç›´è§’åæ ‡ç³»ç»Ÿä¸­çš„ç‚¹ï¼ˆRï¼ŒIï¼‰ã€‚</p>
<p>ä¸‹å›¾æ˜¯ç”Ÿæˆæ­£å¼¦æ³¢çš„å›¾åƒï¼š</p>
<p><img src="/2021/06/27/Image-Process-There-Plus/1.png" alt="Image-Process-Three-Plus"></p>
<p><img src="/2021/06/27/Image-Process-There-Plus/2.png" alt="Image-Process-Three-Plus"></p>
<p>ç”±ä¸Šå›¾å¯çŸ¥ï¼Œæåæ ‡ä¸‹çš„å¤æ•°è¡¨ç¤ºä¸ºï¼š</p>
<script type="math/tex; mode=display">
C=R+jI=\sqrt{R^2+I^2}\left(\frac{R}{\sqrt{R^2+I^2}}+\frac{I}{\sqrt{R^2+I^2}}j\right)</script><script type="math/tex; mode=display">
\because\frac{R}{\sqrt{R^2+I^2}}=\cos\theta,\frac{I}{\sqrt{R^2+I^2}}=\sin\theta</script><script type="math/tex; mode=display">
\therefore C=|C|(\cos\theta+j\sin\theta), |C|=\sqrt{R^2+I^2}\quad(æ¨¡é•¿)</script><script type="math/tex; mode=display">
\thetaä¸ºå¹…è§’ï¼Œ\tan\theta=(I/R),\theta=\arctan(I/R),\theta\in[-\pi/2,\pi/2]</script><p>ç„¶åç”±äºRå’ŒIå¯æ­£ã€å¯è´Ÿï¼Œæ‰€ä»¥&theta;&in;[-&pi;, &pi;]ã€‚</p>
<p><strong>æ¬§æ‹‰å…¬å¼ï¼š</strong></p>
<script type="math/tex; mode=display">
e^{i\theta}=\cos\theta+i\sin\theta,\quad(\theta\in R)</script><p><strong>ä¸ºä»€ä¹ˆæ¬§æ‹‰å…¬å¼èƒ½ç”¨ä¸Šå¼è¡¨ç¤ºï¼Ÿ</strong></p>
<p>åœ¨å®æ•°åŸŸä¸‹ï¼Œæœ‰äº›å‡½æ•°çš„æ³°å‹’å…¬å¼å¦‚ä¸‹:</p>
<script type="math/tex; mode=display">
e^x=1+x+\frac{1}{2!}x^2+\frac{1}{3!}x^3+...</script><script type="math/tex; mode=display">
\sin x=x-\frac{1}{3!}x^3+\frac{1}{5!}s^5+...</script><script type="math/tex; mode=display">
\cos x=1-\frac{1}{2!}x^2+\frac{1}{4!}x^4+...</script><p>è¿™ä¸‰ä¸ªå…¬å¼åˆ†ä¸ºä¸ºçœç•¥ä½™é¡¹çš„éº¦å…‹åŠ³æ—å…¬å¼ï¼Œä¸­éº¦å…‹åŠ³æ—å…¬å¼ä¸ºæ³°å‹’å…¬å¼çš„ä¸€ç§ç‰¹æ®Šå½¢å¼ã€‚</p>
<p>åœ¨e<sup>x</sup>çš„å±•å¼€å¼ä¸­æŠŠxæ¢æˆ&pm;(ix)</p>
<script type="math/tex; mode=display">
(\pm i)^2=-1,(\pm i)^3=\mp i,(\pm i)^4=1......</script><script type="math/tex; mode=display">
e^{\pm ix}=1\pm \frac{ix}{1!}-\frac{x^2}{2!}\mp\frac{ix^3}{3!}+\frac{x^4}{4!}.....=(1-\frac{x^2}{2!}+......)\pm i(x-\frac{x^3}{3!}......)</script><script type="math/tex; mode=display">
\therefore e^{\pm ix}=\cos x \pm i\sin x</script><p>ç”±æ­¤ï¼š</p>
<script type="math/tex; mode=display">
e^{ix}=\cos x+i\sin x, e^{-ix}=\cos x-i\sin x</script><script type="math/tex; mode=display">
\sin x=\frac{e^{ix}-e^{-ix}}{2i},\cos x=\frac{e^{ix}+e^{-ix}}{2}</script><script type="math/tex; mode=display">
e^{ix}=\cos x+i\sin x,ä»¤x=\pi,e^{ix}+1=0</script><p>å¤å‡½æ•°ï¼šå˜é‡uçš„å¤å‡½æ•°F(u)å¯è¡¨ç¤ºä¸ºF(u)=R(u)+jI(u)ï¼Œå…¶ä¸­R(u)è¡¨ç¤ºå®åˆ†é‡å‡½æ•°ï¼ŒI(u)è¡¨ç¤ºè™šåˆ†é‡å‡½æ•°ã€‚å¤å…±è½­å‡½æ•°æ˜¯ï¼š</p>
<script type="math/tex; mode=display">
F^*(U) = R(U)-jI(u),å¹…å€¼æ˜¯|F(u)|=\sqrt{R(u)^2+I(u)^2},è§’åº¦æ˜¯:\theta=\arctan[I(u)/R(u)]</script><h4 id="äºŒã€å‚…é‡Œå¶çº§æ•°"><a href="#äºŒã€å‚…é‡Œå¶çº§æ•°" class="headerlink" title="äºŒã€å‚…é‡Œå¶çº§æ•°"></a>äºŒã€å‚…é‡Œå¶çº§æ•°</h4><p>å…·æœ‰å‘¨æœŸTçš„è¿ç»­å˜é‡tçš„å‘¨æœŸå‡½æ•°f(t)å¯ä»¥è¢«æè¿°ä¸ºä¹˜ä»¥é€‚å½“ç³»æ•°çš„æ­£å¼¦å’Œä½™å¼¦å’Œã€‚è¯¥å’Œç§°ä¸ºå‚…é‡Œå¶çº§æ•°ï¼Œå…·æœ‰å¦‚ä¸‹å½¢å¼ï¼š</p>
<script type="math/tex; mode=display">
f(t)=\sum^{\infty}_{n=-\infty}c_ne^{j\frac{2\pi n}{T}t},å…¶ä¸­ï¼Œc_n=\frac{1}{T}\int^{T/2}_{-T/2}f(t)e^{-j\frac{2\pi n}{T}t}dt,n=0,\pm1,\pm2...\quadæ˜¯ç³»æ•°</script><p><strong>ç”±æ¥ï¼š</strong>é¦–å…ˆï¼Œå‘¨æœŸå‡½æ•°æ˜¯å®¢è§‚ä¸–ç•Œä¸­å‘¨æœŸè¿åŠ¨çš„æ•°å­¦è¡¨è¿°ï¼Œå¦‚ç‰©ä½“æŒ‚åœ¨å¼¹ç°§ä¸Šä½œç®€è°æŒ¯åŠ¨ã€å•æ‘†æŒ¯åŠ¨ã€æ— çº¿ç”µç”µå­æŒ¯è¡å™¨çš„ç”µå­æŒ¯è¡ç­‰ï¼Œå¤§å¤šå¯ä»¥è¡¨è¿°ä¸ºå¦‚ä¸‹çš„ä¸‰è§’å‡½æ•°ï¼š</p>
<script type="math/tex; mode=display">
f(t)=A\sin(\omega t+\psi)</script><p>è¿™é‡Œtè¡¨ç¤ºæ—¶é—´ï¼ŒAè¡¨ç¤ºæŒ¯å¹…ï¼Œ&omega;ä¸ºè§’é¢‘ç‡ï¼Œ&psi;ä¸ºåˆç›¸(ä¸è€ƒå¯Ÿæ—¶è®¾ç½®åŸç‚¹ä½ç½®æœ‰å…³ï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªå¸¸é‡)ã€‚</p>
<p>ä¸–ç•Œä¸Šè®¸å¤šå‘¨æœŸä¿¡å·å¹¶éæ­£å¼¦å‡½æ•°é‚£ä¹ˆç®€å•ï¼Œå¦‚æ–¹æ³¢ã€ä¸‰è§’æ³¢ç­‰ã€‚ä¸ºäº†ç®€åŒ–è¡¨ç¤ºï¼Œå¸Œæœ›ç”¨ä¸€ç³»åˆ—ä¸‰è§’å‡½æ•°æ¥è¡¨è¾¾å¤æ‚çš„å‘¨æœŸå‡½æ•°ã€‚æ‰€ä»¥æœ‰ä¸‹å¼ï¼š</p>
<script type="math/tex; mode=display">
f(t)=A_0+\sum^{\infty}_{n=1}A_n\sin(n\omega t+\psi_n)</script><p>å‚…é‡Œå¶æ˜¯æƒ³æŠŠä¸€ä¸ªå‘¨æœŸå‡½æ•°è¡¨ç¤ºæˆè®¸å¤šæ­£å¼¦å‡½æ•°çš„çº¿æ€§å åŠ ï¼Œè¿™è®¸è®¸å¤šå¤šçš„æ­£å¼¦å‡½æ•°æœ‰ç€ä¸åŒçš„å¹…åº¦åˆ†é‡A<sub>n</sub>ã€æœ‰ä¸åŒçš„å‘¨æœŸæˆ–é¢‘ç‡nï¼Œæœ‰ä¸åŒçš„åˆç›¸è§’&psi;<sub>n</sub>ï¼Œè¿˜æœ‰ä¸€ä¸ªå¸¸æ•°é¡¹A<sub>0</sub>ã€‚nä»1åˆ°æ— ç©·ï¼Œæ˜¯ä¸€ä¸ªæ— ç©·çº§æ•°ã€‚</p>
<p><strong>è¿™é‡Œå¼ºè°ƒä¸€ä¸‹ï¼Œå‚…é‡Œå¶çº§æ•°ä¸­å¯¹ä¸åŒé¢‘ç‡çš„æ³¢æœ‰ä¸€ä¸ªè¦æ±‚å°±æ˜¯ç»™å®šä¸€ä¸ªåˆå§‹çš„é¢‘ç‡&omega;<sub>0</sub>ï¼Œä¹‹åçš„è§’é¢‘ç‡å¿…é¡»æ˜¯&omega;<sub>0</sub>çš„æ•´æ•°å€ï¼Œè¿™ä¹Ÿæ˜¯ç¦»æ•£å‚…é‡Œå¶å˜æ¢ä¸­è§’é¢‘ç‡å–å€¼çš„åŸåˆ™ã€‚</strong></p>
<p> è¦æ±‚f(t)çš„è¡¨è¾¾å¼ï¼Œéœ€è¦æ±‚å„é¡¹ç³»æ•°ï¼Œæ‰€ä»¥å¯¹ä¸Šå¼åšå˜æ¢ï¼š</p>
<script type="math/tex; mode=display">
A_n\sin(n\omega t+\psi_n)=A_n\sin\psi_n\cos(n\omega t)+A_n\cos\psi_n\sin(n\omega_nt)</script><p>ä¸Šå¼ç”±ä¸‹é¢çš„ä¸‰è§’å…¬å¼å¾—å‡ºï¼š</p>
<script type="math/tex; mode=display">
\sin(\alpha\pm\beta)=\sin\alpha\cos\beta\pm\cos\alpha\sin\beta</script><p>è®°ä¸‹å¼ä¸ºå¸¸æ•°é¡¹ï¼š</p>
<script type="math/tex; mode=display">
a_n=A_n\cdot\sin\psi_n, b_n=A_n\cdot\cos\psi_n</script><p>åˆ™ï¼š</p>
<script type="math/tex; mode=display">
f(t)=A_0+\sum^{\infty}_{n=1}A_n\sin(n\omega t+\psi_n)=A_0+\sum^{\infty}_{n=1}[a_n\cos(n\omega t)+b_n\sin(n\omega t)]</script><p>ä»ä¸Šå¼å¯ä»¥çœ‹å‡ºï¼Œåªéœ€è¦æ±‚è§£A<sub>0</sub>ï¼Œa<sub>n</sub>ï¼Œb<sub>n</sub>çš„å€¼å³å¯ã€‚</p>
<p>ç”±çº¿æ€§ä»£æ•°ä¸­å·²çŸ¥ç©ºé—´ä¸­çš„ä¸€ç»„æ­£äº¤åŸºï¼Œé‚£ä¹ˆç©ºé—´ä¸­çš„ä»»æ„å‘é‡è¡¨ç¤ºä¸ºè¿™ç»„åŸºçš„çº¿æ€§ç»„åˆï¼š</p>
<script type="math/tex; mode=display">
v=x_1q_q+x_2q_2+...+x_nq_n,çŸ©é˜µå½¢å¼ä¸ºï¼šV=QX</script><p>è¦æ±‚x<sub>1</sub>,ç›´æ¥ç”¨q<sub>1</sub>ç‚¹ä¹˜vçš„çº¿æ€§ç»„åˆï¼š</p>
<script type="math/tex; mode=display">
q_1^Tv=x_1q_1^Tq_1+x_2q_1^Tq_2+...+x_nq_1^Tq_n=x_1q_1^Tq_1+0+...+0=x_1</script><p>åˆ™ï¼Œ</p>
<script type="math/tex; mode=display">
x_i=q_i^Tv</script><p>é‚£ä¹ˆè¦æ±‚ä¸Šå¼ä¸­çš„ç³»æ•°a<sub>0</sub>,a<sub>n</sub>,b<sub>n</sub>å°±éœ€è¦å¯»æ‰¾ä¸€ç»„æ­£äº¤åŸºï¼Œå¹¶ä¸æ­£å¼¦ã€ä½™å¼¦å‡½æ•°æœ‰è”ç³»çš„ï¼Œå¯ä»¥åˆ©ç”¨ä¸‰è§’å‡½æ•°çš„æ­£äº¤æ€§ï¼Œé€‰æ‹©ä¸‹é¢çš„ä¸‰è§’å‡½æ•°ä½œä¸ºç©ºé—´ä¸­çš„åŸºï¼š</p>
<script type="math/tex; mode=display">
\{1,\sin x, \cos x, \sin 2x, \cos 2x,...,\},äº’ç›¸æ­£äº¤ï¼Œä¸”çº¿æ€§æ— å…³</script><p><strong>åˆ©ç”¨ä¸‰è§’å‡½æ•°çš„æ­£äº¤æ€§ï¼š</strong></p>
<p>å¯¹ä¸‹å¼åœ¨åŒºé—´[-&pi;, &pi;]ç§¯åˆ†,</p>
<script type="math/tex; mode=display">
f(t)=A_0+\sum^{\infty}_{n=1}[a_n\cos(n\omega t)+b_n\sin(n\omega t)]\quad\quad(6)</script><script type="math/tex; mode=display">
\int^\pi_{-\pi}f(t)=\int^\pi_{-\pi}A_0+\int^\pi_{-\pi}[a_n\cos(n\omega t)+b_n\sin(n\omega t)]=\int^\pi_{-\pi}A_0+0=A_0|^\pi_{-\pi}=2\pi A_0</script><p>å¾—å‡º:</p>
<script type="math/tex; mode=display">
A_0=\frac{1}{2\pi}\int^\pi_{-\pi}f(t)dt</script><p>ç”¨cos(k&omega;t)ä¹˜(28)å¼ä¸¤è¾¹å¾—ï¼š</p>
<script type="math/tex; mode=display">
f(t)\cdot\cos(k\omega t)=A_0\cos(k\omega t)+\sum^\infty_{n=1}[a_n\cos(n\omega t)\cdot\cos(k\omega t)+b_n\sin(n\omega t)\cos(k\omega t)]</script><p>å¯¹ä¸Šå¼ä»-&pi;åˆ°&pi;é€é¡¹ç§¯åˆ†ï¼š</p>
<script type="math/tex; mode=display">
\int^\pi_{-\pi}f(t)\cdot\cos(k\omega t)=\mathop {A_0\int^\pi_{-\pi}\cos(k\omega t)}_{(1)}+\sum^\infty_{n=1}[\mathop {a_n\int^\pi_{-\pi}\cos(n\omega t)\cdot\cos(k\omega t)}_{(2)}+\mathop {b_n\int^\pi_{-\pi}\sin(n\omega t)\cos(k\omega t)}_{(3)}]</script><p>æ ¹æ®ä¸‰è§’å‡½æ•°å¾—æ­£äº¤æ€§ï¼Œ(1)å’Œ(3)ä¸º0ï¼Œ(2)ä»…å½“k=næ—¶ç§¯åˆ†ä¸ä¸º0ï¼Œå…¶ä½™é¡¹ç§¯åˆ†ä¸º0ï¼Œæ‰€ä»¥ï¼š</p>
<script type="math/tex; mode=display">
\int^\pi_{-\pi}f(t)\cdot\cos(k\omega t)=a_n\sum^\infty_{n=1}\int^\pi_{-\pi}\cos(k\omega t)\cdot\cos(n\omega t)dt=a_n\int^\pi_{-\pi}\cos^2(n\omega t)dt\\
=\frac{a_n}{2}\int^\pi_{-\pi}(1+\cos2n\omega t)dt(åŠè§’å…¬å¼)\quad\\
=\frac{a_n}{2}\cdot2\pi=a_n\cdot\pi\quad\quad\quad\quad\quad\quad\quad\quad</script><script type="math/tex; mode=display">
\therefore a_n=\frac{1}{\pi}\int^\pi_{-\pi}\cos(n\omega t)\cdot f(t)dt\quad(k=n)</script><p>åŒç†ï¼Œ(28)å¼ä¸¤è¾¹ä¹˜sin(k&omega;t)å¾—ï¼š</p>
<script type="math/tex; mode=display">
b_n=\frac{1}{\pi}\int^\pi_{-\pi}\sin(n\omega t)\cdot f(t)dt\quad (k=n)</script><p>ç”±äºA<sub>0</sub>çš„åˆ†æ¯ä¸º2&pi;ï¼Œè€Œa<sub>n</sub>ã€b<sub>n</sub>ä¸º&pi;ï¼Œä¸ºäº†ç»Ÿä¸€ï¼Œä»¤a<sub>0</sub>=2A<sub>0</sub>ï¼Œæœ‰ï¼š</p>
<script type="math/tex; mode=display">
a_0=\frac{2}{T}\int^\pi_{-\pi}f(t)dt,Tä¸ºä¸€ä¸ªå‘¨æœŸï¼ŒT=2\pi /\omega</script><p>æ‰€ä»¥(28)å¼ä¸ºï¼š</p>
<script type="math/tex; mode=display">
f(t)=\frac{a_0}{2}+\sum^\infty_{n=1}[a_n\cos(n\omega t)+b_n\sin(n\omega t)]</script><p>åˆ™ï¼š</p>
<script type="math/tex; mode=display">
a_n=\frac{2}{T}\int^{t_0+T}_{t_0}f(t)\cos(n\omega t)dt</script><script type="math/tex; mode=display">
b_n=\frac{2}{T}\int^{t_0+T}_{t_0}f(t)\sin(n\omega t)dt</script><p><strong>ä¸‰è§’å‡½æ•°çš„æ­£äº¤æ€§ï¼š</strong></p>
<p>ä¸€ä¸ªä¸‰è§’å‡½æ•°ç³»ï¼š1ã€cos(x)ï¼Œsin(x)ï¼Œcos(2x)ï¼Œsin(2x)ï¼Œâ€¦ ï¼Œcos(nx)ï¼Œsin(nx)ï¼Œâ€¦<strong>å¦‚æœè¿™ä¸€å †å‡½æ•°ï¼ˆåŒ…æ‹¬å¸¸æ•°1ï¼‰ä¸­ä»»ä½•ä¸¤ä¸ªä¸åŒå‡½æ•°çš„ä¹˜ç§¯åœ¨åŒºé—´</strong>[-&pi;, &pi;]ä¸Šçš„ç§¯åˆ†ç­‰äºé›¶ï¼Œå°±è¯´ä¸‰è§’å‡½æ•°ç³»åœ¨åŒºé—´[-&pi;, &pi;]ä¸Šæ­£äº¤ã€‚</p>
<script type="math/tex; mode=display">
\int^\pi_{-\pi}1\cdot\cos nxdx=0\quad(n=1,2,3,...)</script><script type="math/tex; mode=display">
\int^\pi_{-\pi}1\cdot\sin nxdx=0\quad(n=1,2,3,...)</script><script type="math/tex; mode=display">
\int^\pi_{-\pi}\sin kx \cdot\cos nx dx=0\quad(k,n=1,2,3,...)</script><script type="math/tex; mode=display">
\int^\pi_{-\pi}\cos kx \cdot\cos nx dx=0\quad(k,n=1,2,3,...;k\neq n)</script><script type="math/tex; mode=display">
\int^\pi_{-\pi}\sin kx \cdot\sin nx dx=0\quad(k,n=1,2,3,...;k\neq n)</script><p>è¯æ˜ï¼Œå› ä¸º</p>
<script type="math/tex; mode=display">
\cos kx\cdot \cos nx=\frac{1}{2}[\cos(k+n)x+\cos(k-n)x]\quad (1)</script><script type="math/tex; mode=display">
\sin kx\cdot \sin nx=\frac{1}{2}[\cos(k+n)x-\cos(k-n)x]\quad(2)</script><script type="math/tex; mode=display">
\sin kx\cdot \cos nx=\frac{1}{2}[\sin(k+n)x+\sin(k-n)x]\quad(3)</script><p>è¯ï¼ˆ1ï¼‰å½“k&ne;næ—¶ï¼Œæœ‰ï¼›</p>
<script type="math/tex; mode=display">
\int^\pi_{-\pi}\cos kx\cdot\cos nx dx=\frac{1}{2}\int^\pi_{-\pi}[\cos(k+n)x+\cos(k-n)x]dx\\
=\frac{1}{2}[\frac{\sin(k+n)x}{k+n}+\frac{\sin(k-n)x}{k-n}]|^\pi_{-\pi}=\frac{1}{2}[0+0]=0</script><p>å¯è§åœ¨æŒ‡å®šçš„[-&pi;, &pi;]çš„åŒºé—´é‡Œï¼Œè¯¥å¼çš„å®šç§¯åˆ†ä¸º0ã€‚ä¸Šå¼k-nä¸€èˆ¬æ—¶å°äº0çš„ï¼Œä½†sinæ˜¯å¥‡å‡½æ•°ï¼Œæ‰€ä»¥ä¸Šä¸‹çš„è´Ÿå·æŠµæ¶ˆã€‚</p>
<p><a href="https://zhuanlan.zhihu.com/p/41455378" target="_blank" rel="noopener">å‚…é‡Œå¶çº§æ•°æ¨å¯¼å‚è€ƒæ¥è‡ªäºçŸ¥ä¹-leinlin</a></p>
<p><strong>å‚…é‡Œå¶çº§æ•°çš„å¤æ•°å½¢å¼</strong></p>
<script type="math/tex; mode=display">
\because \cos\theta=\frac{1}{2}(e^{i\theta}+e^{-i\theta})\quad \sin\theta=-\frac{1}{2}i(e^{i\theta}-e^{-i\theta})</script><script type="math/tex; mode=display">
å¼(49)ä»£å…¥å¼(37)å¾—ï¼š
\\f(t)=\frac{a_0}{2}+\sum^\infty_{n=1}[a_n\cdot\frac{1}{2}(e^{in\omega t}+e^{-in\omega t})-\frac{1}{2}ib_n(e^{in\omega t}-e^{-in\omega t})]\quad \quad \quad \quad \quad \quad\\
=\frac{a_0}{2}+\sum^\infty_{n=1}\frac{a_n-ib_n}{2}e^{in\omega t}+\sum^{\infty}_{n=1}\frac{a_n+ib_n}{2}e^{in\omega t}ï¼Œ\quad ç¬¬ä¸‰é¡¹è®©nå˜â€œ-nâ€\\
=\frac{a_0}{2}+\sum^\infty_{n=1}\frac{a_n-ib_n}{2}e^{in\omega t}+\sum^{-1}_{n=-\infty}\frac{a_{-n}+ib_{-n}}{2}e^{in\omega t}\quad \quad \quad \quad \quad \quad \\
=\sum^0_{n=0}\frac{a_0}{2}e^{in\omega t}+\sum^\infty_{n=1}\frac{a_n-ib_n}{2}e^{in\omega t}+\sum^{-1}_{n=-\infty}\frac{a_{-n}+ib_{-n}}{2}e^{in\omega t}\quad \quad \\
=\sum^\infty_{-\infty}C_ne^{in\omega t},C_nä¸ºç³»æ•°\quad \quad \quad \quad \quad \quad\quad \quad \quad \quad \quad \quad\quad \quad \quad \quad \quad</script><script type="math/tex; mode=display">
C_n=\begin{cases}\frac{a_0}{2},& n=0\\
\frac{a_n-ib_n}{2}, & n=1,2,3,4...\\
\frac{a_{-n}+ib_{-n}}{2}, & n=-1,-2,-3,-4...
\end{cases}</script><p>ç”±å¼(34)ã€å¼(35)å’Œå¼(36):</p>
<script type="math/tex; mode=display">
a_0=\frac{2}{T}\int^T_0f(t)dt,a_n=\frac{2}{T}\int^T_0f(t)\cos n\omega tdt,b_n=\frac{2}{T}\int^T_0f(t)\sin n\omega tdt</script><p>ç”±å¼(51)å’Œå¼(52)å¾—ï¼š</p>
<script type="math/tex; mode=display">
n=0,C_0=\frac{a_0}{2}=\frac{1}{2}\cdot\frac{2}{T}\int^T_0f(t)dt=\frac{1}{T}\int^T_0f(t)dt</script><p>å½“n=1,2,3â€¦</p>
<script type="math/tex; mode=display">
C_n=\frac{1}{2}\cdot\frac{2}{T}\int^T_0f(t)\cos n\omega tdt-\frac{1}{2}i\cdot \frac{2}{T}\int^T_0f(t)\sin n\omega tdt \quad \quad \quad \\
=\frac{1}{T}\int^T_0f(t)(\cos n\omega t-i\sin n\omega t)dt\quad,coså¶å‡½æ•°ï¼Œsinå¥‡å‡½æ•°\\ 
=\frac{1}{T}\int^T_0f(t)(\cos(-n\omega t)+i\sin(-n\omega t))dt,\quad ç”±æ¬§æ‹‰å…¬å¼å¯å¾— \\
=\frac{1}{T}\int^T_0f(t)e^{-in\omega t}dt\quad \quad \quad \quad \quad \quad \quad \quad \quad \quad \quad \quad \quad \quad \quad</script><p>å½“n=-1,-2,-3â€¦</p>
<script type="math/tex; mode=display">
C_n=\frac{1}{2}(\frac{2}{T}\int^T_0f(t)\cos(-n)\omega tdt+i\frac{2}{T}\int^T_0f(t)\sin(-n)\omega tdt)\quad\\
=\frac{1}{T}\int^T_0f(t)(\cos n\omega t-i\sin n\omega t)dt=\frac{1}{T}\int^T_0f(t)e^{-in\omega t}dt</script><p>å½“n=0æ—¶ï¼Œå› ä¸ºå¼(54)å’Œå¼(55)æœ€åçš„å½¢å¼ä¸€æ ·ï¼Œä¸”å½“nä¸º0æ—¶ï¼š</p>
<script type="math/tex; mode=display">
\frac{1}{T}\int^T_0f(t)e^0dt=\frac{1}{T}\int^T_0f(t)dt=C_0</script><p>æ‰€ä»¥å¯ä»¥ç”¨ä¸€ä¸ªç»Ÿä¸€çš„å½¢å¼è¡¨è¾¾å‚…é‡Œå¶çº§æ•°ã€‚ä¸€ä¸ªå‘¨æœŸä¸ºTçš„å‡½æ•°f(t)=f(t+T)å±•å¼€ä¸ºå‚…é‡Œå¶çº§æ•°ï¼Œå®ƒçš„å¤æ•°å½¢å¼å¯ä»¥è¡¨è¾¾ä¸ºï¼š</p>
<script type="math/tex; mode=display">
f(t)=\sum^\infty_{-\infty}C_ne^{in\omega t},Cn=\frac{1}{T}\int^T_0f(t)e^{-in\omega t}dt</script><p><strong>è¡¥å……çŸ¥è¯†ï¼š</strong>æ³°å‹’çº§æ•°å³ä¸ºä»»æ„ä¸€ä¸ªå‡½æ•°éƒ½å¯ä»¥ç”¨ä¸€ä¸ªå¤šé¡¹å¼æ¥é€¼è¿‘ï¼š</p>
<script type="math/tex; mode=display">
f(x)=A+Bx+Cx^2+Dx^3+...</script><p>åˆ©ç”¨éº¦å…‹åŠ³æ—å…¬å¼ä¸­çš„å¾…å®šç³»æ•°æ³•ï¼š</p>
<script type="math/tex; mode=display">
f'(x)=B+2Cx+3Dx^2,f''(x)=2C+6Dx,...</script><p>æ¯ä¸ªç­‰å¼ä¸­ä»¤x=0ï¼Œç„¶åç”±å¾…å®šç³»æ•°æ³•å¯ä»¥è§£å‡ºA,B,Câ€¦çš„å€¼</p>
<script type="math/tex; mode=display">
A=f(0),B=f'(0),C=f''(0)/2,D=f'''(0)/(1*2*3)),å³ï¼šN=f^n/n!</script><p>ä¼—æ‰€å‘¨çŸ¥ä¸‰è§’å‡½æ•°åœ¨ä¸€ä¸ªå‘¨æœŸå†…çš„ç§¯åˆ†ä¸º0ã€‚</p>
<p>ä¸Šé¢æ˜¯å‘¨æœŸå‡½æ•°çš„å‚…é‡Œå¶çº§æ•°çš„ä¸¤ç§å½¢å¼(ä¸‰è§’å‡½æ•°å½¢å¼å’Œå¤æ•°å½¢å¼)ï¼Œ<strong>é‚£ä¹ˆéå‘¨æœŸå‡½æ•°çš„å‚…é‡Œå¶ç§¯åˆ†æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ</strong></p>
<p>å‡è®¾ä¹‹å‰å‘¨æœŸå‡½æ•°çš„å‘¨æœŸä¸º2l, å½“lè¶‹è¿‘äºæ— ç©·æ—¶ï¼Œå¯ä»¥å°†åŸå…ˆçš„å‘¨æœŸå‡½æ•°çœ‹ä½œæ˜¯éå‘¨æœŸå‡½æ•°ï¼Œå¯ä»¥å€Ÿé‰´å‘¨æœŸå‡½æ•°çš„å‚…é‡Œå¶çº§æ•°çœ‹éå‘¨æœŸå‡½æ•°çš„å±•å¼€å½¢å¼ï¼š</p>
<script type="math/tex; mode=display">
\because \omega_n=\frac{n\pi}{l},n=...,-2,-1,0,1,2,...\quad \Delta\omega_n=\omega_{n+1}-\omega_n=\frac{\pi}{l}\quad ä¸¤ä¸ªç›¸é‚»çš„\omega ä¹‹é—´çš„é—´éš”ï¼Œè¯´æ˜ä¸¤ä¸ªç›¸é‚»çš„æ­£å¼¦æ³¢æ˜¯è·³è·ƒå˜åŒ–çš„</script><script type="math/tex; mode=display">
å‘¨æœŸ(2l)çš„å‡½æ•°\underrightarrow{l\to\infty}éå‘¨æœŸå‡½æ•°ï¼Œ\Delta\omega_n=\frac{\pi}{l} \underrightarrow{l\to\infty}\quad0,\quad \omega_n\to\omega,å˜æˆäº†ä¸€ä¸ªè¿ç»­å‡½æ•°ï¼Œéå‘¨æœŸå‡½æ•°æ˜¯è¿ç»­å˜åŒ–çš„</script><script type="math/tex; mode=display">
\because å‘¨æœŸå‡½æ•°çš„å‚…é‡Œå¶çº§æ•°f(x)=\sum^{\infty}_{-\infty}c_ne^{i\omega_nx},\quad \therefore éå‘¨æœŸå‡½æ•°å¯ä»¥è¡¨ç¤ºä¸ºï¼šf(x)=\lim_{l \to \infty}\sum^{\infty}_{n=-\infty}c_ne^{i\omega_nx}</script><script type="math/tex; mode=display">
\because c_n=\frac{1}{2l}\int^l_{-l}f(t)e^{-i\omega_nt}dt,\quad ä»£å…¥ä¸Šå¼çš„éå‘¨æœŸå‡½æ•°\therefore f(x)=\lim_{l \to \infty}\sum^{\infty}_{n=-\infty}[\frac{1}{2l}\int^l_{-l}f(t)e^{-i\omega_n t}dt]e^{i\omega_nx}</script><script type="math/tex; mode=display">
\because \Delta\omega_n=\frac{\pi}{l},\quad \therefore\frac{1}{l}=\frac{\Delta\omega_n}{\pi},l\to\infty,\Delta\omega_n\to0</script><script type="math/tex; mode=display">
\frac{1}{2l}=\frac{\Delta\omega_n}{2\pi},ä»£å…¥ä¸Šå¼éå‘¨æœŸå‡½æ•°f(x)=\lim_{\Delta\omega_n\to0}\sum^{\infty}_{n=-\infty}\left[\frac{1}{2\pi}\int^\infty_{-\infty}f(t)e^{-i\omega_nt}dt\right]e^{i\omega_nx}\Delta\omega_n</script><script type="math/tex; mode=display">
ç”±ç§¯åˆ†çš„å®šä¹‰\int_lf(z)dz=\lim_{n \to \infty}\sum^{\infty}_{k=0}f(\xi_k)\Delta_{z_k}, max|\Delta x_k\to0|</script><p>åˆ™å¼(68)å¯è½¬åŒ–ä¸ºï¼š</p>
<script type="math/tex; mode=display">
f(x)=\frac{1}{2\pi}\int^{\infty}_{-\infty}\left[\int^{\infty}_{-\infty}f(t)e^{-i\omega_nt}dt\right]e^{i\omega_nx}d\omega,\quad å‚…æ°ç§¯åˆ†</script><p>å‘¨æœŸå‡½æ•°æ˜¯å‚…æ°çº§æ•°ï¼Œéå‘¨æœŸå‡½æ•°æ˜¯å‚…æ°ç§¯åˆ†</p>
<p>å‚…æ°ç§¯åˆ†å­˜åœ¨çš„æ¡ä»¶, (1)æ»¡è¶³ç‹„æ°æ¡ä»¶ï¼›(2)ç»å¯¹å¯ç§¯ </p>
<p><strong>ä¸€ç»´å‚…é‡Œå¶å˜æ¢</strong></p>
<script type="math/tex; mode=display">
ä¸Šå¼(69)ä¸­\int^\infty_{-\infty}f(t)e^{-i\omega t}dt\quad ç§¯åˆ†å‡ºæ¥æ˜¯\omega çš„å‡½æ•°</script><p>æ‰€ä»¥ï¼Œå®šä¹‰f(x)çš„å‚…æ°å˜æ¢ä¸ºï¼š</p>
<script type="math/tex; mode=display">
G(\omega)=\int^\infty_{-\infty}f(t)e^{-i\omega t}dt=F[f(x)],f(x)çš„å‚…é‡Œå¶å˜æ¢</script><p>åˆ™ï¼š</p>
<script type="math/tex; mode=display">
f(x)=\frac{1}{2\pi}\int^\infty_{-\infty}G(\omega)e^{i\omega x}d\omega=F^{-1}[G(\omega)],æ˜¾ç„¶ï¼ŒF^{-1}F[f(x)]=f(x)</script><p>å¯¹f(t)è¿›è¡Œç§¯åˆ†å¾—åˆ°å˜é‡ä¸º&omega;çš„å‚…é‡Œå¶å˜æ¢åçš„é¢‘è°±å›¾(åˆ†ç¦»å‡ºæ¥çš„æ­£å¼¦æ³¢çš„æŒ¯å¹…å›¾)å¯¹åº”é¢‘åŸŸï¼Œåœ¨å¯¹G(&omega;)è¿›è¡Œç§¯åˆ†å¾—åˆ°å˜é‡ä¸ºxçš„æ—¶é—´åŸŸf(x),ç›¸å½“é€šè¿‡å‚…é‡Œå¶é€†å˜æ¢å¾—åˆ°f(x)ã€‚</p>
<p>ä¸¾ä¾‹ï¼š</p>
<script type="math/tex; mode=display">
\begin{aligned}& F[e^{-ax^2}]=?,å‡½æ•°e^{-ax^2}çš„å‚…é‡Œå¶å˜æ¢æ˜¯ä»€ä¹ˆ? \\
& ç”±(71)å¾—ï¼š\int^\infty_{-\infty}e^{-ax^2}e^{-i\omega x}dx=2\int^\infty_0e^{-ax^2}\cdot \cos\omega  xdx,\quad e^{-i\omega t}å«åšç§¯åˆ†å˜æ¢æ ¸ \\
& ä¸Šå¼ä¸­e^{-ax^2}æ˜¯å¶å‡½æ•°ï¼Œe^{-i\omega x}ç”±æ¬§æ‹‰å…¬å¼å¯ä»¥åŒ–ä¸ºcoså’Œsinçš„å½¢å¼ï¼Œsinä¸ºå¥‡å‡½æ•°ï¼Œå¥‡å‡½æ•°ä¹˜å¶å‡½æ•°ä¸ºå¥‡å‡½æ•°ï¼Œæ‰€ä»¥å¯ä»¥èˆå¼ƒï¼Œåªä¿ç•™cosã€‚\\
& åœ¨çƒ­ä¼ å¯¼ä¸­æœ‰ï¼Œ\int^\infty_0e^{-ax^2}cosbxdx=\frac{1}{2}e^{-\frac{\omega^2}{4a}}\cdot\sqrt\frac{\pi}{a},\quad \therefore F[e^{-ax^2}]=e^{-\frac{\omega^2}{4a}}\cdot\sqrt\frac{\pi}{a}\quad (-\infty<\omega<+\infty)\quad \quad \quad \quad \quad \quad \quad \quad \quad\\
& åˆ©ç”¨å‚…é‡Œå¶é€†å˜æ¢æ±‚f(x):\frac{1}{2\pi}\int^\infty_{-\infty}G(\omega)e^{iwx}d\omega; \frac{1}{2\pi}\sqrt\frac{\pi}{a}\int^\infty_{-\infty}e^{-\frac{\omega^2}{4a}}e^{i\omega x}d\omega=\frac{1}{2\pi}\sqrt\frac{\pi}{a}\int^\infty_{-\infty}e^{-\frac{1}{4a}\omega^2}\cos x\omega d\omega=\frac{1}{2\pi}\sqrt\frac{\pi}{a}e^{-ax^2}2\sqrt{\pi a}=e^{-ax^2}=f(x)\end{aligned}</script>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/06/27/Spring-Security-Plus/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qiang Chen">
      <meta itemprop="description" content="è®°å½•æ˜¯å¿˜è®°çš„ç¬¬ä¸€åŠ©æ‰‹.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ç¼–è¾‘å°¼æ’‘">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/27/Spring-Security-Plus/" class="post-title-link" itemprop="url">Spring-Security-Plus</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-06-27 10:03:52 / ä¿®æ”¹æ—¶é—´ï¼š10:05:40" itemprop="dateCreated datePublished" datetime="2021-06-27T10:03:52+08:00">2021-06-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Cloud-Compute/" itemprop="url" rel="index">
                    <span itemprop="name">Cloud Compute</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="è¯¦è§£Spring-Security"><a href="#è¯¦è§£Spring-Security" class="headerlink" title="è¯¦è§£Spring Security"></a>è¯¦è§£Spring Security</h2><h4 id="è¿™é‡Œæ’å…¥ä¸€äº›åŸºç¡€çš„SpringçŸ¥è¯†ç‚¹ï¼š"><a href="#è¿™é‡Œæ’å…¥ä¸€äº›åŸºç¡€çš„SpringçŸ¥è¯†ç‚¹ï¼š" class="headerlink" title="* è¿™é‡Œæ’å…¥ä¸€äº›åŸºç¡€çš„SpringçŸ¥è¯†ç‚¹ï¼š"></a>* è¿™é‡Œæ’å…¥ä¸€äº›åŸºç¡€çš„SpringçŸ¥è¯†ç‚¹ï¼š</h4><p>é¢å‘å¯¹è±¡è®¾è®¡ï¼ˆOODï¼‰æœ‰åŠ©äºæˆ‘ä»¬å¼€å‘å‡ºé«˜æ€§èƒ½ã€æ˜“æ‰©å±•ä»¥åŠæ˜“å¤ç”¨çš„ç¨‹åºã€‚å…¶ä¸­ï¼ŒOODæœ‰ä¸€ä¸ªé‡è¦çš„æ€æƒ³é‚£å°±æ˜¯ä¾èµ–å€’ç½®åŸåˆ™ï¼ˆDIPï¼‰ï¼Œå¹¶ç”±æ­¤å¼•ç”³å‡ºIoCã€DIä»¥åŠIocå®¹å™¨ç­‰æ¦‚å¿µã€‚</p>
<h5 id="1ã€ä¾èµ–å€’ç½®åŸåˆ™-DIP-ä¸€ç§è½¯ä»¶æ¶æ„è®¾è®¡çš„åŸåˆ™ï¼ˆæŠ½è±¡æ¦‚å¿µï¼‰ã€‚"><a href="#1ã€ä¾èµ–å€’ç½®åŸåˆ™-DIP-ä¸€ç§è½¯ä»¶æ¶æ„è®¾è®¡çš„åŸåˆ™ï¼ˆæŠ½è±¡æ¦‚å¿µï¼‰ã€‚" class="headerlink" title="1ã€ä¾èµ–å€’ç½®åŸåˆ™(DIP):  ä¸€ç§è½¯ä»¶æ¶æ„è®¾è®¡çš„åŸåˆ™ï¼ˆæŠ½è±¡æ¦‚å¿µï¼‰ã€‚"></a>1<strong>ã€</strong>ä¾èµ–å€’ç½®åŸåˆ™(DIP):  ä¸€ç§è½¯ä»¶æ¶æ„è®¾è®¡çš„åŸåˆ™ï¼ˆæŠ½è±¡æ¦‚å¿µï¼‰ã€‚</h5><p>ä¾èµ–å€’ç½®åŸåˆ™ï¼Œå®ƒ<strong>è½¬æ¢äº†ä¾èµ–å…³ç³»</strong>ï¼Œé«˜å±‚æ¨¡å—ä¸ä¾èµ–äºä½å±‚æ¨¡å—çš„å®ç°ï¼Œè€Œä½å±‚æ¨¡å—ä¾èµ–äºé«˜å±‚æ¨¡å—å®šä¹‰çš„æ¥å£ã€‚é€šä¿—çš„è®²ï¼Œå°±æ˜¯é«˜å±‚æ¨¡å—å®šä¹‰æ¥å£ï¼Œä½å±‚æ¨¡å—è´Ÿè´£å®ç°ã€‚ä»è€Œæ›´å¥½çš„æ”¯æŒäº†<strong>è®¾è®¡æ¨¡å¼</strong>ä¸­çš„<strong>å¼€æ”¾å°é—­åŸåˆ™</strong>ã€‚ä»¥ä¸‹ä¸ºDIPçš„ä¼˜ç‚¹ï¼š</p>
<ul>
<li><strong>ç³»ç»Ÿæ›´æŸ”éŸ§ï¼š</strong>å¯ä»¥ä¿®æ”¹ä¸€éƒ¨åˆ†ä»£ç è€Œä¸å½±å“å…¶ä»–æ¨¡å—ã€‚</li>
<li><strong>ç³»ç»Ÿæ›´å¥å£®ï¼š</strong>å¯ä»¥ä¿®æ”¹ä¸€éƒ¨åˆ†ä»£ç è€Œä¸ä¼šè®©ç³»ç»Ÿå´©æºƒã€‚</li>
<li><strong>ç³»ç»Ÿæ›´é«˜æ•ˆï¼š</strong>ç»„ä»¶æ¾è€¦åˆï¼Œä¸”å¯å¤ç”¨ï¼Œæé«˜å¼€å‘æ•ˆç‡ã€‚</li>
</ul>
<h5 id="2ã€æ§åˆ¶åè½¬-IoC-ä¸€ç§åè½¬æµã€ä¾èµ–å’Œæ¥å£çš„æ–¹å¼ï¼ˆDIPçš„å…·ä½“å®ç°æ–¹å¼ï¼‰ã€‚"><a href="#2ã€æ§åˆ¶åè½¬-IoC-ä¸€ç§åè½¬æµã€ä¾èµ–å’Œæ¥å£çš„æ–¹å¼ï¼ˆDIPçš„å…·ä½“å®ç°æ–¹å¼ï¼‰ã€‚" class="headerlink" title="2ã€æ§åˆ¶åè½¬(IoC):   ä¸€ç§åè½¬æµã€ä¾èµ–å’Œæ¥å£çš„æ–¹å¼ï¼ˆDIPçš„å…·ä½“å®ç°æ–¹å¼ï¼‰ã€‚"></a>2ã€<strong>æ§åˆ¶åè½¬(IoC):</strong>   ä¸€ç§åè½¬<strong>æµ</strong>ã€<strong>ä¾èµ–</strong>å’Œ<strong>æ¥å£</strong>çš„æ–¹å¼ï¼ˆDIPçš„å…·ä½“å®ç°æ–¹å¼ï¼‰ã€‚</h5><p>DIPæ˜¯ä¸€ç§ <strong>è½¯ä»¶è®¾è®¡åŸåˆ™</strong>ï¼Œå®ƒä»…ä»…å‘Šè¯‰ä½ ä¸¤ä¸ªæ¨¡å—ä¹‹é—´åº”è¯¥å¦‚ä½•ä¾èµ–ï¼Œä½†æ˜¯å®ƒå¹¶æ²¡æœ‰å‘Šè¯‰å¦‚ä½•åšã€‚IoCåˆ™æ˜¯ä¸€ç§ <strong>è½¯ä»¶è®¾è®¡æ¨¡å¼</strong>ï¼Œå®ƒå‘Šè¯‰ä½ åº”è¯¥å¦‚ä½•åšï¼Œæ¥è§£é™¤ç›¸äº’ä¾èµ–æ¨¡å—çš„è€¦åˆã€‚</p>
<p>æ§åˆ¶åè½¬ï¼ˆIoCï¼‰ï¼Œå®ƒä¸ºç›¸äº’ä¾èµ–çš„ç»„ä»¶æä¾›æŠ½è±¡ï¼Œå°†ä¾èµ–ï¼ˆä½å±‚æ¨¡å—ï¼‰å¯¹è±¡çš„è·å¾—äº¤ç»™ç¬¬ä¸‰æ–¹ï¼ˆç³»ç»Ÿï¼‰æ¥æ§åˆ¶<strong>ï¼Œ</strong>å³ä¾èµ–å¯¹è±¡ä¸åœ¨è¢«ä¾èµ–æ¨¡å—çš„ç±»ä¸­ç›´æ¥é€šè¿‡newæ¥è·å–ã€‚ä¹Ÿå°±æ˜¯è¯´<strong>é«˜å±‚æ¨¡å—ä¸ä¼šä¸»åŠ¨æ„ŸçŸ¥åº•å±‚æ¨¡å—</strong>ã€‚</p>
<h5 id="3ã€ä¾èµ–æ³¨å…¥ï¼ˆDIï¼‰ï¼šIoCçš„ä¸€ç§å®ç°æ–¹å¼ï¼Œç”¨æ¥åè½¬ä¾èµ–ï¼ˆIoCçš„å…·ä½“å®ç°æ–¹å¼ï¼‰ã€‚"><a href="#3ã€ä¾èµ–æ³¨å…¥ï¼ˆDIï¼‰ï¼šIoCçš„ä¸€ç§å®ç°æ–¹å¼ï¼Œç”¨æ¥åè½¬ä¾èµ–ï¼ˆIoCçš„å…·ä½“å®ç°æ–¹å¼ï¼‰ã€‚" class="headerlink" title="3ã€ä¾èµ–æ³¨å…¥ï¼ˆDIï¼‰ï¼šIoCçš„ä¸€ç§å®ç°æ–¹å¼ï¼Œç”¨æ¥åè½¬ä¾èµ–ï¼ˆIoCçš„å…·ä½“å®ç°æ–¹å¼ï¼‰ã€‚"></a>3ã€<strong>ä¾èµ–æ³¨å…¥ï¼ˆDIï¼‰ï¼š</strong>IoCçš„ä¸€ç§å®ç°æ–¹å¼ï¼Œç”¨æ¥åè½¬ä¾èµ–ï¼ˆIoCçš„å…·ä½“å®ç°æ–¹å¼ï¼‰ã€‚</h5><p>ä¾èµ–æ³¨å…¥æ˜¯æ§åˆ¶åè½¬ï¼ˆIoCï¼‰ä¸€ç§é‡è¦çš„æ–¹å¼ï¼Œ<strong>å°±æ˜¯å°†ä¾èµ–å¯¹è±¡çš„åˆ›å»ºå’Œç»‘å®šè½¬ç§»åˆ°è¢«ä¾èµ–å¯¹è±¡ç±»çš„å¤–éƒ¨æ¥å®ç°</strong>ã€‚ä¾èµ–æ³¨å…¥ï¼ˆDIï¼‰ï¼Œ<strong>å®ƒæä¾›ä¸€ç§æœºåˆ¶ï¼Œå°†éœ€è¦ä¾èµ–ï¼ˆä½å±‚æ¨¡å—ï¼‰å¯¹è±¡çš„å¼•ç”¨ä¼ é€’ç»™è¢«ä¾èµ–ï¼ˆé«˜å±‚æ¨¡å—ï¼‰å¯¹è±¡</strong>ã€‚<strong>å¦‚ä½•æ³¨å…¥ï¼Ÿ</strong></p>
<p>1ã€<strong>æ„é€ å‡½æ•°æ³¨å…¥ï¼š</strong>æ„é€ å‡½æ•°çš„å‚æ•°å¿…ç„¶ç”¨æ¥æ¥æ”¶ä¸€ä¸ªä¾èµ–å¯¹è±¡ï¼Œè€Œè¯¥ä¾èµ–ç±»å‹åº”è¯¥æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»å‹ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//é«˜å±‚æ¨¡å—</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IDataAccess</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="class"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Add</span><span class="params">()</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç¬¬ä¸€ç§åº•å±‚æ¨¡å—</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">public class SqlServerDal:IDataAccess</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Add</span><span class="params">()</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="function">    </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        Console.WriteLine(<span class="string">"åœ¨æ•°æ®åº“ä¸­æ·»åŠ ä¸€æ¡è®¢å•ï¼"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//ç¬¬äºŒç§åº•å±‚æ¨¡å—</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">public class AccessDal:IDataAccess</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Add</span><span class="params">()</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"><span class="function">    </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">        Console.WriteLine(<span class="string">"åœ¨ACCESSæ•°æ®åº“ä¸­æ·»åŠ ä¸€æ¡è®°å½•ï¼"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line"><span class="class"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> IDataAccess _ida;<span class="comment">//å®šä¹‰ä¸€ä¸ªç§æœ‰å˜é‡ä¿å­˜æŠ½è±¡</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//æ„é€ å‡½æ•°æ³¨å…¥</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Order</span><span class="params">(IDataAccess ida)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line"><span class="function">    </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">        _ida = ida;<span class="comment">//ä¼ é€’ä¾èµ–</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Add</span><span class="params">()</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line"><span class="function">    </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">        _ida.Add();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p>2ã€<strong>å±æ€§æ³¨å…¥ï¼š</strong>å±æ€§æ³¨å…¥æ˜¯é€šè¿‡å±æ€§æ¥ä¼ é€’ä¾èµ–</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Order</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> IDataAccess _ida;<span class="comment">//å®šä¹‰ä¸€ä¸ªç§æœ‰å˜é‡ä¿å­˜æŠ½è±¡</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//å±æ€§ï¼Œæ¥å—ä¾èµ–</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> IDataAccess Ida</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">set</span> &#123; _ida = <span class="keyword">value</span>; &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">get</span> &#123; <span class="keyword">return</span> _ida; &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Add</span>(<span class="params"></span>)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>    &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">        _ida.Add();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Linq;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Text;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"> </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">DIPTest</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">class</span> <span class="title">Program</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">        <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="keyword">string</span>[] args</span>)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>        &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">            AccessDal dal = <span class="keyword">new</span> AccessDal();<span class="comment">//åœ¨å¤–éƒ¨åˆ›å»ºä¾èµ–å¯¹è±¡</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">            Order order = <span class="keyword">new</span> Order();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">            order.Ida = dal;<span class="comment">//ç»™å±æ€§èµ‹å€¼</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">            order.Add();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">            Console.Read();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p>3ã€<strong>æ¥å£æ³¨å…¥ï¼š</strong>å…·ä½“æ€è·¯æ˜¯å…ˆå®šä¹‰ä¸€ä¸ªæ¥å£ï¼ŒåŒ…å«ä¸€ä¸ªè®¾ç½®ä¾èµ–çš„æ–¹æ³•ã€‚ç„¶åä¾èµ–ç±»ï¼Œç»§æ‰¿å¹¶å®ç°è¿™ä¸ªæ¥å£ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IDependent</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="class"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">SetDependence</span><span class="params">(IDataAccess ida)</span></span>;<span class="comment">//è®¾ç½®ä¾èµ–é¡¹</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">public class Order : IDependent</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> IDataAccess _ida;<span class="comment">//å®šä¹‰ä¸€ä¸ªç§æœ‰å˜é‡ä¿å­˜æŠ½è±¡</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//å®ç°æ¥å£</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">SetDependence</span><span class="params">(IDataAccess ida)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="function">    </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        _ida = ida;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Add</span><span class="params">()</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="function">    </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">        _ida.Add();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<h5 id="4ã€IoCå®¹å™¨ï¼šä¾èµ–æ³¨å…¥çš„æ¡†æ¶ï¼Œç”¨æ¥æ˜ å°„ä¾èµ–ï¼Œç®¡ç†å¯¹è±¡åˆ›å»ºå’Œç”Ÿå­˜å‘¨æœŸï¼ˆDIæ¡†æ¶ï¼‰ã€‚"><a href="#4ã€IoCå®¹å™¨ï¼šä¾èµ–æ³¨å…¥çš„æ¡†æ¶ï¼Œç”¨æ¥æ˜ å°„ä¾èµ–ï¼Œç®¡ç†å¯¹è±¡åˆ›å»ºå’Œç”Ÿå­˜å‘¨æœŸï¼ˆDIæ¡†æ¶ï¼‰ã€‚" class="headerlink" title="4ã€IoCå®¹å™¨ï¼šä¾èµ–æ³¨å…¥çš„æ¡†æ¶ï¼Œç”¨æ¥æ˜ å°„ä¾èµ–ï¼Œç®¡ç†å¯¹è±¡åˆ›å»ºå’Œç”Ÿå­˜å‘¨æœŸï¼ˆDIæ¡†æ¶ï¼‰ã€‚"></a>4ã€<strong>IoCå®¹å™¨ï¼šä¾èµ–æ³¨å…¥çš„æ¡†æ¶</strong>ï¼Œç”¨æ¥æ˜ å°„ä¾èµ–ï¼Œç®¡ç†å¯¹è±¡åˆ›å»ºå’Œç”Ÿå­˜å‘¨æœŸï¼ˆDIæ¡†æ¶ï¼‰ã€‚</h5><p>å‰é¢çš„ä¾‹å­ä¸­éƒ½æ˜¯é€šè¿‡<strong>æ‰‹åŠ¨</strong>çš„æ–¹å¼æ¥åˆ›å»ºä¾èµ–å¯¹è±¡ï¼Œå¹¶å°†å¼•ç”¨ä¼ é€’ç»™è¢«ä¾èµ–æ¨¡å—ã€‚IoCå®¹å™¨å®é™…ä¸Šæ˜¯ä¸€ä¸ªDIæ¡†æ¶ï¼Œå®ƒèƒ½ç®€åŒ–æˆ‘ä»¬çš„å·¥ä½œé‡ã€‚</p>
<ul>
<li>åŠ¨æ€åˆ›å»ºã€æ³¨å…¥ä¾èµ–å¯¹è±¡ã€‚</li>
<li>ç®¡ç†å¯¹è±¡ç”Ÿå‘½å‘¨æœŸã€‚</li>
<li>æ˜ å°„ä¾èµ–å…³ç³»ã€‚</li>
</ul>
<p>å…·ä½“çš„IoCå®¹å™¨å¦‚ä½•ä½¿ç”¨å¯ä»¥æ ¹æ®è‡ªå·±çš„é¡¹ç›®ä¸­æ‰€ç”¨åˆ°çš„IoCå®¹å™¨ç±»å‹è¿›è¡Œå­¦ä¹ ã€‚</p>
<h5 id="5ã€AOP"><a href="#5ã€AOP" class="headerlink" title="5ã€AOP"></a>5ã€<strong>AOP</strong></h5><p>AOPï¼ˆAspect Oriented Programmingï¼‰ï¼Œå³é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼Œå¯ä»¥è¯´æ˜¯OOPï¼ˆObject Oriented  Programmingï¼Œé¢å‘å¯¹è±¡ç¼–ç¨‹ï¼‰çš„è¡¥å……å’Œå®Œå–„ã€‚OOPå¼•å…¥å°è£…ã€ç»§æ‰¿ã€å¤šæ€ç­‰æ¦‚å¿µæ¥å»ºç«‹ä¸€ç§å¯¹è±¡å±‚æ¬¡ç»“æ„ï¼Œç”¨äºæ¨¡æ‹Ÿå…¬å…±è¡Œä¸ºçš„ä¸€ä¸ªé›†åˆã€‚ä¸è¿‡OOPå…è®¸å¼€å‘è€…å®šä¹‰çºµå‘çš„å…³ç³»ï¼Œä½†å¹¶ä¸é€‚åˆå®šä¹‰æ¨ªå‘çš„å…³ç³»ï¼Œä¾‹å¦‚æ—¥å¿—åŠŸèƒ½ã€‚æ—¥å¿—ä»£ç å¾€å¾€æ¨ªå‘åœ°æ•£å¸ƒåœ¨æ‰€æœ‰å¯¹è±¡å±‚æ¬¡ä¸­ï¼Œè€Œä¸å®ƒå¯¹åº”çš„å¯¹è±¡çš„æ ¸å¿ƒåŠŸèƒ½æ¯«æ— å…³ç³»å¯¹äºå…¶ä»–ç±»å‹çš„ä»£ç ï¼Œå¦‚å®‰å…¨æ€§ã€å¼‚å¸¸å¤„ç†å’Œé€æ˜çš„æŒç»­æ€§ä¹Ÿéƒ½æ˜¯å¦‚æ­¤ï¼Œè¿™ç§æ•£å¸ƒåœ¨å„å¤„çš„æ— å…³çš„ä»£ç è¢«ç§°ä¸ºæ¨ªåˆ‡ï¼ˆcross cuttingï¼‰ï¼Œåœ¨OOPè®¾è®¡ä¸­ï¼Œå®ƒå¯¼è‡´äº†å¤§é‡ä»£ç çš„é‡å¤ï¼Œè€Œä¸åˆ©äºå„ä¸ªæ¨¡å—çš„é‡ç”¨ã€‚</p>
<p>AOPæŠ€æœ¯æ°æ°ç›¸åï¼Œå®ƒåˆ©ç”¨ä¸€ç§ç§°ä¸ºâ€æ¨ªåˆ‡â€çš„æŠ€æœ¯ï¼Œå‰–è§£å¼€å°è£…çš„å¯¹è±¡å†…éƒ¨ï¼Œå¹¶å°†é‚£äº›å½±å“äº†å¤šä¸ªç±»çš„å…¬å…±è¡Œä¸ºå°è£…åˆ°ä¸€ä¸ªå¯é‡ç”¨æ¨¡å—ï¼Œå¹¶å°†å…¶å‘½åä¸ºâ€Aspectâ€ï¼Œå³åˆ‡é¢ã€‚æ‰€è°“â€åˆ‡é¢â€ï¼Œç®€å•è¯´å°±æ˜¯å°†é‚£äº›ä¸ä¸šåŠ¡æ— å…³ï¼Œå´è¢«ä¸šåŠ¡æ¨¡å—æ‰€å…±åŒè°ƒç”¨çš„é€»è¾‘æˆ–è´£ä»»å°è£…èµ·æ¥ï¼Œä¾¿äºå‡å°‘ç³»ç»Ÿçš„é‡å¤ä»£ç ï¼Œé™ä½æ¨¡å—ä¹‹é—´çš„è€¦åˆåº¦ï¼Œå¹¶æœ‰åˆ©äºæœªæ¥çš„å¯æ“ä½œæ€§å’Œå¯ç»´æŠ¤æ€§ã€‚</p>
<p>é¢å‘åˆ‡é¢ç¼–ç¨‹æ˜¯é€šè¿‡é¢„ç¼–è¯‘æ–¹å¼å’Œè¿è¡ŒæœŸåŠ¨æ€ä»£ç†çš„æ–¹å¼å®ç°ä¸ä¿®æ”¹æºä»£ç çš„æƒ…å†µä¸‹ç»™ç¨‹åºåŠ¨æ€ç»Ÿä¸€æ·»åŠ åŠŸèƒ½çš„æŠ€æœ¯ã€‚ä½¿ç”¨â€æ¨ªåˆ‡â€æŠ€æœ¯ï¼ŒAOPæŠŠè½¯ä»¶ç³»ç»Ÿåˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ï¼š<strong>æ ¸å¿ƒå…³æ³¨ç‚¹</strong>å’Œ<strong>æ¨ªåˆ‡å…³æ³¨ç‚¹</strong>ã€‚ä¸šåŠ¡å¤„ç†çš„ä¸»è¦æµç¨‹æ˜¯æ ¸å¿ƒå…³æ³¨ç‚¹ï¼Œä¸ä¹‹å…³ç³»ä¸å¤§çš„éƒ¨åˆ†æ˜¯æ¨ªåˆ‡å…³æ³¨ç‚¹ã€‚æ¨ªåˆ‡å…³æ³¨ç‚¹çš„ä¸€ä¸ªç‰¹ç‚¹æ˜¯ï¼Œä»–ä»¬ç»å¸¸å‘ç”Ÿåœ¨æ ¸å¿ƒå…³æ³¨ç‚¹çš„å¤šå¤„ï¼Œè€Œå„å¤„åŸºæœ¬ç›¸ä¼¼ï¼Œæ¯”å¦‚æƒé™è®¤è¯ã€æ—¥å¿—ã€äº‹ç‰©ã€‚AOPçš„ä½œç”¨åœ¨äºåˆ†ç¦»ç³»ç»Ÿä¸­çš„å„ç§å…³æ³¨ç‚¹ï¼Œå°†æ ¸å¿ƒå…³æ³¨ç‚¹å’Œæ¨ªåˆ‡å…³æ³¨ç‚¹åˆ†ç¦»å¼€æ¥ã€‚</p>
<hr>
<div class="table-container">
<table>
<thead>
<tr>
<th>AOPæ ¸å¿ƒæ¦‚å¿µ</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ¨ªåˆ‡å…³æ³¨ç‚¹</td>
<td>å¯¹å“ªäº›æ–¹æ³•è¿›è¡Œæ‹¦æˆªï¼Œæ‹¦æˆªåæ€ä¹ˆå¤„ç†ï¼Œè¿™äº›å…³æ³¨ç‚¹ç§°ä¹‹ä¸ºæ¨ªåˆ‡å…³æ³¨ç‚¹</td>
</tr>
<tr>
<td>åˆ‡é¢(aspect)</td>
<td>ç±»æ˜¯å¯¹ç‰©ä½“ç‰¹å¾çš„æŠ½è±¡ï¼Œåˆ‡é¢å°±æ˜¯å¯¹æ¨ªåˆ‡å…³æ³¨ç‚¹çš„æŠ½è±¡</td>
</tr>
<tr>
<td>è¿æ¥ç‚¹(joinpoint)</td>
<td>è¢«æ‹¦æˆªåˆ°çš„ç‚¹ï¼Œå› ä¸ºSpringåªæ”¯æŒæ–¹æ³•ç±»å‹çš„è¿æ¥ç‚¹ï¼Œæ‰€ä»¥åœ¨Springä¸­è¿æ¥ç‚¹æŒ‡çš„å°±æ˜¯è¢«æ‹¦æˆªåˆ°çš„æ–¹æ³•ï¼Œå®é™…ä¸Šè¿æ¥ç‚¹è¿˜å¯ä»¥æ˜¯å­—æ®µæˆ–è€…æ„é€ å™¨</td>
</tr>
<tr>
<td>åˆ‡å…¥ç‚¹(pointcut)</td>
<td>å¯¹è¿æ¥ç‚¹è¿›è¡Œæ‹¦æˆªçš„å®šä¹‰</td>
</tr>
<tr>
<td>é€šçŸ¥(advice)</td>
<td>æ‰€è°“é€šçŸ¥æŒ‡çš„å°±æ˜¯æŒ‡æ‹¦æˆªåˆ°è¿æ¥ç‚¹ä¹‹åè¦æ‰§è¡Œçš„ä»£ç ï¼Œé€šçŸ¥åˆ†ä¸ºå‰ç½®@Beforeã€åç½®@Afterã€å¼‚å¸¸@AfterThrowingã€æœ€ç»ˆ@AfterReturningã€ç¯ç»•@Aroundé€šçŸ¥äº”ç±»</td>
</tr>
<tr>
<td>ç›®æ ‡å¯¹è±¡</td>
<td>ä»£ç†çš„ç›®æ ‡å¯¹è±¡</td>
</tr>
<tr>
<td>ç»‡å…¥(weave)</td>
<td>å°†åˆ‡é¢åº”ç”¨åˆ°ç›®æ ‡å¯¹è±¡å¹¶å¯¼è‡´ä»£ç†å¯¹è±¡åˆ›å»ºçš„è¿‡ç¨‹</td>
</tr>
<tr>
<td>å¼•å…¥(introduction)</td>
<td>åœ¨ä¸ä¿®æ”¹ä»£ç çš„å‰æä¸‹ï¼Œå¼•å…¥å¯ä»¥åœ¨<strong>è¿è¡ŒæœŸ</strong>ä¸ºç±»åŠ¨æ€åœ°æ·»åŠ ä¸€äº›æ–¹æ³•æˆ–å­—æ®µ</td>
</tr>
</tbody>
</table>
</div>
<p>AOPåªæ˜¯ä¸€ä¸ªæ¦‚å¿µå¹¶æ²¡æœ‰è®¾å®šå…·ä½“è¯­è¨€çš„å®ç°ï¼Œå®ƒèƒ½å…‹æœé‚£äº›åªæœ‰å•ç»§æ‰¿ç‰¹æ€§è¯­è¨€çš„ç¼ºç‚¹ã€‚å®ç°AOPçš„æŠ€æœ¯ä¸»è¦åˆ†ä¸ºä¸¤ç±»ï¼šä¸€ç±»æ˜¯<strong>é‡‡ç”¨åŠ¨æ€ä»£ç†æŠ€æœ¯</strong>åˆ©ç”¨æˆªå–æ¶ˆæ¯çš„æ–¹å¼ï¼Œå¯¹æ¶ˆæ¯è¿›è¡Œè£…é¥°ä»¥å–ä»£åŸæœ‰å¯¹è±¡è¡Œä¸ºçš„æ‰§è¡Œã€‚å¦ä¸€ç±»æ˜¯<strong>é‡‡ç”¨é™æ€ç»‡å…¥</strong>çš„æ–¹å¼ï¼Œå¼•å…¥ç‰¹å®šè¯­æ³•åˆ›å»ºåˆ‡é¢ï¼Œä»è€Œä½¿ç¼–è¯‘å™¨å¯ä»¥åœ¨ç¼–è¯‘æœŸé—´ç»‡å…¥ç›¸å…³çš„åˆ‡é¢ä»£ç ã€‚</p>
<p><strong>Springå¯¹AOPçš„æ”¯æŒ</strong></p>
<p><strong>Springä¸­AOPä»£ç†ç”±Springçš„IOCå®¹å™¨è´Ÿè´£ç”Ÿæˆã€ç®¡ç†ï¼Œå…¶ä¾èµ–å…³ç³»ä¹Ÿç”±IOCå®¹å™¨è´Ÿè´£ç®¡ç†</strong>ã€‚å› æ­¤ï¼ŒAOPä»£ç†å¯ä»¥ç›´æ¥ä½¿ç”¨å®¹å™¨ä¸­çš„å…¶å®ƒbeanå®ä¾‹ä½œä¸ºç›®æ ‡ï¼Œè¿™ç§å…³ç³»å¯ç”±IOCå®¹å™¨çš„ä¾èµ–æ³¨å…¥æä¾›ã€‚Springåˆ›å»ºä»£ç†çš„è§„åˆ™ä¸ºï¼š</p>
<ol>
<li><strong>é»˜è®¤ä½¿ç”¨JavaåŠ¨æ€ä»£ç†æ¥åˆ›å»ºAOPä»£ç†</strong>ï¼Œè¿™æ ·å°±å¯ä»¥ä¸ºä»»ä½•æ¥å£å®ä¾‹åˆ›å»ºä»£ç†äº†ã€‚</li>
<li><strong>å½“éœ€è¦ä»£ç†çš„ç±»ä¸æ˜¯ä»£ç†æ¥å£çš„æ—¶å€™ï¼ŒSpringä¼šåˆ‡æ¢ä¸ºä½¿ç”¨CGLIBä»£ç†</strong>ï¼Œä¹Ÿå¯å¼ºåˆ¶ä½¿ç”¨CGLIBã€‚</li>
</ol>
<p>AOPç¼–ç¨‹å…¶å®æ˜¯å¾ˆç®€å•çš„äº‹æƒ…ï¼Œçºµè§‚AOPç¼–ç¨‹ï¼Œç¨‹åºå‘˜åªéœ€è¦å‚ä¸ä¸‰ä¸ªéƒ¨åˆ†ï¼š</p>
<ol>
<li>å®šä¹‰æ™®é€šä¸šåŠ¡ç»„ä»¶ã€‚</li>
<li>å®šä¹‰åˆ‡å…¥ç‚¹ï¼Œä¸€ä¸ªåˆ‡å…¥ç‚¹å¯èƒ½æ¨ªåˆ‡å¤šä¸ªä¸šåŠ¡ç»„ä»¶ã€‚</li>
<li>å®šä¹‰å¢å¼ºå¤„ç†ï¼Œå¢å¼ºå¤„ç†å°±æ˜¯åœ¨AOPæ¡†æ¶ä¸ºæ™®é€šä¸šåŠ¡ç»„ä»¶ç»‡å…¥çš„å¤„ç†åŠ¨ä½œã€‚</li>
</ol>
<p>æ‰€ä»¥è¿›è¡ŒAOPç¼–ç¨‹çš„å…³é”®å°±æ˜¯å®šä¹‰åˆ‡å…¥ç‚¹å’Œå®šä¹‰å¢å¼ºå¤„ç†ï¼Œä¸€æ—¦å®šä¹‰äº†åˆé€‚çš„åˆ‡å…¥ç‚¹å’Œå¢å¼ºå¤„ç†ï¼ŒAOPæ¡†æ¶å°†è‡ªåŠ¨ç”ŸæˆAOPä»£ç†ï¼Œå³ï¼š<strong>ä»£ç†å¯¹è±¡çš„æ–¹æ³•=å¢å¼ºå¤„ç†+è¢«ä»£ç†å¯¹è±¡</strong>çš„æ–¹æ³•ã€‚</p>
<p>ä¸‹é¢ç»™å‡ºä¸€ä¸ªSpring AOPçš„.xmlæ–‡ä»¶æ¨¡æ¿ï¼Œåå­—å«åšaop.xmlï¼Œä¹‹åçš„å†…å®¹éƒ½åœ¨aop.xmlä¸Šè¿›è¡Œæ‰©å±•ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="tag">    <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="tag">    <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans/spring-beans-4.2.xsd</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/aop</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/aop/spring-aop-4.2.xsd"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">            </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span></pre></td></tr></table></figure>
<p><strong>åŸºäºSpringçš„AOPç®€å•å®ç°</strong></p>
<p>æ³¨æ„ä¸€ä¸‹ï¼Œåœ¨è®²è§£ä¹‹å‰ï¼Œè¯´æ˜ä¸€ç‚¹ï¼šä½¿ç”¨Spring AOPï¼Œè¦æˆåŠŸè¿è¡Œèµ·ä»£ç ï¼Œåªç”¨Springæä¾›ç»™å¼€å‘è€…çš„jaråŒ…æ˜¯ä¸å¤Ÿçš„ï¼Œè¯·é¢å¤–ä¸Šç½‘ä¸‹è½½ä¸¤ä¸ªjaråŒ…ï¼š1ã€aopalliance.jarï¼›2ã€aspectjweaver.jar</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//å…ˆå®šä¹‰ä¸€ä¸ªæ¥å£ï¼š</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HelloWorld</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="class"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">printHelloWorld</span><span class="params">()</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">doPrint</span><span class="params">()</span></span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//å®šä¹‰ä¸¤ä¸ªæ¥å£å®ç°ç±»ï¼š</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldImpl1</span> <span class="keyword">implements</span> <span class="title">HelloWorld</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="class"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printHelloWorld</span><span class="params">()</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="function">    </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        System.out.println(<span class="string">"Enter HelloWorldImpl1.printHelloWorld()"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doPrint</span><span class="params">()</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="function">    </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">        System.out.println(<span class="string">"Enter HelloWorldImpl1.doPrint()"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> ;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldImpl2</span> <span class="keyword">implements</span> <span class="title">HelloWorld</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"><span class="class"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printHelloWorld</span><span class="params">()</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line"><span class="function">    </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">        System.out.println(<span class="string">"Enter HelloWorldImpl2.printHelloWorld()"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doPrint</span><span class="params">()</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line"><span class="function">    </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">        System.out.println(<span class="string">"Enter HelloWorldImpl2.doPrint()"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> ;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼Œè¿™é‡Œæ˜¯æ‰“å°æ—¶é—´</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeHandler</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line"><span class="class"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">printTime</span><span class="params">()</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line"><span class="function">    </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">        System.out.println(<span class="string">"CurrentTime = "</span> + System.currentTimeMillis());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p>æœ‰è¿™ä¸‰ä¸ªç±»å°±å¯ä»¥å®ç°ä¸€ä¸ªç®€å•çš„Spring AOPäº†ï¼Œçœ‹ä¸€ä¸‹aop.xmlçš„é…ç½®:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="tag">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="tag">    <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="tag">    <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="tag">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/beans/spring-beans-4.2.xsd</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/aop</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="tag"><span class="string">        http://www.springframework.org/schema/aop/spring-aop-4.2.xsd"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"helloWorldImpl1"</span> <span class="attr">class</span>=<span class="string">"com.xrq.aop.HelloWorldImpl1"</span> /&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"helloWorldImpl2"</span> <span class="attr">class</span>=<span class="string">"com.xrq.aop.HelloWorldImpl2"</span> /&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"timeHandler"</span> <span class="attr">class</span>=<span class="string">"com.xrq.aop.TimeHandler"</span> /&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">        </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">aop:config</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">            <span class="tag">&lt;<span class="name">aop:aspect</span> <span class="attr">id</span>=<span class="string">"time"</span> <span class="attr">ref</span>=<span class="string">"timeHandler"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">                <span class="tag">&lt;<span class="name">aop:pointcut</span> <span class="attr">id</span>=<span class="string">"addAllMethod"</span> <span class="attr">expression</span>=<span class="string">"execution(* com.xrq.aop.HelloWorld.*(..))"</span> /&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">                <span class="tag">&lt;<span class="name">aop:before</span> <span class="attr">method</span>=<span class="string">"printTime"</span> <span class="attr">pointcut-ref</span>=<span class="string">"addAllMethod"</span> /&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">                <span class="tag">&lt;<span class="name">aop:after</span> <span class="attr">method</span>=<span class="string">"printTime"</span> <span class="attr">pointcut-ref</span>=<span class="string">"addAllMethod"</span> /&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">            <span class="tag">&lt;/<span class="name">aop:aspect</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;/<span class="name">aop:config</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    ApplicationContext ctx = </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">new</span> ClassPathXmlApplicationContext(<span class="string">"aop.xml"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    HelloWorld hw1 = (HelloWorld)ctx.getBean(<span class="string">"helloWorldImpl1"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    HelloWorld hw2 = (HelloWorld)ctx.getBean(<span class="string">"helloWorldImpl2"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    hw1.printHelloWorld();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    System.out.println();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    hw1.doPrint();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    System.out.println();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    hw2.printHelloWorld();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    System.out.println();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    hw2.doPrint();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p>è¿è¡Œç»“æœä¸ºï¼š</p>
<figure class="highlight tex"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">CurrentTime = 1446129611993</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">Enter HelloWorldImpl1.printHelloWorld()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">CurrentTime = 1446129611993</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">CurrentTime = 1446129611994</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">Enter HelloWorldImpl1.doPrint()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">CurrentTime = 1446129611994</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">CurrentTime = 1446129611994</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">Enter HelloWorldImpl2.printHelloWorld()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">CurrentTime = 1446129611994</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">CurrentTime = 1446129611994</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">Enter HelloWorldImpl2.doPrint()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">CurrentTime = 1446129611994</span></pre></td></tr></table></figure>
<p>çœ‹åˆ°ç»™HelloWorldæ¥å£çš„ä¸¤ä¸ªå®ç°ç±»çš„æ‰€æœ‰æ–¹æ³•éƒ½åŠ ä¸Šäº†ä»£ç†ï¼Œä»£ç†å†…å®¹å°±æ˜¯æ‰“å°æ—¶é—´ã€‚</p>
<h5 id="å‚è€ƒèµ„æ–™-DIP-DI-IoC"><a href="#å‚è€ƒèµ„æ–™-DIP-DI-IoC" class="headerlink" title="å‚è€ƒèµ„æ–™: DIP/DI/IoC"></a><a href="https://www.cnblogs.com/liuhaorain/p/3747470.html" target="_blank" rel="noopener">å‚è€ƒèµ„æ–™: DIP/DI/IoC</a></h5><h5 id="å‚è€ƒèµ„æ–™-AOP"><a href="#å‚è€ƒèµ„æ–™-AOP" class="headerlink" title="å‚è€ƒèµ„æ–™: AOP"></a><a href="https://www.cnblogs.com/hongwz/p/5764917.html" target="_blank" rel="noopener">å‚è€ƒèµ„æ–™: AOP</a></h5><h4 id="ä¸€ã€æ¦‚æ‹¬"><a href="#ä¸€ã€æ¦‚æ‹¬" class="headerlink" title="ä¸€ã€æ¦‚æ‹¬"></a>ä¸€ã€æ¦‚æ‹¬</h4><p>Spring Securityæ˜¯ä¸€ä¸ªé«˜åº¦è‡ªå®šä¹‰çš„<strong>å®‰å…¨æ¡†æ¶</strong>ã€‚åˆ©ç”¨Spring IoC/DIå’ŒAOPåŠŸèƒ½ï¼Œä¸ºç³»ç»Ÿæä¾›äº†<strong>å£°æ˜å¼å®‰å…¨è®¿é—®æ§åˆ¶åŠŸèƒ½</strong>ï¼Œå‡å°‘äº†ä¸ºç³»ç»Ÿå®‰å…¨è€Œç¼–å†™å¤§é‡é‡å¤ä»£ç çš„å·¥ä½œã€‚</p>
<p>Spring Security è§£å†³äº†javaEEçš„Servletè§„èŒƒæˆ–EJBè§„èŒƒä¸­çš„å®‰å…¨åŠŸèƒ½ç¼ºä¹å…¸å‹ä¼ä¸šåº”ç”¨åœºæ™¯çš„ç¼ºé™·ã€‚åŒæ—¶ï¼Œå®ƒæä¾›äº†è®¸å¤šå…¶ä»–æœ‰ç”¨çš„ã€å¯å®šåˆ¶çš„å®‰å…¨åŠŸèƒ½ã€‚</p>
<p>åœ¨webå®‰å…¨æ–¹é¢ä¸»è¦æœ‰<strong>â€œè®¤è¯â€</strong>å’Œ<strong>â€œæˆæƒâ€</strong>ä¸¤ä¸ªä¸»è¦çš„æ¨¡å—ï¼Œè¿™ä¸¤è€…ä¹Ÿæ˜¯Spring Securityé‡è¦æ ¸å¿ƒåŠŸèƒ½ã€‚<strong>â€œè®¤è¯â€</strong>ï¼Œæ˜¯å»ºç«‹ä¸€ä¸ªä»–å£°æ˜çš„ä¸»ä½“çš„è¿‡ç¨‹ï¼ˆä¸€ä¸ªâ€œä¸»ä½“â€ä¸€èˆ¬æ˜¯æŒ‡ç”¨æˆ·ï¼Œè®¾å¤‡æˆ–ä¸€äº›å¯ä»¥åœ¨ä½ çš„åº”ç”¨ç¨‹åºä¸­æ‰§è¡ŒåŠ¨ä½œçš„å…¶ä»–ç³»ç»Ÿï¼‰ï¼Œé€šä¿—ç‚¹è¯´å°±æ˜¯ç³»ç»Ÿè®¤ä¸ºç”¨æˆ·<strong>æ˜¯å¦èƒ½ç™»å½•</strong>ã€‚<strong>â€œæˆæƒâ€</strong>æŒ‡ç¡®å®šä¸€ä¸ªä¸»ä½“æ˜¯å¦å…è®¸åœ¨ä½ çš„åº”ç”¨ç¨‹åºæ‰§è¡Œä¸€ä¸ªåŠ¨ä½œçš„è¿‡ç¨‹ã€‚é€šä¿—ç‚¹è®²å°±æ˜¯ç³»ç»Ÿåˆ¤æ–­ç”¨æˆ·<strong>æ˜¯å¦æœ‰æƒé™å»åš</strong>æŸäº›äº‹æƒ…</p>
<h5 id="1ã€æƒé™ç®¡ç†ï¼šä¸€èˆ¬æŒ‡æ ¹æ®ç³»ç»Ÿè®¾ç½®çš„å®‰å…¨è§„åˆ™æˆ–è€…å®‰å…¨ç­–ç•¥ã€‚ç”¨æˆ·å¯ä»¥è®¿é—®è€Œä¸”åªèƒ½è®¿é—®è‡ªå·±è¢«æˆæƒçš„èµ„æºã€‚ä½†éœ€è¦ç³»ç»Ÿå…·å¤‡æ ¹æ®ç”¨æˆ·åæ ¸å¯†ç è¿›è¡Œè®¤è¯çš„æ“ä½œã€‚ä¸‹é¢æ˜¯æƒé™ç®¡ç†ä¸­ä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µï¼š"><a href="#1ã€æƒé™ç®¡ç†ï¼šä¸€èˆ¬æŒ‡æ ¹æ®ç³»ç»Ÿè®¾ç½®çš„å®‰å…¨è§„åˆ™æˆ–è€…å®‰å…¨ç­–ç•¥ã€‚ç”¨æˆ·å¯ä»¥è®¿é—®è€Œä¸”åªèƒ½è®¿é—®è‡ªå·±è¢«æˆæƒçš„èµ„æºã€‚ä½†éœ€è¦ç³»ç»Ÿå…·å¤‡æ ¹æ®ç”¨æˆ·åæ ¸å¯†ç è¿›è¡Œè®¤è¯çš„æ“ä½œã€‚ä¸‹é¢æ˜¯æƒé™ç®¡ç†ä¸­ä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µï¼š" class="headerlink" title="1ã€æƒé™ç®¡ç†ï¼šä¸€èˆ¬æŒ‡æ ¹æ®ç³»ç»Ÿè®¾ç½®çš„å®‰å…¨è§„åˆ™æˆ–è€…å®‰å…¨ç­–ç•¥ã€‚ç”¨æˆ·å¯ä»¥è®¿é—®è€Œä¸”åªèƒ½è®¿é—®è‡ªå·±è¢«æˆæƒçš„èµ„æºã€‚ä½†éœ€è¦ç³»ç»Ÿå…·å¤‡æ ¹æ®ç”¨æˆ·åæ ¸å¯†ç è¿›è¡Œè®¤è¯çš„æ“ä½œã€‚ä¸‹é¢æ˜¯æƒé™ç®¡ç†ä¸­ä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µï¼š"></a>1ã€<strong>æƒé™ç®¡ç†ï¼š</strong>ä¸€èˆ¬æŒ‡æ ¹æ®ç³»ç»Ÿè®¾ç½®çš„å®‰å…¨è§„åˆ™æˆ–è€…å®‰å…¨ç­–ç•¥ã€‚ç”¨æˆ·å¯ä»¥è®¿é—®è€Œä¸”åªèƒ½è®¿é—®è‡ªå·±è¢«æˆæƒçš„èµ„æºã€‚ä½†éœ€è¦ç³»ç»Ÿå…·å¤‡æ ¹æ®ç”¨æˆ·åæ ¸å¯†ç è¿›è¡Œè®¤è¯çš„æ“ä½œã€‚ä¸‹é¢æ˜¯æƒé™ç®¡ç†ä¸­ä¸¤ä¸ªé‡è¦çš„æ¦‚å¿µï¼š</h5><p><strong>è®¤è¯ï¼š</strong>é€šè¿‡ç”¨æˆ·åå’Œå¯†ç æˆåŠŸç™»å½•ç³»ç»Ÿåï¼Œè®©ç³»ç»Ÿå¾—åˆ°å½“å‰ç”¨æˆ·çš„è§’è‰²èº«ä»½ã€‚</p>
<p><strong>æˆæƒï¼š</strong>ç³»ç»Ÿæ ¹æ®å½“å‰ç”¨æˆ·çš„è§’è‰²ï¼Œç»™æˆäºˆå¯¹åº”å¯ä»¥æ“ä½œçš„æƒé™èµ„æºã€‚</p>
<h5 id="2ã€å®Œæˆæƒé™ç®¡ç†éœ€è¦çš„ä¸‰ä¸ªå¯¹è±¡ï¼š"><a href="#2ã€å®Œæˆæƒé™ç®¡ç†éœ€è¦çš„ä¸‰ä¸ªå¯¹è±¡ï¼š" class="headerlink" title="2ã€å®Œæˆæƒé™ç®¡ç†éœ€è¦çš„ä¸‰ä¸ªå¯¹è±¡ï¼š"></a>2ã€<strong>å®Œæˆæƒé™ç®¡ç†éœ€è¦çš„ä¸‰ä¸ªå¯¹è±¡ï¼š</strong></h5><ol>
<li>ç”¨æˆ·ï¼šä¸»è¦åŒ…å«ç”¨æˆ·åã€å¯†ç å’Œå½“å‰ç”¨æˆ·çš„è§’è‰²ä¿¡æ¯ï¼Œå¯ä»¥å®ç°è®¤è¯æ“ä½œã€‚</li>
<li>è§’è‰²ï¼šä¸»è¦åŒ…å«è§’è‰²åç§°ï¼Œè§’è‰²æè¿°å’Œå½“å‰è§’è‰²æ‹¥æœ‰çš„æƒé™ä¿¡æ¯ï¼Œå¯å®ç°æˆæƒæ“ä½œã€‚</li>
<li>æƒé™ï¼šæˆä¸ºèœå•ï¼Œä¸»è¦åŒ…å«å½“å‰æƒé™çš„åç§°ï¼Œurlåœ°å€ç­‰ä¿¡æ¯ï¼Œä¸ºäº†å®ç°åŠ¨æ€å±•ç¤ºèœå•ã€‚</li>
</ol>
<p>ä¸‰è€…ä¹‹é—´éƒ½æ˜¯<strong>å¤šå¯¹å¤š</strong>çš„å…³ç³»ã€‚</p>
<h5 id="3ã€Spring-Securityæ¦‚å¿µ"><a href="#3ã€Spring-Securityæ¦‚å¿µ" class="headerlink" title="3ã€Spring Securityæ¦‚å¿µ"></a>3ã€Spring Securityæ¦‚å¿µ</h5><p>Spring Securityæ˜¯springé‡‡ç”¨AOPæ€æƒ³ï¼ŒåŸºäºservletè¿‡æ»¤å™¨å®ç°çš„å®‰å…¨æ¡†æ¶ã€‚å®ƒæä¾›äº†å®Œå–„çš„è®¤è¯æœºåˆ¶å’Œæ–¹æ³•çº§çš„æˆæƒåŠŸèƒ½ã€‚æ˜¯ä¸€æ¬¾éå¸¸ä¼˜ç§€çš„<strong>æƒé™ç®¡ç†æ¡†æ¶</strong>ã€‚</p>
<h4 id="äºŒã€å¼€å¯Spring-Securityé¡¹ç›®"><a href="#äºŒã€å¼€å¯Spring-Securityé¡¹ç›®" class="headerlink" title="äºŒã€å¼€å¯Spring Securityé¡¹ç›®"></a>äºŒã€å¼€å¯Spring Securityé¡¹ç›®</h4><h5 id="1ã€å¯¼å…¥ä¾èµ–"><a href="#1ã€å¯¼å…¥ä¾èµ–" class="headerlink" title="1ã€å¯¼å…¥ä¾èµ–"></a>1ã€å¯¼å…¥ä¾èµ–</h5><p>Spring Securityå·²ç»è¢«Spring bootè¿›è¡Œé›†æˆï¼Œä½¿ç”¨æ—¶ç›´æ¥å¼•å…¥å¯åŠ¨å™¨å³å¯ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--è¿™ä¸ªæ˜¯Spring Webå·¥ç¨‹ä¸­éœ€è¦å¯¼å…¥çš„ä¾èµ–--&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-taglibs<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--è¿™æ˜¯åœ¨Spring Bootçš„ç¯å¢ƒä¸‹éœ€è¦å¯¼å…¥çš„åŒ…--&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></pre></td></tr></table></figure>
<h5 id="2ã€è®¿é—®é¡µé¢"><a href="#2ã€è®¿é—®é¡µé¢" class="headerlink" title="2ã€è®¿é—®é¡µé¢"></a>2ã€è®¿é—®é¡µé¢</h5><p>å¯¼å…¥spring-boot-starter-securityå¯åŠ¨å™¨åï¼ŒSpring Securityå·²ç»ç”Ÿæ•ˆï¼Œé»˜è®¤æ‹¦æˆªå…¨éƒ¨è¯·æ±‚ï¼Œå¦‚æœç”¨æˆ·æ²¡æœ‰ç™»å½•ï¼Œè·³è½¬åˆ°å†…ç½®ç™»å½•é¡µé¢ã€‚</p>
<p>åœ¨é¡¹ç›®ä¸­æ–°å»ºlogin.htmlé¡µé¢åï¼Œåœ¨æµè§ˆå™¨è¾“å…¥ï¼š<a href="http://localhost:8080/login.htmlåä¼šæ˜¾ç¤ºä¸‹é¢é¡µé¢" target="_blank" rel="noopener">http://localhost:8080/login.htmlåä¼šæ˜¾ç¤ºä¸‹é¢é¡µé¢</a></p>
<p><img src="/2021/06/27/Spring-Security-Plus/Users\aaa\Desktop\2.png" alt="img"></p>
<p>é»˜è®¤çš„usernameä¸ºuserï¼Œpasswordæ‰“å°åœ¨æ§åˆ¶å°ä¸­ã€‚åœ¨æµè§ˆå™¨ä¸­è¾“å…¥è´¦å·å’Œå¯†ç åä¼šæ˜¾ç¤ºlogin.htmlé¡µé¢å†…å®¹ã€‚</p>
<h5 id="3ã€åº”ç”¨åœºæ™¯"><a href="#3ã€åº”ç”¨åœºæ™¯" class="headerlink" title="3ã€åº”ç”¨åœºæ™¯"></a>3ã€åº”ç”¨åœºæ™¯</h5><p>åœ¨å¾ˆå¤šæŠ€æœ¯ä¸­éƒ½å¯èƒ½æœ‰webè®¿é—®æ§åˆ¶é¡µé¢ã€‚ä¾‹å¦‚ï¼šwww.baidu.comå°±æœ‰webç®¡ç†é¡µé¢ã€‚ä¸éœ€è¦è¿›è¡Œç™»å½•ï¼Œåªè¦çŸ¥é“ipå’Œç«¯å£ä»»ä½•äººéƒ½å¯ä»¥è¿›è¡Œè®¿é—®çš„ã€‚å¯èƒ½å¯¼è‡´ç½‘ç«™ä¸­æ•°æ®ä¸å®‰å…¨é—®é¢˜ã€‚ä¸ºäº†ä¿è¯æ•°æ®å®‰å…¨æ€§ï¼Œå¯ä»¥åœ¨Spring Booté¡¹ç›®ä¸­æ·»åŠ Spring Securityã€‚</p>
<p><strong>å¦‚ä½•è‡ªå®šä¹‰ç”¨æˆ·åå’Œå¯†ç ï¼Ÿ</strong></p>
<p>é€šè¿‡ä¿®æ”¹application.properties/application.yml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">spring.security.user.name=smallming</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">spring.security.user.password=smallming</span></pre></td></tr></table></figure>
<h5 id="4ã€Spring-Securityè¿‡æ»¤å™¨é“¾"><a href="#4ã€Spring-Securityè¿‡æ»¤å™¨é“¾" class="headerlink" title="4ã€Spring Securityè¿‡æ»¤å™¨é“¾"></a>4ã€Spring Securityè¿‡æ»¤å™¨é“¾</h5><p>è¿‡æ»¤å™¨æ˜¯ä¸€ç§å…¸å‹çš„AOPæ€æƒ³</p>
<p><strong>1ã€org.springframework.security.web.context.SecurityContextPersistenceFilter:</strong> åˆå§‹åŒ–SecurityContextè¿™ä¸ªåŸŸ/å®¹å™¨ï¼Œæ”¾åˆ°SecurityContextHolderå¯¹è±¡ä¸­ï¼Œä¸ºåç»­filterå»ºç«‹æ‰€éœ€çš„ä¸Šä¸‹æ–‡ã€‚SecurityContextä¸­å­˜å‚¨äº†å½“å‰ç”¨æˆ·çš„è®¤è¯ä»¥åŠæƒé™ä¿¡æ¯ã€‚</p>
<p><strong>2ã€org.springframework.security.web.context.request.async.WebAsyncManageIntegrationFilter:</strong> æ­¤è¿‡æ»¤å™¨ç”¨äºé›†æˆSecurityContextåˆ°Springå¼‚æ­¥æ‰§è¡Œæœºåˆ¶ä¸­çš„WebAsyncManagerã€‚å¦è€…Spring Securityä¸Springå’ŒWebå®¹å™¨æ— æ³•æ•´åˆã€‚</p>
<p><strong>3ã€org.springframework.security.web.header.HeaderWriterFilter:</strong> å‘è¯·æ±‚çš„Headerä¸­æ·»åŠ ç›¸åº”çš„ä¿¡æ¯ï¼Œå¯åœ¨httpæ ‡ç­¾å†…éƒ¨ä½¿ç”¨security:headeræ¥æ§åˆ¶ï¼Œä»…é™ä¸jspåŠ¨æ€é¡µé¢ã€‚</p>
<p><strong>4ã€org.springframework.security.web.csrf.CsrfFilter:</strong> csrfæˆä¸ºè·¨åŸŸä¼ªé€ è¯·æ±‚ï¼ŒSpringSecurityä¼šå¯¹æ‰€æœ‰postè¯·æ±‚éªŒè¯æ˜¯å¦åŒ…å«ç³»ç»Ÿç”Ÿæˆçš„csrfçš„tokenä¿¡æ¯ï¼Œå¦‚æœä¸åŒ…å«ï¼Œåˆ™æŠ¥é”™ã€‚èµ·åˆ°é˜²æ­¢csrfæ”»å‡»çš„æ•ˆæœã€‚</p>
<p><strong>5ã€org.springframework.security.web.authentication.logout.LogoutFilter:</strong> é€€å‡ºç™»å½•çš„è¿‡æ»¤å™¨ï¼ŒåŒ¹é…URLä¸º/logoutçš„è¯·æ±‚ï¼Œå®ç°ç”¨æˆ·é€€å‡ºï¼Œæ¸…é™¤è®¤è¯ä¿¡æ¯ã€‚</p>
<p><strong>6ã€org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter:</strong> è®¤è¯æ“ä½œå…¨é è¿™ä¸ªè¿‡æ»¤å™¨ï¼Œé»˜è®¤åŒ¹é…URLä¸º/loginä¸”å¿…é¡»ä¸ºPOSTè¯·æ±‚ã€‚</p>
<p><strong>7ã€org.springframework.security.web.authentication.ui.DefaultLoginPageGeneratingFilter:</strong> å¦‚æœæ²¡æœ‰åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šè®¤è¯é¡µé¢ï¼Œåˆ™ç”±è¯¥è¿‡æ»¤å™¨ç”Ÿæˆä¸€ä¸ªé»˜è®¤çš„è®¤è¯é¡µé¢ã€‚</p>
<p><strong>8ã€org.springframework.security.web.authentication.ui.DefaultLogoutPageGeneratingFilter:</strong> æ­¤è¿‡æ»¤å™¨å¯ä»¥äº§ç”Ÿä¸€ä¸ªé»˜è®¤çš„é€€å‡ºç™»å½•é¡µé¢ã€‚</p>
<p><strong>9ã€org.springframework.security.web.authentication.www.BasicAuthenticationFilter:</strong> æ­¤è¿‡æ»¤å™¨ä¼šè‡ªåŠ¨è§£æHTTPè¯·æ±‚ä¸­å¤´éƒ¨åå­—ä¸ºAuthenticationï¼Œä¸”ä»¥Basicå¼€å¤´çš„å¤´ä¿¡æ¯ã€‚</p>
<p><strong>10ã€org.springframework.secutiry.web.savedrequest.RequestCacheAwareFilter:</strong> é€šè¿‡HttpSessionRequestCacheå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªRequestCache,ç”¨äºç¼“å†²HttpServletRequestã€‚</p>
<p><strong>11ã€org.springframework.security.web.servletapi.SecurityContextHolderAwareRequestFilter:</strong> é’ˆå¯¹ServletRequestè¿›è¡Œäº†ä¸€æ¬¡åŒ…è£…ï¼Œä½¿å¾—requestå…·æœ‰æ›´åŠ ä¸°å¯Œçš„APIã€‚</p>
<p><strong>12ã€org.springframework.security.web.authentication.AnonymousAuthenticationFilter:</strong> å½“SecurityContextHolderä¸­è®¤è¯ä¿¡æ¯ä¸ºç©ºï¼Œåˆ™ä¼šåˆ›å»ºä¸€ä¸ªåŒ¿åç”¨æˆ·å­˜å…¥åˆ°SecurityContextHolderä¸­ã€‚spring securityä¸ºäº†å…¼å®¹æœªç™»å½•çš„è®¿é—®ï¼Œä¹Ÿèµ°äº†ä¸€å¥—è®¤è¯æµç¨‹ï¼Œåªä¸è¿‡æ˜¯ä¸€ä¸ªåŒ¿åçš„èº«ä»½ã€‚</p>
<p><strong>13ã€org.springframework.security.web.session.SessionManagementFilter:</strong> SecurityContextRepositoryé™åˆ¶åŒä¸€ç”¨æˆ·å¼€å¯å¤šä¸ªä¼šè¯çš„æ•°é‡ã€‚</p>
<p><strong>14ã€org.springframework.security.web.access.ExceptionTranslationFilter:</strong> ç”¨äºè½¬æ¢æ•´ä¸ªé“¾è·¯ä¸­å‡ºç°çš„å¼‚å¸¸ã€‚</p>
<p><strong>15ã€org.springframework.security.web.access.intercept.FilterSecurityInterceptor:</strong> è·å–æ‰€é…ç½®èµ„æºè®¿é—®çš„æˆæƒä¿¡æ¯ï¼Œæ ¹æ®SecurityContextHolderä¸­å­˜å‚¨çš„ç”¨æˆ·ä¿¡æ¯æ¥å†³å®šå…¶æ˜¯å¦æœ‰æƒé™ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- spring security.xml --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--é‡Šæ”¾é™æ€èµ„æº--&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">security:http</span> <span class="attr">pattern</span>=<span class="string">"/css/**"</span> <span class="attr">security</span>=<span class="string">"none"</span>/&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">security:http</span> <span class="attr">pattern</span>=<span class="string">"/img/**"</span> <span class="attr">security</span>=<span class="string">"none"</span>/&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">security:http</span> <span class="attr">pattern</span>=<span class="string">"/plugins/**"</span> <span class="attr">security</span>=<span class="string">"none"</span>/&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--é…ç½®springSecurity--&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="comment">auto-config="true" è¡¨ç¤ºè‡ªåŠ¨åŠ è½½sprignsecurityçš„é…ç½®æ–‡ä»¶</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="comment">use-expressions="true" è¡¨ç¤ºä½¿ç”¨springçš„ELè¡¨è¾¾å¼æ¥é…ç½®springsecurity</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="comment">--&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">security:http</span> <span class="attr">auto-config</span>=<span class="string">"true"</span> <span class="attr">use-expression</span>=<span class="string">"true"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">&lt;!--è®©è®¤è¯é¡µé¢å¯ä»¥åŒ¿åè®¿é—®--&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">security:intercept-url</span> <span class="attr">pattern</span>=<span class="string">"/login.jsp"</span> <span class="attr">access</span>=<span class="string">"permitAll()"</span>/&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">&lt;!--æ‹¦æˆªèµ„æº--&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">&lt;!--</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"><span class="comment">	pattren="/**" è¡¨ç¤ºæ‹¦æˆªæ‰€æœ‰èµ„æº</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"><span class="comment">	accesee="hasAnyRole('ROLE_USER')" è¡¨ç¤ºåªæœ‰ROLE_USERè§’è‰²æ‰èƒ½è®¿é—®èµ„æº</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"><span class="comment">	--&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">security:intercept-url</span> <span class="attr">pattern</span>=<span class="string">"/**"</span> <span class="attr">access</span>=<span class="string">"hasAnyRole('ROLE_USER')"</span>/&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">&lt;!--é…ç½®è®¤è¯ä¿¡æ¯--&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">security:form-login</span> <span class="attr">login-page</span>=<span class="string">"/login.jsp"</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line"><span class="tag">                         <span class="attr">login-processing-url</span>=<span class="string">"/login"</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line"><span class="tag">                         <span class="attr">default-target-url</span>=<span class="string">"/index.jsp"</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"><span class="tag">                         <span class="attr">authentication-failure-url</span>=<span class="string">"/failer.jsp"</span>/&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">&lt;!--é…ç½®é€€å‡ºç™»å½•ä¿¡æ¯--&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">security:logout</span> <span class="attr">logout-url</span>=<span class="string">"/logout"</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line"><span class="tag">                     <span class="attr">logout-success-url</span>=<span class="string">"/login.jsp"</span>/&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">security:csrf</span> <span class="attr">disabled</span>=<span class="string">"true"</span>/&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">&lt;!--å¼€å¯remember meè¿‡æ»¤å™¨ï¼Œè®¾ç½®tokenå­˜å‚¨æ—¶é—´ä¸º60ç§’--&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">security:remember-me</span> </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line"><span class="tag">             <span class="attr">data-source-ref</span>=<span class="string">"dataSource"</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line"><span class="tag">             <span class="attr">token-validity-second</span>=<span class="string">"60"</span>/&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">security:http</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--æŠŠå¯†ç å¯¹è±¡æ”¾å…¥IoCå®¹å™¨ä¸­--&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"passwordEncoder"</span> <span class="attr">class</span>=<span class="string">"org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder"</span>/&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--è®¾ç½®Spring Securityè®¤è¯ç”¨æˆ·ä¿¡æ¯çš„æ¥æº--&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line"><span class="comment">springsecurityé»˜è®¤çš„è®¤è¯å¿…é¡»æ˜¯åŠ å¯†çš„ï¼ŒåŠ ä¸Š(noop)è¡¨ç¤ºä¸åŠ å¯†è®¤è¯ã€‚</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line"><span class="comment">--&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">security:authentication-manager</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">security:authentication-provider</span> <span class="attr">user-service-ref</span>=<span class="string">"userServiceImpl"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">security:password-encoder</span> <span class="attr">ref</span>=<span class="string">"passwordEncoder"</span>/&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;/<span class="name">security:authentication-provider</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">security:authentication-manager</span>&gt;</span></span></pre></td></tr></table></figure>
<h4 id="ä¸‰ã€UserDetailServiceè¯¦è§£"><a href="#ä¸‰ã€UserDetailServiceè¯¦è§£" class="headerlink" title="ä¸‰ã€UserDetailServiceè¯¦è§£"></a>ä¸‰ã€UserDetailServiceè¯¦è§£</h4><p>å½“ä»€ä¹ˆä¹Ÿæ²¡æœ‰é…ç½®çš„æ—¶å€™ï¼Œè´¦å·å’Œå¯†ç æ˜¯ç”±Spring Securityå®šä¹‰ç”Ÿæˆçš„ã€‚è€Œåœ¨å®é™…é¡¹ç›®ä¸­è´¦å·å’Œå¯†ç éƒ½æ˜¯ä»æ•°æ®åº“ä¸­æŸ¥è¯¢å‡ºæ¥çš„ã€‚ æ‰€ä»¥æˆ‘ä»¬è¦é€šè¿‡è‡ªå®šä¹‰é€»è¾‘æ§åˆ¶è®¤è¯é€»è¾‘ã€‚åŠéœ€è¦å®ç°UserDetailsServiceæ¥å£å³å¯ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//é‡å†™loadUserByUsernameä½¿è‡ªå·±çš„æ•°æ®åº“ä¸spring securityåšè¡”æ¥ï¼Œä¸‹é¢æ˜¯spring securityé»˜è®¤çš„æ¥å£</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDetailService</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="function">UserDetails <span class="title">loadUserByUsername</span><span class="params">(String name)</span> <span class="keyword">throws</span> UsernameNonFoundException</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//è¿”å›å€¼ UserDetails</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDetails</span> <span class="keyword">extends</span> <span class="title">Serializable</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    Collection&lt;? extends GranteAuthority&gt; getAuthorities(); <span class="comment">//è·å–æ‰€æœ‰æƒé™</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="function">String <span class="title">getPassword</span><span class="params">()</span></span>; <span class="comment">//è·å–å¯†ç </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="function">String <span class="title">getUsername</span><span class="params">()</span></span>; <span class="comment">//è·å–ç”¨æˆ·å</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isAccountNonExpired</span><span class="params">()</span></span>; <span class="comment">//æ˜¯å¦è´¦å·è¿‡æœŸ</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isAccountNonLocked</span><span class="params">()</span></span>; <span class="comment">//æ˜¯å¦è´¦å·è¢«é”å®š</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isCredentialsNonExpired</span><span class="params">()</span></span>; <span class="comment">//å‡­è¯æ˜¯å¦è¿‡æœŸ</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span></span>; <span class="comment">//æ˜¯å¦å¯ç”¨</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//UserDetailsæ¥å£çš„å®ç°ç±»ä¸ºUser,ç”±org.springframework.security.core.userdetails.Useræä¾›</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¸‹é¢æ˜¯Userçš„ä¸¤ä¸ªæ„é€ å‡½æ•°</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">User(String, String, Collection&lt;? extends GrantedAuthority&gt;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">User(String, String, <span class="keyword">boolean</span>, <span class="keyword">boolean</span>, <span class="keyword">boolean</span>, <span class="keyword">boolean</span>, Collection&lt;? extends GranteAuthority&gt;)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> enabled æ˜¯å¦å¯ç”¨</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> accountNonExpired è´¦å·æ˜¯å¦å¤±æ•ˆ</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> credentialsNonExpired å¯†ç æ˜¯å¦å¤±æ•ˆ</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> accountNonLocked è´¦æˆ·æ˜¯å¦é”å®š</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//ä¸Šé¢å››ä¸ªbooleanå€¼ï¼Œåªè¦æœ‰ä¸€ä¸ªä¸ºfalseï¼Œåˆ™ä¸èƒ½ä½¿ç”¨</span></span></pre></td></tr></table></figure>
<p>ç”¨æˆ·é€šè¿‡ä¼ å…¥ç”¨æˆ·åå’Œå¯†ç ï¼Œåå°é€šè¿‡ç”¨æˆ·åä»æ•°æ®åº“ä¸­è·å–å¯¹åº”çš„å¯†ç ã€‚å¦‚æœä¸€è‡´ï¼Œåˆ™è®¤è¯é€šè¿‡ï¼›å¦‚æœä¸ä¸€è‡´ï¼Œåˆ™è®¤è¯å¤±è´¥ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> *è®¤è¯ä¸šåŠ¡</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> *<span class="doctag">@param</span> username ç”¨æˆ·åœ¨æµè§ˆå™¨è¾“å…¥çš„ç”¨æˆ·å</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> *<span class="doctag">@return</span> UserDetails æ˜¯springsecurityè‡ªå·±çš„ç”¨æˆ·å¯¹è±¡</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="comment"> *<span class="doctag">@throws</span> UsernameNotFoundExcetion</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment">**/</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">//æ ¹æ®usernameåšæŸ¥è¯¢</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">try</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">		SysUser sysUser = userDao.findByName(username);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">		<span class="keyword">if</span>(sysUser == <span class="keyword">null</span>)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">		&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">        List&lt;SimpleGrantedAuthority&gt; authorities = <span class="keyword">new</span> ArrayList&lt;&gt;();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">        List&lt;SysRole&gt; roles = sysUser.getRoles();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">for</span>(SysRole role : roles) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">        	authorities.add(<span class="keyword">new</span> SimpleGrantedAuthority(role));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">//(noop)åé¢çš„å¯†ç ï¼Œspringsecurityä¼šè®¤ä¸ºæ˜¯åŸæ–‡</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">		UserDetails userDetails = <span class="keyword">new</span> User(sysUser.getUsername(),<span class="string">"sysUser.getPassword(),authorities);</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"><span class="string">        return userDetails;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line"><span class="string">	&#125;catch(Exception e) &#123;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line"><span class="string">		e.printStackTrace();</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"><span class="string">		return null; //è®¤è¯å¤±è´¥</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line"><span class="string">	&#125;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line"><span class="string">&#125;</span></span></pre></td></tr></table></figure>
<p>è®¤è¯é€šè¿‡åauthoritiesä¸­çš„è®¤è¯ä¿¡æ¯ä¸­åŒ…å«äº†ç”¨æˆ·å…·æœ‰çš„æƒé™ï¼Œä»¥ä¾›æˆæƒéƒ¨åˆ†ä½¿ç”¨ã€‚é€šå¸¸éƒ½æ˜¯é€šè¿‡AuthorityUtils.commaSeparatedStringToAuthorityList(â€œâ€)æ¥åˆ›å»ºauthoritiesé›†åˆå¯¹è±¡çš„ã€‚å‚æ•°æ—¶ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå¤šä¸ªæƒé™ä½¿ç”¨é€—å·åˆ†éš”ã€‚</p>
<h4 id="å››ã€æ³¨æ„"><a href="#å››ã€æ³¨æ„" class="headerlink" title="å››ã€æ³¨æ„"></a>å››ã€æ³¨æ„</h4><p>å¦‚æœå¼€å¯äº†csrfé˜²æŠ¤åŠŸèƒ½ï¼Œlogoutå¤„ç†å™¨ä¾¿åªèƒ½æ”¯æŒPOSTè¯·æ±‚æ–¹å¼ï¼</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">&lt;!--é€€å‡ºç™»å½•--&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">&lt;!--ä¿®æ”¹header.jspä¸­æ³¨é”€è¯·æ±‚--&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">&lt;form action=<span class="string">"$&#123;pageContext.request.contextPath&#125;/logout"</span> method=<span class="string">"post"</span>&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">	&lt;security:csrfInput/&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    &lt;input type=<span class="string">"submit"</span> value=<span class="string">"æ³¨é”€"</span>&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">&lt;/form&gt;</span></pre></td></tr></table></figure>
<p><strong>remember meåŠŸèƒ½</strong>ï¼Œ1ã€æ’å…¥æ•°æ®åº“ï¼›2ã€å°†è®¤è¯å†™å…¥Cookie</p>
<p>remember meå®‰å…¨æ€§åˆ†æï¼šå› ä¸ºCookieæ˜¯ä¿å­˜åœ¨å®¢æˆ·ç«¯çš„ï¼Œå®¹æ˜“è¢«ç›—å–ï¼Œå¹¶ä¸”ä¸ç”¨æˆ·åå’Œå¯†ç ç›¸å…³ã€‚æ‰€ä»¥ä¸å¤ªå®‰å…¨ã€‚å› æ­¤ï¼Œéœ€è¦ç”¨å®Œåæ‰‹åŠ¨é€€å‡ºç™»å½•ï¼Œæƒ…å†µè®¤è¯ä¿¡æ¯ã€‚</p>
<p>æ­¤å¤–ï¼ŒSpringSecurityæä¾›äº†remember meçš„å¦ä¸€ç§ç›¸å¯¹å®‰å…¨çš„å®ç°æœºåˆ¶ï¼šåœ¨å®¢æˆ·ç«¯cookieä¸­ï¼Œä¿å­˜ä¸€ä¸ªæ— æ„ä¹‰çš„åŠ å¯†ä¸²(ä¸ç”¨æˆ·åã€å¯†ç ç­‰æ•æ„Ÿæ•°æ®æ— å…³)ï¼Œç„¶ååœ¨DBä¸­ä¿å­˜æ”¹åŠ å¯†ä¸²-ç”¨æˆ·ä¿¡æ¯çš„å¯¹åº”å…³ç³»ï¼Œè‡ªåŠ¨ç™»å½•æ—¶ï¼Œç”¨Cookieä¸­çš„åŠ å¯†ä¸²ï¼Œåˆ°DBä¸­éªŒè¯ï¼Œå¦‚æœé€šè¿‡ï¼Œè‡ªåŠ¨ç™»å½•æ‰ç®—é€šè¿‡ã€‚</p>
<p>åˆ›å»ºä¸€å¼ è¡¨ï¼Œåç§°å’Œå­—æ®µå›ºå®š</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`persistent_logins`</span> (</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">	<span class="string">`username`</span> <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    `series` varchar(64) NOT NULL;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    `token` varchar(64) NOT NULL;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    `last_used` timestamp NOT NULL;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    PRIMARY KEY (`series`)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8</span></pre></td></tr></table></figure>
<p>éœ€è¦åœ¨Spring Securityçš„é…ç½®æ–‡ä»¶ä¸­æ·»åŠ æ•°æ®æºdataSourceï¼Œè¯¥æ•°æ®æºåœ¨IoCçˆ¶å®¹å™¨çš„é…ç½®æ–‡ä»¶ä¸­æ·»åŠ </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">	<span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>/&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql:///security_authority"</span>/&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"root"</span>/&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span></pre></td></tr></table></figure>
<h4 id="äº”ã€æˆæƒ"><a href="#äº”ã€æˆæƒ" class="headerlink" title="äº”ã€æˆæƒ"></a>äº”ã€æˆæƒ</h4><p>äº§å“å’Œè®¢å•ä¸¤ä¸ªä¸šåŠ¡ä¸åŒçš„æ“ä½œäººå‘˜å…·æœ‰ä¸åŒçš„æƒé™ã€‚</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">&lt;ul&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    &lt;security:authorize access=<span class="string">"hasAnyRole('ROLE_PRODUCT', 'ROLE_ADMIN')"</span>&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    &lt;li id=<span class="string">"system-setting"</span>&gt;&lt;a href=<span class="string">"$&#123;pageContext.request.contextPath&#125;/product/findAll"</span>&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        &lt;i class="fa fa-circle-o"&gt;&lt;/i&gt;äº§å“ç®¡ç†</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    &lt;/a&gt;&lt;/li&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    &lt;/security:authorize&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    &lt;security:authorize access=<span class="string">"hasAnyRole('ROLE_ORDER', 'ROLE_ADMIN')"</span>&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    &lt;li id=<span class="string">"system-setting"</span>&gt;&lt;a href=<span class="string">"$&#123;pageContext.request.contextPath&#125;/order/findAll"</span>&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        &lt;i class="fa fa-circle-o"&gt;&lt;/i&gt;äº§å“ç®¡ç†</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    &lt;/a&gt;&lt;/li&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    &lt;/security:authorize&gt;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">&lt;/ul&gt;</span></pre></td></tr></table></figure>
<p><strong>IoCå®¹å™¨çš„ç»“æ„ï¼š</strong>ä»»ä½•webå·¥ç¨‹éƒ½æœ‰ä¸€ä¸ªæœ€å¤§çš„å®¹å™¨ï¼ŒservletContextå®¹å™¨ã€‚webä¸­å¦‚æœåŠ å…¥äº†springï¼Œé‚£ä¹ˆè¿˜ä¼šæœ‰SpringIoCå®¹å™¨(ç”±springçš„æ ¸å¿ƒç›‘å¬å™¨åŠ è½½ï¼Œæ˜¯ä¸€ä¸ªçˆ¶å®¹å™¨)ï¼ŒåŠ è½½Springé…ç½®æ–‡ä»¶å¯¹åº”çš„æ˜¯Serviceå’ŒDAOã€‚å¦‚æœåˆåŠ å…¥äº†SpringMVCï¼Œé‚£ä¹ˆåœ¨SpringIoCçˆ¶å®¹å™¨ä¸­åˆæ”¾å…¥äº†ä¸€ä¸ªSprignIoCå­å®¹å™¨(ç”±å‰ç«¯æ§åˆ¶å™¨åŠ è½½)ï¼ŒåŠ è½½SprignMVCé…ç½®æ–‡ä»¶(æ¢å¥è¯´åŠ è½½çš„æ˜¯Controlleræ§åˆ¶å™¨å¯¹è±¡)ã€‚</p>
<p>å­å®¹å™¨å¯ä»¥è®¿é—®çˆ¶å®¹å™¨ï¼Œå­å®¹å™¨ä¸­çš„å¯¹è±¡è¿˜å¯ä»¥è¢«httpè¯·æ±‚è®¿é—®ã€‚çˆ¶å®¹å™¨ä¸­çš„å¯¹è±¡å¯ä»¥è¢«å­å®¹å™¨è°ƒç”¨ï¼Œçˆ¶å®¹å™¨çš„å¯¹è±¡ä¸èƒ½è¢«httpè¯·æ±‚è®¿é—®ã€‚</p>
<p><img src="/2021/06/27/Spring-Security-Plus/Users\aaa\Desktop\3.png" alt="img"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--spring-security.xml--&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment">å¼€å¯æƒé™æ§åˆ¶çš„æ³¨è§£æ”¯æŒ</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="comment">secured-annotations="enabled"   springSecurityå†…éƒ¨çš„æƒé™æ§åˆ¶æ³¨è§£å¼€å…³</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="comment">pre-post-annotations="enabled"  springæŒ‡å®šçš„æƒé™æ§åˆ¶çš„æ³¨è§£å¼€å…³</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="comment">jsr250-annotations="enabled"    å¼€å¯java250æ³¨è§£æ”¯æŒ</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"><span class="comment">--&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">security:http</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">security:global-method-security</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="tag">             <span class="attr">secured-annotations</span>=<span class="string">"enabled"</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="tag">             <span class="attr">pre-post-annotations</span>=<span class="string">"enabled"</span></span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="tag">             <span class="attr">jsr250-annotations</span>=<span class="string">"enabled"</span>/&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">security:http</span>&gt;</span></span></pre></td></tr></table></figure>
<p><strong>æ³¨æ„ï¼š</strong>æ³¨è§£çš„æ”¯æŒä½ç½®ä¸è¦æ”¾é”™ï¼Œè¦ä¸æ‰€å¯¹åº”çš„IoCå®¹å™¨å¯¹åº”ï¼Œçˆ¶å®¹å™¨çš„æ³¨è§£æ”¯æŒè¦æ”¾åœ¨çˆ¶å®¹å™¨çš„é…ç½®æ–‡ä»¶ä¸­(applicationContext.xml/spring-security.xml)ï¼Œå¹¶æ·»åŠ åˆ°Serviceæˆ–Daoä¸­ï¼Œå­å®¹å™¨çš„æ³¨è§£æ”¯æŒè¦æ”¾åœ¨å­å®¹å™¨spring-mvc.xmlçš„é…ç½®æ–‡ä»¶ä¸­ï¼Œå¹¶æ·»åŠ åˆ°Controllerä¸­ã€‚æŒ‰ç†è¯´æ­£å¸¸éœ€è¦æ”¾åœ¨çˆ¶å®¹å™¨ä¸­ï¼Œè¿™æ ·æ›´åŠ çš„å®‰å…¨ã€‚</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@Secured</span>(&#123;<span class="string">"ROLE_PRODUCT"</span>,<span class="string">"ROLE_ADMIN"</span>&#125;) <span class="comment">//springSecurityå†…éƒ¨åˆ¶å®šçš„æ³¨è§£</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@RolesAllowd</span>(&#123;<span class="string">"ROLE_PRODUCT"</span>, <span class="string">"ROLE_ADMIN"</span>&#125;) <span class="comment">//jsr250æ³¨è§£</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@PreAuthorize</span>(<span class="string">"hasAnyAuthority('ROLE_PRODUCT','ROLE_ADMIN')"</span>) <span class="comment">//springçš„elè¡¨è¾¾å¼æ³¨è§£</span></span></pre></td></tr></table></figure>
<h4 id="å…­ã€å¤„ç†å¼‚å¸¸"><a href="#å…­ã€å¤„ç†å¼‚å¸¸" class="headerlink" title="å…­ã€å¤„ç†å¼‚å¸¸"></a>å…­ã€å¤„ç†å¼‚å¸¸</h4><p>Spring Securityæä¾›äº†ä¸€ç§å¤„ç†403å¼‚å¸¸çš„æ–¹å¼ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">security:http</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">&lt;!--å¤„ç†403å¼‚å¸¸--&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">security:access-denied-handler</span> <span class="attr">error-page</span>=<span class="string">"/403.jsp"</span>/&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">security:http</span>&gt;</span></span></pre></td></tr></table></figure>
<p>web.xmlåªåœ¨åœ¨webå·¥ç¨‹ä¸­(Spring Securityåœ¨Spring-MVCä¸­çš„ä½¿ç”¨)ï¼Œå¯¹äºå‰åç«¯åˆ†ç¦»çš„é¡¹ç›®ï¼Œæ¯”å¦‚spring-booté¡¹ç›®ä¸­ï¼Œé‡Œé¢æ²¡æœ‰web.xmlé…ç½®æ–‡ä»¶(å½“ç„¶ä¹Ÿèƒ½é…ç½®webé…ç½®ç±»ï¼Œä½†æ˜¯ä¸€èˆ¬ä¸ç”¨)ã€‚</p>
<p><strong>web.xmlä¸­å¤„ç†å¼‚å¸¸çš„æ–¹å¼ï¼š</strong>ï¼ˆç›®å‰ä¸å¸¸ç”¨ï¼Œéƒ½å¾€springä¸Šé ï¼‰</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">web-app</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">&lt;!--å¤„ç†403å¼‚å¸¸--&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">error-page</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">error-code</span>&gt;</span>403<span class="tag">&lt;/<span class="name">error-code</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">location</span>&gt;</span>/403.jsp<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;/<span class="name">error-page</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">&lt;!--å¤„ç†404å¼‚å¸¸--&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">error-page</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">error-code</span>&gt;</span>404<span class="tag">&lt;/<span class="name">error-code</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">location</span>&gt;</span>/404.jsp<span class="tag">&lt;/<span class="name">location</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;/<span class="name">error-page</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span></pre></td></tr></table></figure>
<p><strong>Springä¸­çš„å¼‚å¸¸å¤„ç†æ–¹å¼ï¼š</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//æœ€ä½³æ–¹å¼</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HandlerControllerAdvice</span></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">@ExceptionHandler</span>(AccessDeniedException<span class="class">.<span class="keyword">class</span>)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="class">    <span class="title">public</span> <span class="title">String</span> <span class="title">handlerException</span>() </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="string">"redirect:/403.jsp"</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">@ExceptionHandler</span>(RuntimeException<span class="class">.<span class="keyword">class</span>)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="class">    <span class="title">public</span> <span class="title">String</span> <span class="title">runtimeHandlerException</span>() </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> <span class="string">"forward:/500.jsp"</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//redirect:è®¿é—®çš„é“¾æ¥é‡å®šå‘åˆ°åé¢çš„403.jsp - è·Ÿè§†å›¾è§£æå™¨æœ‰å…³</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//forward:è®¿é—®çš„é“¾æ¥ä¿æŒä¸å˜ </span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¯é€‰æ–¹å¼</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HandlerControllerException</span> <span class="keyword">implements</span> <span class="title">HandlerExceptionResolver</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">/**</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     * <span class="doctag">@param</span> httpServletRequest</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     * <span class="doctag">@param</span> httpservletResponse</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     * <span class="doctag">@param</span> o å‡ºç°å¼‚å¸¸çš„å¯¹è±¡</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     * <span class="doctag">@param</span> e å‡ºç°çš„å¼‚å¸¸ä¿¡æ¯</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line"><span class="comment">     * <span class="doctag">@return</span> ModelAndView</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"><span class="comment">    **/</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">@Override</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> ModelAndView <span class="title">resolveException</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Object o, Exception e)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">        ModelAndView mv = <span class="keyword">new</span> ModelAndView();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">//å°†å¼‚å¸¸ä¿¡æ¯æ”¾å…¥requeståŸŸä¸­ï¼ŒåŸºæœ¬ä¸ç”¨</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">        mv.addObject(<span class="string">"errorMsg"</span>, e.getMessage());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">//æŒ‡å®šä¸åŒå¼‚å¸¸è·³è½¬çš„é¡µé¢</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span>(e <span class="keyword">instanceof</span> AccessDeniedException) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">            mv.setViewName(<span class="string">"forward:/403.jsp"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">        &#125;<span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">            mv.setViewName(<span class="string">"redirect:/500.jsp"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> mv;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//springæ§åˆ¶å™¨æœ€åè¿”å›ä¸€ä¸ªModelAndView(urlName),å…¶ä¸­urNamelå¯ä»¥æ˜¯ä¸€ä¸ªè§†å›¾åç§°,ç”±è§†å›¾è§£æå™¨è´Ÿè´£è§£æåå°†å“åº”æµå†™å›å®¢æˆ·ç«¯;ä¹Ÿå¯ä»¥é€šè¿‡redirect/forward:urlæ–¹å¼è½¬åˆ°å¦ä¸€ä¸ªæ§åˆ¶å™¨è¿›è¡Œå¤„ç†.</span></span></pre></td></tr></table></figure>
<h4 id="ä¸ƒã€SpringSecurityä¸Spring-Boot"><a href="#ä¸ƒã€SpringSecurityä¸Spring-Boot" class="headerlink" title="ä¸ƒã€SpringSecurityä¸Spring Boot"></a>ä¸ƒã€SpringSecurityä¸Spring Boot</h4><p>åœ¨Spring MVCä¸­æ·»åŠ Spring Securityéœ€è¦åœ¨é…ç½®æ–‡ä»¶web.xmlä¸­æ·»åŠ ç›¸åº”çš„è¿‡æ»¤å™¨ï¼Œè€Œåœ¨Spring Bootä¸­åˆ™åªéœ€è¦åœ¨pomä¸­å¯¼å…¥Spring Securityçš„ä¾èµ–jaråŒ…å³å¯ï¼Œä¾èµ–çš„ç‰ˆæœ¬ä¸éœ€è¦æŒ‡å®šï¼Œä¸parentçš„ç‰ˆæœ¬ç›¸åŒã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span></pre></td></tr></table></figure>
<p>SpringBootå®˜æ–¹æ˜¯ä¸æ¨èåœ¨SpringBootä¸­ä½¿ç”¨jspçš„ï¼Œä½†æ˜¯è¿˜æ˜¯å¯ä»¥ä½¿ç”¨çš„ã€‚ä¸è¿‡éœ€è¦å¯¼å…¥tomcatæ’ä»¶å¯åŠ¨é¡¹ç›®ï¼Œä¸èƒ½å†ç”¨SpringBooté»˜è®¤çš„tomcatäº†ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--å¯¼å…¥SpringBootçš„tomcatå¯åŠ¨æ’ä»¶jaråŒ…--&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.tomcat.embed<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>tomcat-embed-jasper<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span></pre></td></tr></table></figure>
<p><strong>å¦‚ä½•å¯¼å…¥é™æ€èµ„æºï¼Ÿ</strong></p>
<pre><code>    1. æ–°å»ºwebapp
    2. pomä¸­åŠ å…¥&lt;packaging&gt;war&lt;/packaging&gt;
    3. import
    4. å°†é™æ€èµ„æºæ‹·è´åˆ°webappä¸‹é¢
</code></pre><p>åœ¨SpringBootä¸­æ·»åŠ SpringSecurityçš„é…ç½®ç±»ï¼Œç›¸å½“äºä¹‹å‰çš„spring-security.xml</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableWebSecurity</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//ç»§æ‰¿äº†WebSecurityConfigurerAdapterè¿™ä¸ªç±»ä¹‹åï¼Œç›¸å½“äºæ‹¥æœ‰äº†Spring Securityçš„æ‰€æœ‰é»˜è®¤é…ç½®</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//è¦ä¿®æ”¹é‡Œé¢é‡Œé¢çš„é…ç½®ï¼Œå°±è¦é‡å†™é‡Œé¢çš„æ–¹æ³•</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//è®¤è¯ç”¨æˆ·çš„æ¥æº[å†…å­˜ï¼Œæ•°æ®åº“]</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        auth.inMemoryAuthencation()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">            .withUser(<span class="string">"user"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">            .password(<span class="string">"&#123;noop&#125;123"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">            .roles(<span class="string">"USER"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//é…ç½®SpringSecurityç›¸å…³ä¿¡æ¯</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">//é‡Šæ”¾é™æ€èµ„æºï¼ŒæŒ‡å®šè·¯å¾„/èµ„æºæ‹¦æˆªè§„åˆ™ï¼ŒæŒ‡å®šè‡ªå®šä¹‰è®¤è¯é¡µé¢ï¼ŒæŒ‡å®šé€€å‡ºè®¤è¯é…ç½®ï¼Œcsrfé…ç½®</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">        http.authorizeRequests()   <span class="comment">//é»˜è®¤ä¸”å¿…é¡»ä¸ºç¬¬ä¸€ä¸ª</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">            .andMatchers(<span class="string">"/login.jsp"</span>,<span class="string">"/failer.jsp"</span>,<span class="string">"/css/**"</span>,<span class="string">"/img/**"</span>,<span class="string">"/plugins/**"</span>).permitAll() <span class="comment">//æŒ‡å‡ºè¿™äº›èµ„æºä¸è¢«æ‹¦æˆª</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">			.andMatchers(<span class="string">"/**"</span>).hasAnyRole(<span class="string">"USER"</span>,<span class="string">"ADMIN"</span>) <span class="comment">//æŒ‡å®šè§’è‰²</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">            .anyRequest()  <span class="comment">//å…¶ä»–æ‰€æœ‰çš„èµ„æºåªæœ‰åœ¨è®¤è¯åæ‰èƒ½è¢«ä½¿ç”¨</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">            .authenticated()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">            .and()   <span class="comment">//è¡¨ç¤ºä¸€ä¸ªæ–°çš„é…ç½®çš„å¼€å§‹</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">            .formLogin()   <span class="comment">//æŒ‡å®šä»¥è¡¨å•çš„å½¢å¼ç™»é™†</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">            .loginPage(<span class="string">"/login.jsp"</span>)   <span class="comment">//ç™»é™†çš„ä¸€ä¸ªpage</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">            .loginProcessingUrl(<span class="string">"/login"</span>)   <span class="comment">//ç™»é™†çš„urlåœ°å€</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">            .successForwardUrl(<span class="string">"/index.jsp"</span>)  <span class="comment">//æˆåŠŸçš„è·³è½¬é¡µé¢</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">            .failureForwardUrl(<span class="string">"/failer.jsp"</span>) <span class="comment">//å¤±è´¥çš„è·³è½¬é¡µé¢</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">            .permitAll()  <span class="comment">//æ¸…ç©ºä¸Šé¢çš„é…ç½®</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">            .and()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">            .logout()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">            .logoutUrl(<span class="string">"/logout"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">            .logoutSuccessUrl(<span class="string">"/login.jsp"</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">            .invalidateHttpSession(<span class="keyword">true</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">            .permitAll()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">            .and()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">            .csrf()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">            .disable();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p><strong>ä»æ•°æ®åº“ä¸­åŠ è½½ç”¨æˆ·</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> UserService userService;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> BCryptPasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    auth.userDetailService(userService).passwordEncoder(passwordEncoder());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p><strong>åœ¨SpringSecurityé…ç½®ç±»ä¸­å¼€å¯æˆæƒ</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableGlobalMethodSecurity</span>(securedEnabled=<span class="keyword">true</span>)</span></pre></td></tr></table></figure>
<p><strong>è®¾ç½®å¼‚å¸¸æ‹¦æˆªå™¨</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@ControllerAdvice</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HandlerControllerException</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="meta">@ExceptionHandler</span>(RuntimeException.calss)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">handlerException</span><span class="params">(RuntimeException e)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span>(e <span class="keyword">instanceof</span> AccessDeniedException) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">return</span> <span class="string">"redirect:/403.jsp"</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        &#125;<span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">return</span> <span class="string">"redirect:/500.jsp"</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p><strong>åˆ†å¸ƒå¼è®¤è¯æ¦‚å¿µ</strong></p>
<p>åˆ†å¸ƒå¼è®¤è¯ï¼Œä¹Ÿå°±æ˜¯å•ç‚¹ç™»å½•ï¼Œç®€ç§°SSOã€‚æŒ‡åœ¨å¤šåº”ç”¨ç³»ç»Ÿçš„é¡¹ç›®ä¸­ï¼Œç”¨æˆ·åªéœ€è¦ç™»é™†ä¸€æ¬¡ï¼Œå°±å¯ä»¥è®¿é—®æ‰€æœ‰äº’ç›¸ä¿¡ä»»çš„åº”ç”¨ç³»ç»Ÿã€‚</p>
<p>é¦–å…ˆï¼Œåœ¨åˆ†å¸ƒå¼é¡¹ç›®ä¸­ï¼Œæ¯å°æœåŠ¡å™¨éƒ½æœ‰å„è‡ªç‹¬ç«‹çš„sessionï¼Œè€Œè¿™äº›sessionä¹‹é—´æ˜¯æ— æ³•ç›´æ¥å…±äº«èµ„æºçš„ï¼Œæ‰€ä»¥ï¼Œsessioné€šå¸¸ä¸èƒ½è¢«ä½œä¸ºå•ç‚¹ç™»å½•çš„æŠ€æœ¯æ–¹æ¡ˆã€‚</p>
<p><img src="/2021/06/27/Spring-Security-Plus/Users\aaa\Desktop\5.png" alt="img"></p>
<p><strong>å•ç‚¹ç™»å½•çš„ä¸¤å¤§ç¯èŠ‚</strong></p>
<ol>
<li>ç”¨æˆ·è®¤è¯ï¼šè¿™ä¸€ç¯èŠ‚ä¸»è¦æ˜¯ç”¨æˆ·å‘è®¤è¯æœåŠ¡å™¨å‘èµ·è®¤è¯è¯·æ±‚ï¼Œè®¤è¯æœåŠ¡å™¨ç»™ç”¨æˆ·è¿”å›ä¸€ä¸ªæˆåŠŸçš„ä»¤ç‰Œtokenï¼Œä¸»è¦åœ¨è®¤è¯æœåŠ¡å™¨Aä¸­å®Œæˆï¼ˆè®¤è¯æœåŠ¡å™¨åªèƒ½æœ‰ä¸€ä¸ªï¼‰ã€‚</li>
<li>èº«ä»½æ ¡éªŒï¼šè¿™ä¸€ç¯èŠ‚æ˜¯ç”¨æˆ·æºå¸¦tokenå»è®¿é—®å…¶ä»–æœåŠ¡å™¨æ—¶ï¼Œåœ¨å…¶ä»–æœåŠ¡å™¨ä¸­è¦å¯¹tokençš„çœŸä¼ªè¿›è¡Œæ£€éªŒï¼Œä¸»è¦åœ¨èµ„æºæœåŠ¡å™¨Bä¸­å®Œæˆï¼ˆèµ„æºæœåŠ¡å™¨Bå¯ä»¥æœ‰å¤šä¸ªï¼‰ã€‚</li>
</ol>
<p><strong>JWT(SON Web Token)ä»‹ç»</strong></p>
<p>jwtæ˜¯ä¸€æ¬¾å‡ºè‰²çš„åˆ†å¸ƒå¼èº«ä»½æ ¡éªŒæ–¹æ¡ˆï¼Œå¯ä»¥ç”Ÿæˆtokenï¼Œä¹Ÿå¯ä»¥è§£ææ£€éªŒtokenã€‚</p>
<p>JWTç”Ÿæˆçš„tokenç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼š</p>
<ul>
<li>å¤´éƒ¨ï¼šä¸»è¦è®¾ç½®ä¸€äº›è§„èŒƒä¿¡æ¯ï¼Œç­¾åéƒ¨åˆ†çš„ç¼–ç æ ¼å¼ã€‚</li>
<li>è½½è·ï¼štokenä¸­å­˜æ”¾æœ‰æ•ˆä¿¡æ¯çš„éƒ¨åˆ†ï¼Œæ¯”å¦‚ç”¨æˆ·åã€ç”¨æˆ·è§’è‰²ã€è¿‡æœŸæ—¶é—´ç­‰ã€‚ä½†ä¸è¦æ”¾å¯†ç ï¼Œä¸å®‰å…¨ã€‚</li>
<li>ç­¾åï¼šå°†å¤´éƒ¨ä¸è½½è·åˆ†åˆ«é‡‡ç”¨base64ç¼–ç åï¼Œç”¨â€.â€ç›¸è¿ï¼Œåœ¨åŠ å…¥ç›ï¼Œæœ€åä½¿ç”¨å¤´éƒ¨å£°æ˜çš„ç¼–ç ç±»å‹è¿›è¡Œç¼–ç ï¼Œå°±å¾—åˆ°äº†ç­¾åã€‚</li>
</ul>
<p><strong>éå¯¹ç§°åŠ å¯†RSAä»‹ç»</strong></p>
<p>åŒæ—¶ç”Ÿæˆä¸¤æŠŠç§˜é’¥ï¼šç§é’¥å’Œå…¬é’¥ï¼Œç§é’¥éšç§˜ä¿å­˜ï¼Œå…¬é’¥å¯ä»¥ä¸‹å‘ç»™ä¿¡ä»»å®¢æˆ·ç«¯ã€‚</p>
<ul>
<li>ç§é’¥åŠ å¯†</li>
<li>å…¬é’¥åŠ å¯†</li>
</ul>
<p><strong>åœ¨åˆ†å¸ƒå¼ç¯å¢ƒä¸‹SpringSecurityçš„ä½¿ç”¨ä¸SpringBootè¿˜ä¸ä¸€æ ·</strong>ï¼Œä¸€èˆ¬ä½¿ç”¨SpringSecurity+JWT+RSAåšåˆ†å¸ƒå¼è®¤è¯</p>
<p><strong>åœ¨é›†ä¸­å¼è®¤è¯æµç¨‹ä¸­ï¼š</strong></p>
<ul>
<li>ç”¨æˆ·è®¤è¯ï¼šä½¿ç”¨UsernamePasswordAuthenticationFilterè¿‡æ»¤å™¨ä¸­çš„attemptAuthenticationæ–¹æ³•å®ç°è®¤è¯åŠŸèƒ½ã€‚è¯¥è¿‡æ»¤å™¨çˆ¶ç±»ä¸­successfulAuthenticationæ–¹æ³•å®ç°è®¤è¯æˆåŠŸåçš„æ“ä½œã€‚</li>
<li>èº«ä»½æ ¡éªŒï¼šä½¿ç”¨BasicAuthenticationFilterè¿‡æ»¤å™¨ä¸­çš„doFilterInternalæ–¹æ³•éªŒè¯æ˜¯å¦ç™»é™†ï¼Œä»¥å†³å®šèƒ½å¦è¿›å…¥åç»­è¿‡æ»¤å™¨ã€‚</li>
</ul>
<p><strong>åˆ†å¸ƒå¼è®¤è¯æµç¨‹ï¼š</strong></p>
<ul>
<li>ç”¨æˆ·è®¤è¯ï¼šç”±äºåˆ†å¸ƒå¼é¡¹ç›®å¤šæ•°æ˜¯å‰åç«¯åˆ†ç¦»çš„æ¶æ„è®¾è®¡ï¼Œæ‰€ä»¥éœ€è¦æ»¡è¶³æ¥æ”¶å¼‚æ­¥postçš„è®¤è¯è¯·æ±‚å‚æ•°ï¼Œéœ€è¦ä¿®æ”¹UsernamePasswordAuthenticationFilterè¿‡æ»¤å™¨ä¸­attemptAuthenticationæ–¹æ³•ï¼Œè®©å…¶èƒ½å¤Ÿæ¥æ”¶è¯·æ±‚ä½“ã€‚å¦å¤–ï¼Œé»˜è®¤successfulAuthenticationæ–¹æ³•åœ¨è®¤è¯é€šè¿‡åï¼ŒæŠŠç”¨æˆ·ä¿¡æ¯ç›´æ¥æ”¾å…¥sessionä¸­ï¼Œç°åœ¨æ ¹æ®åˆ†å¸ƒå¼çš„æµç¨‹ï¼Œéœ€è¦å°†è®¤è¯é€šè¿‡åçš„tokenè¿”å›ç»™ç”¨æˆ·ã€‚</li>
<li>èº«ä»½æ ¡éªŒï¼šåŸæ¥BasicAuthenticationFilterè¿‡æ»¤å™¨ä¸­doFilterInternalæ–¹æ³•æ ¡éªŒç”¨æˆ·æ˜¯å¦ç™»é™†ï¼Œå°±æ˜¯çœ‹sessionä¸­æ˜¯å¦æœ‰ç”¨æˆ·ä¿¡æ¯ã€‚ç°åœ¨éœ€è¦ä¿®æ”¹ä¸ºéªŒè¯ç”¨æˆ·æºå¸¦çš„tokenæ˜¯å¦åˆæ³•ï¼Œå¹¶è§£æå‡ºç”¨æˆ·ä¿¡æ¯ï¼Œäº¤ç»™SpringSecurityä»¥ä¾¿äºåç»­çš„æˆæƒã€‚</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtLoginFilter</span> <span class="keyword">extends</span> <span class="title">UsernamePasswordAuthenticationFilter</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> AuthenticationManager authenticationManager;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> RsaKeyProperties prop;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JwtLoginFilter</span><span class="params">(AuthenticationManager authenticationManager, RsaKeyProperties prop)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">this</span>.authenticationManager = authenticationManager;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">this</span>.prop = prop;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> Authentication <span class="title">attemptAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">try</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">           SysUser sysUser = <span class="keyword">new</span> ObjectMapper().reader(request.getInputStream(), SysUser<span class="class">.<span class="keyword">class</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">            UsernamePasswordAuthenticationToken authRequest = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(sysUser.getUserName(), sysUser.getPassword());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">return</span> authenticationManager.authenticate(authRequest);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">try</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">                response.setContexType(<span class="string">"application/json;charset=utf-8"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">                response.sestStatus(HttpServletResponse.SC_UNAUTHORIZED);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">                PrintWriter out = response.getWriter();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">                Map resultMap = <span class="keyword">new</span> HashMap();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">                resultMap.put(<span class="string">"code"</span>, HttpServletResponse.SC_UNAUTHORIZED);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">                resultMap.put(<span class="string">"msg"</span>, <span class="string">"ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯ï¼"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">                out.write(<span class="keyword">new</span> ObjectMapper().writeValueAsString(resultMap));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">                out.flush();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">                out.close();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">            &#125;<span class="keyword">catch</span>(Exception e) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">            	outEx.printStackTrace();    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">            &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">successfuaAuthentication</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain, Authentication authResult)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">        SysUser user = <span class="keyword">new</span> SysUser();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">        user.setUsername(authResult.getName)();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">        user.setRoles(List&lt;SysRole&gt;) authResult.getAuthorities();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">        String token = JwtUtils.generateTokenExpireInMinutes(user, prop.getPrivateKey(), <span class="number">24</span>*<span class="number">60</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">        response.addHeader(<span class="string">"Authorization"</span>, <span class="string">"Bearer "</span>+token);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">try</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">            response.setContexType(<span class="string">"application/json;charset=utf-8"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">            response.sestStatus(HttpServletResponse.SC_OK);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">            PrintWriter out = response.getWriter();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">            Map resultMap = <span class="keyword">new</span> HashMap();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">            resultMap.put(<span class="string">"code"</span>, HttpServletResponse.SC_OK);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">            resultMap.put(<span class="string">"msg"</span>, <span class="string">"è®¤è¯é€šè¿‡ï¼"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">            out.write(<span class="keyword">new</span> ObjectMapper().writeValueAsString(resultMap));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">            out.flush();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">            out.close();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line">        &#125;<span class="keyword">catch</span>(Exception e) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">            outEx.printStackTrace();    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p><strong>é‡å†™æˆæƒçš„è¿‡æ»¤å™¨</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtVerifyFilter</span> <span class="keyword">extends</span> <span class="title">BasicAuthenticationFilter</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> RsaKeyProperties prop;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JwtVerifyFilter</span><span class="params">(AuthenticationManager authenticationManager, RsaKeyProperties prop)</span> </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">super</span>(authenticationManager);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">this</span>.prop = prop;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain chain)</span> throw IOException</span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        String header = request.getHeader(<span class="string">"Authorization"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">if</span>(header == <span class="keyword">null</span> || !header.startsWith(<span class="string">"Bearer "</span>)) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">            <span class="comment">//å¦‚æœæºå¸¦äº†é”™è¯¯çš„tokenï¼Œåˆ™ç»™ç”¨æˆ·æç¤ºè¯·ç™»å½•</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">            chain.doFilter(requet, response);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">            response.setContexType(<span class="string">"application/json;charset=utf-8"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">            response.sestStatus(HttpServletResponse.SC_FORBIDDEN);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">            PrintWriter out = response.getWriter();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">            Map resultMap = <span class="keyword">new</span> HashMap();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">            resultMap.put(<span class="string">"code"</span>, HttpServletResponse.SC_FORBIDDEN);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">            resultMap.put(<span class="string">"msg"</span>, <span class="string">"è¯·ç™»å½•ï¼"</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">            out.write(<span class="keyword">new</span> ObjectMapper().writeValueAsString(resultMap));</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">            out.flush();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">            out.close();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">        &#125;<span class="keyword">else</span> &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">            <span class="comment">//å¦‚æœæºå¸¦äº†æ­£ç¡®æ ¼å¼çš„tokenï¼Œè¦å…ˆå¾—åˆ°tokenè¿›è¡ŒéªŒè¯</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">            String token = header.replace(<span class="string">"Bearer"</span>, <span class="string">""</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">            Payload&lt;SysUser&gt; payload = JwtUtils.getInfoFormToken(token,prop.getPublicKey(), SysUser<span class="class">.<span class="keyword">class</span>)</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">            SysUser user = payload.getUserInfo();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">            <span class="keyword">if</span>(user != <span class="keyword">null</span>)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">                UsernamePasswordAuthenticationToken authResult = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(user.getUserName(),<span class="keyword">null</span>, user.getAuthorities());</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">                SecurityContextHolder.getContext().setAuthentication(authResult);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">                chain.doFilter(requet, response);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">            &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">            </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">        &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p><strong>æ”¹å†™SpringSecurityé…ç½®ç±»</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> RsaKeyProperties prop;    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="comment">//é…ç½®SpringSecurityç›¸å…³ä¿¡æ¯</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">//é‡Šæ”¾é™æ€èµ„æºï¼ŒæŒ‡å®šè·¯å¾„/èµ„æºæ‹¦æˆªè§„åˆ™ï¼ŒæŒ‡å®šè‡ªå®šä¹‰è®¤è¯é¡µé¢ï¼ŒæŒ‡å®šé€€å‡ºè®¤è¯é…ç½®ï¼Œcsrfé…ç½®</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    http.csrf()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        .disable()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">        .authorizeRequests()   <span class="comment">//é»˜è®¤ä¸”å¿…é¡»ä¸ºç¬¬ä¸€ä¸ª</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        .andMatchers(<span class="string">"/**"</span>).hasAnyRole(<span class="string">"USER"</span>,<span class="string">"ADMIN"</span>) <span class="comment">//æŒ‡å®šè§’è‰²</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        .anyRequest()  <span class="comment">//å…¶ä»–æ‰€æœ‰çš„èµ„æºåªæœ‰åœ¨è®¤è¯åæ‰èƒ½è¢«ä½¿ç”¨</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">        .authenticated()</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">        .and()   <span class="comment">//è¡¨ç¤ºä¸€ä¸ªæ–°çš„é…ç½®çš„å¼€å§‹</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">        .addFilter(<span class="keyword">new</span> JwtLoginFilter(<span class="keyword">super</span>.authenticationManager(), prop))   <span class="comment">//æ·»åŠ è®¤è¯è¿‡æ»¤å™¨</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">        .addFilter(<span class="keyword">new</span> JwtVerifyFilter(<span class="keyword">super</span>.authenticationManager(), prop))  <span class="comment">//æ·»åŠ æˆæƒè¿‡æ»¤å™¨</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">        .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS); <span class="comment">//ç¦ç”¨sessionç®¡ç†</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<p><a href="https://zhuanlan.zhihu.com/p/349962352" target="_blank" rel="noopener">Spring Security: å‚è€ƒ1</a></p>
<p><a href="https://www.bilibili.com/video/av370800402/?p=22&amp;spm_id_from=pageDriver" target="_blank" rel="noopener">Spring Security: å‚è€ƒ2</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/06/27/Spring-Mybatis-Label-SQL/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qiang Chen">
      <meta itemprop="description" content="è®°å½•æ˜¯å¿˜è®°çš„ç¬¬ä¸€åŠ©æ‰‹.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ç¼–è¾‘å°¼æ’‘">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/27/Spring-Mybatis-Label-SQL/" class="post-title-link" itemprop="url">Spring-Mybatis-Label-SQL</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-06-27 10:01:14 / ä¿®æ”¹æ—¶é—´ï¼š10:29:52" itemprop="dateCreated datePublished" datetime="2021-06-27T10:01:14+08:00">2021-06-27</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Cloud-Compute/" itemprop="url" rel="index">
                    <span itemprop="name">Cloud Compute</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="MybatisåŠ¨æ€SQL"><a href="#MybatisåŠ¨æ€SQL" class="headerlink" title="MybatisåŠ¨æ€SQL"></a>MybatisåŠ¨æ€SQL</h2><h4 id="ä¸€ã€åŠ¨æ€SQL"><a href="#ä¸€ã€åŠ¨æ€SQL" class="headerlink" title="ä¸€ã€åŠ¨æ€SQL"></a>ä¸€ã€åŠ¨æ€SQL</h4><p>åŠ¨æ€SQLæ˜¯åœ¨åº”ç”¨ç¨‹åºè¿è¡Œæ—¶è¢«ç¼–è¯‘å’Œæ‰§è¡Œçš„SQLï¼Œæ ¹æ®ç”¨æˆ·çš„è¾“å…¥é€‰æ‹©å¯¹åº”çš„æ•°æ®åº“ç­›é€‰æ¡ä»¶ã€‚å¯ä»¥æœ‰æ•ˆçš„å‡å°Mybatisä¸­æ˜ å°„æ–‡ä»¶xmlçš„å¤§å°ï¼Œä½¿SQLçš„å¢ã€åˆ ã€æ”¹ã€æŸ¥æ›´åŠ çµæ´»ã€‚</p>
<p>MybatisåŠ¨æ€SQLå€ŸåŠ©äºOGNLè¡¨è¾¾å¼å¯¹SQLè¿›è¡Œæ‹¼æ¥ã€‚OGNLç±»ä¼¼äºELï¼Œæ˜¯ç”¨å­˜å–å¯¹è±¡å±æ€§ï¼Œè°ƒç”¨å¯¹è±¡æ–¹æ³•çš„è¡¨è¾¾å¼è¯­è¨€ã€‚</p>
<h4 id="äºŒã€å¸¸ç”¨çš„OGNLè¡¨è¾¾å¼"><a href="#äºŒã€å¸¸ç”¨çš„OGNLè¡¨è¾¾å¼" class="headerlink" title="äºŒã€å¸¸ç”¨çš„OGNLè¡¨è¾¾å¼"></a>äºŒã€å¸¸ç”¨çš„OGNLè¡¨è¾¾å¼</h4><div class="table-container">
<table>
<thead>
<tr>
<th>å…³é”®ç¬¦å·ä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>or: æˆ–è€…(å¹¶é›†)ã€and: å’Œ(äº¤é›†)</td>
</tr>
<tr>
<td>eq(==)ã€neq(!=)ã€lt(&lt;)ã€lte(&lt;=)ã€gt(&gt;)ã€gte(&gt;=)</td>
</tr>
<tr>
<td>ç®—æœ¯è¿ç®—ï¼š+ã€-ã€*ã€/ã€%ç­‰</td>
</tr>
<tr>
<td>éã€å–å</td>
</tr>
<tr>
<td>è°ƒç”¨å¯¹è±¡æ–¹æ³•</td>
</tr>
<tr>
<td>å¯¹è±¡å±æ€§å€¼</td>
</tr>
</tbody>
</table>
</div>
<h4 id="ä¸‰ã€MybatisåŠ¨æ€SQLæ ‡ç­¾"><a href="#ä¸‰ã€MybatisåŠ¨æ€SQLæ ‡ç­¾" class="headerlink" title="ä¸‰ã€MybatisåŠ¨æ€SQLæ ‡ç­¾"></a>ä¸‰ã€MybatisåŠ¨æ€SQLæ ‡ç­¾</h4><h5 id="3-1-if"><a href="#3-1-if" class="headerlink" title="3.1 if"></a>3.1 if</h5><p>å•æ¡ä»¶åˆ†æ”¯æ ‡ç­¾<strong>if</strong>ï¼Œtestå±æ€§<strong>(å¿…å¡«)</strong></p>
<ul>
<li>å€¼ä¸ºç¬¦åˆOGNLè¦æ±‚çš„åˆ¤æ–­è¡¨è¾¾å¼ï¼Œç»“æœå¯ä»¥ä¸ºtrueæˆ–false</li>
<li>ç»“æœä¸ºtrueåˆ™æ‰§è¡Œæ ‡ç­¾ä½“å†…å®¹ï¼Œå¦åˆ™ä¸æ‰§è¡Œ</li>
<li>å¦å¤–æ‰€æœ‰é0å€¼éƒ½ä¸ºtrueï¼Œåªæœ‰0ä¸ºfalse</li>
</ul>
<p>ä¾‹å­ï¼š</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ONGLè¡¨è¾¾å¼ï¼Œé›†åˆéç©ºåˆ¤æ–­ --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span> = <span class="string">"list !=null and list.size() &gt; 0"</span> &gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">â€‹	<span class="comment">&lt;!-- æ‰§è¡Œå†…å®¹ --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ONGLè¡¨è¾¾å¼ï¼Œæ•°ç»„éç©ºåˆ¤æ–­ --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span> = <span class="string">"array !=null and array.length &gt; 0"</span> &gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">â€‹	<span class="comment">&lt;!-- æ‰§è¡Œå†…å®¹ --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ONGLè¡¨è¾¾å¼ï¼Œå­—æ®µnameéç©ºåˆ¤æ–­ --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span> = <span class="string">"name !=null and name != ''"</span> &gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">â€‹	<span class="comment">&lt;!-- æ‰§è¡Œå†…å®¹ --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></pre></td></tr></table></figure>
<h5 id="3-2-trim-where-set"><a href="#3-2-trim-where-set" class="headerlink" title="3.2 trim(where, set)"></a>3.2 trim(where, set)</h5><p>è¾…åŠ©å…ƒç´ ï¼Œä¸“é—¨ç”¨äºSQLæ‹¼æ¥å»æ‰å¤šä½™çš„andå’Œorç­‰ï¼Œtrimèƒ½å®ç°æ‰€æœ‰whereå’Œsetå®ç°çš„å†…å®¹ã€‚</p>
<p><strong>whereæ ‡ç­¾: </strong>åŒ…å«çš„å…ƒç´ ä¸­æœ‰è¿”å›å€¼ï¼Œåˆ™æ’å…¥ä¸€ä¸ªwhereï¼›å¦‚whereåçš„å­—ç¬¦ä¸²ä»¥ANDæˆ–ORå¼€å¤´ï¼Œåˆ™å°†ä»–ä»¬å‰”é™¤ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">where</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">&lt;!-- whereæ ‡ç­¾åŒ…å«çš„å†…å®¹ --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">where</span>&gt;</span></span></pre></td></tr></table></figure>
<p><strong>setæ ‡ç­¾ï¼š</strong>åŒ…å«çš„å…ƒç´ ä¸­æœ‰è¿”å›å€¼ï¼Œåˆ™æ’å…¥ä¸€ä¸ªsetï¼›å¦‚setåçš„å­—ç¬¦ä¸²ä»¥é€—å·ç»“å°¾ï¼Œåˆ™å°†è¯¥é€—å·å‰”é™¤ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">set</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">&lt;!-- setæ ‡ç­¾åŒ…å«çš„å†…å®¹ --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">set</span>&gt;</span></span></pre></td></tr></table></figure>
<p><strong>#{}ä¸ºå‚æ•°å ä½ç¬¦ â€œ ? â€œ,å³sqlé¢„ç¼–è¯‘ï¼›${}ä¸ºå­—ç¬¦ä¸²æ›¿æ¢ï¼Œå³sqlæ‹¼æ¥ï¼Œeg:â€™%${bname}%â€™</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- æ–¹æ³•ä¸€ï¼Œtrimæ¯”whereé«˜ä¸€å±‚ï¼Œéœ€è¦æŒ‡å®šå‰ç¼€å’Œè¦†ç›–çš„é‡ --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ä½¿ç”¨if+trimæ ‡ç­¾å®ç°å¤šæ¡ä»¶æŸ¥è¯¢ --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectById"</span> <span class="attr">parameterType</span>=<span class="string">"Book"</span> <span class="attr">resultType</span>=<span class="string">"Book"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">select * from book</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">trim</span> <span class="attr">prefix</span>=<span class="string">"where"</span> <span class="attr">prefixOverrides</span>=<span class="string">"and|or"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"bname!=null"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">        and bname like '%$&#123;bname&#125;%'</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"bAuthor!=null"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">        and bAuthor like '%$&#123;bAuthor&#125;%'</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"bPublisher!=null"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">        and bPublisher like '%$&#123;bPublisher&#125;%'</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">trim</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- æ–¹æ³•äºŒï¼Œ ä½¿ç”¨whereï¼Œå¦‚æœæœ‰andçš„è¯ä¼šç›´æ¥å¿½ç•¥ç¬¬ä¸€ä¸ªandæˆ–or --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectById"</span> <span class="attr">parameterType</span>=<span class="string">"Book"</span> <span class="attr">resultType</span>=<span class="string">"Book"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">select * from book</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">where</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"bname!=null"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">        and bname like '%$&#123;bname&#125;%'</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"bAuthor!=null"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">        and bAuthor like '%$&#123;bAuthor&#125;%'</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"bPublisher!=null"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">        and bPublisher like '%$&#123;bPublisher&#125;%'</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">where</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- setæœ‰ç»“æœåˆ™æ’å…¥set,ä¸”åˆ æ‰æœ€åä¸€ä¸ªé€—å· --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">update</span> <span class="attr">id</span>=<span class="string">"updateBookById"</span> <span class="attr">parameterType</span>=<span class="string">"Book"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">set</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"bname!=null and bname!=''"</span>&gt;</span>bname=#&#123;bname&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"bAuthor!=null and bAuthor!=''"</span>&gt;</span>bAuthor=#&#123;bAuthor&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"bPublisher!=null and bPublisher!=''"</span>&gt;</span>bPublisher=#&#123;bPublisher&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"bPrice!=null and bPrice!=''"</span>&gt;</span>bPrice=#&#123;bPrice&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"bPubdate!=null and bPubdate!=''"</span>&gt;</span>bPubdate=#&#123;bPubdate&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">if</span> <span class="attr">test</span>=<span class="string">"bDetail!=null and bDetail!=''"</span>&gt;</span>bDetail=#&#123;bDetail&#125;,<span class="tag">&lt;/<span class="name">if</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">    where bid=#&#123;bid&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">update</span>&gt;</span></span></pre></td></tr></table></figure>
<h5 id="3-3-choose-when-otherwise"><a href="#3-3-choose-when-otherwise" class="headerlink" title="3.3 choose(when, otherwise)"></a>3.3 choose(when, otherwise)</h5><p>å¤šæ¡ä»¶åˆ†æ”¯æ ‡ç­¾ï¼Œç±»ä¼¼JSTLçš„chooseå’ŒJavaä¸­çš„switchï¼Œç”¨äºä»å¤šä¸ªåˆ†æ”¯ä¸­é€‰æ‹©å…¶ä¸€é¡¹ã€‚</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">choose</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">when</span> <span class="attr">test</span>=<span class="string">"title!=null"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">&lt;!-- æ‰§è¡Œæ¡ä»¶1å†…å®¹ --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;/<span class="name">when</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">when</span> <span class="attr">test</span>=<span class="string">"author!=null"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">&lt;!-- æ‰§è¡Œæ¡ä»¶2å†…å®¹ --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;/<span class="name">when</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">otherwise</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">        <span class="comment">&lt;!-- ä¸Šè¿°æ¡ä»¶éƒ½ä¸æ»¡è¶³çš„æ‰§è¡Œå†…å®¹ --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;/<span class="name">otherwise</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">choose</span>&gt;</span></span></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectByIdAndName"</span> <span class="attr">resultType</span>=<span class="string">"Book"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    SELECT * FROM book WHERE 1=1</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">choose</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">when</span> <span class="attr">test</span>=<span class="string">"bId!=null and bId&gt;0"</span>&gt;</span> and bid=#&#123;bId&#125;<span class="tag">&lt;/<span class="name">when</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">when</span> <span class="attr">test</span>=<span class="string">"bName!=null and bName!=''"</span>&gt;</span> and bName=#&#123;bName&#125;<span class="tag">&lt;/<span class="name">when</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">        <span class="tag">&lt;<span class="name">otherwise</span>&gt;</span>and 1=2<span class="tag">&lt;/<span class="name">otherwise</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;/<span class="name">choose</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span></pre></td></tr></table></figure>
<h5 id="3-4-foreach"><a href="#3-4-foreach" class="headerlink" title="3.4 foreach"></a>3.4 foreach</h5><p>é€šå¸¸ç”¨äºæ„å»ºINæ¡ä»¶è¯­å¥</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line">SELECT * FROM BOOK WHERE BID IN(1,3,5);</span></pre></td></tr></table></figure>
<div class="table-container">
<table>
<thead>
<tr>
<th>å±æ€§å</th>
<th>ä½œç”¨</th>
</tr>
</thead>
<tbody>
<tr>
<td>collection</td>
<td>å¿…å¡«ï¼Œå€¼ä¸ºè¦è¿­ä»£å¾ªç¯çš„å±æ€§å</td>
</tr>
<tr>
<td>item</td>
<td>å˜é‡åï¼Œå€¼ä¸ºä»è¿­ä»£å¯¹è±¡ä¸­å–å‡ºçš„æ¯ä¸ªå€¼</td>
</tr>
<tr>
<td>index</td>
<td>ç´¢å¼•çš„å±æ€§åï¼Œé›†åˆã€æ•°ç»„æƒ…å†µä¸‹å€¼ä¸ºå½“å‰ç´¢å¼•å€¼ï¼Œè¿­ä»£å¯¹è±¡æ˜¯Mapæ—¶ï¼Œå€¼ä¸ºMapçš„key</td>
</tr>
<tr>
<td>open</td>
<td>æ•´ä¸ªå¾ªç¯å†…å®¹å¼€å¤´çš„å­—ç¬¦ä¸²</td>
</tr>
<tr>
<td>seperator</td>
<td>æ¯æ¬¡å¾ªç¯çš„åˆ†éš”ç¬¦</td>
</tr>
<tr>
<td>close</td>
<td>æ•´ä¸ªå¾ªç¯å†…å®¹ç»“å°¾çš„å­—ç¬¦ä¸²</td>
</tr>
</tbody>
</table>
</div>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">foreach</span> <span class="attr">item</span>=<span class="string">"item"</span> <span class="attr">index</span>=<span class="string">"index"</span> <span class="attr">collection</span>=<span class="string">"list"</span> <span class="attr">open</span>=<span class="string">"("</span> <span class="attr">separator</span>=<span class="string">","</span> <span class="attr">close</span>=<span class="string">")"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">	<span class="comment">&lt;!-- å¾ªç¯ä½“ï¼Œä¾‹å¦‚ï¼š#&#123;item&#125; --&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"deleteBookBatch"</span> <span class="attr">parameterType</span>=<span class="string">list</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line">    DELETE FROM book WHERE bId In</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">"list"</span> <span class="attr">index</span>=<span class="string">"index"</span> <span class="attr">item</span>=<span class="string">"item"</span> <span class="attr">open</span>=<span class="string">"("</span> <span class="attr">seperator</span>=<span class="string">","</span><span class="attr">close</span>=<span class="string">")"</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">        #&#123;item&#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">    <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span></pre></td></tr></table></figure>
<h4 id="å››ã€ä¸ç›¸å…³æ‰©å±•"><a href="#å››ã€ä¸ç›¸å…³æ‰©å±•" class="headerlink" title="å››ã€ä¸ç›¸å…³æ‰©å±•"></a>å››ã€ä¸ç›¸å…³æ‰©å±•</h4><p><strong>å¦‚ä½•ç”¨postmanè·³è¿‡cookieå’Œé‰´æƒ</strong></p>
<p>1ã€Googleæµè§ˆå™¨ç™»é™†ï¼ŒF12-&gt;æ‰¾ä¸€ä¸ªè¯·æ±‚ï¼ŒæŸ¥çœ‹Request Headers-&gt;æŸ¥çœ‹x-auth-headerï¼›å°†x-auth-headerè¿™ä¸ªkeyå’Œå¯¹åº”çš„valueæ·»åŠ åœ¨postmançš„Headerä¸­ã€‚</p>
<p>2ã€postman-&gt;Authorization-&gt;TYPE-&gt;Basic Authï¼›è¾“å…¥ç”¨æˆ·åå’Œå¯†ç å³å¯ã€‚å…¶ä¸­TYPEä¸­æœ‰è®¸å¤šä¸­ä¸åŒç±»å‹çš„é‰´æƒæ–¹å¼ï¼Œå¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚è¿›è¡Œé€‰æ‹©</p>
<p><img src="/2021/06/27/Spring-Mybatis-Label-SQL/Users\aaa\Desktop\1.png" alt="Mybatis-SQL"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2021/06/20/Image-Process-Three/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qiang Chen">
      <meta itemprop="description" content="è®°å½•æ˜¯å¿˜è®°çš„ç¬¬ä¸€åŠ©æ‰‹.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ç¼–è¾‘å°¼æ’‘">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2021/06/20/Image-Process-Three/" class="post-title-link" itemprop="url">Image-Process-Three</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">å‘è¡¨äº</span>
              

              <time title="åˆ›å»ºæ—¶é—´ï¼š2021-06-20 23:06:01 / ä¿®æ”¹æ—¶é—´ï¼š23:06:38" itemprop="dateCreated datePublished" datetime="2021-06-20T23:06:01+08:00">2021-06-20</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">åˆ†ç±»äº</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Image-Processing/" itemprop="url" rel="index">
                    <span itemprop="name">Image Processing</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="å›¾åƒå¤„ç†å­¦ä¹ "><a href="#å›¾åƒå¤„ç†å­¦ä¹ " class="headerlink" title="å›¾åƒå¤„ç†å­¦ä¹ "></a>å›¾åƒå¤„ç†å­¦ä¹ </h2><h5 id="å‡ ä½•å˜æ¢ï¼šæ”¹è¿›å›¾åƒä¸­åƒç´ é—´çš„ç©ºé—´å…³ç³»ã€‚åœ¨æ•°å­—å›¾åƒå¤„ç†ä¸­ï¼Œå‡ ä½•å˜æ¢ç”±ä¸¤ä¸ªåŸºæœ¬æ“ä½œç»„æˆï¼š-1-åæ ‡çš„ç©ºé—´å˜æ¢ï¼›-2-å›¾åƒå†…æ’ï¼Œå³å¯¹ç©ºé—´å˜æ¢åçš„åƒç´ èµ‹ç°åº¦å€¼ã€‚"><a href="#å‡ ä½•å˜æ¢ï¼šæ”¹è¿›å›¾åƒä¸­åƒç´ é—´çš„ç©ºé—´å…³ç³»ã€‚åœ¨æ•°å­—å›¾åƒå¤„ç†ä¸­ï¼Œå‡ ä½•å˜æ¢ç”±ä¸¤ä¸ªåŸºæœ¬æ“ä½œç»„æˆï¼š-1-åæ ‡çš„ç©ºé—´å˜æ¢ï¼›-2-å›¾åƒå†…æ’ï¼Œå³å¯¹ç©ºé—´å˜æ¢åçš„åƒç´ èµ‹ç°åº¦å€¼ã€‚" class="headerlink" title="å‡ ä½•å˜æ¢ï¼šæ”¹è¿›å›¾åƒä¸­åƒç´ é—´çš„ç©ºé—´å…³ç³»ã€‚åœ¨æ•°å­—å›¾åƒå¤„ç†ä¸­ï¼Œå‡ ä½•å˜æ¢ç”±ä¸¤ä¸ªåŸºæœ¬æ“ä½œç»„æˆï¼š(1)åæ ‡çš„ç©ºé—´å˜æ¢ï¼›(2)å›¾åƒå†…æ’ï¼Œå³å¯¹ç©ºé—´å˜æ¢åçš„åƒç´ èµ‹ç°åº¦å€¼ã€‚"></a>å‡ ä½•å˜æ¢ï¼šæ”¹è¿›å›¾åƒä¸­åƒç´ é—´çš„ç©ºé—´å…³ç³»ã€‚åœ¨æ•°å­—å›¾åƒå¤„ç†ä¸­ï¼Œå‡ ä½•å˜æ¢ç”±ä¸¤ä¸ªåŸºæœ¬æ“ä½œç»„æˆï¼š(1)åæ ‡çš„ç©ºé—´å˜æ¢ï¼›(2)å›¾åƒå†…æ’ï¼Œå³å¯¹ç©ºé—´å˜æ¢åçš„åƒç´ èµ‹ç°åº¦å€¼ã€‚</h5><h3 id="ä»¿å°„å˜æ¢ï¼ˆAffine-Transformationsï¼‰"><a href="#ä»¿å°„å˜æ¢ï¼ˆAffine-Transformationsï¼‰" class="headerlink" title="ä»¿å°„å˜æ¢ï¼ˆAffine Transformationsï¼‰"></a>ä»¿å°„å˜æ¢ï¼ˆAffine Transformationsï¼‰</h3><p>åæ ‡å˜æ¢çš„è¡¨ç¤ºï¼š</p>
<script type="math/tex; mode=display">
(x,y)=T\{(v,w)\}</script><p>å…¶ä¸­ï¼Œ(v, w)æ˜¯åŸå›¾åƒä¸­åƒç´ çš„åæ ‡ï¼Œ(x, y)æ˜¯å˜æ¢åå›¾åƒä¸­åƒç´ çš„åæ ‡ã€‚ä»¿å°„å˜æ¢æ˜¯æœ€å¸¸ç”¨çš„ç©ºé—´åæ ‡å˜æ¢ä¹‹ä¸€ã€‚å…¶ä¸€èˆ¬å½¢å¼å¦‚ä¸‹ï¼š</p>
<script type="math/tex; mode=display">
[x\quad y\quad 1]=[v\quad w\quad 1]T=[v\quad w\quad 1]\cdot\begin{bmatrix}t_{11} & t_{12} & 0 \\ t_{12} & t_{22} & 0 \\
t_{31} & t_{32} & 1
\end{bmatrix}</script><p>åœ¨ç”¨ä»¿å°„å˜æ¢æ±‚å˜æ¢ååæ ‡å¯¹åº”çš„ç°åº¦å€¼çš„æ—¶å€™ï¼Œæœ‰ä¸¤ç§åŸºæœ¬çš„æ–¹æ³•ã€‚ç¬¬ä¸€ç§æ–¹æ³•ç§°ä¸º<strong>å‰å‘æ˜ å°„</strong>ã€‚å®ƒç”±æ‰«æè¾“å…¥å›¾åƒçš„åƒç´ åœ¨æ¯ä¸ªä½ç½®(v ,w)å¤„è®¡ç®—è¾“å‡ºå›¾åƒä¸­ç›¸åº”åƒç´ çš„ç©ºé—´ä½ç½®(x, y)ç»„æˆã€‚ä½†æœ‰ä¸€ä¸ªé—®é¢˜æ˜¯è¾“å…¥å›¾åƒä¸­çš„ä¸¤ä¸ªæˆ–æ›´å¤šä¸ªåƒç´ å¯è¢«å˜æ¢åˆ°è¾“å‡ºå›¾åƒä¸­çš„åŒä¸€ä½ç½®ã€‚ç¬¬äºŒç§æ–¹æ³•ç§°ä¸º<strong>åå‘æ˜ å°„</strong>ï¼Œæ‰«æè¾“å‡ºå›¾åƒä¸­åƒç´ çš„ä½ç½®ï¼Œå¹¶åœ¨æ¯ä¸€ä¸ªä½ç½®(x, y)ä½¿ç”¨(v, w)=T<sup>-1</sup>(x, y)è®¡ç®—è¾“å…¥å›¾åƒä¸­çš„ç›¸åº”ä½ç½®ã€‚ç„¶åä½¿ç”¨å›¾åƒå†…æ’è·å¾—è¾“å‡ºå›¾åƒåƒç´ çš„ç°åº¦å€¼ã€‚</p>
<p>ä»¿å°„å˜æ¢é€†å˜æ¢å¦‚ä¸‹ï¼š</p>
<script type="math/tex; mode=display">
\begin{pmatrix} x\\ y\\ \end{pmatrix}=\frac{1}{a\cdot d-b\cdot c} \begin{pmatrix} d & -b\\ -c & a\\ \end{pmatrix}\cdot \begin{pmatrix} x'\\ y'\\ \end{pmatrix}-\begin{pmatrix}t_x \\ t_y\end{pmatrix}</script><h4 id="ä¸€ã€å¹³è¡Œç§»åŠ¨"><a href="#ä¸€ã€å¹³è¡Œç§»åŠ¨" class="headerlink" title="ä¸€ã€å¹³è¡Œç§»åŠ¨"></a>ä¸€ã€å¹³è¡Œç§»åŠ¨</h4><script type="math/tex; mode=display">
\begin{pmatrix} x'\\ y'\\ 1\\ \end{pmatrix}=\begin{pmatrix} 1 & 0 & t_x\\ 0 & 1 & t_y\\ 0 & 0 & 1\\ \end{pmatrix}\cdot \begin{pmatrix} x\\ y\\ 1\\ \end{pmatrix}</script><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># Affine</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">affine</span><span class="params">(_img, a=<span class="number">1</span>, b=<span class="number">0</span>, c=<span class="number">0</span>, d=<span class="number">1</span>, tx=<span class="number">30</span>, ty=<span class="number">-30</span>)</span>:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  	H, W, C = _img.shape</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># temporary image</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">	img = np.zeros((H+<span class="number">2</span>, W+<span class="number">2</span>, C), dtype=np.float32)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">	img[<span class="number">1</span>:H+<span class="number">1</span>, <span class="number">1</span>:W+<span class="number">1</span>] = _img</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># get new image shape</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">	H_new = np.round(H * d).astype(np.int)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">	W_new = np.round(W * a).astype(np.int)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">	out = np.zeros((H_new+<span class="number">1</span>, W_new+<span class="number">1</span>, C), dtype=np.float32)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># get position of new image</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">	x_new = np.tile(np.arange(W_new), (H_new, <span class="number">1</span>))</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">	y_new = np.arange(H_new).repeat(W_new).reshape(H_new, <span class="number">-1</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># get position of original image by affine</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">	adbc = a * d - b * c</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">	x = np.round((d * x_new  - b * y_new) / adbc).astype(np.int) - tx + <span class="number">1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">	y = np.round((-c * x_new + a * y_new) / adbc).astype(np.int) - ty + <span class="number">1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">#Xå’ŒYé€ä½è¿›è¡Œæ¯”è¾ƒ,é€‰æ‹©æœ€å°å€¼.æœ€å°‘æ¥å—ä¸¤ä¸ªå‚æ•°</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">#&gt;&gt; np.maximum([-3, -2, 0, 1, 2], 0); è¾“å‡ºarray([0, 0, 0, 1, 2])</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">	x = np.minimum(np.maximum(x, <span class="number">0</span>), W+<span class="number">1</span>).astype(np.int)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">	y = np.minimum(np.maximum(y, <span class="number">0</span>), H+<span class="number">1</span>).astype(np.int)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># assgin pixcel to new image</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">	out[y_new, x_new] = img[y, x]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">	out = out[:H_new, :W_new]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">	out = out.astype(np.uint8)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">return</span> out</span></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// affine</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function">cv::Mat <span class="title">affine</span><span class="params">(cv::Mat img, <span class="keyword">double</span> a, <span class="keyword">double</span> b, <span class="keyword">double</span> c, <span class="keyword">double</span> d, <span class="keyword">double</span> tx, <span class="keyword">double</span> ty)</span></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// get height and width</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> <span class="built_in">width</span> = img.cols;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> <span class="built_in">height</span> = img.rows;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> channel = img.channels();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// get detriment</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> det = a * d - b * c;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Resize width and height</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> resized_width = (<span class="keyword">int</span>)(<span class="built_in">width</span> * a);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> resized_height = (<span class="keyword">int</span>)(<span class="built_in">height</span> * d);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// other parameters</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> x_before, y_before;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> dx, dy, wx, wy, w_sum;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> val;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> _x, _y;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// output</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">  cv::Mat out = cv::Mat::zeros(resized_height, resized_width, CV_8UC3);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Affine transformation</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; resized_height; y++)&#123;    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; resized_width; x++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">// get original position x</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">      x_before = (<span class="keyword">int</span>)((d * x - b * y) / det - tx);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> ((x_before &lt; <span class="number">0</span>) || (x_before &gt;= <span class="built_in">width</span>))&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">continue</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">// get original position y</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">      y_before = (<span class="keyword">int</span>)((-c * x + a * y) / det - ty);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> ((y_before &lt; <span class="number">0</span>) || (y_before &gt;= <span class="built_in">height</span>))&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">continue</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">// assign pixel to new position</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> c = <span class="number">0</span>; c &lt; channel; c++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">        out.at&lt;cv::Vec3b&gt;(y, x)[c] = img.at&lt;cv::Vec3b&gt;(y_before, x_before)[c];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> out;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<h4 id="äºŒã€æ”¾å¤§ç¼©å°"><a href="#äºŒã€æ”¾å¤§ç¼©å°" class="headerlink" title="äºŒã€æ”¾å¤§ç¼©å°"></a>äºŒã€æ”¾å¤§ç¼©å°</h4><script type="math/tex; mode=display">
\begin{pmatrix} x'\\ y'\\ 1\\ \end{pmatrix}=\begin{pmatrix} c_x & 0 & t_x\\ 0 & c_y & t_y\\ 0 & 0 & 1\\ \end{pmatrix}\cdot \begin{pmatrix} x\\ y\\ 1\\ \end{pmatrix}</script><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># Affine</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">affine</span><span class="params">(_img, a=<span class="number">1.3</span>, b=<span class="number">0</span>, c=<span class="number">0</span>, d=<span class="number">0.8</span>, tx=<span class="number">30</span>, ty=<span class="number">-30</span>)</span>:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  	H, W, C = _img.shape</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># temporary image</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">	img = np.zeros((H+<span class="number">2</span>, W+<span class="number">2</span>, C), dtype=np.float32)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">	img[<span class="number">1</span>:H+<span class="number">1</span>, <span class="number">1</span>:W+<span class="number">1</span>] = _img</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># get new image shape</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">	H_new = np.round(H * d).astype(np.int)  <span class="comment">#d-&gt;cy-&gt;h(å®½)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">	W_new = np.round(W * a).astype(np.int)  <span class="comment">#a-&gt;cx-&gt;w(é«˜)</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">#è¿™é‡Œçš„+1æ˜¯ä¸ºäº†é˜²æ­¢å½“a,dçš„å°æ•°éƒ¨åˆ†å°äº0.5æ•°ç»„æº¢å‡º</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">	out = np.zeros((H_new+<span class="number">1</span>, W_new+<span class="number">1</span>, C), dtype=np.float32)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># get position of new image</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">	x_new = np.tile(np.arange(W_new), (H_new, <span class="number">1</span>))</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">	y_new = np.arange(H_new).repeat(W_new).reshape(H_new, <span class="number">-1</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># get position of original image by affine</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">	adbc = a * d - b * c</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">	x = np.round((d * x_new  - b * y_new) / adbc).astype(np.int) - tx + <span class="number">1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">	y = np.round((-c * x_new + a * y_new) / adbc).astype(np.int) - ty + <span class="number">1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">#å°†åæ ‡é™åˆ¶åœ¨åˆé€‚èŒƒå›´å†…</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">	x = np.minimum(np.maximum(x, <span class="number">0</span>), W+<span class="number">1</span>).astype(np.int)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">	y = np.minimum(np.maximum(y, <span class="number">0</span>), H+<span class="number">1</span>).astype(np.int)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># assgin pixcel to new imageï¼Œå› ä¸ºä¸ºimg[h,w]æ‰€ä»¥ä¸ºy,x</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">	out[y_new, x_new] = img[y, x]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">	out = out[:H_new, :W_new]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">	out = out.astype(np.uint8)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">return</span> out</span></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// affine</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function">cv::Mat <span class="title">affine</span><span class="params">(cv::Mat img, <span class="keyword">double</span> a, <span class="keyword">double</span> b, <span class="keyword">double</span> c, <span class="keyword">double</span> d, <span class="keyword">double</span> tx, <span class="keyword">double</span> ty)</span></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// get height and width</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> <span class="built_in">width</span> = img.cols;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> <span class="built_in">height</span> = img.rows;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> channel = img.channels();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// get detriment</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> det = a * d - b * c;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Resize width and height</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> resized_width = (<span class="keyword">int</span>)(<span class="built_in">width</span> * a);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> resized_height = (<span class="keyword">int</span>)(<span class="built_in">height</span> * d);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// other parameters</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> x_before, y_before;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> dx, dy, wx, wy, w_sum;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> val;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> _x, _y;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// output</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">  cv::Mat out = cv::Mat::zeros(resized_height, resized_width, CV_8UC3);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Affine transformation</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; resized_height; y++)&#123;    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; resized_width; x++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">// get original position x</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">      x_before = (<span class="keyword">int</span>)((d * x - b * y) / det - tx);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> ((x_before &lt; <span class="number">0</span>) || (x_before &gt;= <span class="built_in">width</span>))&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">continue</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">// get original position y</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">      y_before = (<span class="keyword">int</span>)((-c * x + a * y) / det - ty);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> ((y_before &lt; <span class="number">0</span>) || (y_before &gt;= <span class="built_in">height</span>))&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">continue</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">// assign pixel to new position</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> c = <span class="number">0</span>; c &lt; channel; c++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">        out.at&lt;cv::Vec3b&gt;(y, x)[c] = img.at&lt;cv::Vec3b&gt;(y_before, x_before)[c];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> out;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<h4 id="ä¸‰ã€æ—‹è½¬"><a href="#ä¸‰ã€æ—‹è½¬" class="headerlink" title="ä¸‰ã€æ—‹è½¬"></a>ä¸‰ã€æ—‹è½¬</h4><p>ä¸‹é¢çš„å¼å­è¿›è¡Œé€†æ—¶é’ˆæ–¹å‘æ—‹è½¬ åº¦çš„ä»¿å°„å˜æ¢ï¼š</p>
<script type="math/tex; mode=display">
\begin{pmatrix} x'\\ y'\\ 1\\ \end{pmatrix}=\begin{pmatrix} cos(A) & -sin(A) & t_x\\ sin(A) & cos(A) & t_y\\ 0 & 0 & 1\\ \end{pmatrix}\cdot \begin{pmatrix} x\\ y\\ 1\\ \end{pmatrix}</script><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># affine</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">affine</span><span class="params">(_img, a, b, c, d, tx, ty)</span>:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">	H, W, C = _img.shape</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># temporary image</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">	img = np.zeros((H+<span class="number">2</span>, W+<span class="number">2</span>, C), dtype=np.float32)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">	img[<span class="number">1</span>:H+<span class="number">1</span>, <span class="number">1</span>:W+<span class="number">1</span>] = _img</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># get shape of new image</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">	H_new = np.round(H).astype(np.int)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">	W_new = np.round(W).astype(np.int)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">	out = np.zeros((H_new, W_new, C), dtype=np.float32)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># get position of new image</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">	x_new = np.tile(np.arange(W_new), (H_new, <span class="number">1</span>))</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">	y_new = np.arange(H_new).repeat(W_new).reshape(H_new, <span class="number">-1</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># get position of original image by affine</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">	adbc = a * d - b * c</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">	x = np.round((d * x_new  - b * y_new) / adbc).astype(np.int) - tx + <span class="number">1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">	y = np.round((-c * x_new + a * y_new) / adbc).astype(np.int) - ty + <span class="number">1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># adjust center by affine</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">	dcx = (x.max() + x.min()) // <span class="number">2</span> - W // <span class="number">2</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">	dcy = (y.max() + y.min()) // <span class="number">2</span> - H // <span class="number">2</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">	x -= dcx</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">	y -= dcy</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">	x = np.clip(x, <span class="number">0</span>, W + <span class="number">1</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">	y = np.clip(y, <span class="number">0</span>, H + <span class="number">1</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">	<span class="comment"># assign pixcel</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">	out[y_new, x_new] = img[y, x]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">	out = out.astype(np.uint8)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">	<span class="keyword">return</span> out</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># Read image</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">_img = cv2.imread(<span class="string">"imori.jpg"</span>).astype(np.float32)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># Affine</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">A = <span class="number">30.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">theta = - np.pi * A / <span class="number">180.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">out = affine(img, a=np.cos(theta), b=-np.sin(theta), c=np.sin(theta), d=np.cos(theta),</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line"> tx=<span class="number">0</span>, ty=<span class="number">0</span>)</span></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// affine</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function">cv::Mat <span class="title">affine</span><span class="params">(cv::Mat img, <span class="keyword">double</span> a, <span class="keyword">double</span> b, <span class="keyword">double</span> c, <span class="keyword">double</span> d, <span class="keyword">double</span> tx, <span class="keyword">double</span> ty, <span class="keyword">double</span> theta)</span></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// get height and width</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> <span class="built_in">width</span> = img.cols;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> <span class="built_in">height</span> = img.rows;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> channel = img.channels();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// get detriment</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> det = a * d - b * c;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> (theta != <span class="number">0</span>)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// Affine parameters</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">double</span> rad = theta / <span class="number">180.</span> * M_PI;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    a = <span class="built_in">std</span>::<span class="built_in">cos</span>(rad);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    b = - <span class="built_in">std</span>::<span class="built_in">sin</span>(rad);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">    c = <span class="built_in">std</span>::<span class="built_in">sin</span>(rad);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    d = <span class="built_in">std</span>::<span class="built_in">cos</span>(rad);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    tx = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    ty = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">double</span> det = a * d - b * c;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// center transition</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">double</span> cx = <span class="built_in">width</span> / <span class="number">2.</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">double</span> cy = <span class="built_in">height</span> / <span class="number">2.</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">double</span> new_cx = (d * cx - b * cy) / det;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">double</span> new_cy = (- c * cx + a * cy) / det;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">    tx = new_cx - cx;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">    ty = new_cy - cy;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Resize width and height</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> resized_width = (<span class="keyword">int</span>)(<span class="built_in">width</span> * a);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> resized_height = (<span class="keyword">int</span>)(<span class="built_in">height</span> * d);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> (theta != <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">    resized_width = (<span class="keyword">int</span>)(<span class="built_in">width</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">    resized_height = (<span class="keyword">int</span>)(<span class="built_in">height</span>);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// other parameters</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> x_before, y_before;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> dx, dy, wx, wy, w_sum;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> val;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> _x, _y;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// output</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">  cv::Mat out = cv::Mat::zeros(resized_height, resized_width, CV_8UC3);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Affine transformation</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; resized_height; y++)&#123;    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; resized_width; x++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">54</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">// get original position x</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">55</span></pre></td><td class="code"><pre><span class="line">      x_before = (<span class="keyword">int</span>)((d * x - b * y) / det - tx);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">56</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">57</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> ((x_before &lt; <span class="number">0</span>) || (x_before &gt;= <span class="built_in">width</span>))&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">58</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">continue</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">59</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">60</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">61</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">// get original position y</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">62</span></pre></td><td class="code"><pre><span class="line">      y_before = (<span class="keyword">int</span>)((-c * x + a * y) / det - ty);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">63</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">64</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> ((y_before &lt; <span class="number">0</span>) || (y_before &gt;= <span class="built_in">height</span>))&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">65</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">continue</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">66</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">67</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">68</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">// assign pixel to new position</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">69</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> c = <span class="number">0</span>; c &lt; channel; c++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">70</span></pre></td><td class="code"><pre><span class="line">        out.at&lt;cv::Vec3b&gt;(y, x)[c] = img.at&lt;cv::Vec3b&gt;(y_before, x_before)[c];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">71</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">72</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">73</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">74</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">75</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> out;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">76</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>
<h4 id="å››ã€å€¾æ–œï¼ˆåç§»å˜æ¢-æ°´å¹³ã€å‚ç›´ï¼‰"><a href="#å››ã€å€¾æ–œï¼ˆåç§»å˜æ¢-æ°´å¹³ã€å‚ç›´ï¼‰" class="headerlink" title="å››ã€å€¾æ–œï¼ˆåç§»å˜æ¢-æ°´å¹³ã€å‚ç›´ï¼‰"></a>å››ã€å€¾æ–œï¼ˆåç§»å˜æ¢-æ°´å¹³ã€å‚ç›´ï¼‰</h4><p>å‡è®¾åŸå›¾åƒçš„å¤§å°ä¸º(h, w)ï¼Œå€¾æ–œè§’åº¦ä¸ºAï¼Œåˆ™ï¼š</p>
<p>æ°´å¹³å€¾æ–œï¼š</p>
<script type="math/tex; mode=display">
s_h=\frac{A}{h}\\\begin{pmatrix} x'\\ y'\\ 1\\ \end{pmatrix}=\begin{pmatrix} 1 & s_h & t_x\\ 0 & 1 & t_y\\ 0 & 0 & 1\\ \end{pmatrix}\cdot \begin{pmatrix} x\\ y\\ 1\\ \end{pmatrix}</script><p>å‚ç›´å€¾æ–œï¼š</p>
<script type="math/tex; mode=display">
s_v=\frac{A}{w}\\\begin{pmatrix} x'\\ y'\\ 1\\ \end{pmatrix}=\begin{pmatrix} 1 & 0 & t_x\\ s_v & 1 & t_y\\ 0 & 0 & 1\\ \end{pmatrix}\cdot \begin{pmatrix} x\\ y\\ 1\\ \end{pmatrix}</script><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment"># Affine</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">affine</span><span class="params">(img, dx=<span class="number">30</span>, dy=<span class="number">30</span>)</span>:</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">    <span class="comment"># get shape</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">    H, W, C = img.shape</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">    <span class="comment"># Affine hyper parameters</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line">    a = <span class="number">1.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">    b = dx / H</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">    c = dy / W</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line">    d = <span class="number">1.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">    tx = <span class="number">0.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    ty = <span class="number">0.</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">    <span class="comment"># prepare temporary</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    _img = np.zeros((H+<span class="number">2</span>, W+<span class="number">2</span>, C), dtype=np.float32)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line">    <span class="comment"># insert image to center of temporary</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">    _img[<span class="number">1</span>:H+<span class="number">1</span>, <span class="number">1</span>:W+<span class="number">1</span>] = img</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    <span class="comment"># prepare affine image temporary</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    H_new = np.ceil(dy + H).astype(np.int)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    W_new = np.ceil(dx + W).astype(np.int)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    out = np.zeros((H_new, W_new, C), dtype=np.float32)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    <span class="comment"># preprare assigned index</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    x_new = np.tile(np.arange(W_new), (H_new, <span class="number">1</span>))</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line">    y_new = np.arange(H_new).repeat(W_new).reshape(H_new, <span class="number">-1</span>)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line">    <span class="comment"># prepare inverse matrix for affine</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">    adbc = a * d - b * c</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">    x = np.round((d * x_new  - b * y_new) / adbc).astype(np.int) - tx + <span class="number">1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">    y = np.round((-c * x_new + a * y_new) / adbc).astype(np.int) - ty + <span class="number">1</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">    x = np.minimum(np.maximum(x, <span class="number">0</span>), W+<span class="number">1</span>).astype(np.int)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">    y = np.minimum(np.maximum(y, <span class="number">0</span>), H+<span class="number">1</span>).astype(np.int)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">    <span class="comment"># assign value from original to affine image</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line">    out[y_new, x_new] = _img[y, x]</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">    out = out.astype(np.uint8)</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">return</span> out</span></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span></pre></td><td class="code"><pre><span class="line"><span class="comment">// affine</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">2</span></pre></td><td class="code"><pre><span class="line"><span class="function">cv::Mat <span class="title">affine</span><span class="params">(cv::Mat img, <span class="keyword">double</span> a, <span class="keyword">double</span> b, <span class="keyword">double</span> c, <span class="keyword">double</span> d, <span class="keyword">double</span> tx, <span class="keyword">double</span> ty, <span class="keyword">double</span> theta, <span class="keyword">double</span> dx, <span class="keyword">double</span> dy)</span></span>&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">3</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// get height and width</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">4</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> <span class="built_in">width</span> = img.cols;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">5</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> <span class="built_in">height</span> = img.rows;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">6</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> channel = img.channels();</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">7</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">8</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// get detriment</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">9</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">double</span> det = a * d - b * c;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">10</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">11</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> (dx != <span class="number">0</span>)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">12</span></pre></td><td class="code"><pre><span class="line">    b = dx / <span class="built_in">height</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">13</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">14</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> (dy != <span class="number">0</span>)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">15</span></pre></td><td class="code"><pre><span class="line">    c = dy / <span class="built_in">width</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">16</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">17</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">18</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> (theta != <span class="number">0</span>)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">19</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// Affine parameters</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">20</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">double</span> rad = theta / <span class="number">180.</span> * M_PI;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">21</span></pre></td><td class="code"><pre><span class="line">    a = <span class="built_in">std</span>::<span class="built_in">cos</span>(rad);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">22</span></pre></td><td class="code"><pre><span class="line">    b = - <span class="built_in">std</span>::<span class="built_in">sin</span>(rad);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">23</span></pre></td><td class="code"><pre><span class="line">    c = <span class="built_in">std</span>::<span class="built_in">sin</span>(rad);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">24</span></pre></td><td class="code"><pre><span class="line">    d = <span class="built_in">std</span>::<span class="built_in">cos</span>(rad);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">25</span></pre></td><td class="code"><pre><span class="line">    tx = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">26</span></pre></td><td class="code"><pre><span class="line">    ty = <span class="number">0</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">27</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">28</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">double</span> det = a * d - b * c;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">29</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">30</span></pre></td><td class="code"><pre><span class="line">    <span class="comment">// center transition</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">31</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">double</span> cx = <span class="built_in">width</span> / <span class="number">2.</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">32</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">double</span> cy = <span class="built_in">height</span> / <span class="number">2.</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">33</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">double</span> new_cx = (d * cx - b * cy) / det;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">34</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">double</span> new_cy = (- c * cx + a * cy) / det;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">35</span></pre></td><td class="code"><pre><span class="line">    tx = new_cx - cx;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">36</span></pre></td><td class="code"><pre><span class="line">    ty = new_cy - cy;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">37</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">38</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">39</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Resize width and height</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">40</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> resized_width = (<span class="keyword">int</span>)(<span class="built_in">width</span> * a + dx);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">41</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> resized_height = (<span class="keyword">int</span>)(<span class="built_in">height</span> * d + dy);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">42</span></pre></td><td class="code"><pre><span class="line">  </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">43</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">if</span> (theta != <span class="number">0</span>) &#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">44</span></pre></td><td class="code"><pre><span class="line">    resized_width = (<span class="keyword">int</span>)(<span class="built_in">width</span> + dx);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">45</span></pre></td><td class="code"><pre><span class="line">    resized_height = (<span class="keyword">int</span>)(<span class="built_in">height</span> + dy);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">46</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">47</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">48</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// other parameters</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">49</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">int</span> x_before, y_before;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">50</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">51</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// output</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">52</span></pre></td><td class="code"><pre><span class="line">  cv::Mat out = cv::Mat::zeros(resized_height, resized_width, CV_8UC3);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">53</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">54</span></pre></td><td class="code"><pre><span class="line">  <span class="comment">// Affine transformation</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">55</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> y = <span class="number">0</span>; y &lt; resized_height; y++)&#123;    </span></pre></td></tr><tr><td class="gutter"><pre><span class="line">56</span></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> x = <span class="number">0</span>; x &lt; resized_width; x++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">57</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">58</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">// get original position x</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">59</span></pre></td><td class="code"><pre><span class="line">      x_before = (<span class="keyword">int</span>)((d * x - b * y) / det - tx);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">60</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">61</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> ((x_before &lt; <span class="number">0</span>) || (x_before &gt;= <span class="built_in">width</span>))&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">62</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">continue</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">63</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">64</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">65</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">// get original position y</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">66</span></pre></td><td class="code"><pre><span class="line">      y_before = (<span class="keyword">int</span>)((-c * x + a * y) / det - ty);</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">67</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">68</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">if</span> ((y_before &lt; <span class="number">0</span>) || (y_before &gt;= <span class="built_in">height</span>))&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">69</span></pre></td><td class="code"><pre><span class="line">        <span class="keyword">continue</span>;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">70</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">71</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">72</span></pre></td><td class="code"><pre><span class="line">      <span class="comment">// assign pixel to new position</span></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">73</span></pre></td><td class="code"><pre><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> _c = <span class="number">0</span>; _c &lt; channel; _c++)&#123;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">74</span></pre></td><td class="code"><pre><span class="line">        out.at&lt;cv::Vec3b&gt;(y, x)[_c] = img.at&lt;cv::Vec3b&gt;(y_before, x_before)[_c];</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">75</span></pre></td><td class="code"><pre><span class="line">      &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">76</span></pre></td><td class="code"><pre><span class="line">    &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">77</span></pre></td><td class="code"><pre><span class="line">  &#125;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">78</span></pre></td><td class="code"><pre><span class="line"></span></pre></td></tr><tr><td class="gutter"><pre><span class="line">79</span></pre></td><td class="code"><pre><span class="line">  <span class="keyword">return</span> out;</span></pre></td></tr><tr><td class="gutter"><pre><span class="line">80</span></pre></td><td class="code"><pre><span class="line">&#125;</span></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="ä¸Šä¸€é¡µ"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>



          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Qiang Chen</p>
  <div class="site-description" itemprop="description">è®°å½•æ˜¯å¿˜è®°çš„ç¬¬ä¸€åŠ©æ‰‹.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">64</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">åˆ†ç±»</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/chenaing19" title="GitHub â†’ https://github.com/chenaing19" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="/765206494@qq.com" title="E-Mail â†’ 765206494@qq.com"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Qiang Chen</span>
</div>
  <div class="powered-by">ç”± <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> å¼ºåŠ›é©±åŠ¨ v4.0.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">ä¸»é¢˜ ï¿½?<a href="https://mist.theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> v7.5.0
  </div>
    <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>



        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="æ€»è®¿å®¢é‡">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="æ€»è®¿é—®é‡">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








        
      </div>
    </footer>
  </div>

  
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/muse.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>













  

  
      
<script type="text/x-mathjax-config">

  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [ ['$', '$'], ['\\(', '\\)'] ],
      processEscapes: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    },
    TeX: {
      equationNumbers: {
        autoNumber: 'AMS'
      }
    }
  });

  MathJax.Hub.Register.StartupHook('TeX Jax Ready', function() {
    MathJax.InputJax.TeX.prefilterHooks.Add(function(data) {
      if (data.display) {
        var next = data.script.nextSibling;
        while (next && next.nodeName.toLowerCase() === '#text') {
          next = next.nextSibling;
        }
        if (next && next.nodeName.toLowerCase() === 'br') {
          next.parentNode.removeChild(next);
        }
      }
    });
  });

  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for (i = 0; i < all.length; i += 1) {
      element = document.getElementById(all[i].inputID + '-Frame').parentNode;
      if (element.nodeName.toLowerCase() == 'li') {
        element = element.parentNode;
      }
      element.classList.add('has-jax');
    }
  });
</script>
<script>
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML', () => {
    MathJax.Hub.Typeset();
  }, window.MathJax);
</script>

    

  


  
  <!-- Ò³ï¿½ï¿½ï¿½ï¿½Ğ¡ï¿½ï¿½ï¿½ï¿½ -->
  
  
    <script src="/js/cursor/love.min.js"></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  



</body>
</html>
